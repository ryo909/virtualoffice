warning: in the working copy of 'src/call/deskCall.js', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/call/deskWebrtc.js', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/chatRealtime.js', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/main.js', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/realtime/deskCallRealtime.js', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/ui/drawer.chat.js', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/ui/modal.bgm.js', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/index.html b/index.html[m
[1mindex 5b69fce..c3bb539 100644[m
[1m--- a/index.html[m
[1m+++ b/index.html[m
[36m@@ -4,7 +4,7 @@[m
 <head>[m
   <meta charset="UTF-8">[m
   <meta name="viewport" content="width=device-width, initial-scale=1.0">[m
[31m-  <title>Virtual Office</title>[m
[32m+[m[32m  <title>„Éê„Éº„ÉÅ„É£„É´„Ç™„Éï„Ç£„Çπ</title>[m
   <link rel="preconnect" href="https://fonts.googleapis.com">[m
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>[m
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">[m
[36m@@ -20,7 +20,7 @@[m
     <!-- Loading Screen -->[m
     <div id="loading-screen">[m
       <div class="loading-spinner"></div>[m
[31m-      <div class="loading-text">Loading...</div>[m
[32m+[m[32m      <div class="loading-text">Ë™≠„ÅøËæº„Åø‰∏≠...</div>[m
 [m
       <!-- Boot Log & Fatal Error -->[m
       <pre id="bootLog" style="[m
[36m@@ -57,53 +57,54 @@[m
     <header id="menubar" class="hidden">[m
       <div class="logo">[m
         <div class="logo-icon"></div>[m
[31m-        <span>Virtual Office</span>[m
[32m+[m[32m        <span>„Éê„Éº„ÉÅ„É£„É´„Ç™„Éï„Ç£„Çπ</span>[m
       </div>[m
       <nav class="nav">[m
[31m-        <button class="nav-btn" data-drawer="chat" title="Chat">[m
[31m-          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
[31m-            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />[m
[31m-          </svg>[m
[31m-          <span>Chat</span>[m
[31m-        </button>[m
[31m-        <button class="nav-btn" data-drawer="people" title="People">[m
[32m+[m[32m        <button class="nav-btn" data-drawer="chat" title="„ÉÅ„É£„ÉÉ„Éà">[m
[32m+[m[32m          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
[32m+[m[32m            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />[m
[32m+[m[32m          </svg>[m
[32m+[m[32m          <span class="chat-unread-dot" id="chat-unread-dot" aria-hidden="true"></span>[m
[32m+[m[32m          <span>„ÉÅ„É£„ÉÉ„Éà</span>[m
[32m+[m[32m        </button>[m
[32m+[m[32m        <button class="nav-btn" data-drawer="people" title="„É°„É≥„Éê„Éº">[m
           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
             <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />[m
             <circle cx="9" cy="7" r="4" />[m
             <path d="M23 21v-2a4 4 0 0 0-3-3.87" />[m
             <path d="M16 3.13a4 4 0 0 1 0 7.75" />[m
           </svg>[m
[31m-          <span>People</span>[m
[32m+[m[32m          <span>„É°„É≥„Éê„Éº</span>[m
         </button>[m
[31m-        <button class="nav-btn" data-drawer="search" title="Search">[m
[32m+[m[32m        <button class="nav-btn" data-drawer="search" title="Ê§úÁ¥¢">[m
           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
             <circle cx="11" cy="11" r="8" />[m
             <path d="m21 21-4.35-4.35" />[m
           </svg>[m
[31m-          <span>Search</span>[m
[32m+[m[32m          <span>Ê§úÁ¥¢</span>[m
         </button>[m
         <div class="nav-dropdown" id="map-menu">[m
[31m-          <button class="nav-btn" id="map-menu-btn" title="Map">[m
[32m+[m[32m          <button class="nav-btn" id="map-menu-btn" title="„Éû„ÉÉ„Éó">[m
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
               <path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z" />[m
               <path d="M8 2v16" />[m
               <path d="M16 6v16" />[m
             </svg>[m
[31m-            <span id="map-menu-label">Map</span>[m
[32m+[m[32m            <span id="map-menu-label">„Éû„ÉÉ„Éó</span>[m
           </button>[m
           <div class="nav-dropdown-content" id="map-dropdown">[m
[31m-            <button class="nav-dropdown-item active" data-area="area:core">Office</button>[m
[31m-            <button class="nav-dropdown-item" data-area="area:garden">Garden</button>[m
[31m-            <button class="nav-dropdown-item" data-area="area:library">Library</button>[m
[32m+[m[32m            <button class="nav-dropdown-item active" data-area="area:core">„Ç™„Éï„Ç£„Çπ</button>[m
[32m+[m[32m            <button class="nav-dropdown-item" data-area="area:garden">„Ç¨„Éº„Éá„É≥</button>[m
[32m+[m[32m            <button class="nav-dropdown-item" data-area="area:library">„É©„Ç§„Éñ„É©„É™</button>[m
           </div>[m
         </div>[m
[31m-        <button class="nav-btn" data-drawer="settings" title="Settings">[m
[32m+[m[32m        <button class="nav-btn" data-drawer="settings" title="Ë®≠ÂÆö">[m
           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
             <circle cx="12" cy="12" r="3" />[m
             <path[m
               d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />[m
           </svg>[m
[31m-          <span>Settings</span>[m
[32m+[m[32m          <span>Ë®≠ÂÆö</span>[m
         </button>[m
       </nav>[m
       <div class="status-indicator">[m
[36m@@ -137,7 +138,7 @@[m
     <!-- Drawer -->[m
     <aside id="drawer">[m
       <div class="drawer-header">[m
[31m-        <h2 class="drawer-title" id="drawer-title">Drawer</h2>[m
[32m+[m[32m        <h2 class="drawer-title" id="drawer-title">„Éâ„É≠„ÉØ„Éº</h2>[m
         <button class="drawer-close" id="drawer-close">[m
           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
             <path d="M18 6 6 18M6 6l12 12" />[m
[36m@@ -148,14 +149,14 @@[m
       <!-- Chat Drawer Content -->[m
       <div id="drawer-chat" class="hidden">[m
         <div class="chat-tabs">[m
[31m-          <button class="chat-tab active" data-chat-tab="all">All</button>[m
[31m-          <button class="chat-tab" data-chat-tab="room">Room</button>[m
[31m-          <button class="chat-tab" data-chat-tab="dm">DM</button>[m
[32m+[m[32m          <button class="chat-tab active" data-chat-tab="all">ÂÖ®‰Ωì</button>[m
[32m+[m[32m          <button class="chat-tab" data-chat-tab="room">„É´„Éº„É†</button>[m
[32m+[m[32m          <button class="chat-tab" data-chat-tab="dm">DM</button>[m
         </div>[m
         <div class="chat-messages" id="chat-messages"></div>[m
         <div class="chat-input-container">[m
[31m-          <input type="text" class="chat-input" id="chat-input" placeholder="Type a message...">[m
[31m-          <button class="btn btn-primary" id="chat-send">Send</button>[m
[32m+[m[32m          <input type="text" class="chat-input" id="chat-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...">[m
[32m+[m[32m          <button class="btn btn-primary" id="chat-send">ÈÄÅ‰ø°</button>[m
         </div>[m
       </div>[m
 [m
[36m@@ -172,7 +173,7 @@[m
             <circle cx="11" cy="11" r="8" />[m
             <path d="m21 21-4.35-4.35" />[m
           </svg>[m
[31m-          <input type="text" class="search-input" id="search-input" placeholder="Search people...">[m
[32m+[m[32m          <input type="text" class="search-input" id="search-input" placeholder="„É°„É≥„Éê„Éº„ÇíÊ§úÁ¥¢...">[m
         </div>[m
         <div class="people-list" id="search-results"></div>[m
       </div>[m
[36m@@ -180,51 +181,67 @@[m
       <!-- Settings Drawer Content -->[m
       <div id="drawer-settings" class="drawer-content hidden">[m
         <div class="settings-section">[m
[31m-          <div class="settings-label">Display Name</div>[m
[32m+[m[32m          <div class="settings-label">Ë°®Á§∫Âêç</div>[m
           <div class="form-group">[m
[31m-            <input type="text" class="form-input" id="settings-name" placeholder="Your name">[m
[31m-            <button class="btn btn-secondary" id="settings-name-save" style="margin-top: 8px;">Save</button>[m
[32m+[m[32m            <input type="text" class="form-input" id="settings-name" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç">[m
[32m+[m[32m            <button class="btn btn-secondary" id="settings-name-save" style="margin-top: 8px;">‰øùÂ≠ò</button>[m
           </div>[m
         </div>[m
         <div class="settings-section">[m
[31m-          <div class="settings-label">Status</div>[m
[32m+[m[32m          <div class="settings-label">„Çπ„ÉÜ„Éº„Çø„Çπ</div>[m
           <div class="theme-options">[m
             <button class="theme-option" data-status="online">[m
               <div class="theme-preview" style="background: #10b981;"></div>[m
[31m-              <div class="theme-name">Online</div>[m
[32m+[m[32m              <div class="theme-name">„Ç™„É≥„É©„Ç§„É≥</div>[m
             </button>[m
             <button class="theme-option" data-status="away">[m
               <div class="theme-preview" style="background: #f59e0b;"></div>[m
[31m-              <div class="theme-name">Away</div>[m
[32m+[m[32m              <div class="theme-name">Èõ¢Â∏≠</div>[m
             </button>[m
             <button class="theme-option" data-status="focus">[m
               <div class="theme-preview" style="background: #ef4444;"></div>[m
[31m-              <div class="theme-name">Focus</div>[m
[32m+[m[32m              <div class="theme-name">ÈõÜ‰∏≠</div>[m
             </button>[m
           </div>[m
         </div>[m
         <div class="settings-section">[m
[31m-          <div class="settings-label">Theme</div>[m
[32m+[m[32m          <div class="settings-label">„ÉÜ„Éº„Éû</div>[m
           <div class="theme-options" id="theme-options">[m
             <button class="theme-option active" data-theme="theme:day">[m
               <div class="theme-preview" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0);"></div>[m
[31m-              <div class="theme-name">Day</div>[m
[32m+[m[32m              <div class="theme-name">Êòº</div>[m
             </button>[m
             <button class="theme-option" data-theme="theme:night">[m
               <div class="theme-preview" style="background: linear-gradient(135deg, #0f172a, #1e293b);"></div>[m
[31m-              <div class="theme-name">Night</div>[m
[32m+[m[32m              <div class="theme-name">Â§ú</div>[m
             </button>[m
             <button class="theme-option" data-theme="theme:mono">[m
               <div class="theme-preview" style="background: linear-gradient(135deg, #fafafa, #d4d4d4);"></div>[m
[31m-              <div class="theme-name">Mono</div>[m
[32m+[m[32m              <div class="theme-name">„É¢„Éé</div>[m
             </button>[m
           </div>[m
         </div>[m
         <div class="settings-section">[m
[31m-          <div class="settings-label">Debug</div>[m
[31m-          <button class="btn btn-secondary" id="settings-logout">Logout</button>[m
[31m-          <button class="btn btn-secondary" id="settings-clear-pw" style="margin-left: 8px;">Clear Saved[m
[31m-            Password</button>[m
[32m+[m[32m          <div class="settings-label">Èü≥Â£∞</div>[m
[32m+[m[32m          <div class="form-group">[m[41m[m
[32m+[m[32m            <label class="form-label" for="audio-mic">„Éû„Ç§„ÇØ</label>[m
[32m+[m[32m            <select class="form-input" id="audio-mic">[m[41m[m
[32m+[m[32m              <option value="">-- „Éû„Ç§„ÇØ„ÇíÈÅ∏Êäû --</option>[m
[32m+[m[32m            </select>[m[41m[m
[32m+[m[32m          </div>[m[41m[m
[32m+[m[32m          <div class="form-group">[m[41m[m
[32m+[m[32m            <label class="form-label" for="audio-speaker">„Çπ„Éî„Éº„Ç´„Éº</label>[m
[32m+[m[32m            <select class="form-input" id="audio-speaker">[m[41m[m
[32m+[m[32m              <option value="">-- „Çπ„Éî„Éº„Ç´„Éº„ÇíÈÅ∏Êäû --</option>[m
[32m+[m[32m            </select>[m[41m[m
[32m+[m[32m            <div class="form-hint" id="audio-speaker-hint"></div>[m[41m[m
[32m+[m[32m          </div>[m[41m[m
[32m+[m[32m          <button class="btn btn-secondary" id="audio-refresh">üîÑ „Éá„Éê„Ç§„ÇπÂÜçË™≠„ÅøËæº„Åø</button>[m
[32m+[m[32m        </div>[m[41m[m
[32m+[m[32m        <div class="settings-section">[m[41m[m
[32m+[m[32m          <div class="settings-label">„Ç¢„Ç´„Ç¶„É≥„Éà</div>[m
[32m+[m[32m          <button class="btn btn-secondary" id="settings-logout">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>[m
[32m+[m[32m          <button class="btn btn-secondary" id="settings-clear-pw" style="margin-left: 8px;">‰øùÂ≠òÊ∏à„Åø„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂâäÈô§</button>[m
         </div>[m
       </div>[m
     </aside>[m
[36m@@ -239,8 +256,8 @@[m
         </div>[m
         <div class="modal-body">[m
           <div class="form-group">[m
[31m-            <label class="form-label" for="password-input">Password</label>[m
[31m-            <input type="password" class="form-input" id="password-input" placeholder="Enter password">[m
[32m+[m[32m            <label class="form-label" for="password-input">„Éë„Çπ„ÉØ„Éº„Éâ</label>[m
[32m+[m[32m            <input type="password" class="form-input" id="password-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">[m
             <div class="form-error hidden" id="password-error"></div>[m
           </div>[m
           <label class="form-checkbox">[m
[36m@@ -261,8 +278,8 @@[m
         </div>[m
         <div class="modal-body">[m
           <div class="form-group">[m
[31m-            <label class="form-label" for="nameplate-input">Display Name</label>[m
[31m-            <input type="text" class="form-input" id="nameplate-input" placeholder="Your display name" maxlength="20">[m
[32m+[m[32m            <label class="form-label" for="nameplate-input">Ë°®Á§∫Âêç</label>[m
[32m+[m[32m            <input type="text" class="form-input" id="nameplate-input" placeholder="Ë°®Á§∫Âêç„ÇíÂÖ•Âäõ" maxlength="20">[m
             <div class="form-hint">ÊúÄÂ§ß20ÊñáÂ≠ó</div>[m
             <div class="form-error hidden" id="nameplate-error"></div>[m
           </div>[m
[36m@@ -297,4 +314,4 @@[m
   <script type="module" src="src/boot.js?v=20260201_2"></script>[m
 </body>[m
 [m
[31m-</html>[m
\ No newline at end of file[m
[32m+[m[32m</html>[m
[1mdiff --git a/src/call/deskCall.js b/src/call/deskCall.js[m
[1mindex 5bacea8..f63e23d 100644[m
[1m--- a/src/call/deskCall.js[m
[1m+++ b/src/call/deskCall.js[m
[36m@@ -17,6 +17,7 @@[m [mimport {[m
     sendDeskCallEvent,[m
     leaveDeskCallChannel[m
 } from '../realtime/deskCallRealtime.js';[m
[32m+[m[32mimport { getSelectedSpeakerId, isSpeakerSelectionSupported } from '../services/audioDevices.js';[m
 [m
 let mySessionId = null;[m
 let myJoinAt = null;[m
[36m@@ -27,7 +28,8 @@[m [mconst state = {[m
     status: 'idle',[m
     muted: false,[m
     peerSessionId: null,[m
[31m-    error: null[m
[32m+[m[32m    error: null,[m
[32m+[m[32m    participants: [][m
 };[m
 [m
 const remoteAudio = new Audio();[m
[36m@@ -39,24 +41,47 @@[m [mfunction setState(patch) {[m
     onStateChange?.(state, prev);[m
 }[m
 [m
[32m+[m[32m/**[m
[32m+[m[32m * Apply selected speaker to remote audio element[m
[32m+[m[32m */[m
[32m+[m[32masync function applySelectedSpeaker() {[m
[32m+[m[32m    if (!isSpeakerSelectionSupported()) return;[m
[32m+[m
[32m+[m[32m    const speakerId = getSelectedSpeakerId();[m
[32m+[m[32m    if (!speakerId) return;[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        await remoteAudio.setSinkId(speakerId);[m
[32m+[m[32m        console.log('[deskCall] Speaker applied:', speakerId);[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[deskCall] Failed to set speaker:', err);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
 export function initDeskCall({ sessionId, onStateChange: onChange }) {[m
     mySessionId = sessionId;[m
     onStateChange = onChange;[m
 [m
     initDeskWebRTC({[m
[31m-        onIceCandidate: (candidate) => {[m
[32m+[m[32m        onIceCandidate: (payload) => {[m
[32m+[m[32m            const candidate = payload?.candidate;[m
[32m+[m[32m            if (!candidate) return;[m
             if (!state.peerSessionId) return;[m
[32m+[m
             sendDeskCallEvent({[m
                 type: 'call_ice',[m
                 fromSessionId: mySessionId,[m
                 toSessionId: state.peerSessionId,[m
                 candidate,[m
                 ts: Date.now()[m
[32m+[m[32m            }).catch((err) => {[m
[32m+[m[32m                console.warn('[deskCall] failed to send ICE candidate', err);[m
             });[m
         },[m
         onTrack: (stream) => {[m
             remoteAudio.srcObject = stream;[m
[31m-            remoteAudio.play().catch(() => {});[m
[32m+[m[32m            remoteAudio.play().catch(() => { });[m
[32m+[m[32m            applySelectedSpeaker(); // Apply speaker selection[m
         },[m
         onConnectionStateChange: (connectionState) => {[m
             if (connectionState === 'connected') {[m
[36m@@ -73,18 +98,19 @@[m [mexport function getDeskCallState() {[m
     return { ...state };[m
 }[m
 [m
[31m-export async function joinDeskCall(deskId) {[m
[32m+[m[32mexport async function joinDeskCall(deskId, opts = {}) {[m
     if (!mySessionId) return false;[m
 [m
     if (state.deskId && state.deskId !== deskId) {[m
         await leaveDeskCall();[m
     }[m
 [m
[31m-    setState({ deskId, status: 'ready', error: null });[m
[32m+[m[32m    setState({ deskId, status: 'ready', error: null, participants: [] });[m
 [m
     const join = await joinDeskCallChannel({[m
         deskId,[m
         sessionId: mySessionId,[m
[32m+[m[32m        displayName: opts.displayName || null,[m
         onEvent: handleEvent,[m
         onPresenceSync: handlePresence[m
     });[m
[36m@@ -122,7 +148,27 @@[m [mexport function toggleDeskMute() {[m
     setState({ muted: !state.muted });[m
 }[m
 [m
[32m+[m[32mfunction computeParticipants(presenceState) {[m
[32m+[m[32m    const participants = [];[m
[32m+[m[32m    Object.entries(presenceState || {}).forEach(([key, presences]) => {[m
[32m+[m[32m        if (!presences || presences.length === 0) return;[m
[32m+[m[32m        const p = presences[0];[m
[32m+[m[32m        if (!p?.sessionId) return;[m
[32m+[m[32m        participants.push({[m
[32m+[m[32m            sessionId: p.sessionId,[m
[32m+[m[32m            displayName: p.displayName || null,[m
[32m+[m[32m            joinedAt: p.joinedAt || 0[m
[32m+[m[32m        });[m
[32m+[m[32m    });[m
[32m+[m[32m    participants.sort((a, b) => (a.joinedAt || 0) - (b.joinedAt || 0));[m
[32m+[m[32m    return participants;[m
[32m+[m[32m}[m
[32m+[m
 async function handlePresence(presenceState) {[m
[32m+[m[32m    // Always update participants list[m
[32m+[m[32m    const participants = computeParticipants(presenceState);[m
[32m+[m[32m    setState({ participants });[m
[32m+[m
     if (!presenceState || state.status !== 'ready') return;[m
 [m
     const others = [];[m
[36m@@ -201,7 +247,8 @@[m [masync function handleOffer(payload) {[m
 [m
 async function handleAnswer(payload) {[m
     if (state.status !== 'connecting') return;[m
[31m-    if (payload.toSessionId && payload.toSessionId !== mySessionId) return;[m
[32m+[m[32m    if (payload?.toSessionId && payload.toSessionId !== mySessionId) return;[m
[32m+[m[32m    if (!payload?.sdp) return;[m
 [m
     try {[m
         await setDeskRemoteDescription(payload.sdp);[m
[36m@@ -213,12 +260,19 @@[m [masync function handleAnswer(payload) {[m
 }[m
 [m
 async function handleIce(payload) {[m
[31m-    if (payload.toSessionId && payload.toSessionId !== mySessionId) return;[m
[31m-    await addDeskIceCandidate(payload.candidate);[m
[32m+[m[32m    if (payload?.toSessionId && payload.toSessionId !== mySessionId) return;[m
[32m+[m[32m    const candidate = payload?.candidate;[m
[32m+[m[32m    if (!candidate) return;[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        await addDeskIceCandidate({ candidate });[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[deskCall] handleIce failed', err, candidate);[m
[32m+[m[32m    }[m
 }[m
 [m
 function handleHangup(payload) {[m
[31m-    if (payload.toSessionId && payload.toSessionId !== mySessionId) return;[m
[32m+[m[32m    if (payload?.toSessionId && payload.toSessionId !== mySessionId) return;[m
     closeDeskPeerConnection();[m
     setState({ status: 'ended', peerSessionId: null });[m
 }[m
[36m@@ -229,13 +283,19 @@[m [mfunction handleEvent(payload) {[m
 [m
     switch (payload.type) {[m
         case 'call_offer':[m
[31m-            handleOffer(payload);[m
[32m+[m[32m            void handleOffer(payload).catch((err) => {[m
[32m+[m[32m                console.warn('[deskCall] handleOffer failed', err);[m
[32m+[m[32m            });[m
             break;[m
         case 'call_answer':[m
[31m-            handleAnswer(payload);[m
[32m+[m[32m            void handleAnswer(payload).catch((err) => {[m
[32m+[m[32m                console.warn('[deskCall] handleAnswer failed', err);[m
[32m+[m[32m            });[m
             break;[m
         case 'call_ice':[m
[31m-            handleIce(payload);[m
[32m+[m[32m            void handleIce(payload).catch((err) => {[m
[32m+[m[32m                console.warn('[deskCall] handleIce failed', err);[m
[32m+[m[32m            });[m
             break;[m
         case 'call_hangup':[m
             handleHangup(payload);[m
[1mdiff --git a/src/call/deskWebrtc.js b/src/call/deskWebrtc.js[m
[1mindex 9be1bec..01543a5 100644[m
[1m--- a/src/call/deskWebrtc.js[m
[1m+++ b/src/call/deskWebrtc.js[m
[36m@@ -1,6 +1,7 @@[m
 // deskWebrtc.js - WebRTC connection management for desk calls (separate from direct calls)[m
 [m
 import { getConfig } from '../services/supabaseClient.js';[m
[32m+[m[32mimport { getSelectedMicId } from '../services/audioDevices.js';[m
 [m
 let peerConnection = null;[m
 let localStream = null;[m
[36m@@ -11,9 +12,9 @@[m [mlet onTrack = null;[m
 let onConnectionStateChange = null;[m
 [m
 export function initDeskWebRTC(callbacks) {[m
[31m-    onIceCandidate = callbacks.onIceCandidate;[m
[31m-    onTrack = callbacks.onTrack;[m
[31m-    onConnectionStateChange = callbacks.onConnectionStateChange;[m
[32m+[m[32m    onIceCandidate = callbacks?.onIceCandidate || null;[m
[32m+[m[32m    onTrack = callbacks?.onTrack || null;[m
[32m+[m[32m    onConnectionStateChange = callbacks?.onConnectionStateChange || null;[m
 }[m
 [m
 export async function createDeskPeerConnection() {[m
[36m@@ -25,8 +26,18 @@[m [mexport async function createDeskPeerConnection() {[m
     peerConnection = new RTCPeerConnection({ iceServers });[m
 [m
     peerConnection.onicecandidate = (event) => {[m
[31m-        if (event.candidate && onIceCandidate) {[m
[31m-            onIceCandidate(event.candidate);[m
[32m+[m[32m        try {[m
[32m+[m[32m            const candidate = event?.candidate;[m
[32m+[m[32m            if (!candidate) return;[m
[32m+[m[32m            console.log('[ICE] local candidate', candidate);[m
[32m+[m[32m            const result = onIceCandidate?.({ candidate });[m
[32m+[m[32m            if (result && typeof result.catch === 'function') {[m
[32m+[m[32m                result.catch((err) => {[m
[32m+[m[32m                    console.warn('[deskWebrtc] onIceCandidate callback failed', err);[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.warn('[deskWebrtc] onicecandidate handler failed', err);[m
         }[m
     };[m
 [m
[36m@@ -47,10 +58,28 @@[m [mexport async function createDeskPeerConnection() {[m
 }[m
 [m
 export async function getDeskUserMedia() {[m
[31m-    localStream = await navigator.mediaDevices.getUserMedia({[m
[31m-        audio: true,[m
[31m-        video: false[m
[31m-    });[m
[32m+[m[32m    const micId = getSelectedMicId();[m
[32m+[m
[32m+[m[32m    // Build audio constraint with selected device if available[m
[32m+[m[32m    const audioConstraint = micId[m
[32m+[m[32m        ? { deviceId: { exact: micId } }[m
[32m+[m[32m        : true;[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        localStream = await navigator.mediaDevices.getUserMedia({[m
[32m+[m[32m            audio: audioConstraint,[m
[32m+[m[32m            video: false[m
[32m+[m[32m        });[m
[32m+[m[32m        console.log('[deskWebrtc] getUserMedia success, mic:', micId || 'default');[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        // Fallback to default mic if specific device fails[m
[32m+[m[32m        console.warn('[deskWebrtc] getUserMedia with deviceId failed, fallback to default', err);[m
[32m+[m[32m        localStream = await navigator.mediaDevices.getUserMedia({[m
[32m+[m[32m            audio: true,[m
[32m+[m[32m            video: false[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
     return localStream;[m
 }[m
 [m
[36m@@ -80,12 +109,24 @@[m [mexport async function setDeskRemoteDescription(description) {[m
     await peerConnection.setRemoteDescription(new RTCSessionDescription(description));[m
 }[m
 [m
[31m-export async function addDeskIceCandidate(candidate) {[m
[32m+[m[32mexport async function addDeskIceCandidate(payload) {[m
     if (!peerConnection) return;[m
[32m+[m[32m    const candidate = payload?.candidate;[m
[32m+[m[32m    if (!candidate) return;[m
[32m+[m
[32m+[m[32m    console.log('[ICE] remote candidate received', candidate);[m
[32m+[m
[32m+[m[32m    const candidateInit = typeof candidate === 'string'[m
[32m+[m[32m        ? { candidate }[m
[32m+[m[32m        : candidate;[m
[32m+[m
     try {[m
[31m-        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));[m
[32m+[m[32m        const iceCandidate = candidate instanceof RTCIceCandidate[m
[32m+[m[32m            ? candidate[m
[32m+[m[32m            : new RTCIceCandidate(candidateInit);[m
[32m+[m[32m        await peerConnection.addIceCandidate(iceCandidate);[m
     } catch (err) {[m
[31m-        console.error('[DeskCall] Failed to add ICE candidate:', err);[m
[32m+[m[32m        console.warn('[deskWebrtc] addIceCandidate failed', err, candidateInit);[m
     }[m
 }[m
 [m
[1mdiff --git a/src/call/signaling.js b/src/call/signaling.js[m
[1mindex 8b5a332..1e192a1 100644[m
[1m--- a/src/call/signaling.js[m
[1m+++ b/src/call/signaling.js[m
[36m@@ -1,204 +1,577 @@[m
 // signaling.js - WebRTC signaling via Supabase Realtime[m
 [m
 import { sendEventTo } from '../services/realtime.js';[m
[31m-import { generateCallId } from '../utils/ids.js';[m
[31m-import {[m
[31m-    requestCall,[m
[31m-    receiveIncomingCall,[m
[31m-    callConnected,[m
[31m-    endCall,[m
[31m-    callError,[m
[31m-    getCallState[m
[31m-} from './callStateMachine.js';[m
[31m-import {[m
[31m-    createPeerConnection,[m
[31m-    getUserMedia,[m
[32m+[m[32mimport { generateCallId } from '../utils/ids.js';[m
[32m+[m[32mimport {[m
[32m+[m[32m    requestCall,[m
[32m+[m[32m    receiveIncomingCall,[m
[32m+[m[32m    acceptCall,[m
[32m+[m[32m    callConnected,[m
[32m+[m[32m    endCall,[m
[32m+[m[32m    getCallState[m
[32m+[m[32m} from './callStateMachine.js';[m
[32m+[m[32mimport {[m
[32m+[m[32m    createPeerConnection,[m
[32m+[m[32m    getUserMedia,[m
     addLocalStream,[m
     createOffer,[m
[31m-    createAnswer,[m
[31m-    setRemoteDescription,[m
[31m-    addIceCandidate,[m
[31m-    closePeerConnection[m
[31m-} from './webrtc.js';[m
[31m-[m
[31m-let myActorId = null;[m
[31m-[m
[31m-export function initSignaling({ actorId }) {[m
[31m-    myActorId = actorId;[m
[31m-}[m
[31m-[m
[31m-/**[m
[31m- * Initiate a call to a peer[m
[31m- */[m
[31m-export async function startCall(peerActorId) {[m
[31m-    const callId = generateCallId();[m
[31m-[m
[31m-    if (!requestCall(peerActorId, callId)) {[m
[31m-        return false;[m
[31m-    }[m
[31m-[m
[31m-    try {[m
[31m-        await createPeerConnection();[m
[31m-        await getUserMedia();[m
[32m+[m[32m    createAnswer,[m
[32m+[m[32m    setRemoteDescription,[m
[32m+[m[32m    addIceCandidate,[m
[32m+[m[32m    closePeerConnection,[m
[32m+[m[32m    getPeerConnection[m
[32m+[m[32m} from './webrtc.js';[m
[32m+[m
[32m+[m[32mlet myActorId = null;[m
[32m+[m[32mconst DROP_LOG_INTERVAL_MS = 3000;[m
[32m+[m[32mconst CALL_NO_ANSWER_TIMEOUT_MS = 20000;[m
[32m+[m[32mconst droppedLogAt = new Map();[m
[32m+[m[32mconst callSession = {[m
[32m+[m[32m    callId: null,[m
[32m+[m[32m    deskId: null,[m
[32m+[m[32m    role: null,[m
[32m+[m[32m    peerActorId: null,[m
[32m+[m[32m    status: 'idle',[m
[32m+[m[32m    pendingOffer: null,[m
[32m+[m[32m    pendingCandidates: [],[m
[32m+[m[32m    timers: {[m
[32m+[m[32m        noAnswerTimeout: null[m
[32m+[m[32m    }[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32mfunction warnDropped(key, message, detail) {[m
[32m+[m[32m    const now = Date.now();[m
[32m+[m[32m    const last = droppedLogAt.get(key) || 0;[m
[32m+[m[32m    if (now - last < DROP_LOG_INTERVAL_MS) return;[m
[32m+[m[32m    droppedLogAt.set(key, now);[m
[32m+[m[32m    console.warn(message, detail);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction parseJsonObject(text) {[m
[32m+[m[32m    if (typeof text !== 'string') return null;[m
[32m+[m[32m    try {[m
[32m+[m[32m        const parsed = JSON.parse(text);[m
[32m+[m[32m        return parsed && typeof parsed === 'object' ? parsed : null;[m
[32m+[m[32m    } catch {[m
[32m+[m[32m        return null;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction asObject(value) {[m
[32m+[m[32m    if (!value) return null;[m
[32m+[m[32m    if (typeof value === 'string') return parseJsonObject(value);[m
[32m+[m[32m    if (typeof value !== 'object') return null;[m
[32m+[m[32m    return value;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction collectObjects(raw, out, seen, depth = 0) {[m
[32m+[m[32m    if (depth > 2) return;[m
[32m+[m[32m    const obj = asObject(raw);[m
[32m+[m[32m    if (!obj) return;[m
[32m+[m[32m    if (seen.has(obj)) return;[m
[32m+[m[32m    seen.add(obj);[m
[32m+[m[32m    out.push(obj);[m
[32m+[m[32m    collectObjects(obj.payload, out, seen, depth + 1);[m
[32m+[m[32m    collectObjects(obj.data, out, seen, depth + 1);[m
[32m+[m[32m    collectObjects(obj.new, out, seen, depth + 1);[m
[32m+[m[32m    collectObjects(obj.message, out, seen, depth + 1);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction normalizeCallEvent(evt) {[m
[32m+[m[32m    if (!evt) return null;[m
[32m+[m[32m    const objects = [];[m
[32m+[m[32m    collectObjects(evt, objects, new Set());[m
[32m+[m
[32m+[m[32m    let fallback = null;[m
[32m+[m[32m    for (const obj of objects) {[m
[32m+[m[32m        const type = typeof obj.type === 'string' ? obj.type : '';[m
[32m+[m[32m        if (type.startsWith('call_')) return obj;[m
[32m+[m[32m        if (!fallback && (type || obj.callId || obj.offer || obj.answer || obj.candidate)) {[m
[32m+[m[32m            fallback = obj;[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m[32m    return fallback;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction clearCallTimers() {[m
[32m+[m[32m    if (callSession.timers.noAnswerTimeout) {[m
[32m+[m[32m        clearTimeout(callSession.timers.noAnswerTimeout);[m
[32m+[m[32m        callSession.timers.noAnswerTimeout = null;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction setCallSession(patch = {}) {[m
[32m+[m[32m    Object.assign(callSession, patch);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction ensureSessionIdleOrReset(reason) {[m
[32m+[m[32m    const state = getCallState();[m
[32m+[m[32m    if (callSession.status === 'idle' && state.state === 'idle') return;[m
[32m+[m[32m    resetCallSession(reason);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32masync function flushPendingCandidates() {[m
[32m+[m[32m    const pc = getPeerConnection();[m
[32m+[m[32m    if (!pc?.remoteDescription) return;[m
[32m+[m[32m    if (callSession.pendingCandidates.length === 0) return;[m
[32m+[m
[32m+[m[32m    const queue = [...callSession.pendingCandidates];[m
[32m+[m[32m    callSession.pendingCandidates = [];[m
[32m+[m[32m    for (const candidate of queue) {[m
[32m+[m[32m        try {[m
[32m+[m[32m            await addIceCandidate({ candidate });[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.warn('[call] failed to flush ICE candidate', err, candidate);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction startNoAnswerTimeout() {[m
[32m+[m[32m    clearCallTimers();[m
[32m+[m[32m    callSession.timers.noAnswerTimeout = setTimeout(() => {[m
[32m+[m[32m        if (callSession.status === 'idle') return;[m
[32m+[m[32m        const callId = callSession.callId;[m
[32m+[m[32m        const peerActorId = callSession.peerActorId;[m
[32m+[m[32m        console.log('[call] hangup', { callId, reason: 'no_answer_timeout' });[m
[32m+[m[32m        if (callId && peerActorId) {[m
[32m+[m[32m            sendEventTo(peerActorId, {[m
[32m+[m[32m                type: 'call_hangup',[m
[32m+[m[32m                payload: {[m
[32m+[m[32m                    callId,[m
[32m+[m[32m                    from: myActorId,[m
[32m+[m[32m                    to: peerActorId,[m
[32m+[m[32m                    deskId: null,[m
[32m+[m[32m                    fromActorId: myActorId,[m
[32m+[m[32m                    toActorId: peerActorId,[m
[32m+[m[32m                    reason: 'no_answer_timeout',[m
[32m+[m[32m                    data: { reason: 'no_answer_timeout' }[m
[32m+[m[32m                }[m
[32m+[m[32m            }).catch((err) => {[m
[32m+[m[32m                console.warn('[call] failed to send timeout hangup', err);[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m[32m        resetCallSession('no_answer_timeout');[m
[32m+[m[32m    }, CALL_NO_ANSWER_TIMEOUT_MS);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction resetCallSession(reason) {[m
[32m+[m[32m    console.warn('[call] reset', reason);[m
[32m+[m
[32m+[m[32m    clearCallTimers();[m
[32m+[m[32m    callSession.pendingCandidates = [];[m
[32m+[m[32m    callSession.pendingOffer = null;[m
[32m+[m
[32m+[m[32m    const pc = getPeerConnection();[m
[32m+[m[32m    if (pc) {[m
[32m+[m[32m        try {[m
[32m+[m[32m            pc.onicecandidate = null;[m
[32m+[m[32m            pc.ontrack = null;[m
[32m+[m[32m            pc.onconnectionstatechange = null;[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.warn('[call] reset handler cleanup failed', err);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        closePeerConnection();[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[call] reset closePeerConnection failed', err);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    setCallSession({[m
[32m+[m[32m        callId: null,[m
[32m+[m[32m        deskId: null,[m
[32m+[m[32m        role: null,[m
[32m+[m[32m        peerActorId: null,[m
[32m+[m[32m        status: 'idle',[m
[32m+[m[32m        pendingOffer: null,[m
[32m+[m[32m        pendingCandidates: [][m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    if (getCallState().state !== 'idle') {[m
[32m+[m[32m        endCall();[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport function initSignaling({ actorId }) {[m
[32m+[m[32m    myActorId = actorId;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/**[m
[32m+[m[32m * Initiate a call to a peer[m
[32m+[m[32m */[m
[32m+[m[32mexport async function startCall(peerActorId) {[m
[32m+[m[32m    if (!peerActorId) return false;[m
[32m+[m
[32m+[m[32m    if (callSession.status !== 'idle' || getCallState().state !== 'idle') {[m
[32m+[m[32m        resetCallSession('start_call_while_busy');[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const callId = generateCallId();[m
[32m+[m[32m    if (!requestCall(peerActorId, callId)) {[m
[32m+[m[32m        resetCallSession('start_call_request_failed');[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    setCallSession({[m
[32m+[m[32m        callId,[m
[32m+[m[32m        deskId: null,[m
[32m+[m[32m        role: 'caller',[m
[32m+[m[32m        peerActorId,[m
[32m+[m[32m        status: 'calling',[m
[32m+[m[32m        pendingOffer: null,[m
[32m+[m[32m        pendingCandidates: [][m
[32m+[m[32m    });[m
[32m+[m[32m    startNoAnswerTimeout();[m
[32m+[m[32m    console.log('[call] start', { callId, deskId: null, to: peerActorId });[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        await createPeerConnection();[m
[32m+[m[32m        await getUserMedia();[m
         await addLocalStream();[m
 [m
         const offer = await createOffer();[m
 [m
         // Send call request[m
[31m-        await sendEventTo(peerActorId, {[m
[31m-            type: 'call_request',[m
[31m-            payload: {[m
[31m-                callId,[m
[31m-                fromActorId: myActorId,[m
[31m-                offer[m
[31m-            }[m
[31m-        });[m
[31m-[m
[31m-        return true;[m
[31m-    } catch (err) {[m
[31m-        console.error('Failed to start call:', err);[m
[31m-        callError(err.message);[m
[31m-        closePeerConnection();[m
[31m-        return false;[m
[31m-    }[m
[31m-}[m
[32m+[m[32m        await sendEventTo(peerActorId, {[m
[32m+[m[32m            type: 'call_request',[m
[32m+[m[32m            payload: {[m
[32m+[m[32m                callId,[m
[32m+[m[32m                from: myActorId,[m
[32m+[m[32m                to: peerActorId,[m
[32m+[m[32m                deskId: null,[m
[32m+[m[32m                fromActorId: myActorId,[m
[32m+[m[32m                toActorId: peerActorId,[m
[32m+[m[32m                data: { offer },[m
[32m+[m[32m                offer[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        return true;[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error('[call] start failed', err);[m
[32m+[m[32m        resetCallSession('start_call_failed');[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
 [m
 /**[m
  * Handle incoming call request[m
  */[m
[31m-export function handleCallRequest({ callId, fromActorId, offer }) {[m
[31m-    if (!receiveIncomingCall(fromActorId, callId)) {[m
[31m-        // Send busy signal[m
[31m-        sendEventTo(fromActorId, {[m
[31m-            type: 'call_busy',[m
[31m-            payload: { callId }[m
[31m-        });[m
[31m-        return false;[m
[31m-    }[m
[31m-[m
[31m-    // Store offer for later use when accepting[m
[31m-    window.__pendingOffer = offer;[m
[31m-[m
[31m-    return true;[m
[31m-}[m
[32m+[m[32mexport function handleCallRequest(payload) {[m
[32m+[m[32m    const callId = typeof payload?.callId === 'string' ? payload.callId : null;[m
[32m+[m[32m    const fromActorId = payload?.from || payload?.fromActorId || null;[m
[32m+[m[32m    const offer = payload?.data?.offer || payload?.offer || null;[m
[32m+[m[32m    if (!callId || !fromActorId || !offer) {[m
[32m+[m[32m        warnDropped('call_request_invalid', '[call] dropped event (missing callId/type)', payload);[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (callSession.callId === callId && callSession.status === 'ringing') {[m
[32m+[m[32m        return true;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (callSession.status !== 'idle' || getCallState().state !== 'idle') {[m
[32m+[m[32m        const pc = getPeerConnection();[m
[32m+[m[32m        const hasLiveCall = !!pc && pc.connectionState !== 'closed';[m
[32m+[m[32m        if (hasLiveCall) {[m
[32m+[m[32m            sendEventTo(fromActorId, {[m
[32m+[m[32m                type: 'call_busy',[m
[32m+[m[32m                payload: {[m
[32m+[m[32m                    callId,[m
[32m+[m[32m                    from: myActorId,[m
[32m+[m[32m                    to: fromActorId,[m
[32m+[m[32m                    deskId: null,[m
[32m+[m[32m                    fromActorId: myActorId,[m
[32m+[m[32m                    toActorId: fromActorId,[m
[32m+[m[32m                    data: { reason: 'busy' },[m
[32m+[m[32m                    reason: 'busy'[m
[32m+[m[32m                }[m
[32m+[m[32m            }).catch((err) => {[m
[32m+[m[32m                console.warn('[call] failed to send busy signal', err);[m
[32m+[m[32m            });[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m[32m        ensureSessionIdleOrReset('incoming_offer_when_busy');[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (!receiveIncomingCall(fromActorId, callId)) {[m
[32m+[m[32m        sendEventTo(fromActorId, {[m
[32m+[m[32m            type: 'call_busy',[m
[32m+[m[32m            payload: {[m
[32m+[m[32m                callId,[m
[32m+[m[32m                from: myActorId,[m
[32m+[m[32m                to: fromActorId,[m
[32m+[m[32m                deskId: null,[m
[32m+[m[32m                fromActorId: myActorId,[m
[32m+[m[32m                toActorId: fromActorId,[m
[32m+[m[32m                data: { reason: 'busy' },[m
[32m+[m[32m                reason: 'busy'[m
[32m+[m[32m            }[m
[32m+[m[32m        }).catch((err) => {[m
[32m+[m[32m            console.warn('[call] failed to send busy signal', err);[m
[32m+[m[32m        });[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m    setCallSession({[m
[32m+[m[32m        callId,[m
[32m+[m[32m        deskId: null,[m
[32m+[m[32m        role: 'callee',[m
[32m+[m[32m        peerActorId: fromActorId,[m
[32m+[m[32m        status: 'ringing',[m
[32m+[m[32m        pendingOffer: offer,[m
[32m+[m[32m        pendingCandidates: [][m
[32m+[m[32m    });[m
[32m+[m[32m    console.log('[call] incoming', { callId, deskId: null, from: fromActorId });[m
[32m+[m
[32m+[m[32m    return true;[m
[32m+[m[32m}[m
 [m
 /**[m
  * Accept incoming call[m
  */[m
[31m-export async function acceptIncomingCall() {[m
[31m-    const state = getCallState();[m
[31m-    const offer = window.__pendingOffer;[m
[31m-[m
[31m-    if (!offer || state.state !== 'incoming') {[m
[31m-        return false;[m
[31m-    }[m
[31m-[m
[31m-    try {[m
[31m-        await createPeerConnection();[m
[31m-        await getUserMedia();[m
[31m-        await addLocalStream();[m
[31m-[m
[31m-        await setRemoteDescription(offer);[m
[31m-        const answer = await createAnswer();[m
[31m-[m
[31m-        // Send answer[m
[31m-        await sendEventTo(state.peerActorId, {[m
[31m-            type: 'call_answer',[m
[31m-            payload: {[m
[31m-                callId: state.callId,[m
[31m-                fromActorId: myActorId,[m
[31m-                answer[m
[31m-            }[m
[31m-        });[m
[31m-[m
[31m-        callConnected();[m
[31m-        delete window.__pendingOffer;[m
[31m-[m
[31m-        return true;[m
[31m-    } catch (err) {[m
[31m-        console.error('Failed to accept call:', err);[m
[31m-        callError(err.message);[m
[31m-        closePeerConnection();[m
[31m-        return false;[m
[31m-    }[m
[31m-}[m
[32m+[m[32mexport async function acceptIncomingCall() {[m
[32m+[m[32m    const state = getCallState();[m
[32m+[m[32m    const offer = callSession.pendingOffer;[m
[32m+[m[32m    const callId = callSession.callId || state.callId;[m
[32m+[m[32m    const peerActorId = callSession.peerActorId || state.peerActorId;[m
[32m+[m
[32m+[m[32m    if (!offer || !callId || !peerActorId || state.state !== 'incoming') {[m
[32m+[m[32m        resetCallSession('accept_invalid_state');[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m    if (!acceptCall()) {[m
[32m+[m[32m        resetCallSession('accept_state_transition_failed');[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    setCallSession({ status: 'connecting' });[m
[32m+[m[32m    console.log('[call] accept', { callId });[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        await createPeerConnection();[m
[32m+[m[32m        await getUserMedia();[m
[32m+[m[32m        await addLocalStream();[m
[32m+[m
[32m+[m[32m        await setRemoteDescription(offer);[m
[32m+[m[32m        await flushPendingCandidates();[m
[32m+[m[32m        const answer = await createAnswer();[m
[32m+[m
[32m+[m[32m        await sendEventTo(peerActorId, {[m
[32m+[m[32m            type: 'call_answer',[m
[32m+[m[32m            payload: {[m
[32m+[m[32m                callId,[m
[32m+[m[32m                from: myActorId,[m
[32m+[m[32m                to: peerActorId,[m
[32m+[m[32m                deskId: null,[m
[32m+[m[32m                fromActorId: myActorId,[m
[32m+[m[32m                toActorId: peerActorId,[m
[32m+[m[32m                data: { answer },[m
[32m+[m[32m                answer[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        console.log('[call] send_answer', { callId });[m
[32m+[m[32m        callConnected();[m
[32m+[m[32m        clearCallTimers();[m
[32m+[m[32m        setCallSession({ status: 'connected', pendingOffer: null });[m
[32m+[m
[32m+[m[32m        return true;[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error('[call] accept failed', err);[m
[32m+[m[32m        resetCallSession('accept_failed');[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
 [m
 /**[m
  * Handle call answer[m
  */[m
[31m-export async function handleCallAnswer({ callId, answer }) {[m
[31m-    const state = getCallState();[m
[31m-[m
[31m-    if (state.state !== 'requesting' || state.callId !== callId) {[m
[31m-        return false;[m
[31m-    }[m
[31m-[m
[31m-    try {[m
[31m-        await setRemoteDescription(answer);[m
[31m-        callConnected();[m
[31m-        return true;[m
[31m-    } catch (err) {[m
[31m-        console.error('Failed to handle call answer:', err);[m
[31m-        callError(err.message);[m
[31m-        return false;[m
[31m-    }[m
[31m-}[m
[32m+[m[32mexport async function handleCallAnswer(msg) {[m
[32m+[m[32m    const callId = typeof msg?.callId === 'string' ? msg.callId : null;[m
[32m+[m[32m    const answer = msg?.data?.answer || msg?.answer || null;[m
[32m+[m[32m    if (!callId || !answer) {[m
[32m+[m[32m        warnDropped('call_answer_invalid', '[call] dropped event (missing callId/type)', msg);[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const state = getCallState();[m
[32m+[m[32m    if (state.callId && state.callId !== callId) {[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m    if (callSession.callId && callSession.callId !== callId) {[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    console.log('[call] recv_answer', { callId });[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        const pc = getPeerConnection();[m
[32m+[m[32m        if (!pc) {[m
[32m+[m[32m            resetCallSession('answer_without_peer_connection');[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m[32m        await setRemoteDescription(answer);[m
[32m+[m[32m        await flushPendingCandidates();[m
[32m+[m[32m        callConnected();[m
[32m+[m[32m        clearCallTimers();[m
[32m+[m[32m        setCallSession({ status: 'connected', pendingOffer: null });[m
[32m+[m[32m        return true;[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error('[call] failed to handle answer', err);[m
[32m+[m[32m        resetCallSession('handle_answer_failed');[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
 [m
 /**[m
  * Handle ICE candidate[m
  */[m
[31m-export async function handleIceCandidate({ candidate }) {[m
[31m-    await addIceCandidate(candidate);[m
[31m-}[m
[31m-[m
[31m-/**[m
[31m- * Hang up call[m
[31m- */[m
[31m-export async function hangUp() {[m
[31m-    const state = getCallState();[m
[31m-[m
[31m-    if (state.peerActorId) {[m
[31m-        await sendEventTo(state.peerActorId, {[m
[31m-            type: 'call_hangup',[m
[31m-            payload: {[m
[31m-                callId: state.callId,[m
[31m-                fromActorId: myActorId[m
[31m-            }[m
[31m-        });[m
[31m-    }[m
[31m-[m
[31m-    closePeerConnection();[m
[31m-    endCall();[m
[31m-}[m
[32m+[m[32mexport async function handleIceCandidate(msg) {[m
[32m+[m[32m    const callId = typeof msg?.callId === 'string' ? msg.callId : null;[m
[32m+[m[32m    const candidate = msg?.data?.candidate || msg?.candidate || null;[m
[32m+[m[32m    if (!callId || !candidate) {[m
[32m+[m[32m        warnDropped('call_ice_invalid', '[call] dropped event (missing callId/type)', msg);[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const state = getCallState();[m
[32m+[m[32m    if (state?.callId && state.callId !== callId) return false;[m
[32m+[m[32m    if (callSession.callId && callSession.callId !== callId) return false;[m
[32m+[m
[32m+[m[32m    const pc = getPeerConnection();[m
[32m+[m[32m    if (!pc || !pc.remoteDescription) {[m
[32m+[m[32m        callSession.pendingCandidates.push(candidate);[m
[32m+[m[32m        return true;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        await addIceCandidate({ candidate });[m
[32m+[m[32m        return true;[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[signaling] handleIceCandidate failed', err, candidate);[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/**[m
[32m+[m[32m * Hang up call[m
[32m+[m[32m */[m
[32m+[m[32mexport async function hangUp(reason = 'hangup') {[m
[32m+[m[32m    const state = getCallState();[m
[32m+[m[32m    const peerActorId = callSession.peerActorId || state.peerActorId;[m
[32m+[m[32m    const callId = callSession.callId || state.callId;[m
[32m+[m
[32m+[m[32m    console.log('[call] hangup', { callId, reason });[m
[32m+[m
[32m+[m[32m    if (peerActorId && callId) {[m
[32m+[m[32m        await sendEventTo(peerActorId, {[m
[32m+[m[32m            type: 'call_hangup',[m
[32m+[m[32m            payload: {[m
[32m+[m[32m                callId,[m
[32m+[m[32m                from: myActorId,[m
[32m+[m[32m                to: peerActorId,[m
[32m+[m[32m                deskId: null,[m
[32m+[m[32m                fromActorId: myActorId,[m
[32m+[m[32m                toActorId: peerActorId,[m
[32m+[m[32m                reason,[m
[32m+[m[32m                data: { reason }[m
[32m+[m[32m            }[m
[32m+[m[32m        }).catch((err) => {[m
[32m+[m[32m            console.warn('[call] failed to send hangup', err);[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    resetCallSession(reason);[m
[32m+[m[32m    return true;[m
[32m+[m[32m}[m
 [m
 /**[m
  * Handle hangup from peer[m
  */[m
[31m-export function handleHangup() {[m
[31m-    closePeerConnection();[m
[31m-    endCall();[m
[31m-}[m
[32m+[m[32mexport function handleHangup(msg) {[m
[32m+[m[32m    const callId = typeof msg?.callId === 'string' ? msg.callId : null;[m
[32m+[m[32m    if (!callId) {[m
[32m+[m[32m        warnDropped('call_hangup_invalid', '[call] dropped event (missing callId/type)', msg);[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m    if (callSession.callId && callSession.callId !== callId) return false;[m
[32m+[m
[32m+[m[32m    const reason = msg?.reason || msg?.data?.reason || 'remote_hangup';[m
[32m+[m[32m    console.log('[call] hangup', { callId, reason });[m
[32m+[m[32m    resetCallSession(reason);[m
[32m+[m[32m    return true;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction handleCallBusy(msg) {[m
[32m+[m[32m    const callId = typeof msg?.callId === 'string' ? msg.callId : null;[m
[32m+[m[32m    if (!callId) {[m
[32m+[m[32m        warnDropped('call_busy_invalid', '[call] dropped event (missing callId/type)', msg);[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m    if (callSession.callId && callSession.callId !== callId) return false;[m
[32m+[m
[32m+[m[32m    resetCallSession('busy');[m
[32m+[m[32m    return true;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport function handlePeerConnectionStateChange(connectionState) {[m
[32m+[m[32m    if (!connectionState) return;[m
[32m+[m[32m    if (connectionState === 'connected') {[m
[32m+[m[32m        clearCallTimers();[m
[32m+[m[32m        if (callSession.status !== 'connected') {[m
[32m+[m[32m            setCallSession({ status: 'connected' });[m
[32m+[m[32m            callConnected();[m
[32m+[m[32m        }[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m[32m    if (connectionState === 'failed' || connectionState === 'disconnected' || connectionState === 'closed') {[m
[32m+[m[32m        resetCallSession(`connection_${connectionState}`);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
 [m
 /**[m
  * Handle call event from realtime[m
  */[m
[31m-export function handleCallEvent(event) {[m
[31m-    const { type, payload } = event;[m
[31m-[m
[31m-    switch (type) {[m
[31m-        case 'call_request':[m
[31m-            return handleCallRequest(payload);[m
[31m-        case 'call_answer':[m
[31m-            return handleCallAnswer(payload);[m
[31m-        case 'call_ice_candidate':[m
[31m-            return handleIceCandidate(payload);[m
[31m-        case 'call_hangup':[m
[31m-            return handleHangup();[m
[31m-        case 'call_busy':[m
[31m-            callError('User is busy');[m
[31m-            closePeerConnection();[m
[31m-            return true;[m
[31m-        default:[m
[31m-            return false;[m
[31m-    }[m
[31m-}[m
[32m+[m[32mexport function handleCallEvent(evt) {[m
[32m+[m[32m    try {[m
[32m+[m[32m        const msg = normalizeCallEvent(evt);[m
[32m+[m[32m        if (!msg) {[m
[32m+[m[32m            warnDropped('invalid_msg', '[call] dropped event (invalid msg)', evt);[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const type = typeof msg.type === 'string' ? msg.type : null;[m
[32m+[m[32m        const callId = typeof msg.callId === 'string' ? msg.callId : null;[m
[32m+[m[32m        if (!type || !callId) {[m
[32m+[m[32m            warnDropped('missing_type_or_callid', '[call] dropped event (missing callId/type)', msg);[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        switch (type) {[m
[32m+[m[32m            case 'call_request': {[m
[32m+[m[32m                return handleCallRequest(msg);[m
[32m+[m[32m            }[m
[32m+[m[32m            case 'call_answer':[m
[32m+[m[32m                return handleCallAnswer(msg).catch((err) => {[m
[32m+[m[32m                    console.warn('[signaling] handleCallAnswer failed', err);[m
[32m+[m[32m                    return false;[m
[32m+[m[32m                });[m
[32m+[m[32m            case 'call_ice_candidate':[m
[32m+[m[32m                return handleIceCandidate(msg).catch((err) => {[m
[32m+[m[32m                    console.warn('[signaling] handleIceCandidate failed', err);[m
[32m+[m[32m                    return false;[m
[32m+[m[32m                });[m
[32m+[m[32m            case 'call_hangup':[m
[32m+[m[32m                return handleHangup(msg);[m
[32m+[m[32m            case 'call_busy':[m
[32m+[m[32m                return handleCallBusy(msg);[m
[32m+[m[32m            default:[m
[32m+[m[32m                console.warn('[call] unknown event type', type, msg);[m
[32m+[m[32m                return false;[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error('[call] handleCallEvent failed', err, evt);[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[1mdiff --git a/src/call/webrtc.js b/src/call/webrtc.js[m
[1mindex 9b827d6..5bd0a47 100644[m
[1m--- a/src/call/webrtc.js[m
[1m+++ b/src/call/webrtc.js[m
[36m@@ -10,11 +10,11 @@[m [mlet onIceCandidate = null;[m
 let onTrack = null;[m
 let onConnectionStateChange = null;[m
 [m
[31m-export function initWebRTC(callbacks) {[m
[31m-    onIceCandidate = callbacks.onIceCandidate;[m
[31m-    onTrack = callbacks.onTrack;[m
[31m-    onConnectionStateChange = callbacks.onConnectionStateChange;[m
[31m-}[m
[32m+[m[32mexport function initWebRTC(callbacks) {[m
[32m+[m[32m    onIceCandidate = callbacks?.onIceCandidate || null;[m
[32m+[m[32m    onTrack = callbacks?.onTrack || null;[m
[32m+[m[32m    onConnectionStateChange = callbacks?.onConnectionStateChange || null;[m
[32m+[m[32m}[m
 [m
 export async function createPeerConnection() {[m
     const config = getConfig();[m
[36m@@ -24,11 +24,21 @@[m [mexport async function createPeerConnection() {[m
 [m
     peerConnection = new RTCPeerConnection({ iceServers });[m
 [m
[31m-    peerConnection.onicecandidate = (event) => {[m
[31m-        if (event.candidate && onIceCandidate) {[m
[31m-            onIceCandidate(event.candidate);[m
[31m-        }[m
[31m-    };[m
[32m+[m[32m    peerConnection.onicecandidate = (event) => {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const candidate = event?.candidate;[m
[32m+[m[32m            if (!candidate) return;[m
[32m+[m[32m            console.log('[ICE] local candidate', candidate);[m
[32m+[m[32m            const result = onIceCandidate?.({ candidate });[m
[32m+[m[32m            if (result && typeof result.catch === 'function') {[m
[32m+[m[32m                result.catch((err) => {[m
[32m+[m[32m                    console.warn('[webrtc] onIceCandidate callback failed', err);[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.warn('[webrtc] onicecandidate handler failed', err);[m
[32m+[m[32m        }[m
[32m+[m[32m    };[m
 [m
     peerConnection.ontrack = (event) => {[m
         remoteStream = event.streams[0];[m
[36m@@ -92,15 +102,26 @@[m [mexport async function setRemoteDescription(description) {[m
     await peerConnection.setRemoteDescription(new RTCSessionDescription(description));[m
 }[m
 [m
[31m-export async function addIceCandidate(candidate) {[m
[31m-    if (!peerConnection) return;[m
[31m-[m
[31m-    try {[m
[31m-        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));[m
[31m-    } catch (err) {[m
[31m-        console.error('Failed to add ICE candidate:', err);[m
[31m-    }[m
[31m-}[m
[32m+[m[32mexport async function addIceCandidate(payload) {[m
[32m+[m[32m    if (!peerConnection) return;[m
[32m+[m[32m    const candidate = payload?.candidate;[m
[32m+[m[32m    if (!candidate) return;[m
[32m+[m
[32m+[m[32m    console.log('[ICE] remote candidate received', candidate);[m
[32m+[m
[32m+[m[32m    const candidateInit = typeof candidate === 'string'[m
[32m+[m[32m        ? { candidate }[m
[32m+[m[32m        : candidate;[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        const iceCandidate = candidate instanceof RTCIceCandidate[m
[32m+[m[32m            ? candidate[m
[32m+[m[32m            : new RTCIceCandidate(candidateInit);[m
[32m+[m[32m        await peerConnection.addIceCandidate(iceCandidate);[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[webrtc] addIceCandidate failed', err, candidateInit);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
 [m
 export function closePeerConnection() {[m
     if (localStream) {[m
[1mdiff --git a/src/chatRealtime.js b/src/chatRealtime.js[m
[1mindex 75bb638..9df69cf 100644[m
[1m--- a/src/chatRealtime.js[m
[1m+++ b/src/chatRealtime.js[m
[36m@@ -52,7 +52,7 @@[m [mexport function initGlobalChatRealtime({ getMyName, onMessage }) {[m
 async function sendChatMessage({ supabase, getMyName, text }) {[m
     if (!channel) return null;[m
 [m
[31m-    const name = (getMyName?.() || 'anonymous').trim() || 'anonymous';[m
[32m+[m[32m    const name = (getMyName?.() || '‰∏çÊòé').trim() || '‰∏çÊòé';[m
     const msg = {[m
         id: crypto.randomUUID(),[m
         name,[m
[1mdiff --git a/src/main.js b/src/main.js[m
[1mindex 106a46b..c8fd7ed 100644[m
[1m--- a/src/main.js[m
[1m+++ b/src/main.js[m
[36m@@ -1,6 +1,6 @@[m
 // main.js - Main application state and logic[m
 [m
[31m-import { loadMaps, getSpawnPoint, getSpotById, setActiveArea, getSpots, getWorldModel, getActiveArea } from './world/mapLoader.js';[m
[32m+[m[32mimport { loadMaps, getSpawnPoint, getSpotById, setActiveArea, getSpots, getWorldModel, getActiveArea, getDeskById } from './world/mapLoader.js';[m
 import {[m
     initRenderer, render, worldToScreen, screenToWorld,[m
     updateCamera, applyZoom, setShowDebugSpots, getCamera,[m
[36m@@ -9,7 +9,7 @@[m [mimport {[m
 import {[m
     initMovement, updateMovement, getCurrentPos,[m
     getFacing, getIsMoving, setMoveTarget,[m
[31m-    stopMoving, setPosition, getTarget, lastPathResult, teleportTo[m
[32m+[m[32m    stopMoving, setPosition, getTarget, lastPathResult, teleportTo, setMovementLocked[m
 } from './world/movement.js';[m
 import { canMoveTo, canMoveToDebug } from './world/collision.js';[m
 import { getSpotAt, getNearbyDesk, getClickableAt, getLocationLabel, getSortedSpotsAt } from './world/spotLogic.js';[m
[36m@@ -18,13 +18,13 @@[m [mimport { initDebugHud, updateDebugHud } from './ui/debugHud.js';[m
 import { updateAnimation } from './avatar/pixelSpriteRenderer.js';[m
 import { renderMinimap } from './ui/minimap.js';[m
 [m
[31m-import { getConfig, getSupabase } from './services/supabaseClient.js';[m
[32m+[m[32mimport { getConfig, getSupabase, setActorIdHeader } from './services/supabaseClient.js';[m
 import { upsertNameplate, isDisplayNameTaken, getNameplateBySessionId } from './services/db.js';[m
 import { initRealtime, joinPresence, updatePresence, subscribeEvents, sendEventTo, shutdownRealtime } from './services/realtime.js';[m
 [m
 import { initMenubar, openDrawer, closeDrawer, updateDisplayName, updateStatus } from './ui/menubar.js';[m
 import { showToast, showPokeToast } from './ui/toast.js';[m
[31m-import { initChatDrawer, setChatDrawerOpen } from './ui/drawer.chat.js';[m
[32m+[m[32mimport { initChatDrawer, setChatDrawerOpen, openDmThread } from './ui/drawer.chat.js';[m
 import { initPeopleDrawer, updatePeople, getPeople } from './ui/drawer.people.js';[m
 import { initSearchDrawer, refreshSearch } from './ui/drawer.search.js';[m
 import { initSettingsDrawer, applyTheme, setDisplayNameInput, setActiveStatus, setActiveTheme } from './ui/drawer.settings.js';[m
[36m@@ -44,17 +44,11 @@[m [mimport { DEFAULT_AMBIENT_PRESET_ID } from './data/ambientPresets.js';[m
 import { nextTimeOfDay, getTimePreset } from './data/timeOfDay.js';[m
 import { initModal, closeModal } from './ui/modal.js';[m
 import { openProfileEditor, openDirectorySearch, openRecentUpdates, openProfileViewer } from './library/libraryActions.js';[m
[32m+[m[32mimport { checkAdminSession } from './admin/adminAuth.js';[m
 [m
[31m-import { initCallStateMachine, getCallState } from './call/callStateMachine.js';[m
[31m-import { initSignaling, startCall, acceptIncomingCall, hangUp, handleCallEvent } from './call/signaling.js';[m
[31m-import { initWebRTC } from './call/webrtc.js';[m
[31m-import {[m
[31m-    initDeskCall,[m
[31m-    joinDeskCall,[m
[31m-    leaveDeskCall,[m
[31m-    toggleDeskMute,[m
[31m-    hangupDeskCall[m
[31m-} from './call/deskCall.js';[m
[32m+[m[32mimport { initCallStateMachine } from './call/callStateMachine.js';[m
[32m+[m[32mimport { initSignaling, startCall, acceptIncomingCall, hangUp, handleCallEvent, handlePeerConnectionStateChange } from './call/signaling.js';[m
[32m+[m[32mimport { initWebRTC, getLocalStream } from './call/webrtc.js';[m
 [m
 import { getSessionId, setSessionId, getSavedPassword, setSavedPassword, clearSavedPassword, getDisplayName, setDisplayName, getThemeId, getTimeMode, setTimeMode } from './utils/storage.js';[m
 import { generateSessionId } from './utils/ids.js';[m
[36m@@ -74,7 +68,8 @@[m [mconst state = {[m
         areaId: 'area:core',[m
         pos: { x: 260, y: 260 },[m
         facing: 'down',[m
[31m-        seatedDeskId: null,[m
[32m+[m[32m        seatedDeskId: null, // Claimed desk id[m
[32m+[m[32m        seatLockedDeskId: null, // Seated (movement locked) desk id[m
         insideSpotId: null,[m
         forcedSeated: false[m
     },[m
[36m@@ -89,10 +84,13 @@[m [mconst state = {[m
         people: new Map()[m
     },[m
     call: {[m
[31m-        state: 'idle',[m
[32m+[m[32m        status: 'idle',[m
         peerActorId: null,[m
[32m+[m[32m        peerDisplayName: null,[m
[32m+[m[32m        deskId: null,[m
         callId: null,[m
[31m-        lastError: null[m
[32m+[m[32m        muted: false,[m
[32m+[m[32m        startedAt: null[m
     },[m
     debug: {[m
         showSpots: false,[m
[36m@@ -105,8 +103,6 @@[m [mlet lastFrameTime = 0;[m
 let lastActivityTime = Date.now();[m
 let animationFrameId = null;[m
 let config = null;[m
[31m-let deskCallState = { status: 'idle' };[m
[31m-let prevPosBeforeSit = null;[m
 let isMapSwitching = false;[m
 [m
 // Debug object for coordinate verification[m
[36m@@ -121,6 +117,8 @@[m [mlet lastOpenedSpotId = null;[m
 let lastOpenedAt = 0;[m
 let nearbySpotId = null;[m
 let interactHintEl = null;[m
[32m+[m[32mlet lastCallUiRefreshAt = 0;[m
[32m+[m[32mconst DEBUG_HUD_STORAGE_KEY = 'vo:debugHudEnabled';[m
 [m
 function setWorldLoading(isLoading) {[m
     const world = getWorldModel();[m
[36m@@ -167,6 +165,67 @@[m [mfunction enforceBgmAreaRule() {[m
     }[m
 }[m
 [m
[32m+[m[32mfunction getSafeDisplayName() {[m
[32m+[m[32m    const name = typeof state.me.displayName === 'string' ? state.me.displayName.trim() : '';[m
[32m+[m[32m    return name || 'anonymous';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction buildPresencePayload(overrides = {}) {[m
[32m+[m[32m    if (!state.me.actorId) return null;[m
[32m+[m
[32m+[m[32m    const payload = {[m
[32m+[m[32m        actorId: state.me.actorId,[m
[32m+[m[32m        displayName: getSafeDisplayName(),[m
[32m+[m[32m        status: state.me.status,[m
[32m+[m[32m        callStatus: state.call.status,[m
[32m+[m[32m        pos: getCurrentPos(),[m
[32m+[m[32m        facing: getFacing(),[m
[32m+[m[32m        avatarColor: state.me.avatar.color || null,[m
[32m+[m[32m        areaId: state.world.areaId || null,[m
[32m+[m[32m        seatedDeskId: state.world.seatedDeskId || null,[m
[32m+[m[32m        seatLockedDeskId: state.world.seatLockedDeskId || null,[m
[32m+[m[32m        location: getLocationLabel([m
[32m+[m[32m            state.world.insideSpotId,[m
[32m+[m[32m            state.world.seatedDeskId,[m
[32m+[m[32m            state.world.areaId,[m
[32m+[m[32m            state.world.seatLockedDeskId[m
[32m+[m[32m        ),[m
[32m+[m[32m        ...overrides[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    payload.displayName = (typeof payload.displayName === 'string' ? payload.displayName.trim() : '') || 'anonymous';[m
[32m+[m[32m    payload.areaId = payload.areaId || null;[m
[32m+[m[32m    payload.seatedDeskId = payload.seatedDeskId || null;[m
[32m+[m[32m    payload.seatLockedDeskId = payload.seatLockedDeskId || null;[m
[32m+[m[32m    payload.claimedByActorId = payload.seatedDeskId ? state.me.actorId : null;[m
[32m+[m[32m    payload.claimedByDisplayName = payload.seatedDeskId ? payload.displayName : null;[m
[32m+[m
[32m+[m[32m    if (!payload.location) {[m
[32m+[m[32m        payload.location = getLocationLabel([m
[32m+[m[32m            state.world.insideSpotId,[m
[32m+[m[32m            payload.seatedDeskId,[m
[32m+[m[32m            payload.areaId,[m
[32m+[m[32m            payload.seatLockedDeskId[m
[32m+[m[32m        );[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return payload;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction loadDebugHudPreference() {[m
[32m+[m[32m    try {[m
[32m+[m[32m        return localStorage.getItem(DEBUG_HUD_STORAGE_KEY) === '1';[m
[32m+[m[32m    } catch {[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction applyDebugHudVisibility() {[m
[32m+[m[32m    const enabled = checkAdminSession() && loadDebugHudPreference();[m
[32m+[m[32m    document.body.classList.toggle('debug-hud-on', enabled);[m
[32m+[m[32m    return enabled;[m
[32m+[m[32m}[m
[32m+[m
 // ========== Initialization ==========[m
 export async function initApp(appConfig, session) {[m
     config = appConfig;[m
[36m@@ -181,6 +240,7 @@[m [mexport async function initApp(appConfig, session) {[m
         setSessionId(sessionId);[m
     }[m
     state.me.actorId = sessionId;[m
[32m+[m[32m    setActorIdHeader(sessionId);[m
 [m
     // Load saved theme[m
     const savedTheme = getThemeId();[m
[36m@@ -229,6 +289,7 @@[m [mexport async function initApp(appConfig, session) {[m
 [m
     // Initialize debug HUD (development only)[m
     initDebugHud();[m
[32m+[m[32m    applyDebugHudVisibility();[m
 [m
     // Set spawn position[m
     const spawn = getSpawnPoint('lobby');[m
[36m@@ -242,14 +303,10 @@[m [mexport async function initApp(appConfig, session) {[m
 [m
         // Update presence[m
         if (state.me.actorId) {[m
[31m-            updatePresence({[m
[31m-                actorId: state.me.actorId,[m
[31m-                displayName: state.me.displayName,[m
[31m-                status: state.me.status,[m
[31m-                pos: pos,[m
[31m-                facing: facing,[m
[31m-                location: getLocationLabel(state.world.insideSpotId, state.world.seatedDeskId, state.world.areaId)[m
[31m-            });[m
[32m+[m[32m            const presencePayload = buildPresencePayload({ pos, facing });[m
[32m+[m[32m            if (presencePayload) {[m
[32m+[m[32m                updatePresence(presencePayload);[m
[32m+[m[32m            }[m
         }[m
 [m
         // Check spot entry/exit[m
[36m@@ -269,21 +326,25 @@[m [mexport async function initApp(appConfig, session) {[m
     });[m
 [m
     initChatDrawer({[m
[31m-        getMyName: () => state.me.displayName || 'anonymous'[m
[32m+[m[32m        getMyName: () => state.me.displayName || '‰∏çÊòé',[m
[32m+[m[32m        getMyActorId: () => state.me.actorId,[m
[32m+[m[32m        getPersonName: (actorId) => getPeople().get(actorId)?.displayName || actorId?.slice?.(0, 6) || '‰∏çÊòé',[m
[32m+[m[32m        getPeople: () => getPeople()[m
     });[m
 [m
     initPeopleDrawer({[m
         warpCallback: (person) => {[m
             warpNearUser(person.pos);[m
             closeDrawer();[m
[31m-            showToast(`Warped near ${person.displayName}`);[m
[32m+[m[32m            showToast(`${person.displayName} „ÅÆËøë„Åè„Å´„ÉØ„Éº„Éó„Åó„Åæ„Åó„Åü`);[m
         },[m
         pokeCallback: (person) => {[m
             sendPoke(person.actorId);[m
[31m-            showToast(`Poked ${person.displayName}`);[m
[32m+[m[32m            showToast(`${person.displayName} „Çí„Å§„Å§„Åç„Åæ„Åó„Åü`);[m
         },[m
[31m-        dmCallback: () => {[m
[32m+[m[32m        dmCallback: (person) => {[m
             openDrawer('chat');[m
[32m+[m[32m            openDmThread(person);[m
         }[m
     });[m
 [m
[36m@@ -291,7 +352,7 @@[m [mexport async function initApp(appConfig, session) {[m
         warpCallback: (person) => {[m
             warpNearUser(person.pos);[m
             closeDrawer();[m
[31m-            showToast(`Warped near ${person.displayName}`);[m
[32m+[m[32m            showToast(`${person.displayName} „ÅÆËøë„Åè„Å´„ÉØ„Éº„Éó„Åó„Åæ„Åó„Åü`);[m
         }[m
     });[m
 [m
[36m@@ -321,10 +382,10 @@[m [mexport async function initApp(appConfig, session) {[m
         statusChangeCallback: (status) => {[m
             state.me.status = status;[m
             updateStatus(status);[m
[31m-            updatePresence({[m
[31m-                actorId: state.me.actorId,[m
[31m-                status: status[m
[31m-            });[m
[32m+[m[32m            const presencePayload = buildPresencePayload({ status });[m
[32m+[m[32m            if (presencePayload) {[m
[32m+[m[32m                updatePresence(presencePayload);[m
[32m+[m[32m            }[m
         },[m
         logoutCallback: async () => {[m
             await shutdownRealtime();[m
[36m@@ -345,9 +406,9 @@[m [mexport async function initApp(appConfig, session) {[m
     const mapDropdown = document.getElementById('map-dropdown');[m
 [m
     const AREA_LABELS = {[m
[31m-        'area:core': 'Office',[m
[31m-        'area:garden': 'Garden',[m
[31m-        'area:library': 'Library'[m
[32m+[m[32m        'area:core': '„Ç™„Éï„Ç£„Çπ',[m
[32m+[m[32m        'area:garden': '„Ç¨„Éº„Éá„É≥',[m
[32m+[m[32m        'area:library': '„É©„Ç§„Éñ„É©„É™'[m
     };[m
 [m
     function setActiveMapItem(areaId) {[m
[36m@@ -392,6 +453,85 @@[m [mexport async function initApp(appConfig, session) {[m
 [m
     setActiveMapItem(state.world.areaId);[m
 [m
[32m+[m[32m    function toggleCallMute() {[m
[32m+[m[32m        const stream = getLocalStream();[m
[32m+[m[32m        if (!stream) return;[m
[32m+[m[32m        stream.getAudioTracks().forEach(track => {[m
[32m+[m[32m            track.enabled = !track.enabled;[m
[32m+[m[32m        });[m
[32m+[m[32m        state.call.muted = !state.call.muted;[m
[32m+[m[32m        refreshDeskPanel();[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function syncDeskPresence() {[m
[32m+[m[32m        const presencePayload = buildPresencePayload();[m
[32m+[m[32m        if (presencePayload) {[m
[32m+[m[32m            updatePresence(presencePayload);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function claimDesk(desk) {[m
[32m+[m[32m        if (!desk?.id) return;[m
[32m+[m[32m        const prevLockedDeskId = state.world.seatLockedDeskId;[m
[32m+[m[32m        if (prevLockedDeskId && prevLockedDeskId !== desk.id) {[m
[32m+[m[32m            leaveSeat(getDeskById(prevLockedDeskId));[m
[32m+[m[32m        }[m
[32m+[m[32m        if (state.world.seatedDeskId && state.world.seatedDeskId !== desk.id) {[m
[32m+[m[32m            state.world.seatLockedDeskId = null;[m
[32m+[m[32m            state.world.forcedSeated = false;[m
[32m+[m[32m            setMovementLocked(false);[m
[32m+[m[32m            stopMoving();[m
[32m+[m[32m        }[m
[32m+[m[32m        state.world.seatedDeskId = desk.id;[m
[32m+[m[32m        syncDeskPresence();[m
[32m+[m[32m        refreshDeskPanel();[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function seatDesk(desk) {[m
[32m+[m[32m        if (!desk?.id) return;[m
[32m+[m[32m        state.world.seatedDeskId = desk.id;[m
[32m+[m[32m        state.world.seatLockedDeskId = desk.id;[m
[32m+[m[32m        state.world.forcedSeated = false;[m
[32m+[m[32m        stopMoving();[m
[32m+[m[32m        setMovementLocked(true);[m
[32m+[m
[32m+[m[32m        const seatPos = desk.posAbs || desk.pos || null;[m
[32m+[m[32m        if (seatPos) {[m
[32m+[m[32m            teleportTo(seatPos.x, seatPos.y);[m
[32m+[m[32m        }[m
[32m+[m[32m        syncDeskPresence();[m
[32m+[m[32m        refreshDeskPanel();[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function leaveSeat(desk) {[m
[32m+[m[32m        const lockedDeskId = state.world.seatLockedDeskId;[m
[32m+[m[32m        if (!lockedDeskId) return;[m
[32m+[m[32m        const targetDesk = desk || getDeskById(lockedDeskId);[m
[32m+[m
[32m+[m[32m        stopMoving();[m
[32m+[m[32m        setMovementLocked(false);[m
[32m+[m[32m        state.world.seatLockedDeskId = null;[m
[32m+[m[32m        state.world.forcedSeated = false;[m
[32m+[m
[32m+[m[32m        const standPos = targetDesk?.standPointAbs || targetDesk?.standPoint || targetDesk?.posAbs || targetDesk?.pos || null;[m
[32m+[m[32m        if (standPos) {[m
[32m+[m[32m            teleportTo(standPos.x, standPos.y);[m
[32m+[m[32m        }[m
[32m+[m[32m        syncDeskPresence();[m
[32m+[m[32m        refreshDeskPanel();[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function unclaimDesk(desk) {[m
[32m+[m[32m        const deskId = desk?.id || state.world.seatedDeskId;[m
[32m+[m[32m        if (!deskId || state.world.seatedDeskId !== deskId) return;[m
[32m+[m[32m        if (state.world.seatLockedDeskId === deskId) {[m
[32m+[m[32m            leaveSeat(desk);[m
[32m+[m[32m        }[m
[32m+[m[32m        state.world.seatedDeskId = null;[m
[32m+[m[32m        syncDeskPresence();[m
[32m+[m[32m        refreshDeskPanel();[m
[32m+[m[32m    }[m
[32m+[m
     initContextPanel({[m
         openZoom: (url) => {[m
             window.open(url, '_blank');[m
[36m@@ -399,85 +539,120 @@[m [mexport async function initApp(appConfig, session) {[m
         openRoomChat: (spotId) => {[m
             openDrawer('chat');[m
         },[m
[31m-        sit: (desk) => {[m
[31m-            if (state.world.seatedDeskId && state.world.seatedDeskId !== desk.id) {[m
[31m-                leaveDeskCall();[m
[31m-            }[m
[31m-            state.world.seatedDeskId = desk.id;[m
[31m-            state.world.forcedSeated = false;[m
[31m-            const p = getCurrentPos();[m
[31m-            prevPosBeforeSit = { x: p.x, y: p.y };[m
[31m-            if (desk.standPoint) {[m
[31m-                teleportTo(desk.standPoint.x, desk.standPoint.y);[m
[31m-            } else if (desk.pos) {[m
[31m-                teleportTo(desk.pos.x, desk.pos.y);[m
[31m-            }[m
[31m-            hideContextPanel();[m
[31m-            refreshDeskPanel();[m
[32m+[m[32m        claimDesk: (desk) => {[m
[32m+[m[32m            claimDesk(desk);[m
         },[m
[31m-        stand: () => {[m
[31m-            state.world.seatedDeskId = null;[m
[31m-            state.world.forcedSeated = false;[m
[31m-            leaveDeskCall();[m
[31m-            stopMoving();[m
[31m-            if (prevPosBeforeSit) {[m
[31m-                teleportTo(prevPosBeforeSit.x, prevPosBeforeSit.y);[m
[31m-                prevPosBeforeSit = null;[m
[31m-            }[m
[31m-            hideContextPanel();[m
[31m-            refreshDeskPanel();[m
[32m+[m[32m        seatDesk: (desk) => {[m
[32m+[m[32m            seatDesk(desk);[m
[32m+[m[32m        },[m
[32m+[m[32m        leaveSeat: (desk) => {[m
[32m+[m[32m            leaveSeat(desk);[m
         },[m
[32m+[m[32m        unclaimDesk: (desk) => {[m
[32m+[m[32m            unclaimDesk(desk);[m
[32m+[m[32m        },[m
[32m+[m
         poke: (person) => {[m
             sendPoke(person.actorId);[m
[31m-            showToast(`Poked ${person.displayName}`);[m
[32m+[m[32m            showToast(`${person.displayName} „Çí„Å§„Å§„Åç„Åæ„Åó„Åü`);[m
         },[m
[31m-        dm: () => {[m
[32m+[m[32m        dm: (person) => {[m
             openDrawer('chat');[m
[32m+[m[32m            openDmThread(person);[m
[32m+[m[32m        },[m
[32m+[m[32m        call: async (person) => {[m
[32m+[m[32m            if (!person?.actorId) return;[m
[32m+[m[32m            unlockAudio();[m
[32m+[m[32m            await startCall(person.actorId);[m
[32m+[m[32m            refreshDeskPanel();[m
[32m+[m[32m        },[m
[32m+[m[32m        callAccept: async () => {[m
[32m+[m[32m            unlockAudio();[m
[32m+[m[32m            await acceptIncomingCall();[m
[32m+[m[32m            refreshDeskPanel();[m
         },[m
[31m-        call: (person) => {[m
[31m-            startCall(person.actorId);[m
[32m+[m[32m        callReject: async () => {[m
[32m+[m[32m            await hangUp('declined');[m
[32m+[m[32m            refreshDeskPanel();[m
         },[m
[31m-        deskCallJoin: (desk) => {[m
[31m-            joinDeskCall(desk.id);[m
[32m+[m[32m        callCancel: async () => {[m
[32m+[m[32m            await hangUp('cancelled');[m
             refreshDeskPanel();[m
         },[m
[31m-        deskCallMute: () => {[m
[31m-            toggleDeskMute();[m
[32m+[m[32m        callMute: () => {[m
[32m+[m[32m            toggleCallMute();[m
             refreshDeskPanel();[m
         },[m
[31m-        deskCallHangup: () => {[m
[31m-            hangupDeskCall();[m
[32m+[m[32m        callEnd: async () => {[m
[32m+[m[32m            await hangUp('hangup');[m
             refreshDeskPanel();[m
         }[m
     });[m
 [m
[32m+[m[32m    // Helper: find who is sitting at a given desk[m
[32m+[m[32m    function findOccupantForDesk(deskId) {[m
[32m+[m[32m        if (!deskId) return null;[m
[32m+[m[32m        const peopleMap = getPeople();[m
[32m+[m[32m        for (const [actorId, person] of peopleMap) {[m
[32m+[m[32m            const personDeskId = person.seatLockedDeskId || person.seatedDeskId;[m
[32m+[m[32m            if (personDeskId === deskId && actorId !== state.me.actorId) {[m
[32m+[m[32m                return person; // Return first occupant that isn't self[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m        return null;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function resolveClaimedByDisplayName(deskId, occupant = null) {[m
[32m+[m[32m        if (!deskId) return null;[m
[32m+[m[32m        if (state.world.seatedDeskId === deskId) {[m
[32m+[m[32m            return getSafeDisplayName();[m
[32m+[m[32m        }[m
[32m+[m[32m        const deskOccupant = occupant || findOccupantForDesk(deskId);[m
[32m+[m[32m        if (!deskOccupant) return null;[m
[32m+[m[32m        return deskOccupant.claimedByDisplayName || deskOccupant.displayName || null;[m
[32m+[m[32m    }[m
[32m+[m
     function buildContextMeta(selection) {[m
         if (selection?.kind !== 'desk') return {};[m
[32m+[m[32m        const claimed = state.world.seatedDeskId === selection.data.id;[m
[32m+[m[32m        const seatLocked = state.world.seatLockedDeskId === selection.data.id;[m
[32m+[m[32m        const occupant = claimed ? null : findOccupantForDesk(selection.data.id);[m
[32m+[m[32m        const claimedByDisplayName = resolveClaimedByDisplayName(selection.data.id, occupant);[m
         return {[m
[31m-            seated: state.world.seatedDeskId === selection.data.id,[m
[31m-            callState: deskCallState,[m
[31m-            forced: state.world.forcedSeated === true && state.world.seatedDeskId === selection.data.id[m
[32m+[m[32m            claimed,[m
[32m+[m[32m            seatLocked,[m
[32m+[m[32m            occupant,[m
[32m+[m[32m            claimedByDisplayName,[m
[32m+[m[32m            callState: state.call,[m
[32m+[m[32m            forced: state.world.forcedSeated === true && seatLocked[m
         };[m
     }[m
 [m
     function refreshDeskPanel() {[m
         const selection = state.ui.selected;[m
         if (selection?.kind !== 'desk') return;[m
[32m+[m[32m        const claimed = state.world.seatedDeskId === selection.data.id;[m
[32m+[m[32m        const seatLocked = state.world.seatLockedDeskId === selection.data.id;[m
[32m+[m[32m        const occupant = claimed ? null : findOccupantForDesk(selection.data.id);[m
[32m+[m[32m        const claimedByDisplayName = resolveClaimedByDisplayName(selection.data.id, occupant);[m
         updateDeskPanel([m
             selection.data,[m
[31m-            state.world.seatedDeskId === selection.data.id,[m
[31m-            null,[m
[31m-            deskCallState,[m
[31m-            state.world.forcedSeated === true[m
[32m+[m[32m            claimed,[m
[32m+[m[32m            seatLocked,[m
[32m+[m[32m            occupant,[m
[32m+[m[32m            state.call,[m
[32m+[m[32m            state.world.forcedSeated === true && seatLocked,[m
[32m+[m[32m            claimedByDisplayName[m
         );[m
     }[m
 [m
     initIncomingCallModal({[m
         acceptCallback: async () => {[m
[32m+[m[32m            unlockAudio();[m
             await acceptIncomingCall();[m
         },[m
[31m-        rejectCallback: () => {[m
[31m-            hangUp();[m
[32m+[m[32m        rejectCallback: async () => {[m
[32m+[m[32m            await hangUp('declined');[m
         }[m
     });[m
 [m
[36m@@ -489,7 +664,13 @@[m [mexport async function initApp(appConfig, session) {[m
     applyAreaBgm(state.world.areaId);[m
     initAmbientModal();[m
     initModal();[m
[31m-    initAdminModal();[m
[32m+[m[32m    initAdminModal({[m
[32m+[m[32m        onDebugHudToggle: (enabled) => {[m
[32m+[m[32m            const safeEnabled = enabled === true && checkAdminSession();[m
[32m+[m[32m            document.body.classList.toggle('debug-hud-on', safeEnabled);[m
[32m+[m[32m        },[m
[32m+[m[32m        getDebugHudEnabled: () => document.body.classList.contains('debug-hud-on')[m
[32m+[m[32m    });[m
 [m
     // Load dynamic content[m
     loadGallery();[m
[36m@@ -504,29 +685,80 @@[m [mexport async function initApp(appConfig, session) {[m
     }[m
 [m
     // Initialize call modules[m
[32m+[m[32m    function toCallUiStatus(machineState) {[m
[32m+[m[32m        switch (machineState) {[m
[32m+[m[32m            case 'requesting':[m
[32m+[m[32m            case 'connecting':[m
[32m+[m[32m                return 'calling';[m
[32m+[m[32m            case 'incoming':[m
[32m+[m[32m                return 'ringing';[m
[32m+[m[32m            case 'in_call':[m
[32m+[m[32m                return 'in_call';[m
[32m+[m[32m            default:[m
[32m+[m[32m                return 'idle';[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
     initCallStateMachine((callState, prevState) => {[m
[31m-        state.call = callState;[m
[32m+[m[32m        const prevUiStatus = state.call.status;[m
[32m+[m[32m        const nextUiStatus = toCallUiStatus(callState?.state);[m
[32m+[m[32m        const isConnectedNow = nextUiStatus === 'in_call';[m
[32m+[m[32m        const wasConnected = prevUiStatus === 'in_call';[m
[32m+[m[32m        const peerActorId = callState?.peerActorId || null;[m
[32m+[m[32m        const peer = peerActorId ? getPeople().get(peerActorId) : null;[m
[32m+[m
[32m+[m[32m        state.call = {[m
[32m+[m[32m            status: nextUiStatus,[m
[32m+[m[32m            peerActorId,[m
[32m+[m[32m            peerDisplayName: peer?.displayName || null,[m
[32m+[m[32m            deskId: null,[m
[32m+[m[32m            callId: callState?.callId || null,[m
[32m+[m[32m            muted: isConnectedNow ? state.call.muted : false,[m
[32m+[m[32m            startedAt: isConnectedNow[m
[32m+[m[32m                ? (wasConnected ? state.call.startedAt : Date.now())[m
[32m+[m[32m                : null[m
[32m+[m[32m        };[m
 [m
[31m-        if (callState.state === 'incoming') {[m
[31m-            const caller = getPeople().get(callState.peerActorId);[m
[31m-            showIncomingCallModal(caller?.displayName || 'Unknown');[m
[31m-        } else if (prevState === 'incoming' && callState.state !== 'incoming') {[m
[32m+[m[32m        if (nextUiStatus === 'ringing') {[m
[32m+[m[32m            const caller = peerActorId ? getPeople().get(peerActorId) : null;[m
[32m+[m[32m            showIncomingCallModal(caller?.displayName || '‰∏çÊòé„Å™Áõ∏Êâã');[m
[32m+[m[32m        } else if (prevUiStatus === 'ringing' && nextUiStatus !== 'ringing') {[m
             hideIncomingCallModal();[m
         }[m
 [m
[31m-        if (callState.state === 'error') {[m
[31m-            showToast(callState.lastError || 'Call failed', 'error');[m
[32m+[m[32m        if (callState?.state === 'error') {[m
[32m+[m[32m            showToast(callState?.lastError || 'ÈÄöË©±„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const presencePayload = buildPresencePayload({ callStatus: state.call.status });[m
[32m+[m[32m        if (presencePayload) {[m
[32m+[m[32m            updatePresence(presencePayload);[m
         }[m
[32m+[m[32m        refreshDeskPanel();[m
     });[m
 [m
     initWebRTC({[m
[31m-        onIceCandidate: (candidate) => {[m
[31m-            if (state.call.peerActorId) {[m
[31m-                sendEventTo(state.call.peerActorId, {[m
[31m-                    type: 'call_ice_candidate',[m
[31m-                    payload: { candidate }[m
[31m-                });[m
[31m-            }[m
[32m+[m[32m        onIceCandidate: (payload) => {[m
[32m+[m[32m            const candidate = payload?.candidate;[m
[32m+[m[32m            if (!candidate) return;[m
[32m+[m[32m            if (!state.call.peerActorId) return;[m
[32m+[m[32m            if (!state.call.callId) return;[m
[32m+[m
[32m+[m[32m            sendEventTo(state.call.peerActorId, {[m
[32m+[m[32m                type: 'call_ice_candidate',[m
[32m+[m[32m                payload: {[m
[32m+[m[32m                    callId: state.call.callId,[m
[32m+[m[32m                    from: state.me.actorId,[m
[32m+[m[32m                    to: state.call.peerActorId,[m
[32m+[m[32m                    deskId: null,[m
[32m+[m[32m                    fromActorId: state.me.actorId,[m
[32m+[m[32m                    toActorId: state.call.peerActorId,[m
[32m+[m[32m                    data: { candidate },[m
[32m+[m[32m                    candidate[m
[32m+[m[32m                }[m
[32m+[m[32m            }).catch((err) => {[m
[32m+[m[32m                console.warn('[main] failed to send ICE candidate', err);[m
[32m+[m[32m            });[m
         },[m
         onTrack: (stream) => {[m
             // Play remote audio[m
[36m@@ -535,20 +767,13 @@[m [mexport async function initApp(appConfig, session) {[m
             audio.play();[m
         },[m
         onConnectionStateChange: (connectionState) => {[m
[32m+[m[32m            handlePeerConnectionStateChange(connectionState);[m
             console.log('WebRTC connection state:', connectionState);[m
         }[m
     });[m
 [m
     initSignaling({ actorId: state.me.actorId });[m
 [m
[31m-    initDeskCall({[m
[31m-        sessionId: state.me.actorId,[m
[31m-        onStateChange: (nextState) => {[m
[31m-            deskCallState = nextState;[m
[31m-            refreshDeskPanel();[m
[31m-        }[m
[31m-    });[m
[31m-[m
     // Initialize realtime[m
     initRealtime({[m
         supabase: getSupabase(),[m
[36m@@ -564,10 +789,19 @@[m [mexport async function initApp(appConfig, session) {[m
                 }[m
             });[m
             updatePeople(presenceState);[m
[32m+[m[32m            if (state.call.peerActorId) {[m
[32m+[m[32m                const peer = getPeople().get(state.call.peerActorId);[m
[32m+[m[32m                state.call.peerDisplayName = peer?.displayName || state.call.peerDisplayName;[m
[32m+[m[32m            }[m
[32m+[m[32m            refreshDeskPanel();[m
             refreshSearch();[m
         },[m
         onEvent: (event) => {[m
[31m-            handleEvent(event);[m
[32m+[m[32m            try {[m
[32m+[m[32m                handleEvent(event);[m
[32m+[m[32m            } catch (err) {[m
[32m+[m[32m                console.error('[realtime] event handler failed', err, event);[m
[32m+[m[32m            }[m
         }[m
     });[m
 [m
[36m@@ -703,7 +937,8 @@[m [mexport async function initApp(appConfig, session) {[m
         }[m
 [m
         console.log('[MOVE] click received', {[m
[31m-            seated: state.world.seatedDeskId != null,[m
[32m+[m[32m            claimedDeskId: state.world.seatedDeskId,[m
[32m+[m[32m            seatLockedDeskId: state.world.seatLockedDeskId,[m
             forcedSeated: state.world.forcedSeated === true,[m
             inputTarget: getTarget(),[m
             isMoving: getIsMoving()[m
[36m@@ -828,12 +1063,10 @@[m [mexport async function initApp(appConfig, session) {[m
             stopMoving();[m
 [m
             // 3) seating/call reset[m
[31m-            if (state.world.seatedDeskId) {[m
[31m-                leaveDeskCall();[m
[31m-            }[m
             state.world.seatedDeskId = null;[m
[32m+[m[32m            state.world.seatLockedDeskId = null;[m
             state.world.forcedSeated = false;[m
[31m-            prevPosBeforeSit = null;[m
[32m+[m[32m            setMovementLocked(false);[m
 [m
             // 4) switch active world[m
             const areaKey = resolveAreaKey(areaId);[m
[36m@@ -858,11 +1091,11 @@[m [mexport async function initApp(appConfig, session) {[m
             // Update Map menu active state[m
             setActiveMapItem(areaId);[m
 [m
[31m-            showToast(`Switched: ${areaId}`, 'success');[m
[32m+[m[32m            showToast(`„Ç®„É™„Ç¢„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åó„Åü: ${AREA_LABELS[areaId] || areaId}`, 'success');[m
             console.log('[Area] switched', { areaId, spawnName, sp, bg });[m
         } catch (e) {[m
             console.error('[Area] switch failed', e);[m
[31m-            showToast('Area switch failed', 'error');[m
[32m+[m[32m            showToast('„Ç®„É™„Ç¢Âàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');[m
         } finally {[m
             setWorldLoading(false);[m
             isMapSwitching = false;[m
[36m@@ -897,18 +1130,26 @@[m [mexport async function initApp(appConfig, session) {[m
             const forced = state.world.forcedSeated;[m
             if (forced) {[m
                 state.world.seatedDeskId = null;[m
[32m+[m[32m                state.world.seatLockedDeskId = null;[m
                 state.world.forcedSeated = false;[m
[31m-                leaveDeskCall();[m
[31m-                showToast('Forced seat cleared', 'info');[m
[32m+[m[32m                setMovementLocked(false);[m
[32m+[m[32m                showToast('Âº∑Âà∂Â∫ßÂ∏≠Âõ∫ÂÆö„ÇíËß£Èô§„Åó„Åæ„Åó„Åü', 'info');[m
             } else {[m
                 const p = getCurrentPos();[m
                 const nearest = getNearbyDesk(p.x, p.y);[m
                 if (nearest) {[m
                     state.world.seatedDeskId = nearest.id;[m
[32m+[m[32m                    state.world.seatLockedDeskId = nearest.id;[m
                     state.world.forcedSeated = true;[m
[31m-                    showToast(`Seated: ${nearest.id} (forced)`, 'info');[m
[32m+[m[32m                    stopMoving();[m
[32m+[m[32m                    setMovementLocked(true);[m
[32m+[m[32m                    const seatPos = nearest.posAbs || nearest.pos;[m
[32m+[m[32m                    if (seatPos) {[m
[32m+[m[32m                        teleportTo(seatPos.x, seatPos.y);[m
[32m+[m[32m                    }[m
[32m+[m[32m                    showToast(`Â∫ßÂ∏≠Âõ∫ÂÆö: ${nearest.id}ÔºàÂº∑Âà∂Ôºâ`, 'info');[m
                 } else {[m
[31m-                    showToast('No nearby desk found', 'error');[m
[32m+[m[32m                    showToast('Ëøë„Åè„Å´„Éá„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');[m
                 }[m
             }[m
             refreshDeskPanel();[m
[36m@@ -987,6 +1228,10 @@[m [mexport async function initApp(appConfig, session) {[m
 [m
         // Throttled presence update[m
         const now = Date.now();[m
[32m+[m[32m        if (state.call.status === 'in_call' && state.ui.selected?.kind === 'desk' && now - lastCallUiRefreshAt >= 1000) {[m
[32m+[m[32m            refreshDeskPanel();[m
[32m+[m[32m            lastCallUiRefreshAt = now;[m
[32m+[m[32m        }[m
         const distMoved = Math.sqrt([m
             Math.pow(pos.x - lastSentPos.x, 2) +[m
             Math.pow(pos.y - lastSentPos.y, 2)[m
[36m@@ -994,14 +1239,13 @@[m [mexport async function initApp(appConfig, session) {[m
 [m
         if (distMoved > PRESENCE_DISTANCE_THRESHOLD || now - lastPresenceSent > PRESENCE_INTERVAL_MS) {[m
             if (distMoved > 0.1) { // Only send if actually moved[m
[31m-                updatePresence({[m
[31m-                    actorId: state.me.actorId,[m
[31m-                    displayName: state.me.displayName,[m
[31m-                    status: state.me.status,[m
[31m-                    pos: pos,[m
[31m-                    facing: getFacing(),[m
[31m-                    location: getLocationLabel(state.world.insideSpotId, state.world.seatedDeskId, state.world.areaId)[m
[32m+[m[32m                const presencePayload = buildPresencePayload({[m
[32m+[m[32m                    pos,[m
[32m+[m[32m                    facing: getFacing()[m
                 });[m
[32m+[m[32m                if (presencePayload) {[m
[32m+[m[32m                    updatePresence(presencePayload);[m
[32m+[m[32m                }[m
                 lastSentPos = { ...pos };[m
                 lastPresenceSent = now;[m
             }[m
[36m@@ -1013,7 +1257,10 @@[m [mexport async function initApp(appConfig, session) {[m
             if (elapsed > config.presence.awayAfterMs && state.me.status === 'online') {[m
                 state.me.status = 'away';[m
                 updateStatus('away');[m
[31m-                updatePresence({ status: 'away' });[m
[32m+[m[32m                const presencePayload = buildPresencePayload({ status: 'away' });[m
[32m+[m[32m                if (presencePayload) {[m
[32m+[m[32m                    updatePresence(presencePayload);[m
[32m+[m[32m                }[m
             }[m
         }[m
 [m
[36m@@ -1034,8 +1281,9 @@[m [mexport async function initApp(appConfig, session) {[m
         // Render[m
         const otherPlayers = Array.from(state.rt.people.values()).map(p => ({[m
             pos: p.pos || { x: 0, y: 0 },[m
[31m-            displayName: p.displayName || 'Unknown',[m
[32m+[m[32m            displayName: p.displayName || '‰∏çÊòé',[m
             status: p.status || 'online',[m
[32m+[m[32m            callStatus: p.callStatus || 'idle',[m
             avatarColor: p.avatarColor,[m
             actorId: p.actorId[m
         }));[m
[36m@@ -1045,12 +1293,13 @@[m [mexport async function initApp(appConfig, session) {[m
                 pos,[m
                 getFacing(),[m
                 otherPlayers,[m
[31m-                state.me,[m
[32m+[m[32m                { ...state.me, callStatus: state.call.status },[m
                 clickMarker,[m
                 clickMarkerTime,[m
                 deltaMs,[m
                 state.world.areaId,[m
[31m-                state.ui.timeMode[m
[32m+[m[32m                state.ui.timeMode,[m
[32m+[m[32m                getPeople()[m
             );[m
         }[m
 [m
[36m@@ -1139,12 +1388,12 @@[m [mfunction updateDrawerUI() {[m
         if (content) content.classList.remove('hidden');[m
 [m
         const titles = {[m
[31m-            chat: 'Chat',[m
[31m-            people: 'People',[m
[31m-            search: 'Search',[m
[31m-            settings: 'Settings'[m
[32m+[m[32m            chat: '„ÉÅ„É£„ÉÉ„Éà',[m
[32m+[m[32m            people: '„É°„É≥„Éê„Éº',[m
[32m+[m[32m            search: 'Ê§úÁ¥¢',[m
[32m+[m[32m            settings: 'Ë®≠ÂÆö'[m
         };[m
[31m-        title.textContent = titles[state.ui.drawer] || 'Drawer';[m
[32m+[m[32m        title.textContent = titles[state.ui.drawer] || '„Éâ„É≠„ÉØ„Éº';[m
     }[m
 [m
     setChatDrawerOpen(state.ui.drawer === 'chat');[m
[36m@@ -1160,11 +1409,28 @@[m [mfunction updateDrawerUI() {[m
 }[m
 [m
 function handleEvent(event) {[m
[31m-    const { type, payload, fromActorId, fromDisplayName } = event;[m
[32m+[m[32m    const type = typeof event?.type === 'string' ? event.type : null;[m
[32m+[m[32m    if (!type) {[m
[32m+[m[32m        console.warn('[event] dropped invalid event', event);[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const payload = event?.payload;[m
[32m+[m[32m    const fromActorId = event?.fromActorId;[m
[32m+[m[32m    const fromDisplayName = event?.fromDisplayName;[m
 [m
     // Handle call events[m
     if (type.startsWith('call_')) {[m
[31m-        handleCallEvent(event);[m
[32m+[m[32m        try {[m
[32m+[m[32m            const result = handleCallEvent(event);[m
[32m+[m[32m            if (result && typeof result.catch === 'function') {[m
[32m+[m[32m                result.catch((err) => {[m
[32m+[m[32m                    console.error('[call] handleCallEvent promise rejected', err, event);[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('[call] handleCallEvent failed', err, event);[m
[32m+[m[32m        }[m
         return;[m
     }[m
 [m
[36m@@ -1205,7 +1471,7 @@[m [mfunction handleSpotAction(action, spot) {[m
             }[m
             const stored = localStorage.getItem('bgm:garden:selected');[m
             const selectedId = stored && stored.length ? stored : DEFAULT_GARDEN_BGM_ID;[m
[31m-            showBgmModal({ tracks: resolveGardenTracksSafe(), selectedId, title: 'Garden BGM' });[m
[32m+[m[32m            showBgmModal({ tracks: resolveGardenTracksSafe(), selectedId, title: '„Ç¨„Éº„Éá„É≥BGM' });[m
             break;[m
         }[m
         case 'openAmbientParticles':[m
[36m@@ -1270,7 +1536,7 @@[m [mfunction handleSpotAction(action, spot) {[m
                 state.ui.timeMode = next;[m
                 setTimeMode(next);[m
                 console.log('[Temizu] cycleTimeMode', { areaId, prev, next });[m
[31m-                showToast(`Time: ${getTimePreset(next).label.toLowerCase()}`, 'success');[m
[32m+[m[32m                showToast(`ÊôÇÈñì: ${getTimePreset(next).label.toLowerCase()}`, 'success');[m
             }[m
             break;[m
         default:[m
[36m@@ -1349,18 +1615,16 @@[m [mexport async function saveNameplate(displayName) {[m
 [m
 export async function startPresence() {[m
     const pos = getCurrentPos();[m
[32m+[m[32m    const initialState = buildPresencePayload({[m
[32m+[m[32m        pos,[m
[32m+[m[32m        facing: getFacing(),[m
[32m+[m[32m        avatarColor: state.me.avatar.color || null[m
[32m+[m[32m    });[m
[32m+[m[32m    if (!initialState) return;[m
 [m
     await joinPresence({[m
         presenceChannelKey: 'presence:office',[m
[31m-        initialState: {[m
[31m-            actorId: state.me.actorId,[m
[31m-            displayName: state.me.displayName,[m
[31m-            status: state.me.status,[m
[31m-            pos: pos,[m
[31m-            facing: getFacing(),[m
[31m-            avatarColor: state.me.avatar.color,[m
[31m-            location: getLocationLabel(state.world.insideSpotId, state.world.seatedDeskId, state.world.areaId)[m
[31m-        }[m
[32m+[m[32m        initialState[m
     });[m
 }[m
 [m
[1mdiff --git a/src/realtime/deskCallRealtime.js b/src/realtime/deskCallRealtime.js[m
[1mindex c5f28d4..906742b 100644[m
[1m--- a/src/realtime/deskCallRealtime.js[m
[1m+++ b/src/realtime/deskCallRealtime.js[m
[36m@@ -5,7 +5,7 @@[m [mimport { getSupabase } from '../services/supabaseClient.js';[m
 let channel = null;[m
 let deskId = null;[m
 [m
[31m-export async function joinDeskCallChannel({ deskId: nextDeskId, sessionId, onEvent, onPresenceSync }) {[m
[32m+[m[32mexport async function joinDeskCallChannel({ deskId: nextDeskId, sessionId, displayName, onEvent, onPresenceSync }) {[m
     const supabase = getSupabase();[m
 [m
     if (channel) {[m
[36m@@ -22,17 +22,38 @@[m [mexport async function joinDeskCallChannel({ deskId: nextDeskId, sessionId, onEve[m
     });[m
 [m
     channel[m
[31m-        .on('broadcast', { event: 'call' }, ({ payload }) => {[m
[31m-            onEvent?.(payload);[m
[32m+[m[32m        .on('broadcast', { event: 'call' }, (event) => {[m
[32m+[m[32m            const payload = event?.payload;[m
[32m+[m[32m            const type = typeof payload?.type === 'string' ? payload.type : null;[m
[32m+[m[32m            if (!type || !type.startsWith('call_')) return;[m
[32m+[m[32m            try {[m
[32m+[m[32m                const result = onEvent?.(payload);[m
[32m+[m[32m                if (result && typeof result.catch === 'function') {[m
[32m+[m[32m                    result.catch((err) => {[m
[32m+[m[32m                        console.error('[deskCallRealtime] onEvent rejected', err, payload);[m
[32m+[m[32m                    });[m
[32m+[m[32m                }[m
[32m+[m[32m            } catch (err) {[m
[32m+[m[32m                console.error('[deskCallRealtime] onEvent failed', err, payload);[m
[32m+[m[32m            }[m
         })[m
         .on('presence', { event: 'sync' }, () => {[m
             const state = channel.presenceState();[m
             onPresenceSync?.(state);[m
         })[m
[32m+[m[32m        .on('presence', { event: 'join' }, () => {[m
[32m+[m[32m            const state = channel.presenceState();[m
[32m+[m[32m            onPresenceSync?.(state);[m
[32m+[m[32m        })[m
[32m+[m[32m        .on('presence', { event: 'leave' }, () => {[m
[32m+[m[32m            const state = channel.presenceState();[m
[32m+[m[32m            onPresenceSync?.(state);[m
[32m+[m[32m        })[m
         .subscribe(async (status) => {[m
             if (status === 'SUBSCRIBED') {[m
                 await channel.track({[m
                     sessionId,[m
[32m+[m[32m                    displayName: displayName || null,[m
                     joinedAt: joinAt,[m
                     ts: Date.now()[m
                 });[m
[1mdiff --git a/src/services/realtime.js b/src/services/realtime.js[m
[1mindex 9aa246a..a59affd 100644[m
[1m--- a/src/services/realtime.js[m
[1m+++ b/src/services/realtime.js[m
[36m@@ -2,9 +2,10 @@[m
 [m
 import { getSupabase } from './supabaseClient.js';[m
 [m
[31m-let presenceChannel = null;[m
[31m-let eventChannels = [];[m
[31m-let chatChannels = [];[m
[32m+[m[32mlet presenceChannel = null;[m
[32m+[m[32mlet eventChannels = [];[m
[32m+[m[32mlet chatChannels = [];[m
[32m+[m[32mlet presenceStateCache = null;[m
 [m
 const callbacks = {[m
     onPresenceChange: null,[m
[36m@@ -24,8 +25,9 @@[m [mexport function initRealtime({ supabase, me, onPresenceChange, onEvent, onChat }[m
 /**[m
  * Join presence channel[m
  */[m
[31m-export async function joinPresence({ presenceChannelKey, initialState }) {[m
[31m-    const supabase = getSupabase();[m
[32m+[m[32mexport async function joinPresence({ presenceChannelKey, initialState }) {[m
[32m+[m[32m    const supabase = getSupabase();[m
[32m+[m[32m    presenceStateCache = { ...(initialState || {}) };[m
 [m
     presenceChannel = supabase.channel(presenceChannelKey, {[m
         config: {[m
[36m@@ -48,11 +50,11 @@[m [mexport async function joinPresence({ presenceChannelKey, initialState }) {[m
         .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {[m
             console.log('Presence leave:', key, leftPresences);[m
         })[m
[31m-        .subscribe(async (status) => {[m
[31m-            if (status === 'SUBSCRIBED') {[m
[31m-                await presenceChannel.track(initialState);[m
[31m-            }[m
[31m-        });[m
[32m+[m[32m        .subscribe(async (status) => {[m
[32m+[m[32m            if (status === 'SUBSCRIBED') {[m
[32m+[m[32m                await presenceChannel.track(presenceStateCache || {});[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
 [m
     return presenceChannel;[m
 }[m
[36m@@ -60,22 +62,29 @@[m [mexport async function joinPresence({ presenceChannelKey, initialState }) {[m
 /**[m
  * Update presence state[m
  */[m
[31m-export async function updatePresence(patch) {[m
[31m-    if (!presenceChannel) return;[m
[31m-[m
[31m-    await presenceChannel.track(patch);[m
[31m-}[m
[32m+[m[32mexport async function updatePresence(patch) {[m
[32m+[m[32m    if (!presenceChannel) return;[m
[32m+[m[32m    if (!patch || typeof patch !== 'object') return;[m
[32m+[m
[32m+[m[32m    presenceStateCache = {[m
[32m+[m[32m        ...(presenceStateCache || {}),[m
[32m+[m[32m        ...patch[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    await presenceChannel.track(presenceStateCache);[m
[32m+[m[32m}[m
 [m
 /**[m
  * Leave presence channel[m
  */[m
[31m-export async function leavePresence() {[m
[31m-    if (!presenceChannel) return;[m
[31m-[m
[31m-    await presenceChannel.untrack();[m
[31m-    await presenceChannel.unsubscribe();[m
[31m-    presenceChannel = null;[m
[31m-}[m
[32m+[m[32mexport async function leavePresence() {[m
[32m+[m[32m    if (!presenceChannel) return;[m
[32m+[m
[32m+[m[32m    await presenceChannel.untrack();[m
[32m+[m[32m    await presenceChannel.unsubscribe();[m
[32m+[m[32m    presenceChannel = null;[m
[32m+[m[32m    presenceStateCache = null;[m
[32m+[m[32m}[m
 [m
 /**[m
  * Subscribe to events for this actor[m
[36m@@ -84,26 +93,34 @@[m [mexport function subscribeEvents({ myActorId }) {[m
     const supabase = getSupabase();[m
 [m
     // Subscribe to direct events[m
[31m-    const directChannel = supabase.channel(`evt:to:${myActorId}`);[m
[31m-    directChannel[m
[31m-        .on('broadcast', { event: 'evt' }, ({ payload }) => {[m
[31m-            if (callbacks.onEvent) {[m
[31m-                callbacks.onEvent(payload);[m
[31m-            }[m
[31m-        })[m
[31m-        .subscribe();[m
[32m+[m[32m    const directChannel = supabase.channel(`evt:to:${myActorId}`);[m
[32m+[m[32m    directChannel[m
[32m+[m[32m        .on('broadcast', { event: 'evt' }, (event) => {[m
[32m+[m[32m            const payload = event?.payload;[m
[32m+[m[32m            if (!callbacks.onEvent || !payload) return;[m
[32m+[m[32m            try {[m
[32m+[m[32m                callbacks.onEvent(payload);[m
[32m+[m[32m            } catch (err) {[m
[32m+[m[32m                console.error('[realtime] onEvent callback failed (direct)', err, payload);[m
[32m+[m[32m            }[m
[32m+[m[32m        })[m
[32m+[m[32m        .subscribe();[m
 [m
     eventChannels.push(directChannel);[m
 [m
     // Subscribe to all events[m
[31m-    const allChannel = supabase.channel('evt:all');[m
[31m-    allChannel[m
[31m-        .on('broadcast', { event: 'evt' }, ({ payload }) => {[m
[31m-            if (callbacks.onEvent) {[m
[31m-                callbacks.onEvent(payload);[m
[31m-            }[m
[31m-        })[m
[31m-        .subscribe();[m
[32m+[m[32m    const allChannel = supabase.channel('evt:all');[m
[32m+[m[32m    allChannel[m
[32m+[m[32m        .on('broadcast', { event: 'evt' }, (event) => {[m
[32m+[m[32m            const payload = event?.payload;[m
[32m+[m[32m            if (!callbacks.onEvent || !payload) return;[m
[32m+[m[32m            try {[m
[32m+[m[32m                callbacks.onEvent(payload);[m
[32m+[m[32m            } catch (err) {[m
[32m+[m[32m                console.error('[realtime] onEvent callback failed (all)', err, payload);[m
[32m+[m[32m            }[m
[32m+[m[32m        })[m
[32m+[m[32m        .subscribe();[m
 [m
     eventChannels.push(allChannel);[m
 }[m
[1mdiff --git a/src/services/supabaseClient.js b/src/services/supabaseClient.js[m
[1mindex 55547d5..7f39e06 100644[m
[1m--- a/src/services/supabaseClient.js[m
[1m+++ b/src/services/supabaseClient.js[m
[36m@@ -27,9 +27,31 @@[m [mexport async function initSupabase() {[m
     return supabaseClient;[m
 }[m
 [m
[31m-export function getSupabase() {[m
[31m-    return supabaseClient;[m
[31m-}[m
[32m+[m[32mexport function getSupabase() {[m
[32m+[m[32m    return supabaseClient;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport function setActorIdHeader(actorId) {[m
[32m+[m[32m    if (!supabaseClient) return;[m
[32m+[m[32m    const value = actorId ? String(actorId) : '';[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        if (supabaseClient.rest?.headers) {[m
[32m+[m[32m            supabaseClient.rest.headers['x-actor-id'] = value;[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[supabase] failed to set x-actor-id on rest headers', err);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        if (supabaseClient.realtime) {[m
[32m+[m[32m            const prev = supabaseClient.realtime.headers || {};[m
[32m+[m[32m            supabaseClient.realtime.headers = { ...prev, 'x-actor-id': value };[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[supabase] failed to set x-actor-id on realtime headers', err);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
 [m
 export async function getSession() {[m
     const client = getSupabase();[m
[1mdiff --git a/src/ui/drawer.chat.js b/src/ui/drawer.chat.js[m
[1mindex 4c323d7..9efb1fa 100644[m
[1m--- a/src/ui/drawer.chat.js[m
[1m+++ b/src/ui/drawer.chat.js[m
[36m@@ -2,32 +2,73 @@[m
 [m
 import { formatTime } from '../utils/time.js';[m
 import { validateChatMessage } from '../utils/validate.js';[m
[31m-import { initGlobalChatRealtime } from '../chatRealtime.js';[m
[32m+[m[32mimport {[m
[32m+[m[32m    createDmThreadKey,[m
[32m+[m[32m    fetchDmMessagesByThread,[m
[32m+[m[32m    fetchDmThreadSummariesForActor,[m
[32m+[m[32m    insertDmMessage,[m
[32m+[m[32m    subscribeDmThread,[m
[32m+[m[32m    subscribeDmInbox[m
[32m+[m[32m} from '../services/dmMessages.js';[m
[32m+[m[32mimport {[m
[32m+[m[32m    DEFAULT_GLOBAL_ROOM_ID,[m
[32m+[m[32m    fetchGlobalMessages,[m
[32m+[m[32m    sendGlobalMessage,[m
[32m+[m[32m    subscribeGlobalMessages[m
[32m+[m[32m} from '../services/globalMessages.js';[m
[32m+[m[32mimport { setChatUnreadBadge } from './menubar.js';[m
[32m+[m[32mimport { showToast } from './toast.js';[m
[32m+[m
[32m+[m[32mconst DM_LAST_READ_KEY = 'vo:lastReadDmTsByThread';[m
[32m+[m[32mconst LEGACY_DM_LAST_READ_KEY = 'vo.dm.lastReadAt.v1';[m
[32m+[m[32mconst GLOBAL_LAST_READ_KEY = 'vo:lastReadGlobalTs';[m
[32m+[m[32mconst GLOBAL_ROOM_ID = DEFAULT_GLOBAL_ROOM_ID;[m
[32m+[m
[32m+[m[32mlet allMessages = [];[m
[32m+[m[32mlet allMessageIds = new Set();[m
[32m+[m[32mlet globalUnreadCount = 0;[m
[32m+[m[32mlet dmMessagesByThread = new Map();[m
[32m+[m[32mlet dmMessageIdsByThread = new Map();[m
[32m+[m[32mlet dmUnreadByThread = new Map();[m
[32m+[m[32mlet dmThreadSummaries = [];[m
[32m+[m[32mlet lastReadAtByThread = loadLastReadDmTsByThread();[m
[32m+[m[32mlet lastReadGlobalTs = loadLastReadGlobalTs();[m
 [m
[31m-let messages = [];[m
 let currentTab = 'all';[m
[31m-let chatSession = null;[m
[32m+[m[32mlet currentDmPeer = null;[m
[32m+[m[32mlet currentDmThreadKey = null;[m
[32m+[m
[32m+[m[32mlet stopGlobalSubscription = null;[m
[32m+[m[32mlet stopDmThreadSubscription = null;[m
[32m+[m[32mlet stopDmInboxSubscription = null;[m
[32m+[m
 let getMyNameCb = null;[m
[32m+[m[32mlet getMyActorIdCb = null;[m
[32m+[m[32mlet getPersonNameCb = null;[m
[32m+[m[32mlet getPeopleCb = null;[m
[32m+[m
 let listEl = null;[m
 let inputEl = null;[m
 let sendBtn = null;[m
 let isOpen = false;[m
 [m
[31m-export function initChatDrawer({ getMyName }) {[m
[32m+[m[32mexport function initChatDrawer({ getMyName, getMyActorId, getPersonName, getPeople }) {[m
     getMyNameCb = getMyName;[m
[32m+[m[32m    getMyActorIdCb = getMyActorId;[m
[32m+[m[32m    getPersonNameCb = getPersonName;[m
[32m+[m[32m    getPeopleCb = getPeople;[m
 [m
[31m-    // Tab switching (All„ÅÆ„ÅøÊúâÂäπ)[m
     const tabs = document.querySelectorAll('.chat-tab');[m
     tabs.forEach(tab => {[m
[31m-        if (tab.dataset.chatTab !== 'all') {[m
[32m+[m[32m        if (tab.dataset.chatTab === 'room') {[m
             tab.disabled = true;[m
             tab.classList.add('disabled');[m
             tab.setAttribute('aria-disabled', 'true');[m
[31m-            tab.title = 'Coming soon';[m
[32m+[m[32m            tab.title = 'Ê∫ñÂÇô‰∏≠';[m
         }[m
         tab.addEventListener('click', () => {[m
[31m-            if (tab.dataset.chatTab !== 'all') return;[m
[31m-            switchTab('all');[m
[32m+[m[32m            if (tab.disabled) return;[m
[32m+[m[32m            switchTab(tab.dataset.chatTab || 'all');[m
         });[m
     });[m
 [m
[36m@@ -35,69 +76,416 @@[m [mexport function initChatDrawer({ getMyName }) {[m
     inputEl = document.getElementById('chat-input');[m
     sendBtn = document.getElementById('chat-send');[m
 [m
[31m-    sendBtn?.addEventListener('click', () => sendMessage());[m
[32m+[m[32m    sendBtn?.addEventListener('click', () => {[m
[32m+[m[32m        void sendMessage();[m
[32m+[m[32m    });[m
     inputEl?.addEventListener('keydown', (e) => {[m
         if (e.key === 'Enter' && !e.shiftKey) {[m
             e.preventDefault();[m
[31m-            sendMessage();[m
[32m+[m[32m            void sendMessage();[m
         }[m
     });[m
[32m+[m
[32m+[m[32m    startDmInboxSubscription();[m
[32m+[m[32m    void ensureGlobalMessagesReady();[m
[32m+[m[32m    void loadDmThreadSummaries();[m
[32m+[m
[32m+[m[32m    refreshDmTabLabel();[m
[32m+[m[32m    refreshUnreadIndicators();[m
[32m+[m[32m    updateInputState();[m
 }[m
 [m
 export function setChatDrawerOpen(open) {[m
     isOpen = open;[m
 [m
     if (open) {[m
[31m-        ensureChatSession();[m
[32m+[m[32m        if (currentTab === 'all') {[m
[32m+[m[32m            void ensureGlobalMessagesReady();[m
[32m+[m[32m        }[m
[32m+[m[32m        if (currentTab === 'dm') {[m
[32m+[m[32m            void ensureCurrentDmLoaded();[m
[32m+[m[32m        }[m
         renderMessages();[m
         return;[m
     }[m
 [m
[31m-    if (chatSession) {[m
[31m-        chatSession.destroy();[m
[31m-        chatSession = null;[m
[31m-    }[m
[32m+[m[32m    stopCurrentDmSubscription();[m
 }[m
 [m
[31m-function ensureChatSession() {[m
[31m-    if (chatSession) return;[m
[32m+[m[32mexport function openDmThread(person) {[m
[32m+[m[32m    if (!person?.actorId) return;[m
 [m
[31m-    chatSession = initGlobalChatRealtime({[m
[31m-        getMyName: () => (getMyNameCb?.() || 'anonymous'),[m
[31m-        onMessage: appendMessage[m
[31m-    });[m
[32m+[m[32m    const myActorId = getMyActorId();[m
[32m+[m[32m    if (!myActorId) {[m
[32m+[m[32m        showToast('DM„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    currentDmPeer = {[m
[32m+[m[32m        actorId: person.actorId,[m
[32m+[m[32m        displayName: person.displayName || resolvePersonName(person.actorId)[m
[32m+[m[32m    };[m
[32m+[m[32m    currentDmThreadKey = createDmThreadKey(myActorId, person.actorId);[m
[32m+[m
[32m+[m[32m    switchTab('dm');[m
[32m+[m[32m    void ensureCurrentDmLoaded();[m
 }[m
 [m
 function switchTab(tab) {[m
     currentTab = tab;[m
 [m
[31m-    // Update tab buttons[m
     document.querySelectorAll('.chat-tab').forEach(t => {[m
         t.classList.toggle('active', t.dataset.chatTab === tab);[m
     });[m
 [m
[32m+[m[32m    updateInputState();[m
[32m+[m
[32m+[m[32m    if (tab === 'dm') {[m
[32m+[m[32m        void loadDmThreadSummaries();[m
[32m+[m[32m        void ensureCurrentDmLoaded();[m
[32m+[m[32m    } else if (tab === 'all') {[m
[32m+[m[32m        void ensureGlobalMessagesReady();[m
[32m+[m[32m    } else {[m
[32m+[m[32m        stopCurrentDmSubscription();[m
[32m+[m[32m    }[m
[32m+[m
     renderMessages();[m
 }[m
 [m
[31m-function sendMessage() {[m
[31m-    if (!chatSession) {[m
[31m-        ensureChatSession();[m
[32m+[m[32masync function ensureCurrentDmLoaded() {[m
[32m+[m[32m    if (!currentDmThreadKey) {[m
[32m+[m[32m        stopCurrentDmSubscription();[m
[32m+[m[32m        await loadDmThreadSummaries();[m
[32m+[m[32m        renderMessages();[m
[32m+[m[32m        return;[m
     }[m
 [m
[32m+[m[32m    await loadDmThread(currentDmThreadKey);[m
[32m+[m[32m    subscribeCurrentDmThread(currentDmThreadKey);[m
[32m+[m
[32m+[m[32m    markThreadAsRead(currentDmThreadKey);[m
[32m+[m[32m    clearUnread(currentDmThreadKey);[m
[32m+[m
[32m+[m[32m    if (currentTab === 'dm') {[m
[32m+[m[32m        renderMessages();[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32masync function sendMessage() {[m
     const validation = validateChatMessage(inputEl?.value);[m
     if (!validation.valid) return;[m
 [m
[31m-    chatSession?.send?.(validation.value);[m
[32m+[m[32m    if (currentTab === 'dm') {[m
[32m+[m[32m        await sendDmMessage(validation.value);[m
[32m+[m[32m    } else {[m
[32m+[m[32m        const senderActorId = getMyActorId();[m
[32m+[m[32m        if (!senderActorId) {[m
[32m+[m[32m            showToast('„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        try {[m
[32m+[m[32m            const saved = await sendGlobalMessage({[m
[32m+[m[32m                roomId: GLOBAL_ROOM_ID,[m
[32m+[m[32m                message: validation.value,[m
[32m+[m[32m                senderActorId,[m
[32m+[m[32m                senderDisplayName: getMyNameCb?.() || '‰∏çÊòé',[m
[32m+[m[32m                clientMsgId: crypto.randomUUID()[m
[32m+[m[32m            });[m
[32m+[m[32m            appendGlobalRow(saved);[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('[chat] ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°Â§±Êïó', err);[m
[32m+[m[32m            showToast('ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
     if (inputEl) inputEl.value = '';[m
 }[m
 [m
[31m-function appendMessage(msg) {[m
[31m-    messages.push(msg);[m
[31m-    if (messages.length > 100) {[m
[31m-        messages = messages.slice(-100);[m
[32m+[m[32masync function sendDmMessage(text) {[m
[32m+[m[32m    const senderId = getMyActorId();[m
[32m+[m[32m    const recipientId = currentDmPeer?.actorId;[m
[32m+[m[32m    const threadKey = currentDmThreadKey;[m
[32m+[m
[32m+[m[32m    if (!senderId || !recipientId || !threadKey) {[m
[32m+[m[32m        showToast('DM„ÅÆÈÄÅ‰ø°ÂÖà„ÅåÊú™ÈÅ∏Êäû„Åß„Åô', 'error');[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        const saved = await insertDmMessage({[m
[32m+[m[32m            threadKey,[m
[32m+[m[32m            senderId,[m
[32m+[m[32m            recipientId,[m
[32m+[m[32m            body: text[m
[32m+[m[32m        });[m
[32m+[m[32m        appendDmRow(saved);[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error('[chat] DMÈÄÅ‰ø°Â§±Êïó', err);[m
[32m+[m[32m        showToast('DMÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32masync function ensureGlobalMessagesReady() {[m
[32m+[m[32m    await loadGlobalMessages();[m
[32m+[m[32m    subscribeGlobalStream();[m
[32m+[m
[32m+[m[32m    if (isOpen && currentTab === 'all') {[m
[32m+[m[32m        markGlobalAsRead();[m
[32m+[m[32m        renderMessages();[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32masync function loadGlobalMessages() {[m
[32m+[m[32m    try {[m
[32m+[m[32m        const rows = await fetchGlobalMessages({ roomId: GLOBAL_ROOM_ID, limit: 200 });[m
[32m+[m[32m        const messages = rows.map(toGlobalMessage).filter(msg => !!msg);[m
[32m+[m[32m        allMessages = messages;[m
[32m+[m[32m        allMessageIds = new Set(messages.map(msg => String(msg.id)));[m
[32m+[m[32m        recalcGlobalUnread();[m
[32m+[m[32m        refreshUnreadIndicators();[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error('[chat] ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂèñÂæóÂ§±Êïó', err);[m
[32m+[m[32m        showToast('ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');[m
     }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction subscribeGlobalStream() {[m
[32m+[m[32m    if (stopGlobalSubscription) return;[m
[32m+[m
[32m+[m[32m    stopGlobalSubscription = subscribeGlobalMessages({[m
[32m+[m[32m        roomId: GLOBAL_ROOM_ID,[m
[32m+[m[32m        onInsert: (row) => {[m
[32m+[m[32m            if (!row) return;[m
[32m+[m[32m            appendGlobalRow(row);[m
[32m+[m[32m        },[m
[32m+[m[32m        onDeleteOrUpdate: (row, oldRow) => {[m
[32m+[m[32m            if (row?.deleted) {[m
[32m+[m[32m                removeGlobalMessageById(row.id);[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m[32m            if (!row && oldRow?.id) {[m
[32m+[m[32m                removeGlobalMessageById(oldRow.id);[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m[32m            if (row && oldRow?.id && String(row.id) === String(oldRow.id)) {[m
[32m+[m[32m                removeGlobalMessageById(row.id);[m
[32m+[m[32m                appendGlobalRow(row);[m
[32m+[m[32m            }[m
[32m+[m[32m        },[m
[32m+[m[32m        onError: (err) => {[m
[32m+[m[32m            console.warn('[chat] global realtime error', err);[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction appendGlobalRow(row) {[m
[32m+[m[32m    const msg = toGlobalMessage(row);[m
[32m+[m[32m    if (!msg) return;[m
[32m+[m
[32m+[m[32m    const messageId = String(msg.id);[m
[32m+[m[32m    if (allMessageIds.has(messageId)) return;[m
[32m+[m
[32m+[m[32m    allMessageIds.add(messageId);[m
[32m+[m[32m    allMessages.push(msg);[m
[32m+[m
[32m+[m[32m    if (allMessages.length > 300) {[m
[32m+[m[32m        const overflow = allMessages.length - 300;[m
[32m+[m[32m        const removed = allMessages.splice(0, overflow);[m
[32m+[m[32m        removed.forEach(item => allMessageIds.delete(String(item.id)));[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (isOpen && currentTab === 'all') {[m
[32m+[m[32m        markGlobalAsRead();[m
[32m+[m[32m        if (listEl) {[m
[32m+[m[32m            listEl.appendChild(createMessageElement(msg));[m
[32m+[m[32m            listEl.scrollTop = listEl.scrollHeight;[m
[32m+[m[32m        }[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const mine = msg.senderActorId && msg.senderActorId === getMyActorId();[m
[32m+[m[32m    if (!mine && normalizeTsValue(msg.ts) > lastReadGlobalTs) {[m
[32m+[m[32m        globalUnreadCount += 1;[m
[32m+[m[32m        refreshUnreadIndicators();[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction removeGlobalMessageById(messageId) {[m
[32m+[m[32m    if (!messageId) return;[m
[32m+[m
[32m+[m[32m    const key = String(messageId);[m
[32m+[m[32m    if (!allMessageIds.has(key)) return;[m
[32m+[m
[32m+[m[32m    allMessageIds.delete(key);[m
[32m+[m[32m    allMessages = allMessages.filter(msg => String(msg.id) !== key);[m
[32m+[m
[32m+[m[32m    recalcGlobalUnread();[m
[32m+[m[32m    refreshUnreadIndicators();[m
[32m+[m
[32m+[m[32m    if (isOpen && currentTab === 'all') {[m
[32m+[m[32m        renderMessages();[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction markGlobalAsRead() {[m
[32m+[m[32m    const latestGlobalTs = allMessages.reduce((max, msg) => Math.max(max, normalizeTsValue(msg.ts)), 0);[m
[32m+[m[32m    lastReadGlobalTs = Math.max(lastReadGlobalTs, latestGlobalTs);[m
[32m+[m[32m    persistLastReadGlobalTs(lastReadGlobalTs);[m
[32m+[m[32m    globalUnreadCount = 0;[m
[32m+[m[32m    refreshUnreadIndicators();[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction recalcGlobalUnread() {[m
[32m+[m[32m    const myActorId = getMyActorId();[m
[32m+[m[32m    globalUnreadCount = allMessages.reduce((sum, msg) => {[m
[32m+[m[32m        if (!msg) return sum;[m
[32m+[m[32m        if (myActorId && msg.senderActorId === myActorId) return sum;[m
[32m+[m[32m        return normalizeTsValue(msg.ts) > lastReadGlobalTs ? sum + 1 : sum;[m
[32m+[m[32m    }, 0);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32masync function loadDmThread(threadKey) {[m
[32m+[m[32m    try {[m
[32m+[m[32m        const rows = await fetchDmMessagesByThread(threadKey, 200);[m
[32m+[m[32m        const messages = rows.map(toDmMessage).filter(msg => !!msg);[m
[32m+[m
[32m+[m[32m        dmMessagesByThread.set(threadKey, messages);[m
[32m+[m[32m        dmMessageIdsByThread.set(threadKey, new Set(messages.map(msg => String(msg.id))));[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error('[chat] DMÂ±•Ê≠¥ÂèñÂæóÂ§±Êïó', err, threadKey);[m
[32m+[m[32m        showToast('DMÂ±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32masync function loadDmThreadSummaries() {[m
[32m+[m[32m    const actorId = getMyActorId();[m
[32m+[m[32m    if (!actorId) {[m
[32m+[m[32m        dmThreadSummaries = [];[m
[32m+[m[32m        dmUnreadByThread = new Map();[m
[32m+[m[32m        refreshDmTabLabel();[m
[32m+[m[32m        refreshUnreadIndicators();[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        const rows = await fetchDmThreadSummariesForActor(actorId, 300);[m
[32m+[m[32m        const summaryByThread = new Map();[m
[32m+[m[32m        const nextUnread = new Map();[m
[32m+[m
[32m+[m[32m        for (const row of rows) {[m
[32m+[m[32m            const threadKey = row?.thread_key;[m
[32m+[m[32m            if (!threadKey) continue;[m
[32m+[m
[32m+[m[32m            const senderId = row?.sender_id || null;[m
[32m+[m[32m            const recipientId = row?.recipient_id || null;[m
[32m+[m[32m            const peerActorId = senderId === actorId ? recipientId : senderId;[m
[32m+[m[32m            if (!peerActorId) continue;[m
[32m+[m
[32m+[m[32m            if (!summaryByThread.has(threadKey)) {[m
[32m+[m[32m                summaryByThread.set(threadKey, {[m
[32m+[m[32m                    threadKey,[m
[32m+[m[32m                    peerActorId,[m
[32m+[m[32m                    peerName: resolvePersonName(peerActorId),[m
[32m+[m[32m                    lastMessage: row?.body || '',[m
[32m+[m[32m                    ts: row?.created_at || Date.now()[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            const lastReadTs = Number(lastReadAtByThread[threadKey] || 0);[m
[32m+[m[32m            const rowTs = normalizeTsValue(row?.created_at);[m
[32m+[m[32m            if (senderId !== actorId && rowTs > lastReadTs) {[m
[32m+[m[32m                nextUnread.set(threadKey, (nextUnread.get(threadKey) || 0) + 1);[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        dmThreadSummaries = Array.from(summaryByThread.values());[m
[32m+[m[32m        dmUnreadByThread = nextUnread;[m
[32m+[m[32m        refreshDmTabLabel();[m
[32m+[m[32m        refreshUnreadIndicators();[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[chat] DM„Çπ„É¨„ÉÉ„Éâ‰∏ÄË¶ßÂèñÂæóÂ§±Êïó', err);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction startDmInboxSubscription() {[m
[32m+[m[32m    if (stopDmInboxSubscription) return;[m
[32m+[m
[32m+[m[32m    const actorId = getMyActorId();[m
[32m+[m[32m    if (!actorId) return;[m
[32m+[m
[32m+[m[32m    stopDmInboxSubscription = subscribeDmInbox({[m
[32m+[m[32m        actorId,[m
[32m+[m[32m        onInsert: (row) => {[m
[32m+[m[32m            if (!row) return;[m
[32m+[m[32m            appendDmRow(row);[m
[32m+[m[32m        },[m
[32m+[m[32m        onError: (err) => {[m
[32m+[m[32m            console.warn('[chat] DM inbox realtime error', err);[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction subscribeCurrentDmThread(threadKey) {[m
[32m+[m[32m    stopCurrentDmSubscription();[m
[32m+[m
[32m+[m[32m    stopDmThreadSubscription = subscribeDmThread({[m
[32m+[m[32m        threadKey,[m
[32m+[m[32m        onInsert: (row) => {[m
[32m+[m[32m            if (!row) return;[m
[32m+[m[32m            appendDmRow(row);[m
[32m+[m[32m        },[m
[32m+[m[32m        onError: (err) => {[m
[32m+[m[32m            console.warn('[chat] DM realtime error', err);[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction stopCurrentDmSubscription() {[m
[32m+[m[32m    if (!stopDmThreadSubscription) return;[m
[32m+[m[32m    const stop = stopDmThreadSubscription;[m
[32m+[m[32m    stopDmThreadSubscription = null;[m
[32m+[m
[32m+[m[32m    Promise.resolve(stop()).catch((err) => {[m
[32m+[m[32m        console.warn('[chat] DM subscription cleanup failed', err);[m
[32m+[m[32m    });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction appendDmRow(row) {[m
[32m+[m[32m    const msg = toDmMessage(row);[m
[32m+[m[32m    if (!msg) return;[m
[32m+[m
[32m+[m[32m    const threadKey = msg.threadKey;[m
[32m+[m[32m    if (!threadKey) return;[m
[32m+[m
[32m+[m[32m    const idSet = dmMessageIdsByThread.get(threadKey) || new Set();[m
[32m+[m[32m    const messageId = String(msg.id);[m
[32m+[m[32m    if (idSet.has(messageId)) return;[m
[32m+[m
[32m+[m[32m    const list = dmMessagesByThread.get(threadKey) || [];[m
[32m+[m[32m    list.push(msg);[m
[32m+[m[32m    dmMessagesByThread.set(threadKey, list);[m
[32m+[m
[32m+[m[32m    idSet.add(messageId);[m
[32m+[m[32m    dmMessageIdsByThread.set(threadKey, idSet);[m
[32m+[m
[32m+[m[32m    upsertThreadSummary(msg);[m
[32m+[m
[32m+[m[32m    const myActorId = getMyActorId();[m
[32m+[m[32m    if (!isViewingThread(threadKey) && msg.senderId !== myActorId) {[m
[32m+[m[32m        dmUnreadByThread.set(threadKey, (dmUnreadByThread.get(threadKey) || 0) + 1);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (isViewingThread(threadKey)) {[m
[32m+[m[32m        markThreadAsRead(threadKey, normalizeTsValue(msg.ts));[m
[32m+[m[32m        clearUnread(threadKey);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    refreshDmTabLabel();[m
[32m+[m[32m    refreshUnreadIndicators();[m
[32m+[m
[32m+[m[32m    if (!isOpen || currentTab !== 'dm' || currentDmThreadKey !== threadKey || !listEl) return;[m
 [m
[31m-    if (!isOpen || !listEl) return;[m
     listEl.appendChild(createMessageElement(msg));[m
     listEl.scrollTop = listEl.scrollHeight;[m
 }[m
[36m@@ -106,12 +494,128 @@[m [mfunction renderMessages() {[m
     if (!listEl) return;[m
 [m
     listEl.innerHTML = '';[m
[31m-    messages.forEach(msg => {[m
[32m+[m
[32m+[m[32m    if (currentTab === 'dm') {[m
[32m+[m[32m        renderDmMessages();[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (allMessages.length === 0) {[m
[32m+[m[32m        listEl.appendChild(createInfoElement('ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'));[m
[32m+[m[32m    } else {[m
[32m+[m[32m        allMessages.forEach(msg => {[m
[32m+[m[32m            listEl.appendChild(createMessageElement(msg));[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    listEl.scrollTop = listEl.scrollHeight;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction renderDmMessages() {[m
[32m+[m[32m    if (!listEl) return;[m
[32m+[m
[32m+[m[32m    if (!currentDmThreadKey || !currentDmPeer?.actorId) {[m
[32m+[m[32m        listEl.appendChild(createSectionTitle('ÊúÄËøë„ÅÆDM'));[m
[32m+[m[32m        if (dmThreadSummaries.length === 0) {[m
[32m+[m[32m            listEl.appendChild(createInfoElement('„Åæ„Å†DMÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ'));[m
[32m+[m[32m        } else {[m
[32m+[m[32m            dmThreadSummaries.forEach(summary => {[m
[32m+[m[32m                listEl.appendChild(createThreadElement(summary));[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        listEl.appendChild(createSectionTitle('Áõ∏Êâã„ÇíÈÅ∏ÊäûÔºà„Ç™„É≥„É©„Ç§„É≥Ôºâ'));[m
[32m+[m[32m        const selectablePeople = getSelectableDmPeople();[m
[32m+[m[32m        if (selectablePeople.length === 0) {[m
[32m+[m[32m            listEl.appendChild(createInfoElement('„Ç™„É≥„É©„Ç§„É≥„ÅÆÁõ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ'));[m
[32m+[m[32m        } else {[m
[32m+[m[32m            selectablePeople.forEach(person => {[m
[32m+[m[32m                listEl.appendChild(createDmPeerElement(person));[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const threadMessages = dmMessagesByThread.get(currentDmThreadKey) || [];[m
[32m+[m[32m    if (threadMessages.length === 0) {[m
[32m+[m[32m        listEl.appendChild(createInfoElement(`${currentDmPeer.displayName || 'Áõ∏Êâã'} „Å®„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`));[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    threadMessages.forEach(msg => {[m
         listEl.appendChild(createMessageElement(msg));[m
     });[m
     listEl.scrollTop = listEl.scrollHeight;[m
 }[m
 [m
[32m+[m[32mfunction createInfoElement(text) {[m
[32m+[m[32m    const item = document.createElement('div');[m
[32m+[m[32m    item.className = 'chat-empty';[m
[32m+[m[32m    item.textContent = text;[m
[32m+[m[32m    return item;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction createSectionTitle(text) {[m
[32m+[m[32m    const el = document.createElement('div');[m
[32m+[m[32m    el.className = 'chat-section-title';[m
[32m+[m[32m    el.textContent = text;[m
[32m+[m[32m    return el;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction createThreadElement(summary) {[m
[32m+[m[32m    const btn = document.createElement('button');[m
[32m+[m[32m    btn.className = 'chat-thread-item';[m
[32m+[m[32m    btn.type = 'button';[m
[32m+[m
[32m+[m[32m    const unread = dmUnreadByThread.get(summary.threadKey) || 0;[m
[32m+[m[32m    const preview = (summary.lastMessage || '').slice(0, 40);[m
[32m+[m[32m    btn.innerHTML = `[m
[32m+[m[32m        <div class="chat-thread-header">[m
[32m+[m[32m            <strong>${escapeHtml(summary.peerName || '‰∏çÊòé')}</strong>[m
[32m+[m[32m            <span class="chat-time">${formatTime(summary.ts)}</span>[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="chat-thread-preview">${escapeHtml(preview || '„É°„ÉÉ„Çª„Éº„Ç∏„Å™„Åó')}</div>[m
[32m+[m[32m        ${unread > 0 ? `<div class="chat-thread-unread">Êú™Ë™≠ ${unread}</div>` : ''}[m
[32m+[m[32m    `;[m
[32m+[m
[32m+[m[32m    btn.addEventListener('click', () => {[m
[32m+[m[32m        openDmThread({[m
[32m+[m[32m            actorId: summary.peerActorId,[m
[32m+[m[32m            displayName: summary.peerName[m
[32m+[m[32m        });[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    return btn;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction createDmPeerElement(peer) {[m
[32m+[m[32m    const btn = document.createElement('button');[m
[32m+[m[32m    btn.className = 'chat-thread-item';[m
[32m+[m[32m    btn.type = 'button';[m
[32m+[m
[32m+[m[32m    const statusLabel = peer.status === 'online'[m
[32m+[m[32m        ? '„Ç™„É≥„É©„Ç§„É≥'[m
[32m+[m[32m        : (peer.status === 'away' ? 'Èõ¢Â∏≠' : (peer.status === 'focus' ? 'ÈõÜ‰∏≠' : ''));[m
[32m+[m[32m    const preview = peer.hasHistory ? 'Â±•Ê≠¥„ÅÇ„Çä' : 'Êñ∞Ë¶èDM„ÇíÈñãÂßã';[m
[32m+[m
[32m+[m[32m    btn.innerHTML = `[m
[32m+[m[32m        <div class="chat-thread-header">[m
[32m+[m[32m            <strong>${escapeHtml(peer.displayName || '‰∏çÊòé')}</strong>[m
[32m+[m[32m            <span class="chat-time">${escapeHtml(statusLabel)}</span>[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="chat-thread-preview">${escapeHtml(preview)}</div>[m
[32m+[m[32m    `;[m
[32m+[m
[32m+[m[32m    btn.addEventListener('click', () => {[m
[32m+[m[32m        openDmThread({[m
[32m+[m[32m            actorId: peer.actorId,[m
[32m+[m[32m            displayName: peer.displayName[m
[32m+[m[32m        });[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    return btn;[m
[32m+[m[32m}[m
[32m+[m
 function createMessageElement(msg) {[m
     const item = document.createElement('div');[m
     item.className = 'chat-message';[m
[36m@@ -145,7 +649,245 @@[m [mfunction createMessageElement(msg) {[m
     return item;[m
 }[m
 [m
[32m+[m[32mfunction toGlobalMessage(row) {[m
[32m+[m[32m    if (!row || typeof row !== 'object') return null;[m
[32m+[m
[32m+[m[32m    const text = row.message || row.text || '';[m
[32m+[m[32m    if (!text) return null;[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m        id: row.id || row.message_id || crypto.randomUUID(),[m
[32m+[m[32m        senderActorId: row.sender_actor_id || row.senderActorId || null,[m
[32m+[m[32m        name: row.sender_display_name || row.name || '‰∏çÊòé',[m
[32m+[m[32m        text,[m
[32m+[m[32m        ts: row.created_at || row.ts || Date.now()[m
[32m+[m[32m    };[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction toDmMessage(row) {[m
[32m+[m[32m    if (!row || typeof row !== 'object') return null;[m
[32m+[m
[32m+[m[32m    const threadKey = row.thread_key || row.threadKey || null;[m
[32m+[m[32m    const senderId = row.sender_id || row.senderId || null;[m
[32m+[m[32m    const recipientId = row.recipient_id || row.recipientId || null;[m
[32m+[m[32m    const text = row.body || row.text || '';[m
[32m+[m
[32m+[m[32m    if (!threadKey || !senderId || !recipientId || !text) return null;[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m        id: row.id || row.message_id || crypto.randomUUID(),[m
[32m+[m[32m        threadKey,[m
[32m+[m[32m        senderId,[m
[32m+[m[32m        recipientId,[m
[32m+[m[32m        name: resolvePersonName(senderId),[m
[32m+[m[32m        text,[m
[32m+[m[32m        ts: row.created_at || row.ts || Date.now()[m
[32m+[m[32m    };[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction upsertThreadSummary(msg) {[m
[32m+[m[32m    const myActorId = getMyActorId();[m
[32m+[m[32m    const peerActorId = msg.senderId === myActorId ? msg.recipientId : msg.senderId;[m
[32m+[m[32m    if (!peerActorId) return;[m
[32m+[m
[32m+[m[32m    const next = {[m
[32m+[m[32m        threadKey: msg.threadKey,[m
[32m+[m[32m        peerActorId,[m
[32m+[m[32m        peerName: resolvePersonName(peerActorId),[m
[32m+[m[32m        lastMessage: msg.text || '',[m
[32m+[m[32m        ts: msg.ts || Date.now()[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const remain = dmThreadSummaries.filter(item => item.threadKey !== msg.threadKey);[m
[32m+[m[32m    dmThreadSummaries = [next, ...remain];[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction resolvePersonName(actorId) {[m
[32m+[m[32m    if (!actorId) return '‰∏çÊòé';[m
[32m+[m[32m    return getPersonNameCb?.(actorId) || actorId.slice(0, 6);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction getSelectableDmPeople() {[m
[32m+[m[32m    const myActorId = getMyActorId();[m
[32m+[m[32m    const map = new Map();[m
[32m+[m[32m    const peopleMap = getPeopleCb?.();[m
[32m+[m
[32m+[m[32m    if (peopleMap && peopleMap instanceof Map) {[m
[32m+[m[32m        for (const person of peopleMap.values()) {[m
[32m+[m[32m            if (!person?.actorId || person.actorId === myActorId) continue;[m
[32m+[m[32m            map.set(person.actorId, {[m
[32m+[m[32m                actorId: person.actorId,[m
[32m+[m[32m                displayName: person.displayName || resolvePersonName(person.actorId),[m
[32m+[m[32m                status: person.status || 'online',[m
[32m+[m[32m                hasHistory: dmThreadSummaries.some(s => s.peerActorId === person.actorId)[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    for (const summary of dmThreadSummaries) {[m
[32m+[m[32m        if (!summary?.peerActorId || summary.peerActorId === myActorId) continue;[m
[32m+[m[32m        if (map.has(summary.peerActorId)) {[m
[32m+[m[32m            const existing = map.get(summary.peerActorId);[m
[32m+[m[32m            existing.hasHistory = true;[m
[32m+[m[32m            continue;[m
[32m+[m[32m        }[m
[32m+[m[32m        map.set(summary.peerActorId, {[m
[32m+[m[32m            actorId: summary.peerActorId,[m
[32m+[m[32m            displayName: summary.peerName || resolvePersonName(summary.peerActorId),[m
[32m+[m[32m            status: 'offline',[m
[32m+[m[32m            hasHistory: true[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return Array.from(map.values()).sort(compareDmPeer);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction compareDmPeer(a, b) {[m
[32m+[m[32m    const rank = (status) => {[m
[32m+[m[32m        if (status === 'online') return 0;[m
[32m+[m[32m        if (status === 'focus') return 1;[m
[32m+[m[32m        if (status === 'away') return 2;[m
[32m+[m[32m        return 3;[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const byStatus = rank(a.status) - rank(b.status);[m
[32m+[m[32m    if (byStatus !== 0) return byStatus;[m
[32m+[m
[32m+[m[32m    return String(a.displayName || '').localeCompare(String(b.displayName || ''), 'ja');[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction refreshUnreadIndicators() {[m
[32m+[m[32m    const dmUnreadTotal = Array.from(dmUnreadByThread.values()).reduce((sum, n) => sum + (Number(n) || 0), 0);[m
[32m+[m[32m    const total = globalUnreadCount + dmUnreadTotal;[m
[32m+[m
[32m+[m[32m    setChatUnreadBadge({[m
[32m+[m[32m        hasUnread: total > 0,[m
[32m+[m[32m        count: total[m
[32m+[m[32m    });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction refreshDmTabLabel() {[m
[32m+[m[32m    const tab = document.querySelector('.chat-tab[data-chat-tab="dm"]');[m
[32m+[m[32m    if (!tab) return;[m
[32m+[m
[32m+[m[32m    const totalUnread = Array.from(dmUnreadByThread.values()).reduce((sum, n) => sum + (Number(n) || 0), 0);[m
[32m+[m[32m    tab.textContent = totalUnread > 0 ? `DM (${totalUnread})` : 'DM';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction clearUnread(threadKey) {[m
[32m+[m[32m    if (!threadKey) return;[m
[32m+[m[32m    dmUnreadByThread.delete(threadKey);[m
[32m+[m[32m    refreshDmTabLabel();[m
[32m+[m[32m    refreshUnreadIndicators();[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction markThreadAsRead(threadKey, explicitTs = null) {[m
[32m+[m[32m    if (!threadKey) return;[m
[32m+[m
[32m+[m[32m    let latestTs = Number(explicitTs) || 0;[m
[32m+[m[32m    if (!latestTs) {[m
[32m+[m[32m        const list = dmMessagesByThread.get(threadKey) || [];[m
[32m+[m[32m        latestTs = list.reduce((max, msg) => Math.max(max, normalizeTsValue(msg.ts)), 0);[m
[32m+[m[32m    }[m
[32m+[m[32m    if (!latestTs) {[m
[32m+[m[32m        latestTs = Date.now();[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    lastReadAtByThread[threadKey] = latestTs;[m
[32m+[m[32m    persistLastReadDmTsByThread(lastReadAtByThread);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction updateInputState() {[m
[32m+[m[32m    if (!inputEl || !sendBtn) return;[m
[32m+[m
[32m+[m[32m    if (currentTab === 'dm') {[m
[32m+[m[32m        if (!currentDmPeer?.actorId) {[m
[32m+[m[32m            inputEl.placeholder = 'DMÁõ∏Êâã„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';[m
[32m+[m[32m            inputEl.disabled = true;[m
[32m+[m[32m            sendBtn.disabled = true;[m
[32m+[m[32m        } else {[m
[32m+[m[32m            inputEl.placeholder = `${currentDmPeer.displayName || 'Áõ∏Êâã'} „Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...`;[m
[32m+[m[32m            inputEl.disabled = false;[m
[32m+[m[32m            sendBtn.disabled = false;[m
[32m+[m[32m        }[m
[32m+[m[32m        sendBtn.textContent = 'ÈÄÅ‰ø°';[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    inputEl.placeholder = '„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...';[m
[32m+[m[32m    inputEl.disabled = false;[m
[32m+[m[32m    sendBtn.disabled = false;[m
[32m+[m[32m    sendBtn.textContent = 'ÈÄÅ‰ø°';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction getMyActorId() {[m
[32m+[m[32m    return getMyActorIdCb?.() || null;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction isViewingThread(threadKey) {[m
[32m+[m[32m    return isOpen && currentTab === 'dm' && currentDmThreadKey === threadKey;[m
[32m+[m[32m}[m
[32m+[m
 function getInitials(name) {[m
     if (!name) return '?';[m
     return name.slice(0, 2).toUpperCase();[m
 }[m
[32m+[m
[32m+[m[32mfunction escapeHtml(text) {[m
[32m+[m[32m    const div = document.createElement('div');[m
[32m+[m[32m    div.textContent = String(text ?? '');[m
[32m+[m[32m    return div.innerHTML;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction normalizeTsValue(value) {[m
[32m+[m[32m    if (typeof value === 'number' && Number.isFinite(value)) return value;[m
[32m+[m[32m    const n = Number(value);[m
[32m+[m[32m    if (Number.isFinite(n) && n > 0) return n;[m
[32m+[m[32m    const d = new Date(value || 0);[m
[32m+[m[32m    const t = d.getTime();[m
[32m+[m[32m    return Number.isFinite(t) ? t : 0;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction loadLastReadGlobalTs() {[m
[32m+[m[32m    try {[m
[32m+[m[32m        const raw = localStorage.getItem(GLOBAL_LAST_READ_KEY);[m
[32m+[m[32m        const ts = Number(raw || 0);[m
[32m+[m[32m        return Number.isFinite(ts) ? ts : 0;[m
[32m+[m[32m    } catch {[m
[32m+[m[32m        return 0;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction persistLastReadGlobalTs(ts) {[m
[32m+[m[32m    try {[m
[32m+[m[32m        localStorage.setItem(GLOBAL_LAST_READ_KEY, String(Number(ts) || 0));[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[chat] failed to persist global lastRead', err);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction loadLastReadDmTsByThread() {[m
[32m+[m[32m    const candidates = [DM_LAST_READ_KEY, LEGACY_DM_LAST_READ_KEY];[m
[32m+[m
[32m+[m[32m    for (const key of candidates) {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const raw = localStorage.getItem(key);[m
[32m+[m[32m            if (!raw) continue;[m
[32m+[m[32m            const parsed = JSON.parse(raw);[m
[32m+[m[32m            if (!parsed || typeof parsed !== 'object') continue;[m
[32m+[m[32m            return parsed;[m
[32m+[m[32m        } catch {[m
[32m+[m[32m            // noop[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return {};[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction persistLastReadDmTsByThread(value) {[m
[32m+[m[32m    try {[m
[32m+[m[32m        localStorage.setItem(DM_LAST_READ_KEY, JSON.stringify(value || {}));[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[chat] failed to persist DM lastRead', err);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[1mdiff --git a/src/ui/drawer.people.js b/src/ui/drawer.people.js[m
[1mindex 7f6e2c6..0c206e9 100644[m
[1m--- a/src/ui/drawer.people.js[m
[1m+++ b/src/ui/drawer.people.js[m
[36m@@ -6,109 +6,132 @@[m [mlet onPoke = null;[m
 let onDm = null;[m
 [m
 export function initPeopleDrawer({ warpCallback, pokeCallback, dmCallback }) {[m
[31m-    onWarp = warpCallback;[m
[31m-    onPoke = pokeCallback;[m
[31m-    onDm = dmCallback;[m
[32m+[m[32m  onWarp = warpCallback;[m[41m[m
[32m+[m[32m  onPoke = pokeCallback;[m[41m[m
[32m+[m[32m  onDm = dmCallback;[m[41m[m
 }[m
 [m
 export function updatePeople(presenceState) {[m
[31m-    people = new Map();[m
[32m+[m[32m  people = new Map();[m[41m[m
 [m
[31m-    Object.entries(presenceState).forEach(([key, presences]) => {[m
[31m-        if (presences && presences.length > 0) {[m
[31m-            const p = presences[0];[m
[31m-            people.set(p.actorId, {[m
[31m-                actorId: p.actorId,[m
[31m-                displayName: p.displayName || 'Unknown',[m
[31m-                status: p.status || 'online',[m
[31m-                pos: p.pos || { x: 0, y: 0 },[m
[31m-                avatarColor: p.avatarColor || null,[m
[31m-                location: p.location || ''[m
[31m-            });[m
[31m-        }[m
[31m-    });[m
[32m+[m[32m  Object.entries(presenceState).forEach(([key, presences]) => {[m[41m[m
[32m+[m[32m    if (presences && presences.length > 0) {[m[41m[m
[32m+[m[32m      const p = presences[0];[m
[32m+[m[32m      const displayName = p.displayName || p.claimedByDisplayName || '‰∏çÊòé';[m
[32m+[m[32m      people.set(p.actorId, {[m
[32m+[m[32m        actorId: p.actorId,[m
[32m+[m[32m        displayName,[m
[32m+[m[32m        status: p.status || 'online',[m
[32m+[m[32m        callStatus: p.callStatus || 'idle',[m
[32m+[m[32m        pos: p.pos || { x: 0, y: 0 },[m
[32m+[m[32m        avatarColor: p.avatarColor || null,[m
[32m+[m[32m        location: p.location || '',[m
[32m+[m[32m        seatedDeskId: p.seatedDeskId || null,[m
[32m+[m[32m        seatLockedDeskId: p.seatLockedDeskId || null,[m
[32m+[m[32m        areaId: p.areaId || null,[m
[32m+[m[32m        claimedByActorId: p.claimedByActorId || p.actorId || null,[m
[32m+[m[32m        claimedByDisplayName: p.claimedByDisplayName || displayName[m
[32m+[m[32m      });[m
[32m+[m[32m    }[m
[32m+[m[32m  });[m
 [m
[31m-    renderPeople();[m
[32m+[m[32m  renderPeople();[m[41m[m
 }[m
 [m
 function renderPeople() {[m
[31m-    const container = document.getElementById('people-list');[m
[31m-    if (!container) return;[m
[32m+[m[32m  const container = document.getElementById('people-list');[m[41m[m
[32m+[m[32m  if (!container) return;[m[41m[m
 [m
[31m-    const sorted = Array.from(people.values()).sort((a, b) => {[m
[31m-        // Online first, then by name[m
[31m-        if (a.status === 'online' && b.status !== 'online') return -1;[m
[31m-        if (a.status !== 'online' && b.status === 'online') return 1;[m
[31m-        return a.displayName.localeCompare(b.displayName);[m
[31m-    });[m
[32m+[m[32m  const sorted = Array.from(people.values()).sort((a, b) => {[m[41m[m
[32m+[m[32m    // Online first, then by name[m[41m[m
[32m+[m[32m    if (a.status === 'online' && b.status !== 'online') return -1;[m[41m[m
[32m+[m[32m    if (a.status !== 'online' && b.status === 'online') return 1;[m[41m[m
[32m+[m[32m    return a.displayName.localeCompare(b.displayName);[m[41m[m
[32m+[m[32m  });[m[41m[m
 [m
[31m-    container.innerHTML = sorted.map(p => `[m
[31m-    <div class="person-item" data-actor-id="${p.actorId}">[m
[31m-      <div class="person-avatar" style="background-color: ${p.avatarColor || 'var(--color-avatarDefault)'}">[m
[31m-        ${getInitials(p.displayName)}[m
[31m-        <div class="person-status ${p.status}"></div>[m
[31m-      </div>[m
[31m-      <div class="person-info">[m
[31m-        <div class="person-name">${escapeHtml(p.displayName)}</div>[m
[31m-        <div class="person-location">${escapeHtml(p.location)}</div>[m
[31m-      </div>[m
[31m-      <div class="person-actions">[m
[31m-        <button class="person-action-btn" data-action="warp" title="Warp near">[m
[32m+[m[32m  container.innerHTML = sorted.map(p => {[m
[32m+[m[32m    const locationText = p.seatLockedDeskId[m
[32m+[m[32m      ? `ü™ëüîí „Éá„Çπ„ÇØ ${p.seatLockedDeskId.replace('desk:', '')}`[m
[32m+[m[32m      : p.seatedDeskId[m
[32m+[m[32m      ? `ü™ë Á¢∫‰øù‰∏≠ ${p.seatedDeskId.replace('desk:', '')}`[m
[32m+[m[32m      : (p.location || '');[m
[32m+[m[32m    const callStatusLabel = ([m
[32m+[m[32m      p.callStatus === 'in_call' ? 'üìû ÈÄöË©±‰∏≠' :[m
[32m+[m[32m      p.callStatus === 'calling' ? 'üìû Áô∫‰ø°‰∏≠' :[m
[32m+[m[32m      p.callStatus === 'ringing' ? 'üìû ÁùÄ‰ø°‰∏≠' :[m
[32m+[m[32m      ''[m
[32m+[m[32m    );[m
[32m+[m[32m    return `[m
[32m+[m[32m    <div class="person-item" data-actor-id="${p.actorId}">[m
[32m+[m[32m      <div class="person-avatar" style="background-color: ${p.avatarColor || 'var(--color-avatarDefault)'}">[m
[32m+[m[32m        ${getInitials(p.displayName)}[m
[32m+[m[32m        <div class="person-status ${p.status}"></div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m      <div class="person-info">[m
[32m+[m[32m        <div class="person-name-row">[m
[32m+[m[32m          <div class="person-name">${escapeHtml(p.displayName)}</div>[m
[32m+[m[32m          ${callStatusLabel ? `<div class="person-call-badge">${escapeHtml(callStatusLabel)}</div>` : ''}[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="person-location">${escapeHtml(locationText)}</div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m      <div class="person-actions">[m
[32m+[m[32m        <button class="person-action-btn" data-action="warp" title="Ëøë„Åè„Å´„ÉØ„Éº„Éó">[m
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
             <path d="M3 12h18M12 3v18"/>[m
           </svg>[m
         </button>[m
[31m-        <button class="person-action-btn" data-action="poke" title="Poke">[m
[32m+[m[32m        <button class="person-action-btn" data-action="poke" title="„Å§„Å§„Åè">[m
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
             <path d="M12 12c2.5 0 4.5-2 4.5-4.5S14.5 3 12 3 7.5 5 7.5 7.5 9.5 12 12 12zm0 2c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/>[m
           </svg>[m
         </button>[m
[31m-        <button class="person-action-btn" data-action="dm" title="Direct Message">[m
[32m+[m[32m        <button class="person-action-btn" data-action="dm" title="„ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏">[m
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
             <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>[m
           </svg>[m
         </button>[m
       </div>[m
     </div>[m
[31m-  `).join('');[m
[32m+[m[32m  `;[m[41m[m
[32m+[m[32m  }).join('');[m[41m[m
 [m
[31m-    // Attach event listeners[m
[31m-    container.querySelectorAll('.person-action-btn').forEach(btn => {[m
[31m-        btn.addEventListener('click', (e) => {[m
[31m-            e.stopPropagation();[m
[31m-            const item = btn.closest('.person-item');[m
[31m-            const actorId = item.dataset.actorId;[m
[31m-            const action = btn.dataset.action;[m
[31m-            const person = people.get(actorId);[m
[32m+[m[32m  // Attach event listeners[m[41m[m
[32m+[m[32m  container.querySelectorAll('.person-action-btn').forEach(btn => {[m[41m[m
[32m+[m[32m    btn.addEventListener('click', (e) => {[m[41m[m
[32m+[m[32m      e.stopPropagation();[m[41m[m
[32m+[m[32m      const item = btn.closest('.person-item');[m[41m[m
[32m+[m[32m      const actorId = item.dataset.actorId;[m[41m[m
[32m+[m[32m      const action = btn.dataset.action;[m[41m[m
[32m+[m[32m      const person = people.get(actorId);[m[41m[m
 [m
[31m-            if (!person) return;[m
[32m+[m[32m      if (!person) return;[m[41m[m
 [m
[31m-            if (action === 'warp' && onWarp) {[m
[31m-                onWarp(person);[m
[31m-            } else if (action === 'poke' && onPoke) {[m
[31m-                onPoke(person);[m
[31m-            } else if (action === 'dm' && onDm) {[m
[31m-                onDm(person);[m
[31m-            }[m
[31m-        });[m
[32m+[m[32m      if (action === 'warp' && onWarp) {[m[41m[m
[32m+[m[32m        onWarp(person);[m[41m[m
[32m+[m[32m      } else if (action === 'poke' && onPoke) {[m[41m[m
[32m+[m[32m        onPoke(person);[m[41m[m
[32m+[m[32m      } else if (action === 'dm' && onDm) {[m[41m[m
[32m+[m[32m        onDm(person);[m[41m[m
[32m+[m[32m      }[m[41m[m
     });[m
[32m+[m[32m  });[m[41m[m
 }[m
 [m
 function getInitials(name) {[m
[31m-    if (!name) return '?';[m
[31m-    return name.slice(0, 2).toUpperCase();[m
[32m+[m[32m  if (!name) return '?';[m[41m[m
[32m+[m[32m  return name.slice(0, 2).toUpperCase();[m[41m[m
 }[m
 [m
 function escapeHtml(text) {[m
[31m-    const div = document.createElement('div');[m
[31m-    div.textContent = text;[m
[31m-    return div.innerHTML;[m
[32m+[m[32m  const div = document.createElement('div');[m[41m[m
[32m+[m[32m  div.textContent = text;[m[41m[m
[32m+[m[32m  return div.innerHTML;[m[41m[m
 }[m
 [m
 export function getPeople() {[m
[31m-    return people;[m
[32m+[m[32m  return people;[m[41m[m
 }[m
 [m
 export function getPersonByActorId(actorId) {[m
[31m-    return people.get(actorId);[m
[32m+[m[32m  return people.get(actorId);[m[41m[m
 }[m
[1mdiff --git a/src/ui/drawer.search.js b/src/ui/drawer.search.js[m
[1mindex e381501..ad98adb 100644[m
[1m--- a/src/ui/drawer.search.js[m
[1m+++ b/src/ui/drawer.search.js[m
[36m@@ -36,7 +36,7 @@[m [mfunction renderResults() {[m
     if (!container) return;[m
 [m
     if (searchResults.length === 0) {[m
[31m-        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--color-textMuted);">No results found</div>';[m
[32m+[m[32m        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--color-textMuted);">Ë©≤ÂΩì„Åô„Çã„É°„É≥„Éê„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';[m
         return;[m
     }[m
 [m
[36m@@ -50,7 +50,7 @@[m [mfunction renderResults() {[m
         <div class="person-name">${escapeHtml(p.displayName)}</div>[m
         <div class="person-location">${escapeHtml(p.location)}</div>[m
       </div>[m
[31m-      <button class="btn btn-secondary" data-action="warp">Warp near</button>[m
[32m+[m[32m      <button class="btn btn-secondary" data-action="warp">Ëøë„Åè„Å´„ÉØ„Éº„Éó</button>[m
     </div>[m
   `).join('');[m
 [m
[1mdiff --git a/src/ui/drawer.settings.js b/src/ui/drawer.settings.js[m
[1mindex b1737cb..9c3812e 100644[m
[1m--- a/src/ui/drawer.settings.js[m
[1m+++ b/src/ui/drawer.settings.js[m
[36m@@ -1,6 +1,11 @@[m
 // drawer.settings.js - Settings drawer[m
 [m
 import { setThemeId } from '../utils/storage.js';[m
[32m+[m[32mimport {[m[41m[m
[32m+[m[32m    getSelectedMicId, setSelectedMicId,[m[41m[m
[32m+[m[32m    getSelectedSpeakerId, setSelectedSpeakerId,[m[41m[m
[32m+[m[32m    unlockAndEnumerateDevices, isSpeakerSelectionSupported[m[41m[m
[32m+[m[32m} from '../services/audioDevices.js';[m[41m[m
 [m
 let onNameChange = null;[m
 let onStatusChange = null;[m
[36m@@ -70,6 +75,92 @@[m [mexport function initSettingsDrawer({ nameChangeCallback, statusChangeCallback, l[m
             if (onClearPassword) onClearPassword();[m
         });[m
     }[m
[32m+[m[41m[m
[32m+[m[32m    // Audio device handling[m[41m[m
[32m+[m[32m    initAudioSettings();[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32masync function initAudioSettings() {[m[41m[m
[32m+[m[32m    const micSelect = document.getElementById('audio-mic');[m[41m[m
[32m+[m[32m    const speakerSelect = document.getElementById('audio-speaker');[m[41m[m
[32m+[m[32m    const speakerHint = document.getElementById('audio-speaker-hint');[m[41m[m
[32m+[m[32m    const refreshBtn = document.getElementById('audio-refresh');[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (!micSelect || !speakerSelect) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Check speaker support[m[41m[m
[32m+[m[32m    const speakerSupported = isSpeakerSelectionSupported();[m[41m[m
[32m+[m[32m    if (!speakerSupported) {[m[41m[m
[32m+[m[32m        speakerSelect.disabled = true;[m[41m[m
[32m+[m[32m        if (speakerHint) {[m[41m[m
[32m+[m[32m            speakerHint.textContent = '„Çπ„Éî„Éº„Ç´„ÉºÂàáÊõø„ÅØÊú™ÂØæÂøú„Åß„ÅôÔºàChromeÊé®Â•®Ôºâ';[m[41m[m
[32m+[m[32m        }[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Mic selection change[m[41m[m
[32m+[m[32m    micSelect.addEventListener('change', () => {[m[41m[m
[32m+[m[32m        const deviceId = micSelect.value;[m[41m[m
[32m+[m[32m        setSelectedMicId(deviceId || null);[m[41m[m
[32m+[m[32m        console.log('[Audio] Mic selected:', deviceId || 'default');[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Speaker selection change[m[41m[m
[32m+[m[32m    speakerSelect.addEventListener('change', () => {[m[41m[m
[32m+[m[32m        const deviceId = speakerSelect.value;[m[41m[m
[32m+[m[32m        setSelectedSpeakerId(deviceId || null);[m[41m[m
[32m+[m[32m        console.log('[Audio] Speaker selected:', deviceId || 'default');[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Refresh button[m[41m[m
[32m+[m[32m    if (refreshBtn) {[m[41m[m
[32m+[m[32m        refreshBtn.addEventListener('click', () => {[m[41m[m
[32m+[m[32m            populateAudioDevices();[m[41m[m
[32m+[m[32m        });[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Initial population (delayed to let drawer open first)[m[41m[m
[32m+[m[32m    setTimeout(() => {[m[41m[m
[32m+[m[32m        populateAudioDevices();[m[41m[m
[32m+[m[32m    }, 100);[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32masync function populateAudioDevices() {[m[41m[m
[32m+[m[32m    const micSelect = document.getElementById('audio-mic');[m[41m[m
[32m+[m[32m    const speakerSelect = document.getElementById('audio-speaker');[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (!micSelect || !speakerSelect) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    try {[m[41m[m
[32m+[m[32m        const { inputs, outputs } = await unlockAndEnumerateDevices();[m[41m[m
[32m+[m[32m        const savedMicId = getSelectedMicId();[m[41m[m
[32m+[m[32m        const savedSpeakerId = getSelectedSpeakerId();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        // Populate mic options[m[41m[m
[32m+[m[32m        micSelect.innerHTML = '<option value="">-- „Éá„Éï„Ç©„É´„Éà --</option>';[m[41m[m
[32m+[m[32m        inputs.forEach((device, i) => {[m[41m[m
[32m+[m[32m            const label = device.label || `„Éû„Ç§„ÇØ ${i + 1}`;[m
[32m+[m[32m            const opt = document.createElement('option');[m[41m[m
[32m+[m[32m            opt.value = device.deviceId;[m[41m[m
[32m+[m[32m            opt.textContent = label;[m[41m[m
[32m+[m[32m            opt.selected = device.deviceId === savedMicId;[m[41m[m
[32m+[m[32m            micSelect.appendChild(opt);[m[41m[m
[32m+[m[32m        });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        // Populate speaker options[m[41m[m
[32m+[m[32m        speakerSelect.innerHTML = '<option value="">-- „Éá„Éï„Ç©„É´„Éà --</option>';[m[41m[m
[32m+[m[32m        outputs.forEach((device, i) => {[m[41m[m
[32m+[m[32m            const label = device.label || `„Çπ„Éî„Éº„Ç´„Éº ${i + 1}`;[m
[32m+[m[32m            const opt = document.createElement('option');[m[41m[m
[32m+[m[32m            opt.value = device.deviceId;[m[41m[m
[32m+[m[32m            opt.textContent = label;[m[41m[m
[32m+[m[32m            opt.selected = device.deviceId === savedSpeakerId;[m[41m[m
[32m+[m[32m            speakerSelect.appendChild(opt);[m[41m[m
[32m+[m[32m        });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        console.log('[Audio] Devices populated:', inputs.length, 'inputs,', outputs.length, 'outputs');[m[41m[m
[32m+[m[32m    } catch (err) {[m[41m[m
[32m+[m[32m        console.error('[Audio] Failed to enumerate devices:', err);[m[41m[m
[32m+[m[32m    }[m[41m[m
 }[m
 [m
 export function applyTheme(themeId) {[m
[1mdiff --git a/src/ui/menubar.js b/src/ui/menubar.js[m
[1mindex 10d0928..521390b 100644[m
[1m--- a/src/ui/menubar.js[m
[1m+++ b/src/ui/menubar.js[m
[36m@@ -1,7 +1,8 @@[m
 // menubar.js - Top menu bar handling[m
 [m
[31m-let currentDrawer = 'none';[m
[31m-let onDrawerChange = null;[m
[32m+[m[32mlet currentDrawer = 'none';[m
[32m+[m[32mlet onDrawerChange = null;[m
[32m+[m[32mlet chatUnreadCount = 0;[m
 [m
 export function initMenubar(callback) {[m
     onDrawerChange = callback;[m
[36m@@ -64,6 +65,20 @@[m [mexport function updateStatus(status) {[m
     }[m
 }[m
 [m
[31m-export function getCurrentDrawer() {[m
[31m-    return currentDrawer;[m
[31m-}[m
[32m+[m[32mexport function getCurrentDrawer() {[m
[32m+[m[32m    return currentDrawer;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport function setChatUnreadBadge({ hasUnread = false, count = 0 } = {}) {[m
[32m+[m[32m    const dot = document.getElementById('chat-unread-dot');[m
[32m+[m[32m    const safeCount = Math.max(0, Number(count) || 0);[m
[32m+[m[32m    chatUnreadCount = safeCount;[m
[32m+[m
[32m+[m[32m    if (dot) {[m
[32m+[m[32m        dot.classList.toggle('visible', !!hasUnread || safeCount > 0);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport function getChatUnreadCount() {[m
[32m+[m[32m    return chatUnreadCount;[m
[32m+[m[32m}[m
[1mdiff --git a/src/ui/modal.admin.js b/src/ui/modal.admin.js[m
[1mindex 9629193..5486e20 100644[m
[1m--- a/src/ui/modal.admin.js[m
[1m+++ b/src/ui/modal.admin.js[m
[36m@@ -1,47 +1,69 @@[m
 // modal.admin.js - Admin login and panel modals[m
 [m
[31m-import { checkAdminSession, loginAdmin, logoutAdmin } from '../admin/adminAuth.js';[m
[31m-import {[m
[31m-    getGallery, getNews,[m
[31m-    saveGalleryOverride, saveNewsOverride,[m
[31m-    exportData, importData, clearOverrides[m
[31m-} from '../data/contentLoader.js';[m
[31m-[m
[31m-let adminOverlay = null;[m
[31m-let isVisible = false;[m
[31m-let currentTab = 'gallery';[m
[32m+[m[32mimport { checkAdminSession, loginAdmin, logoutAdmin } from '../admin/adminAuth.js';[m
[32m+[m[32mimport {[m
[32m+[m[32m    getGallery, getNews,[m
[32m+[m[32m    saveGalleryOverride, saveNewsOverride,[m
[32m+[m[32m    exportData, importData, clearOverrides[m
[32m+[m[32m} from '../data/contentLoader.js';[m
[32m+[m[32mimport { adminPurgeDmBefore, adminPurgeDmAll } from '../services/dmMessages.js';[m
[32m+[m[32mimport {[m
[32m+[m[32m    adminDeleteGlobalMessage,[m
[32m+[m[32m    adminPurgeGlobalAll,[m
[32m+[m[32m    adminPurgeGlobalBefore,[m
[32m+[m[32m    fetchGlobalMessagesForAdmin[m
[32m+[m[32m} from '../services/globalMessages.js';[m
[32m+[m
[32m+[m[32mlet adminOverlay = null;[m
[32m+[m[32mlet isVisible = false;[m
[32m+[m[32mlet currentTab = 'gallery';[m
[32m+[m[32mlet onDebugHudToggle = null;[m
[32m+[m[32mlet getDebugHudEnabled = null;[m
[32m+[m
[32m+[m[32mconst DEBUG_HUD_STORAGE_KEY = 'vo:debugHudEnabled';[m
 [m
 /**[m
  * Initialize admin modal[m
  */[m
[31m-export function initAdminModal() {[m
[31m-    adminOverlay = document.createElement('div');[m
[32m+[m[32mexport function initAdminModal(options = {}) {[m
[32m+[m[32m    onDebugHudToggle = typeof options.onDebugHudToggle === 'function' ? options.onDebugHudToggle : null;[m
[32m+[m[32m    getDebugHudEnabled = typeof options.getDebugHudEnabled === 'function' ? options.getDebugHudEnabled : null;[m
[32m+[m
[32m+[m[32m    adminOverlay = document.createElement('div');[m
     adminOverlay.id = 'admin-modal-overlay';[m
     adminOverlay.className = 'admin-modal-overlay';[m
     adminOverlay.innerHTML = `[m
         <div id="admin-modal" class="admin-modal">[m
[31m-            <div id="admin-login-view" class="admin-view">[m
[31m-                <h2>üîê Admin Login</h2>[m
[31m-                <input type="password" id="admin-password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" maxlength="10">[m
[31m-                <div id="admin-login-error" class="admin-error"></div>[m
[31m-                <div class="admin-buttons">[m
[32m+[m[32m            <div id="admin-login-view" class="admin-view">[m
[32m+[m[32m                <h2>üîê ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥</h2>[m
[32m+[m[32m                <input type="password" id="admin-password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" maxlength="10">[m
[32m+[m[32m                <div id="admin-login-error" class="admin-error"></div>[m
[32m+[m[32m                <div class="admin-buttons">[m
                     <button id="admin-login-btn" class="admin-btn primary">„É≠„Ç∞„Ç§„É≥</button>[m
                     <button id="admin-cancel-btn" class="admin-btn">„Ç≠„É£„É≥„Çª„É´</button>[m
                 </div>[m
             </div>[m
[31m-            <div id="admin-panel-view" class="admin-view" style="display:none;">[m
[31m-                <div class="admin-header">[m
[31m-                    <h2>‚öôÔ∏è Admin Panel</h2>[m
[31m-                    <button id="admin-logout-btn" class="admin-btn small">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>[m
[31m-                </div>[m
[31m-                <div class="admin-tabs">[m
[31m-                    <button class="admin-tab active" data-tab="gallery">Gallery</button>[m
[31m-                    <button class="admin-tab" data-tab="news">News</button>[m
[31m-                    <button class="admin-tab" data-tab="export">Export/Import</button>[m
[31m-                </div>[m
[31m-                <div id="admin-tab-content" class="admin-tab-content">[m
[31m-                    <!-- Content loaded dynamically -->[m
[31m-                </div>[m
[32m+[m[32m            <div id="admin-panel-view" class="admin-view" style="display:none;">[m
[32m+[m[32m                <div class="admin-header">[m
[32m+[m[32m                    <h2>‚öôÔ∏è ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´</h2>[m
[32m+[m[32m                    <button id="admin-logout-btn" class="admin-btn small">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div class="admin-tabs">[m
[32m+[m[32m                    <button class="admin-tab active" data-tab="gallery">„ÇÆ„É£„É©„É™„Éº</button>[m
[32m+[m[32m                    <button class="admin-tab" data-tab="news">„ÅäÁü•„Çâ„Åõ</button>[m
[32m+[m[32m                    <button class="admin-tab" data-tab="export">„Ç®„ÇØ„Çπ„Éù„Éº„Éà/„Ç§„É≥„Éù„Éº„Éà</button>[m
[32m+[m[32m                    <button class="admin-tab" data-tab="dm">DMÁÆ°ÁêÜ</button>[m
[32m+[m[32m                    <button class="admin-tab" data-tab="global">ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÁÆ°ÁêÜ</button>[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div class="form-group" id="admin-debug-hud-wrap">[m
[32m+[m[32m                    <label class="form-checkbox" for="admin-debug-hud-toggle">[m
[32m+[m[32m                        <input type="checkbox" id="admin-debug-hud-toggle">[m
[32m+[m[32m                        „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫„ÇíÊúâÂäπ„Å´„Åô„Çã[m
[32m+[m[32m                    </label>[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div id="admin-tab-content" class="admin-tab-content">[m
[32m+[m[32m                    <!-- Content loaded dynamically -->[m
[32m+[m[32m                </div>[m
                 <div class="admin-footer">[m
                     <button id="admin-save-btn" class="admin-btn primary">üíæ ‰øùÂ≠ò</button>[m
                     <button id="admin-close-btn" class="admin-btn">Èñâ„Åò„Çã</button>[m
[36m@@ -54,9 +76,10 @@[m [mexport function initAdminModal() {[m
     // Event listeners[m
     document.getElementById('admin-login-btn').addEventListener('click', handleLogin);[m
     document.getElementById('admin-cancel-btn').addEventListener('click', hideAdminModal);[m
[31m-    document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);[m
[31m-    document.getElementById('admin-save-btn').addEventListener('click', handleSave);[m
[31m-    document.getElementById('admin-close-btn').addEventListener('click', hideAdminModal);[m
[32m+[m[32m    document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);[m
[32m+[m[32m    document.getElementById('admin-save-btn').addEventListener('click', handleSave);[m
[32m+[m[32m    document.getElementById('admin-close-btn').addEventListener('click', hideAdminModal);[m
[32m+[m[32m    document.getElementById('admin-debug-hud-toggle')?.addEventListener('change', handleDebugHudToggleChange);[m
 [m
     // Password enter key[m
     document.getElementById('admin-password').addEventListener('keydown', (e) => {[m
[36m@@ -91,16 +114,18 @@[m [mexport function showAdminModal() {[m
     if (!adminOverlay) return;[m
 [m
     // Check if already logged in[m
[31m-    if (checkAdminSession()) {[m
[31m-        document.getElementById('admin-login-view').style.display = 'none';[m
[31m-        document.getElementById('admin-panel-view').style.display = 'block';[m
[31m-        renderTabContent();[m
[31m-    } else {[m
[31m-        document.getElementById('admin-login-view').style.display = 'block';[m
[31m-        document.getElementById('admin-panel-view').style.display = 'none';[m
[31m-        document.getElementById('admin-password').value = '';[m
[31m-        document.getElementById('admin-login-error').textContent = '';[m
[31m-    }[m
[32m+[m[32m    if (checkAdminSession()) {[m
[32m+[m[32m        document.getElementById('admin-login-view').style.display = 'none';[m
[32m+[m[32m        document.getElementById('admin-panel-view').style.display = 'block';[m
[32m+[m[32m        syncDebugHudToggleUI();[m
[32m+[m[32m        renderTabContent();[m
[32m+[m[32m    } else {[m
[32m+[m[32m        document.getElementById('admin-login-view').style.display = 'block';[m
[32m+[m[32m        document.getElementById('admin-panel-view').style.display = 'none';[m
[32m+[m[32m        document.getElementById('admin-password').value = '';[m
[32m+[m[32m        document.getElementById('admin-login-error').textContent = '';[m
[32m+[m[32m        applyDebugHud(false);[m
[32m+[m[32m    }[m
 [m
     adminOverlay.classList.add('visible');[m
     isVisible = true;[m
[36m@@ -120,23 +145,26 @@[m [mexport function hideAdminModal() {[m
     isVisible = false;[m
 }[m
 [m
[31m-function handleLogin() {[m
[32m+[m[32mfunction handleLogin() {[m
     const password = document.getElementById('admin-password').value;[m
     const result = loginAdmin(password);[m
 [m
[31m-    if (result.success) {[m
[31m-        document.getElementById('admin-login-view').style.display = 'none';[m
[31m-        document.getElementById('admin-panel-view').style.display = 'block';[m
[31m-        renderTabContent();[m
[31m-    } else {[m
[31m-        document.getElementById('admin-login-error').textContent = result.error;[m
[31m-    }[m
[31m-}[m
[31m-[m
[31m-function handleLogout() {[m
[31m-    logoutAdmin();[m
[31m-    hideAdminModal();[m
[31m-}[m
[32m+[m[32m    if (result.success) {[m
[32m+[m[32m        document.getElementById('admin-login-view').style.display = 'none';[m
[32m+[m[32m        document.getElementById('admin-panel-view').style.display = 'block';[m
[32m+[m[32m        syncDebugHudToggleUI();[m
[32m+[m[32m        renderTabContent();[m
[32m+[m[32m    } else {[m
[32m+[m[32m        document.getElementById('admin-login-error').textContent = result.error;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction handleLogout() {[m
[32m+[m[32m    logoutAdmin();[m
[32m+[m[32m    persistDebugHudEnabled(false);[m
[32m+[m[32m    applyDebugHud(false);[m
[32m+[m[32m    hideAdminModal();[m
[32m+[m[32m}[m
 [m
 function handleSave() {[m
     if (currentTab === 'gallery') {[m
[36m@@ -146,17 +174,75 @@[m [mfunction handleSave() {[m
     }[m
 }[m
 [m
[31m-function renderTabContent() {[m
[31m-    const container = document.getElementById('admin-tab-content');[m
[31m-[m
[31m-    if (currentTab === 'gallery') {[m
[31m-        renderGalleryEditor(container);[m
[31m-    } else if (currentTab === 'news') {[m
[31m-        renderNewsEditor(container);[m
[31m-    } else if (currentTab === 'export') {[m
[31m-        renderExportPanel(container);[m
[31m-    }[m
[31m-}[m
[32m+[m[32mfunction renderTabContent() {[m
[32m+[m[32m    const container = document.getElementById('admin-tab-content');[m
[32m+[m[32m    const saveBtn = document.getElementById('admin-save-btn');[m
[32m+[m
[32m+[m[32m    if (currentTab === 'gallery') {[m
[32m+[m[32m        renderGalleryEditor(container);[m
[32m+[m[32m        if (saveBtn) saveBtn.style.display = '';[m
[32m+[m[32m    } else if (currentTab === 'news') {[m
[32m+[m[32m        renderNewsEditor(container);[m
[32m+[m[32m        if (saveBtn) saveBtn.style.display = '';[m
[32m+[m[32m    } else if (currentTab === 'export') {[m
[32m+[m[32m        renderExportPanel(container);[m
[32m+[m[32m        if (saveBtn) saveBtn.style.display = 'none';[m
[32m+[m[32m    } else if (currentTab === 'dm') {[m
[32m+[m[32m        renderDmMaintenancePanel(container);[m
[32m+[m[32m        if (saveBtn) saveBtn.style.display = 'none';[m
[32m+[m[32m    } else if (currentTab === 'global') {[m
[32m+[m[32m        renderGlobalMaintenancePanel(container);[m
[32m+[m[32m        if (saveBtn) saveBtn.style.display = 'none';[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction handleDebugHudToggleChange() {[m
[32m+[m[32m    const checkbox = document.getElementById('admin-debug-hud-toggle');[m
[32m+[m[32m    if (!checkbox) return;[m
[32m+[m
[32m+[m[32m    if (!checkAdminSession()) {[m
[32m+[m[32m        checkbox.checked = false;[m
[32m+[m[32m        persistDebugHudEnabled(false);[m
[32m+[m[32m        applyDebugHud(false);[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const enabled = checkbox.checked === true;[m
[32m+[m[32m    persistDebugHudEnabled(enabled);[m
[32m+[m[32m    applyDebugHud(enabled);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction syncDebugHudToggleUI() {[m
[32m+[m[32m    const checkbox = document.getElementById('admin-debug-hud-toggle');[m
[32m+[m[32m    if (!checkbox) return;[m
[32m+[m
[32m+[m[32m    const admin = checkAdminSession();[m
[32m+[m[32m    const enabled = admin && (getDebugHudEnabled?.() ?? loadDebugHudEnabled());[m
[32m+[m[32m    checkbox.checked = enabled;[m
[32m+[m[32m    checkbox.disabled = !admin;[m
[32m+[m[32m    applyDebugHud(enabled);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction loadDebugHudEnabled() {[m
[32m+[m[32m    try {[m
[32m+[m[32m        return localStorage.getItem(DEBUG_HUD_STORAGE_KEY) === '1';[m
[32m+[m[32m    } catch {[m
[32m+[m[32m        return false;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction persistDebugHudEnabled(enabled) {[m
[32m+[m[32m    try {[m
[32m+[m[32m        localStorage.setItem(DEBUG_HUD_STORAGE_KEY, enabled ? '1' : '0');[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.warn('[admin] failed to persist debug hud preference', err);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction applyDebugHud(enabled) {[m
[32m+[m[32m    const safeEnabled = enabled === true && checkAdminSession();[m
[32m+[m[32m    onDebugHudToggle?.(safeEnabled);[m
[32m+[m[32m}[m
 [m
 // ========== Gallery Editor ==========[m
 function renderGalleryEditor(container) {[m
[36m@@ -267,10 +353,10 @@[m [mfunction showGalleryItemEditor(index) {[m
     document.getElementById('gallery-edit-cancel').addEventListener('click', renderTabContent);[m
 }[m
 [m
[31m-function saveGalleryFromUI() {[m
[31m-    // Already saving on each action, just show confirmation[m
[31m-    alert('Gallery saved!');[m
[31m-}[m
[32m+[m[32mfunction saveGalleryFromUI() {[m
[32m+[m[32m    // Already saving on each action, just show confirmation[m
[32m+[m[32m    alert('„ÇÆ„É£„É©„É™„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');[m
[32m+[m[32m}[m
 [m
 // ========== News Editor ==========[m
 function renderNewsEditor(container) {[m
[36m@@ -383,26 +469,26 @@[m [mfunction showNewsItemEditor(index) {[m
     document.getElementById('news-edit-cancel').addEventListener('click', renderTabContent);[m
 }[m
 [m
[31m-function saveNewsFromUI() {[m
[31m-    alert('News saved!');[m
[31m-}[m
[32m+[m[32mfunction saveNewsFromUI() {[m
[32m+[m[32m    alert('„ÅäÁü•„Çâ„Åõ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');[m
[32m+[m[32m}[m
 [m
 // ========== Export/Import ==========[m
[31m-function renderExportPanel(container) {[m
[32m+[m[32mfunction renderExportPanel(container) {[m
     const exportJson = exportData();[m
 [m
     container.innerHTML = `[m
[31m-        <div class="admin-export">[m
[31m-            <h3>üì§ Export</h3>[m
[31m-            <p>ÁèæÂú®„ÅÆGallery/News„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åæ„Åü„ÅØ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô</p>[m
[31m-            <textarea id="export-text" readonly rows="8">${exportJson}</textarea>[m
[32m+[m[32m        <div class="admin-export">[m
[32m+[m[32m            <h3>üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</h3>[m
[32m+[m[32m            <p>ÁèæÂú®„ÅÆ„ÇÆ„É£„É©„É™„Éº/„ÅäÁü•„Çâ„Åõ„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åæ„Åü„ÅØ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô</p>[m
[32m+[m[32m            <textarea id="export-text" readonly rows="8">${exportJson}</textarea>[m
             <div class="admin-buttons">[m
                 <button id="export-copy-btn" class="admin-btn">üìã „Ç≥„Éî„Éº</button>[m
                 <button id="export-download-btn" class="admin-btn">üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>[m
             </div>[m
             [m
[31m-            <h3>üì• Import</h3>[m
[31m-            <p>JSON„ÇíË≤º„Çä‰ªò„Åë„Å¶„Ç§„É≥„Éù„Éº„Éà</p>[m
[32m+[m[32m            <h3>üì• „Ç§„É≥„Éù„Éº„Éà</h3>[m
[32m+[m[32m            <p>JSON„ÇíË≤º„Çä‰ªò„Åë„Å¶„Ç§„É≥„Éù„Éº„Éà</p>[m
             <textarea id="import-text" rows="5" placeholder='{"gallery": {...}, "news": {...}}'></textarea>[m
             <div id="import-status" class="admin-status"></div>[m
             <div class="admin-buttons">[m
[36m@@ -446,7 +532,235 @@[m [mfunction renderExportPanel(container) {[m
             alert('„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');[m
         }[m
     });[m
[31m-}[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction renderDmMaintenancePanel(container) {[m
[32m+[m[32m    container.innerHTML = `[m
[32m+[m[32m        <div class="admin-export">[m
[32m+[m[32m            <h3>üßπ DM„Éá„Éº„ÇøÂâäÈô§</h3>[m
[32m+[m[32m            <p>ÁÑ°ÊñôÊû†ÁØÄÁ¥Ñ„ÅÆ„Åü„ÇÅ„ÄÅÂè§„ÅÑDM„ÇÑÂÖ®‰ª∂DM„ÇíÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</p>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label class="form-label" for="dm-purge-days">ÂâäÈô§ÂØæË±°ÔºàÊó•Êï∞„Çà„ÇäÂâçÔºâ</label>[m
[32m+[m[32m                <input type="number" id="dm-purge-days" class="form-input" min="1" step="1" value="30">[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="admin-buttons">[m
[32m+[m[32m                <button id="dm-purge-before-btn" class="admin-btn">30Êó•„Çà„ÇäÂâç„ÇíÂâäÈô§</button>[m
[32m+[m[32m                <button id="dm-purge-all-btn" class="admin-btn danger">üóëÔ∏è DM„ÇíÂÖ®ÂâäÈô§</button>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div id="dm-purge-status" class="admin-status"></div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    `;[m
[32m+[m
[32m+[m[32m    const statusEl = document.getElementById('dm-purge-status');[m
[32m+[m[32m    const daysInput = document.getElementById('dm-purge-days');[m
[32m+[m[32m    const purgeBeforeBtn = document.getElementById('dm-purge-before-btn');[m
[32m+[m[32m    const purgeAllBtn = document.getElementById('dm-purge-all-btn');[m
[32m+[m
[32m+[m[32m    function setStatus(text, ok) {[m
[32m+[m[32m        if (!statusEl) return;[m
[32m+[m[32m        statusEl.textContent = text;[m
[32m+[m[32m        statusEl.className = ok ? 'admin-status success' : 'admin-status error';[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function setBusy(busy) {[m
[32m+[m[32m        if (purgeBeforeBtn) purgeBeforeBtn.disabled = busy;[m
[32m+[m[32m        if (purgeAllBtn) purgeAllBtn.disabled = busy;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    purgeBeforeBtn?.addEventListener('click', async () => {[m
[32m+[m[32m        const days = Math.max(1, Number(daysInput?.value) || 30);[m
[32m+[m[32m        if (!confirm(`${days}Êó•„Çà„ÇäÂâç„ÅÆDM„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)) return;[m
[32m+[m
[32m+[m[32m        setBusy(true);[m
[32m+[m[32m        try {[m
[32m+[m[32m            const deleted = await adminPurgeDmBefore(days);[m
[32m+[m[32m            setStatus(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${deleted}Ôºâ`, true);[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('[admin] DM purge before failed', err);[m
[32m+[m[32m            setStatus('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', false);[m
[32m+[m[32m        } finally {[m
[32m+[m[32m            setBusy(false);[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    purgeAllBtn?.addEventListener('click', async () => {[m
[32m+[m[32m        if (!confirm('DM„ÇíÂÖ®‰ª∂ÂâäÈô§„Åó„Åæ„Åô„ÄÇÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü')) return;[m
[32m+[m
[32m+[m[32m        setBusy(true);[m
[32m+[m[32m        try {[m
[32m+[m[32m            const deleted = await adminPurgeDmAll();[m
[32m+[m[32m            setStatus(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${deleted}Ôºâ`, true);[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('[admin] DM purge all failed', err);[m
[32m+[m[32m            setStatus('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', false);[m
[32m+[m[32m        } finally {[m
[32m+[m[32m            setBusy(false);[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction renderGlobalMaintenancePanel(container) {[m
[32m+[m[32m    container.innerHTML = `[m
[32m+[m[32m        <div class="admin-export">[m
[32m+[m[32m            <h3>üßπ ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂâäÈô§</h3>[m
[32m+[m[32m            <p>ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí‰∏ÄË¶ßÁ¢∫Ë™ç„Åó„ÄÅ1‰ª∂ÂâäÈô§„Åæ„Åü„ÅØ‰∏ÄÊã¨ÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</p>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label class="form-label" for="global-room-id">room_idÔºàÁ©∫Ê¨Ñ„ÅßÂÖ®„É´„Éº„É†Ôºâ</label>[m
[32m+[m[32m                <input type="text" id="global-room-id" class="form-input" value="room:default" placeholder="room:default">[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label class="form-label" for="global-purge-days">ÂâäÈô§ÂØæË±°ÔºàÊó•Êï∞„Çà„ÇäÂâçÔºâ</label>[m
[32m+[m[32m                <input type="number" id="global-purge-days" class="form-input" min="1" step="1" value="30">[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="admin-buttons">[m
[32m+[m[32m                <button id="global-refresh-btn" class="admin-btn">‰∏ÄË¶ß„ÇíÊõ¥Êñ∞</button>[m
[32m+[m[32m                <button id="global-purge-before-btn" class="admin-btn">30Êó•„Çà„ÇäÂâç„ÇíÂâäÈô§</button>[m
[32m+[m[32m                <button id="global-purge-all-btn" class="admin-btn danger">üóëÔ∏è ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂÖ®ÂâäÈô§</button>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div id="global-purge-status" class="admin-status"></div>[m
[32m+[m[32m            <div class="admin-list" id="global-message-list"></div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    `;[m
[32m+[m
[32m+[m[32m    const statusEl = document.getElementById('global-purge-status');[m
[32m+[m[32m    const roomInput = document.getElementById('global-room-id');[m
[32m+[m[32m    const daysInput = document.getElementById('global-purge-days');[m
[32m+[m[32m    const listEl = document.getElementById('global-message-list');[m
[32m+[m[32m    const refreshBtn = document.getElementById('global-refresh-btn');[m
[32m+[m[32m    const purgeBeforeBtn = document.getElementById('global-purge-before-btn');[m
[32m+[m[32m    const purgeAllBtn = document.getElementById('global-purge-all-btn');[m
[32m+[m
[32m+[m[32m    function roomIdValue() {[m
[32m+[m[32m        const value = String(roomInput?.value || '').trim();[m
[32m+[m[32m        return value || null;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function setStatus(text, ok) {[m
[32m+[m[32m        if (!statusEl) return;[m
[32m+[m[32m        statusEl.textContent = text;[m
[32m+[m[32m        statusEl.className = ok ? 'admin-status success' : 'admin-status error';[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function setBusy(busy) {[m
[32m+[m[32m        if (refreshBtn) refreshBtn.disabled = busy;[m
[32m+[m[32m        if (purgeBeforeBtn) purgeBeforeBtn.disabled = busy;[m
[32m+[m[32m        if (purgeAllBtn) purgeAllBtn.disabled = busy;[m
[32m+[m[32m        if (listEl) {[m
[32m+[m[32m            listEl.querySelectorAll('button[data-action="delete"]').forEach(btn => {[m
[32m+[m[32m                btn.disabled = busy;[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async function reloadList() {[m
[32m+[m[32m        if (!listEl) return;[m
[32m+[m[32m        listEl.innerHTML = '<div class="chat-empty">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';[m
[32m+[m
[32m+[m[32m        try {[m
[32m+[m[32m            const rows = await fetchGlobalMessagesForAdmin({ roomId: roomIdValue(), limit: 200 });[m
[32m+[m[32m            if (!rows.length) {[m
[32m+[m[32m                listEl.innerHTML = '<div class="chat-empty">ÂØæË±°„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>';[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            listEl.innerHTML = rows.map(row => {[m
[32m+[m[32m                const msg = String(row?.message || '').slice(0, 120);[m
[32m+[m[32m                const name = row?.sender_display_name || row?.sender_actor_id || '‰∏çÊòé';[m
[32m+[m[32m                return `[m
[32m+[m[32m                    <div class="admin-item">[m
[32m+[m[32m                        <div class="item-header">[m
[32m+[m[32m                            <span class="item-title">${escapeHtml(name)}</span>[m
[32m+[m[32m                            <span class="item-date">${escapeHtml(formatAdminDate(row?.created_at))}</span>[m
[32m+[m[32m                            <div class="item-actions">[m
[32m+[m[32m                                <button class="item-btn danger" data-action="delete" data-id="${escapeHtml(row?.id || '')}" title="ÂâäÈô§">üóëÔ∏è</button>[m
[32m+[m[32m                            </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                        <div class="item-meta">${escapeHtml(msg || '(Á©∫„É°„ÉÉ„Çª„Éº„Ç∏)')}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                `;[m
[32m+[m[32m            }).join('');[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('[admin] global list fetch failed', err);[m
[32m+[m[32m            listEl.innerHTML = '<div class="chat-empty">‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</div>';[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    refreshBtn?.addEventListener('click', () => {[m
[32m+[m[32m        void reloadList();[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    purgeBeforeBtn?.addEventListener('click', async () => {[m
[32m+[m[32m        const days = Math.max(1, Number(daysInput?.value) || 30);[m
[32m+[m[32m        if (!confirm(`${days}Êó•„Çà„ÇäÂâç„ÅÆÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)) return;[m
[32m+[m
[32m+[m[32m        setBusy(true);[m
[32m+[m[32m        try {[m
[32m+[m[32m            const deleted = await adminPurgeGlobalBefore(days, roomIdValue());[m
[32m+[m[32m            setStatus(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${deleted}Ôºâ`, true);[m
[32m+[m[32m            await reloadList();[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('[admin] global purge before failed', err);[m
[32m+[m[32m            setStatus('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', false);[m
[32m+[m[32m        } finally {[m
[32m+[m[32m            setBusy(false);[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    purgeAllBtn?.addEventListener('click', async () => {[m
[32m+[m[32m        if (!confirm('ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂÖ®‰ª∂ÂâäÈô§„Åó„Åæ„Åô„ÄÇÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü')) return;[m
[32m+[m
[32m+[m[32m        setBusy(true);[m
[32m+[m[32m        try {[m
[32m+[m[32m            const deleted = await adminPurgeGlobalAll(roomIdValue());[m
[32m+[m[32m            setStatus(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${deleted}Ôºâ`, true);[m
[32m+[m[32m            await reloadList();[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('[admin] global purge all failed', err);[m
[32m+[m[32m            setStatus('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', false);[m
[32m+[m[32m        } finally {[m
[32m+[m[32m            setBusy(false);[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    listEl?.addEventListener('click', async (e) => {[m
[32m+[m[32m        const btn = e.target.closest?.('button[data-action="delete"]');[m
[32m+[m[32m        if (!btn) return;[m
[32m+[m[32m        const id = btn.dataset.id;[m
[32m+[m[32m        if (!id) return;[m
[32m+[m[32m        if (!confirm('„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) return;[m
[32m+[m
[32m+[m[32m        setBusy(true);[m
[32m+[m[32m        try {[m
[32m+[m[32m            const deleted = await adminDeleteGlobalMessage(id);[m
[32m+[m[32m            if (deleted > 0) {[m
[32m+[m[32m                setStatus('ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: 1Ôºâ', true);[m
[32m+[m[32m            } else {[m
[32m+[m[32m                setStatus('ÂØæË±°„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü', false);[m
[32m+[m[32m            }[m
[32m+[m[32m            await reloadList();[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('[admin] global delete failed', err);[m
[32m+[m[32m            setStatus('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', false);[m
[32m+[m[32m        } finally {[m
[32m+[m[32m            setBusy(false);[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    void reloadList();[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction formatAdminDate(value) {[m
[32m+[m[32m    if (!value) return '';[m
[32m+[m[32m    const d = new Date(value);[m
[32m+[m[32m    if (Number.isNaN(d.getTime())) return String(value);[m
[32m+[m[32m    return d.toLocaleString('ja-JP', { hour12: false });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction escapeHtml(text) {[m
[32m+[m[32m    const div = document.createElement('div');[m
[32m+[m[32m    div.textContent = String(text ?? '');[m
[32m+[m[32m    return div.innerHTML;[m
[32m+[m[32m}[m
 [m
 export function isAdminModalVisible() {[m
     return isVisible;[m
[1mdiff --git a/src/ui/modal.bgm.js b/src/ui/modal.bgm.js[m
[1mindex 2fb26c5..7da542f 100644[m
[1m--- a/src/ui/modal.bgm.js[m
[1m+++ b/src/ui/modal.bgm.js[m
[36m@@ -19,7 +19,7 @@[m [mexport function initBgmModal() {[m
     bgmModal.id = 'modal-bgm';[m
     bgmModal.innerHTML = `[m
         <div class="modal-header">[m
[31m-            <h2 class="modal-title" id="bgm-modal-title">Garden BGM</h2>[m
[32m+[m[32m            <h2 class="modal-title" id="bgm-modal-title">„Ç¨„Éº„Éá„É≥BGM</h2>[m
             <button type="button" class="modal-close-btn" id="bgm-modal-close">[m
                 <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">[m
                     <path d="M18 6 6 18M6 6l12 12" />[m
[36m@@ -55,7 +55,7 @@[m [mexport function initBgmModal() {[m
     });[m
 }[m
 [m
[31m-export function showBgmModal({ tracks = [], selectedId = null, title = 'Garden BGM' } = {}) {[m
[32m+[m[32mexport function showBgmModal({ tracks = [], selectedId = null, title = '„Ç¨„Éº„Éá„É≥BGM' } = {}) {[m
     if (!bgmModal) return;[m
 [m
     const titleEl = document.getElementById('bgm-modal-title');[m
[36m@@ -65,7 +65,7 @@[m [mexport function showBgmModal({ tracks = [], selectedId = null, title = 'Garden B[m
     const selected = selectedId || localStorage.getItem(STORAGE_SELECTED) || 'none';[m
     const bgmState = getBgmState?.() || {};[m
     const activeTrackId = bgmState.isPlaying ? bgmState.playingId : selected;[m
[31m-    const nowPlayingTitle = bgmState.isPlaying ? (bgmState.playingTitle || 'Unknown') : 'Stopped';[m
[32m+[m[32m    const nowPlayingTitle = bgmState.isPlaying ? (bgmState.playingTitle || '‰∏çÊòé') : 'ÂÅúÊ≠¢‰∏≠';[m
 [m
     const trackButtons = tracks.map(track => {[m
         const active = track.id === activeTrackId ? 'data-active="true"' : '';[m
[36m@@ -73,7 +73,7 @@[m [mexport function showBgmModal({ tracks = [], selectedId = null, title = 'Garden B[m
             <button type="button" class="spot-link-item" data-track-id="${track.id}" ${active}>[m
                 <div class="spot-link-header">[m
                     <span class="spot-link-label">${track.title}</span>[m
[31m-                    ${(bgmState.playingId === track.id && bgmState.isPlaying) ? '<span class="spot-playing">Playing</span>' : ''}[m
[32m+[m[32m                    ${(bgmState.playingId === track.id && bgmState.isPlaying) ? '<span class="spot-playing">ÂÜçÁîü‰∏≠</span>' : ''}[m
                 </div>[m
             </button>[m
         `;[m
[36m@@ -81,18 +81,18 @@[m [mexport function showBgmModal({ tracks = [], selectedId = null, title = 'Garden B[m
 [m
     body.innerHTML = `[m
         <div class="spot-link-item bgm-now-playing">[m
[31m-            <span>Now Playing</span>[m
[32m+[m[32m            <span>ÂÜçÁîü‰∏≠</span>[m
             <strong>${nowPlayingTitle}</strong>[m
         </div>[m
         <div class="spot-links-list bgm-track-list">[m
[31m-            ${trackButtons || '<div class="spot-link-item">No tracks</div>'}[m
[32m+[m[32m            ${trackButtons || '<div class="spot-link-item">„Éà„É©„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'}[m
         </div>[m
         <div class="spot-links-list" style="margin-top: 12px; gap: 12px;">[m
             <div class="spot-link-item" style="align-items: center;">[m
[31m-                <label style="flex: 1;">Volume</label>[m
[32m+[m[32m                <label style="flex: 1;">Èü≥Èáè</label>[m
                 <input id="bgm-volume" type="range" min="0" max="1" step="0.01" value="${getCurrentVolume()}" />[m
             </div>[m
[31m-            <button type="button" class="spot-link-item" id="bgm-stop-btn">Stop</button>[m
[32m+[m[32m            <button type="button" class="spot-link-item" id="bgm-stop-btn">ÂÅúÊ≠¢</button>[m
         </div>[m
     `;[m
 [m
[1mdiff --git a/src/ui/panel.context.js b/src/ui/panel.context.js[m
[1mindex f57cbd8..67b9679 100644[m
[1m--- a/src/ui/panel.context.js[m
[1m+++ b/src/ui/panel.context.js[m
[36m@@ -3,39 +3,47 @@[m
 import { getSpotById, getDeskById } from '../world/mapLoader.js';[m
 import { getRoomSettings } from '../services/db.js';[m
 [m
[31m-let roomSettings = new Map();[m
[31m-let onOpenZoom = null;[m
[31m-let onOpenRoomChat = null;[m
[31m-let onSit = null;[m
[31m-let onStand = null;[m
[32m+[m[32mlet roomSettings = new Map();[m
[32m+[m[32mlet onOpenZoom = null;[m
[32m+[m[32mlet onOpenRoomChat = null;[m
[32m+[m[32mlet onClaimDesk = null;[m
[32m+[m[32mlet onSeatDesk = null;[m
[32m+[m[32mlet onLeaveSeat = null;[m
[32m+[m[32mlet onUnclaimDesk = null;[m
 let onPoke = null;[m
 let onDm = null;[m
 let onCall = null;[m
[31m-let onDeskCallJoin = null;[m
[31m-let onDeskCallMute = null;[m
[31m-let onDeskCallHangup = null;[m
[32m+[m[32mlet onCallAccept = null;[m
[32m+[m[32mlet onCallReject = null;[m
[32m+[m[32mlet onCallCancel = null;[m
[32m+[m[32mlet onCallMute = null;[m
[32m+[m[32mlet onCallEnd = null;[m
 [m
 export function initContextPanel(callbacks) {[m
     onOpenZoom = callbacks.openZoom;[m
     onOpenRoomChat = callbacks.openRoomChat;[m
[31m-    onSit = callbacks.sit;[m
[31m-    onStand = callbacks.stand;[m
[32m+[m[32m    onClaimDesk = callbacks.claimDesk;[m
[32m+[m[32m    onSeatDesk = callbacks.seatDesk;[m
[32m+[m[32m    onLeaveSeat = callbacks.leaveSeat;[m
[32m+[m[32m    onUnclaimDesk = callbacks.unclaimDesk;[m
     onPoke = callbacks.poke;[m
     onDm = callbacks.dm;[m
     onCall = callbacks.call;[m
[31m-    onDeskCallJoin = callbacks.deskCallJoin;[m
[31m-    onDeskCallMute = callbacks.deskCallMute;[m
[31m-    onDeskCallHangup = callbacks.deskCallHangup;[m
[32m+[m[32m    onCallAccept = callbacks.callAccept;[m
[32m+[m[32m    onCallReject = callbacks.callReject;[m
[32m+[m[32m    onCallCancel = callbacks.callCancel;[m
[32m+[m[32m    onCallMute = callbacks.callMute;[m
[32m+[m[32m    onCallEnd = callbacks.callEnd;[m
 }[m
 [m
 export async function loadRoomSettings() {[m
     roomSettings = await getRoomSettings();[m
 }[m
 [m
[31m-export function showContextPanel(selection, meta = {}) {[m
[31m-    const panel = document.getElementById('context-panel');[m
[31m-    const title = document.getElementById('context-title');[m
[31m-    const actions = document.getElementById('context-actions');[m
[32m+[m[32mexport function showContextPanel(selection, meta = {}) {[m[41m[m
[32m+[m[32m    const panel = document.getElementById('context-panel');[m[41m[m
[32m+[m[32m    const title = document.getElementById('context-title');[m[41m[m
[32m+[m[32m    const actions = document.getElementById('context-actions');[m[41m[m
 [m
     if (!panel || !selection) {[m
         hideContextPanel();[m
[36m@@ -44,13 +52,13 @@[m [mexport function showContextPanel(selection, meta = {}) {[m
 [m
     const { kind, data } = selection;[m
 [m
[31m-    if (kind === 'spot') {[m
[31m-        showSpotPanel(data, title, actions);[m
[31m-    } else if (kind === 'desk') {[m
[31m-        showDeskPanel(data, title, actions, meta);[m
[31m-    } else if (kind === 'user') {[m
[31m-        showUserPanel(data, title, actions);[m
[31m-    } else {[m
[32m+[m[32m    if (kind === 'spot') {[m[41m[m
[32m+[m[32m        showSpotPanel(data, title, actions);[m[41m[m
[32m+[m[32m    } else if (kind === 'desk') {[m[41m[m
[32m+[m[32m        showDeskPanel(data, title, actions, meta);[m[41m[m
[32m+[m[32m    } else if (kind === 'user') {[m[41m[m
[32m+[m[32m        showUserPanel(data, title, actions);[m[41m[m
[32m+[m[32m    } else {[m[41m[m
         hideContextPanel();[m
         return;[m
     }[m
[36m@@ -70,14 +78,14 @@[m [mfunction showSpotPanel(spot, title, actions) {[m
 [m
         html += `[m
       <button class="btn btn-primary" id="ctx-open-zoom" ${!hasUrl ? 'disabled' : ''}>[m
[31m-        ${hasUrl ? 'üìπ Open Zoom' : 'Zoom URLÊú™Ë®≠ÂÆö'}[m
[32m+[m	[32m        ${hasUrl ? 'üìπ Zoom„ÇíÈñã„Åè' : 'Zoom URLÊú™Ë®≠ÂÆö'}[m
       </button>[m
     `;[m
     }[m
 [m
     // Room chat button[m
     if (spot.ui?.showRoomChat) {[m
[31m-        html += `<button class="btn btn-secondary" id="ctx-room-chat">üí¨ Room Chat</button>`;[m
[32m+[m[32m        html += `<button class="btn btn-secondary" id="ctx-room-chat">üí¨ „É´„Éº„É†„ÉÅ„É£„ÉÉ„Éà</button>`;[m
     }[m
 [m
     actions.innerHTML = html;[m
[36m@@ -100,51 +108,114 @@[m [mfunction showSpotPanel(spot, title, actions) {[m
 }[m
 [m
 function showDeskPanel(desk, title, actions, meta = {}) {[m
[31m-    const seated = meta.seated === true;[m
[32m+[m[32m    const claimed = meta.claimed === true;[m
[32m+[m[32m    const seatLocked = meta.seatLocked === true;[m
     const occupant = meta.occupant || null;[m
[32m+[m[32m    const participantDisplayName = meta.callState?.peerDisplayName || null;[m
[32m+[m[32m    const claimedByDisplayName = meta.claimedByDisplayName[m
[32m+[m[32m        || occupant?.claimedByDisplayName[m
[32m+[m[32m        || occupant?.displayName[m
[32m+[m[32m        || participantDisplayName[m
[32m+[m[32m        || null;[m
     const callState = meta.callState || {};[m
     const forced = meta.forced === true;[m
     const callStatus = callState.status || 'idle';[m
[31m-    const inCall = callStatus === 'in_call' || callStatus === 'connecting';[m
[32m+[m[32m    const callPeerId = callState.peerActorId || null;[m
[32m+[m[32m    const callPeerLabel = callState.peerDisplayName || (callPeerId ? callPeerId.slice(0, 6) : '');[m
[32m+[m[32m    const callDurationSec = callState.startedAt ? Math.max(0, Math.floor((Date.now() - callState.startedAt) / 1000)) : 0;[m
 [m
[31m-    title.textContent = `Desk ${desk.id.replace('desk:', '')}`;[m
[32m+[m[32m    function labelStatus(s) {[m
[32m+[m[32m        switch (s) {[m
[32m+[m[32m            case 'idle': return 'ÈùûÈÄöË©±';[m
[32m+[m[32m            case 'calling': return 'Áô∫‰ø°‰∏≠‚Ä¶';[m
[32m+[m[32m            case 'ringing': return 'ÁùÄ‰ø°‰∏≠';[m
[32m+[m[32m            case 'in_call': return 'ÈÄöË©±‰∏≠';[m
[32m+[m[32m            default: return s || '‰∏çÊòé';[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
 [m
[31m-    let html = '';[m
[32m+[m[32m    function formatDuration(totalSeconds) {[m
[32m+[m[32m        const mm = String(Math.floor(totalSeconds / 60)).padStart(2, '0');[m
[32m+[m[32m        const ss = String(totalSeconds % 60).padStart(2, '0');[m
[32m+[m[32m        return `${mm}:${ss}`;[m
[32m+[m[32m    }[m
 [m
[31m-    if (seated) {[m
[31m-        // Currently seated[m
[31m-        html += `<div class="context-status">ü™ë Seated${forced ? ' (forced)' : ''}</div>`;[m
[31m-        html += `<div class="context-status">üìû Call: ${callStatus}</div>`;[m
[31m-        if (!inCall) {[m
[31m-            html += `<button class="btn btn-primary" id="ctx-join-call">üìû ÈÄöË©±„Å´ÂèÇÂä†</button>`;[m
[31m-        } else {[m
[31m-            html += `<button class="btn btn-secondary" id="ctx-mute-call">${callState.muted ? 'üîà Unmute' : 'üîá Mute'}</button>`;[m
[31m-            html += `<button class="btn btn-secondary" id="ctx-hangup-call">‚èπ Hang up</button>`;[m
[32m+[m[32m    function buildCallButtons() {[m
[32m+[m[32m        if (callStatus === 'calling') {[m
[32m+[m[32m            return `<button class="btn btn-secondary" id="ctx-call-cancel">‚èπ „Ç≠„É£„É≥„Çª„É´</button>`;[m
         }[m
[31m-        html += `<button class="btn btn-secondary" id="ctx-stand">üö∂ Stand</button>`;[m
[31m-    } else if (occupant) {[m
[31m-        // Someone else is sitting here[m
[32m+[m[32m        if (callStatus === 'ringing') {[m
[32m+[m[32m            return `[m
[32m+[m[32m            <button class="btn btn-primary" id="ctx-call-accept">‚úÖ ÂøúÁ≠î</button>[m
[32m+[m[32m            <button class="btn btn-secondary" id="ctx-call-reject">‚ùå ÊãíÂê¶</button>[m
[32m+[m[32m          `;[m
[32m+[m[32m        }[m
[32m+[m[32m        if (callStatus === 'in_call') {[m
[32m+[m[32m            return `[m
[32m+[m[32m            <button class="btn btn-secondary" id="ctx-call-mute">${callState.muted ? 'üîà „Éü„É•„Éº„ÉàËß£Èô§' : 'üîá „Éü„É•„Éº„Éà'}</button>[m
[32m+[m[32m            <button class="btn btn-secondary" id="ctx-call-end">‚èπ ÈÄöË©±ÁµÇ‰∫Ü</button>[m
[32m+[m[32m          `;[m
[32m+[m[32m        }[m
[32m+[m[32m        if (occupant) {[m
[32m+[m[32m            return `<button class="btn btn-primary" id="ctx-call">üìû Áô∫‰ø°</button>`;[m
[32m+[m[32m        }[m
[32m+[m[32m        return '';[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function buildDeskButtons() {[m
[32m+[m[32m        if (seatLocked) {[m
[32m+[m[32m            return `<button class="btn btn-secondary" id="ctx-stand">üö∂ Á´ã„Å§</button>`;[m
[32m+[m[32m        }[m
[32m+[m[32m        if (claimed) {[m
[32m+[m[32m            return `[m
[32m+[m[32m            <button class="btn btn-primary" id="ctx-seat">ü™ë ÁùÄÂ∏≠</button>[m
[32m+[m[32m            <button class="btn btn-secondary" id="ctx-unclaim">‚Ü© Á¢∫‰øùËß£Èô§</button>[m
[32m+[m[32m          `;[m
[32m+[m[32m        }[m
[32m+[m[32m        return `<button class="btn btn-primary" id="ctx-claim">ü™ë Â∏≠„ÇíÁ¢∫‰øù</button>`;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function deskStatusLabel() {[m
[32m+[m[32m        if (seatLocked) return `ü™ë ÁùÄÂ∏≠‰∏≠ÔºàÁßªÂãïÂõ∫ÂÆöÔºâ${forced ? 'ÔºàÂº∑Âà∂Ôºâ' : ''}`;[m
[32m+[m[32m        if (claimed) return 'ü™ë Â∏≠„ÇíÁ¢∫‰øù‰∏≠';[m
[32m+[m[32m        return 'ü™ë Êú™Á¢∫‰øù';[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    title.textContent = `„Éá„Çπ„ÇØ ${desk.id.replace('desk:', '')}`;[m
[32m+[m
[32m+[m[32m    let html = '';[m
[32m+[m[32m    html += `<div class="context-status">${deskStatusLabel()}</div>`;[m
[32m+[m[32m    if (claimed || seatLocked || occupant || claimedByDisplayName) {[m
[32m+[m[32m        html += `<div class="context-status">üë§ Á¢∫‰øùËÄÖ: ${escapeHtml(claimedByDisplayName || '‰∏çÊòé')}</div>`;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    html += `<div class="context-status">üìû ${labelStatus(callStatus)}${callStatus === 'in_call' ? `Ôºà${formatDuration(callDurationSec)}Ôºâ` : ''}${callPeerLabel ? ` / ${callPeerLabel}` : ''}</div>`;[m
[32m+[m
[32m+[m[32m    if (occupant) {[m
         html += `[m
[31m-      <button class="btn btn-secondary" id="ctx-dm">üí¨ DM</button>[m
[31m-      <button class="btn btn-secondary" id="ctx-poke">üëÜ Poke</button>[m
[31m-      <button class="btn btn-primary" id="ctx-call">üìû Call</button>[m
[31m-    `;[m
[31m-    } else {[m
[31m-        // Empty desk[m
[31m-        html += `<button class="btn btn-primary" id="ctx-sit">ü™ë Sit</button>`;[m
[31m-    }[m
[32m+[m[32m        <button class="btn btn-secondary" id="ctx-dm">üí¨ DM</button>[m
[32m+[m[32m        <button class="btn btn-secondary" id="ctx-poke">üëÜ „Å§„Å§„Åè</button>[m
[32m+[m[32m      `;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    html += buildCallButtons();[m
[32m+[m[32m    html += buildDeskButtons();[m
 [m
     actions.innerHTML = html;[m
 [m
     // Attach event listeners[m
[31m-    document.getElementById('ctx-sit')?.addEventListener('click', () => onSit?.(desk));[m
[31m-    document.getElementById('ctx-stand')?.addEventListener('click', () => onStand?.());[m
[32m+[m[32m    document.getElementById('ctx-claim')?.addEventListener('click', () => onClaimDesk?.(desk));[m
[32m+[m[32m    document.getElementById('ctx-seat')?.addEventListener('click', () => onSeatDesk?.(desk));[m
[32m+[m[32m    document.getElementById('ctx-stand')?.addEventListener('click', () => onLeaveSeat?.(desk));[m
[32m+[m[32m    document.getElementById('ctx-unclaim')?.addEventListener('click', () => onUnclaimDesk?.(desk));[m
     document.getElementById('ctx-dm')?.addEventListener('click', () => onDm?.(occupant));[m
     document.getElementById('ctx-poke')?.addEventListener('click', () => onPoke?.(occupant));[m
     document.getElementById('ctx-call')?.addEventListener('click', () => onCall?.(occupant));[m
[31m-    document.getElementById('ctx-join-call')?.addEventListener('click', () => onDeskCallJoin?.(desk));[m
[31m-    document.getElementById('ctx-mute-call')?.addEventListener('click', () => onDeskCallMute?.());[m
[31m-    document.getElementById('ctx-hangup-call')?.addEventListener('click', () => onDeskCallHangup?.());[m
[32m+[m[32m    document.getElementById('ctx-call-accept')?.addEventListener('click', () => onCallAccept?.());[m
[32m+[m[32m    document.getElementById('ctx-call-reject')?.addEventListener('click', () => onCallReject?.());[m
[32m+[m[32m    document.getElementById('ctx-call-cancel')?.addEventListener('click', () => onCallCancel?.());[m
[32m+[m[32m    document.getElementById('ctx-call-mute')?.addEventListener('click', () => onCallMute?.());[m
[32m+[m[32m    document.getElementById('ctx-call-end')?.addEventListener('click', () => onCallEnd?.());[m
 }[m
 [m
 function showUserPanel(user, title, actions) {[m
[36m@@ -152,9 +223,9 @@[m [mfunction showUserPanel(user, title, actions) {[m
 [m
     actions.innerHTML = `[m
     <button class="btn btn-secondary" id="ctx-dm">üí¨ DM</button>[m
[31m-    <button class="btn btn-secondary" id="ctx-poke">üëÜ Poke</button>[m
[31m-    <button class="btn btn-primary" id="ctx-warp">üìç Warp near</button>[m
[31m-  `;[m
[32m+[m[32m    <button class="btn btn-secondary" id="ctx-poke">üëÜ „Å§„Å§„Åè</button>[m
[32m+[m[32m    <button class="btn btn-primary" id="ctx-warp">üìç Ëøë„Åè„Å´„ÉØ„Éº„Éó</button>[m
[32m+[m[32m  `;[m
 [m
     document.getElementById('ctx-dm')?.addEventListener('click', () => onDm?.(user));[m
     document.getElementById('ctx-poke')?.addEventListener('click', () => onPoke?.(user));[m
[36m@@ -170,11 +241,17 @@[m [mexport function hideContextPanel() {[m
     }[m
 }[m
 [m
[31m-export function updateDeskPanel(desk, seated, occupant, callState, forced = false) {[m
[32m+[m[32mexport function updateDeskPanel(desk, claimed, seatLocked, occupant, callState, forced = false, claimedByDisplayName = null) {[m
     const title = document.getElementById('context-title');[m
     const actions = document.getElementById('context-actions');[m
 [m
     if (title && actions) {[m
[31m-        showDeskPanel(desk, title, actions, { seated, occupant, callState, forced });[m
[32m+[m[32m        showDeskPanel(desk, title, actions, { claimed, seatLocked, occupant, callState, forced, claimedByDisplayName });[m
     }[m
 }[m
[32m+[m
[32m+[m[32mfunction escapeHtml(text) {[m
[32m+[m[32m    const div = document.createElement('div');[m
[32m+[m[32m    div.textContent = text ?? '';[m
[32m+[m[32m    return div.innerHTML;[m
[32m+[m[32m}[m
[1mdiff --git a/src/world/mapLoader.js b/src/world/mapLoader.js[m
[1mindex 2d785d1..1ffa294 100644[m
[1m--- a/src/world/mapLoader.js[m
[1m+++ b/src/world/mapLoader.js[m
[36m@@ -495,8 +495,16 @@[m [mfunction normalizeDesks(desks = [], size, floorRect) {[m
             };[m
         }[m
 [m
[31m-        if (standAbs && posAbs && Math.abs(standAbs.x - posAbs.x) <= 60 && Math.abs(standAbs.y - posAbs.y) <= 60) {[m
[31m-            standAbs = { x: posAbs.x + (standRaw?.x || 0), y: posAbs.y + (standRaw?.y || 0) };[m
[32m+[m[32m        // NOTE: standPoint is already absolute in our data.[m
[32m+[m[32m        // Do NOT add posAbs + standRaw; it can explode coordinates and teleport out of bounds.[m
[32m+[m
[32m+[m[32m        // Safety: if standAbs is out of world bounds, fallback to posAbs[m
[32m+[m[32m        if (W && H && standAbs) {[m
[32m+[m[32m            const out = standAbs.x < 0 || standAbs.x > W || standAbs.y < 0 || standAbs.y > H;[m
[32m+[m[32m            if (out) {[m
[32m+[m[32m                console.warn('[desk] standPointAbs out of bounds -> fallback to posAbs', desk.id, standAbs, { W, H });[m
[32m+[m[32m                standAbs = posAbs;[m
[32m+[m[32m            }[m
         }[m
 [m
         next.posRaw = posRaw;[m
[1mdiff --git a/src/world/mapRenderer.js b/src/world/mapRenderer.js[m
[1mindex 3c3453a..5d53c6e 100644[m
[1m--- a/src/world/mapRenderer.js[m
[1m+++ b/src/world/mapRenderer.js[m
[36m@@ -1,10 +1,10 @@[m
 // mapRenderer.js - Canvas rendering for the map (Pixel Illustration Style)[m
 [m
[31m-import { getWorldModel, getDesks, getSpots, getActiveArea } from './mapLoader.js';[m
[31m-import { getConfig } from '../services/supabaseClient.js';[m
[31m-import { AVATAR_RADIUS } from './collision.js';[m
[31m-import { initAmbientParticles, updateAmbientParticles, renderAmbientParticles } from './ambientParticles.js';[m
[31m-import { getTimePreset } from '../data/timeOfDay.js';[m
[32m+[m[32mimport { getWorldModel, getDesks, getSpots, getActiveArea } from './mapLoader.js';[m[41m[m
[32m+[m[32mimport { getConfig } from '../services/supabaseClient.js';[m[41m[m
[32m+[m[32mimport { AVATAR_RADIUS } from './collision.js';[m[41m[m
[32m+[m[32mimport { initAmbientParticles, updateAmbientParticles, renderAmbientParticles } from './ambientParticles.js';[m[41m[m
[32m+[m[32mimport { getTimePreset } from '../data/timeOfDay.js';[m[41m[m
 [m
 // New render modules[m
 import { getPattern, zonePatterns } from '../render/patterns.js';[m
[36m@@ -19,28 +19,28 @@[m [mlet ctx = null;[m
 let container = null;[m
 let camera = { x: 0, y: 0, zoom: 1 };[m
 let canvasSize = { w: 0, h: 0 };[m
[31m-let resizeObserver = null;[m
[31m-let renderGuardLogged = false;[m
[31m-[m
[31m-// Background image[m
[31m-let backgroundImage = null;[m
[31m-let backgroundLoaded = false;[m
[31m-// Background image source (switchable)[m
[31m-let backgroundSrc = '/assets/maps/map.png'; // default office[m
[31m-let backgroundLogOnce = new Set();[m
[31m-let lastTimeOverlayLogKey = '';[m
[31m-[m
[31m-// Zoom limits[m
[31m-const MIN_ZOOM = 0.65;[m
[31m-const MAX_ZOOM = 1.6;[m
[31m-const LANTERN_LIGHTS = [[m
[31m-    { x: 126, y: 173 },[m
[31m-    { x: 374, y: 229 },[m
[31m-    { x: 274, y: 404 },[m
[31m-    { x: 529, y: 423 }[m
[31m-];[m
[31m-const NIGHT_LIGHT_RADIUS = 115;[m
[31m-const NIGHT_LIGHT_INTENSITY = 0.42;[m
[32m+[m[32mlet resizeObserver = null;[m[41m[m
[32m+[m[32mlet renderGuardLogged = false;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m// Background image[m[41m[m
[32m+[m[32mlet backgroundImage = null;[m[41m[m
[32m+[m[32mlet backgroundLoaded = false;[m[41m[m
[32m+[m[32m// Background image source (switchable)[m[41m[m
[32m+[m[32mlet backgroundSrc = '/assets/maps/map.png'; // default office[m[41m[m
[32m+[m[32mlet backgroundLogOnce = new Set();[m[41m[m
[32m+[m[32mlet lastTimeOverlayLogKey = '';[m[41m[m
[32m+[m[41m[m
[32m+[m[32m// Zoom limits[m[41m[m
[32m+[m[32mconst MIN_ZOOM = 0.65;[m[41m[m
[32m+[m[32mconst MAX_ZOOM = 1.6;[m[41m[m
[32m+[m[32mconst LANTERN_LIGHTS = [[m[41m[m
[32m+[m[32m    { x: 126, y: 173 },[m[41m[m
[32m+[m[32m    { x: 374, y: 229 },[m[41m[m
[32m+[m[32m    { x: 274, y: 404 },[m[41m[m
[32m+[m[32m    { x: 529, y: 423 }[m[41m[m
[32m+[m[32m];[m[41m[m
[32m+[m[32mconst NIGHT_LIGHT_RADIUS = 115;[m[41m[m
[32m+[m[32mconst NIGHT_LIGHT_INTENSITY = 0.42;[m[41m[m
 [m
 // Lerp factor for camera smoothing[m
 const CAMERA_LERP = 0.12;[m
[36m@@ -55,14 +55,14 @@[m [mfunction raf() {[m
 /**[m
  * Initialize renderer[m
  */[m
[31m-export async function initRenderer(canvasElement) {[m
[31m-    canvas = canvasElement;[m
[31m-    ctx = canvas.getContext('2d');[m
[31m-    container = document.getElementById('canvas-container');[m
[31m-    if (ctx) ctx.imageSmoothingEnabled = false;[m
[31m-[m
[31m-    // Load background image[m
[31m-    await setBackgroundSrc('/assets/maps/map.png');[m
[32m+[m[32mexport async function initRenderer(canvasElement) {[m[41m[m
[32m+[m[32m    canvas = canvasElement;[m[41m[m
[32m+[m[32m    ctx = canvas.getContext('2d');[m[41m[m
[32m+[m[32m    container = document.getElementById('canvas-container');[m[41m[m
[32m+[m[32m    if (ctx) ctx.imageSmoothingEnabled = false;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Load background image[m[41m[m
[32m+[m[32m    await setBackgroundSrc('/assets/maps/map.png');[m[41m[m
 [m
     // Initial resize (twice for layout settle)[m
     resizeCanvasToContainer();[m
[36m@@ -76,70 +76,70 @@[m [mexport async function initRenderer(canvasElement) {[m
     resizeObserver = new ResizeObserver(() => {[m
         resizeCanvasToContainer();[m
     });[m
[31m-    resizeObserver.observe(container);[m
[31m-[m
[31m-    initAmbientParticles({[m
[31m-        getAreaId: () => getActiveArea(),[m
[31m-        getZoom: () => camera.zoom,[m
[31m-        getCanvasSize: () => ({ w: canvasSize.w, h: canvasSize.h })[m
[31m-    });[m
[31m-[m
[31m-    return { canvas, ctx };[m
[31m-}[m
[32m+[m[32m    resizeObserver.observe(container);[m[41m[m
 [m
[31m-function getBasePath() {[m
[31m-    const pathname = window.location.pathname || '/';[m
[31m-    if (!pathname || pathname === '/') return '/';[m
[31m-    const parts = pathname.split('/').filter(Boolean);[m
[31m-    if (!parts.length) return '/';[m
[31m-    return `/${parts[0]}/`;[m
[31m-}[m
[31m-[m
[31m-function resolveAssetUrl(path) {[m
[31m-    const raw = String(path || '');[m
[31m-    if (!raw) return raw;[m
[31m-    if (/^https?:\/\//i.test(raw)) return raw;[m
[31m-    if (raw.startsWith('./') || raw.startsWith('../')) {[m
[31m-        return new URL(raw, window.location.href).href;[m
[31m-    }[m
[31m-    if (raw.startsWith('/')) {[m
[31m-        const basePath = getBasePath();[m
[31m-        return `${window.location.origin}${basePath}${raw.slice(1)}`;[m
[31m-    }[m
[31m-    return new URL(raw, window.location.href).href;[m
[31m-}[m
[31m-[m
[31m-/**[m
[31m- * Switch background map image at runtime[m
[31m- */[m
[31m-export async function setBackgroundSrc(src) {[m
[31m-    if (!src) return;[m
[31m-    if (src === backgroundSrc && backgroundLoaded) return;[m
[31m-[m
[31m-    backgroundSrc = src;[m
[31m-    const resolvedSrc = resolveAssetUrl(src);[m
[31m-    if (!backgroundLogOnce.has(resolvedSrc)) {[m
[31m-        backgroundLogOnce.add(resolvedSrc);[m
[31m-        console.log('[bg] loading:', resolvedSrc, 'from', src);[m
[31m-    }[m
[31m-[m
[31m-    return new Promise((resolve) => {[m
[31m-        const nextImage = new Image();[m
[31m-        backgroundLoaded = false;[m
[31m-        nextImage.onload = () => {[m
[31m-            backgroundImage = nextImage;[m
[31m-            backgroundLoaded = true;[m
[31m-            console.log('[MapRenderer] Background image loaded:', backgroundSrc, nextImage.width, 'x', nextImage.height);[m
[31m-            resolve();[m
[31m-        };[m
[31m-        nextImage.onerror = (err) => {[m
[31m-            backgroundLoaded = false;[m
[31m-            console.warn('[bg] FAILED:', resolvedSrc, 'from', src, err);[m
[31m-            resolve();[m
[31m-        };[m
[31m-        nextImage.src = resolvedSrc;[m
[31m-    });[m
[31m-}[m
[32m+[m[32m    initAmbientParticles({[m[41m[m
[32m+[m[32m        getAreaId: () => getActiveArea(),[m[41m[m
[32m+[m[32m        getZoom: () => camera.zoom,[m[41m[m
[32m+[m[32m        getCanvasSize: () => ({ w: canvasSize.w, h: canvasSize.h })[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    return { canvas, ctx };[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32mfunction getBasePath() {[m[41m[m
[32m+[m[32m    const pathname = window.location.pathname || '/';[m[41m[m
[32m+[m[32m    if (!pathname || pathname === '/') return '/';[m[41m[m
[32m+[m[32m    const parts = pathname.split('/').filter(Boolean);[m[41m[m
[32m+[m[32m    if (!parts.length) return '/';[m[41m[m
[32m+[m[32m    return `/${parts[0]}/`;[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32mfunction resolveAssetUrl(path) {[m[41m[m
[32m+[m[32m    const raw = String(path || '');[m[41m[m
[32m+[m[32m    if (!raw) return raw;[m[41m[m
[32m+[m[32m    if (/^https?:\/\//i.test(raw)) return raw;[m[41m[m
[32m+[m[32m    if (raw.startsWith('./') || raw.startsWith('../')) {[m[41m[m
[32m+[m[32m        return new URL(raw, window.location.href).href;[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[32m    if (raw.startsWith('/')) {[m[41m[m
[32m+[m[32m        const basePath = getBasePath();[m[41m[m
[32m+[m[32m        return `${window.location.origin}${basePath}${raw.slice(1)}`;[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[32m    return new URL(raw, window.location.href).href;[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32m/**[m[41m[m
[32m+[m[32m * Switch background map image at runtime[m[41m[m
[32m+[m[32m */[m[41m[m
[32m+[m[32mexport async function setBackgroundSrc(src) {[m[41m[m
[32m+[m[32m    if (!src) return;[m[41m[m
[32m+[m[32m    if (src === backgroundSrc && backgroundLoaded) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    backgroundSrc = src;[m[41m[m
[32m+[m[32m    const resolvedSrc = resolveAssetUrl(src);[m[41m[m
[32m+[m[32m    if (!backgroundLogOnce.has(resolvedSrc)) {[m[41m[m
[32m+[m[32m        backgroundLogOnce.add(resolvedSrc);[m[41m[m
[32m+[m[32m        console.log('[bg] loading:', resolvedSrc, 'from', src);[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    return new Promise((resolve) => {[m[41m[m
[32m+[m[32m        const nextImage = new Image();[m[41m[m
[32m+[m[32m        backgroundLoaded = false;[m[41m[m
[32m+[m[32m        nextImage.onload = () => {[m[41m[m
[32m+[m[32m            backgroundImage = nextImage;[m[41m[m
[32m+[m[32m            backgroundLoaded = true;[m[41m[m
[32m+[m[32m            console.log('[MapRenderer] Background image loaded:', backgroundSrc, nextImage.width, 'x', nextImage.height);[m[41m[m
[32m+[m[32m            resolve();[m[41m[m
[32m+[m[32m        };[m[41m[m
[32m+[m[32m        nextImage.onerror = (err) => {[m[41m[m
[32m+[m[32m            backgroundLoaded = false;[m[41m[m
[32m+[m[32m            console.warn('[bg] FAILED:', resolvedSrc, 'from', src, err);[m[41m[m
[32m+[m[32m            resolve();[m[41m[m
[32m+[m[32m        };[m[41m[m
[32m+[m[32m        nextImage.src = resolvedSrc;[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[32m}[m[41m[m
 [m
 /**[m
  * Resize canvas to fit container with DPR support[m
[36m@@ -311,35 +311,36 @@[m [mfunction getCssVar(name) {[m
 /**[m
  * Render the entire map with pixel illustration style[m
  */[m
[31m-export function render([m
[31m-    playerPos,[m
[31m-    playerFacing,[m
[31m-    otherPlayers = [],[m
[31m-    me = {},[m
[31m-    clickMarker = null,[m
[31m-    clickMarkerTime = 0,[m
[31m-    deltaMs = 16,[m
[31m-    currentAreaId = getActiveArea(),[m
[31m-    timeOfDayId = 'day'[m
[31m-) {[m
[31m-    if (!ctx) return;[m
[31m-[m
[31m-    const world = getWorldModel();[m
[31m-    if (!world || world.isMapLoading || !world.isReady || !world.size || !playerPos || !Number.isFinite(playerPos.x) || !Number.isFinite(playerPos.y)) {[m
[31m-        if (!renderGuardLogged) {[m
[31m-            renderGuardLogged = true;[m
[31m-            console.warn('[render guard] skip frame', {[m
[31m-                hasWorld: !!world,[m
[31m-                hasSize: !!world?.size,[m
[31m-                isReady: world?.isReady,[m
[31m-                isMapLoading: world?.isMapLoading,[m
[31m-                playerPos,[m
[31m-                mapId: world?.meta?.id[m
[31m-            });[m
[31m-        }[m
[31m-        return;[m
[31m-    }[m
[31m-    renderGuardLogged = false;[m
[32m+[m[32mexport function render([m[41m[m
[32m+[m[32m    playerPos,[m[41m[m
[32m+[m[32m    playerFacing,[m[41m[m
[32m+[m[32m    otherPlayers = [],[m[41m[m
[32m+[m[32m    me = {},[m[41m[m
[32m+[m[32m    clickMarker = null,[m[41m[m
[32m+[m[32m    clickMarkerTime = 0,[m[41m[m
[32m+[m[32m    deltaMs = 16,[m[41m[m
[32m+[m[32m    currentAreaId = getActiveArea(),[m[41m[m
[32m+[m[32m    timeOfDayId = 'day',[m[41m[m
[32m+[m[32m    presenceState = null[m[41m[m
[32m+[m[32m) {[m[41m[m
[32m+[m[32m    if (!ctx) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    const world = getWorldModel();[m[41m[m
[32m+[m[32m    if (!world || world.isMapLoading || !world.isReady || !world.size || !playerPos || !Number.isFinite(playerPos.x) || !Number.isFinite(playerPos.y)) {[m[41m[m
[32m+[m[32m        if (!renderGuardLogged) {[m[41m[m
[32m+[m[32m            renderGuardLogged = true;[m[41m[m
[32m+[m[32m            console.warn('[render guard] skip frame', {[m[41m[m
[32m+[m[32m                hasWorld: !!world,[m[41m[m
[32m+[m[32m                hasSize: !!world?.size,[m[41m[m
[32m+[m[32m                isReady: world?.isReady,[m[41m[m
[32m+[m[32m                isMapLoading: world?.isMapLoading,[m[41m[m
[32m+[m[32m                playerPos,[m[41m[m
[32m+[m[32m                mapId: world?.meta?.id[m[41m[m
[32m+[m[32m            });[m[41m[m
[32m+[m[32m        }[m[41m[m
[32m+[m[32m        return;[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[32m    renderGuardLogged = false;[m[41m[m
 [m
     // === Layer 0: Clear canvas ===[m
     ctx.fillStyle = '#2a2520';[m
[36m@@ -355,10 +356,10 @@[m [mexport function render([m
     ctx.translate(-camera.x, -camera.y);[m
 [m
     // === Layer 1: Background Image ===[m
[31m-    if (backgroundImage) {[m
[31m-        // Draw background at world origin (0,0), sized to the world[m
[31m-        ctx.drawImage(backgroundImage, 0, 0, world.size.w, world.size.h);[m
[31m-    } else {[m
[32m+[m[32m    if (backgroundImage) {[m[41m[m
[32m+[m[32m        // Draw background at world origin (0,0), sized to the world[m[41m[m
[32m+[m[32m        ctx.drawImage(backgroundImage, 0, 0, world.size.w, world.size.h);[m[41m[m
[32m+[m[32m    } else {[m[41m[m
         // Fallback: solid color[m
         ctx.fillStyle = '#e8e4dc';[m
         ctx.fillRect(0, 0, world.size.w, world.size.h);[m
[36m@@ -370,97 +371,104 @@[m [mexport function render([m
         drawDebugSpots();[m
     }[m
 [m
[32m+[m[32m    // === Layer 2.5: Desk occupant labels ===[m[41m[m
[32m+[m[32m    if (presenceState && world.desks) {[m[41m[m
[32m+[m[32m        drawDeskOccupantLabels(world.desks, presenceState);[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
     // === Layer 3: Click marker ===[m
     if (clickMarker) {[m
         drawClickMarkerPixel(clickMarker.x, clickMarker.y, clickMarkerTime);[m
     }[m
 [m
[31m-    // === Layer 4: Other players (pixel avatars) ===[m
[31m-    otherPlayers.forEach(player => {[m
[31m-        const state = getAnimationState(player.actorId || player.displayName);[m
[31m-        renderPixelAvatar(ctx, player.pos.x, player.pos.y, player.displayName, state, camera.zoom, false);[m
[31m-        renderNameTag(ctx, player.pos.x, player.pos.y, player.displayName, player.status, camera.zoom);[m
[31m-    });[m
[31m-[m
[32m+[m[32m    // === Layer 4: Other players (pixel avatars) ===[m
[32m+[m[32m    otherPlayers.forEach(player => {[m
[32m+[m[32m        const state = getAnimationState(player.actorId || player.displayName);[m
[32m+[m[32m        renderPixelAvatar(ctx, player.pos.x, player.pos.y, player.displayName, state, camera.zoom, false);[m
[32m+[m[32m        renderNameTag(ctx, player.pos.x, player.pos.y, player.displayName, player.status, camera.zoom);[m
[32m+[m[32m        drawCallBadge(player.pos.x, player.pos.y, player.callStatus, camera.zoom);[m
[32m+[m[32m    });[m
[32m+[m
     // === Layer 5: Current player (pixel avatar) ===[m
     const playerState = getAnimationState(me.actorId || 'me');[m
     renderPixelAvatar(ctx, playerPos.x, playerPos.y, me.displayName || 'You', playerState, camera.zoom, true);[m
     renderNameTag(ctx, playerPos.x, playerPos.y, me.displayName || 'You', me.status || 'online', camera.zoom);[m
[31m-[m
[31m-    // === Debug collision overlays ===[m
[31m-    if (window.DEBUG_COLLISION) {[m
[31m-        drawCollisionDebug(world, playerPos);[m
[31m-    }[m
[31m-[m
[31m-    ctx.restore();[m
[31m-[m
[31m-    updateAmbientParticles(deltaMs);[m
[31m-    renderAmbientParticles(ctx);[m
[31m-    renderTimeOfDayOverlay(currentAreaId, timeOfDayId);[m
[31m-}[m
[31m-[m
[31m-function renderTimeOfDayOverlay(currentAreaId, timeOfDayId) {[m
[31m-    if (!ctx) return;[m
[31m-    if (currentAreaId !== 'area:garden') {[m
[31m-        lastTimeOverlayLogKey = '';[m
[31m-        return;[m
[31m-    }[m
[31m-[m
[31m-    const preset = getTimePreset(timeOfDayId);[m
[31m-    const overlay = preset?.overlay || 'rgba(0,0,0,0)';[m
[31m-    const logKey = `${currentAreaId}:${preset?.id || 'unknown'}`;[m
[31m-    if (lastTimeOverlayLogKey !== logKey) {[m
[31m-        lastTimeOverlayLogKey = logKey;[m
[31m-        console.log('[TimeOverlay] applied', {[m
[31m-            areaId: currentAreaId,[m
[31m-            requested: timeOfDayId,[m
[31m-            presetId: preset?.id || 'day',[m
[31m-            overlay[m
[31m-        });[m
[31m-    }[m
[31m-[m
[31m-    ctx.save();[m
[31m-    ctx.fillStyle = overlay;[m
[31m-    ctx.fillRect(0, 0, canvasSize.w, canvasSize.h);[m
[31m-    ctx.restore();[m
[31m-[m
[31m-    if (preset?.id !== 'night') return;[m
[31m-    drawGardenLanternLights();[m
[31m-}[m
[31m-[m
[31m-function drawGardenLanternLights() {[m
[31m-    if (!ctx) return;[m
[31m-[m
[31m-    ctx.save();[m
[31m-    ctx.globalCompositeOperation = 'screen';[m
[31m-[m
[31m-    LANTERN_LIGHTS.forEach((point) => {[m
[31m-        if (!point) return;[m
[31m-        const screen = worldToScreen(point.x, point.y);[m
[31m-        const radius = Math.max(1, NIGHT_LIGHT_RADIUS * camera.zoom);[m
[31m-        const intensity = Math.max(0, Math.min(1, NIGHT_LIGHT_INTENSITY));[m
[31m-[m
[31m-        if (screen.x + radius < 0 || screen.x - radius > canvasSize.w) return;[m
[31m-        if (screen.y + radius < 0 || screen.y - radius > canvasSize.h) return;[m
[31m-[m
[31m-        const gradient = ctx.createRadialGradient(screen.x, screen.y, 0, screen.x, screen.y, radius);[m
[31m-        gradient.addColorStop(0, `rgba(255,235,170,${intensity})`);[m
[31m-        gradient.addColorStop(1, 'rgba(255,235,170,0)');[m
[31m-[m
[31m-        ctx.fillStyle = gradient;[m
[31m-        ctx.beginPath();[m
[31m-        ctx.arc(screen.x, screen.y, radius, 0, Math.PI * 2);[m
[31m-        ctx.fill();[m
[31m-    });[m
[31m-[m
[31m-    ctx.globalCompositeOperation = 'source-over';[m
[31m-    ctx.restore();[m
[31m-}[m
[32m+[m[32m    drawCallBadge(playerPos.x, playerPos.y, me.callStatus, camera.zoom);[m
[32m+[m[41m[m
[32m+[m[32m    // === Debug collision overlays ===[m[41m[m
[32m+[m[32m    if (window.DEBUG_COLLISION) {[m[41m[m
[32m+[m[32m        drawCollisionDebug(world, playerPos);[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    ctx.restore();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    updateAmbientParticles(deltaMs);[m[41m[m
[32m+[m[32m    renderAmbientParticles(ctx);[m[41m[m
[32m+[m[32m    renderTimeOfDayOverlay(currentAreaId, timeOfDayId);[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32mfunction renderTimeOfDayOverlay(currentAreaId, timeOfDayId) {[m[41m[m
[32m+[m[32m    if (!ctx) return;[m[41m[m
[32m+[m[32m    if (currentAreaId !== 'area:garden') {[m[41m[m
[32m+[m[32m        lastTimeOverlayLogKey = '';[m[41m[m
[32m+[m[32m        return;[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    const preset = getTimePreset(timeOfDayId);[m[41m[m
[32m+[m[32m    const overlay = preset?.overlay || 'rgba(0,0,0,0)';[m[41m[m
[32m+[m[32m    const logKey = `${currentAreaId}:${preset?.id || 'unknown'}`;[m[41m[m
[32m+[m[32m    if (lastTimeOverlayLogKey !== logKey) {[m[41m[m
[32m+[m[32m        lastTimeOverlayLogKey = logKey;[m[41m[m
[32m+[m[32m        console.log('[TimeOverlay] applied', {[m[41m[m
[32m+[m[32m            areaId: currentAreaId,[m[41m[m
[32m+[m[32m            requested: timeOfDayId,[m[41m[m
[32m+[m[32m            presetId: preset?.id || 'day',[m[41m[m
[32m+[m[32m            overlay[m[41m[m
[32m+[m[32m        });[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    ctx.save();[m[41m[m
[32m+[m[32m    ctx.fillStyle = overlay;[m[41m[m
[32m+[m[32m    ctx.fillRect(0, 0, canvasSize.w, canvasSize.h);[m[41m[m
[32m+[m[32m    ctx.restore();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (preset?.id !== 'night') return;[m[41m[m
[32m+[m[32m    drawGardenLanternLights();[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32mfunction drawGardenLanternLights() {[m[41m[m
[32m+[m[32m    if (!ctx) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    ctx.save();[m[41m[m
[32m+[m[32m    ctx.globalCompositeOperation = 'screen';[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    LANTERN_LIGHTS.forEach((point) => {[m[41m[m
[32m+[m[32m        if (!point) return;[m[41m[m
[32m+[m[32m        const screen = worldToScreen(point.x, point.y);[m[41m[m
[32m+[m[32m        const radius = Math.max(1, NIGHT_LIGHT_RADIUS * camera.zoom);[m[41m[m
[32m+[m[32m        const intensity = Math.max(0, Math.min(1, NIGHT_LIGHT_INTENSITY));[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        if (screen.x + radius < 0 || screen.x - radius > canvasSize.w) return;[m[41m[m
[32m+[m[32m        if (screen.y + radius < 0 || screen.y - radius > canvasSize.h) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        const gradient = ctx.createRadialGradient(screen.x, screen.y, 0, screen.x, screen.y, radius);[m[41m[m
[32m+[m[32m        gradient.addColorStop(0, `rgba(255,235,170,${intensity})`);[m[41m[m
[32m+[m[32m        gradient.addColorStop(1, 'rgba(255,235,170,0)');[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        ctx.fillStyle = gradient;[m[41m[m
[32m+[m[32m        ctx.beginPath();[m[41m[m
[32m+[m[32m        ctx.arc(screen.x, screen.y, radius, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m        ctx.fill();[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    ctx.globalCompositeOperation = 'source-over';[m[41m[m
[32m+[m[32m    ctx.restore();[m[41m[m
[32m+[m[32m}[m[41m[m
 [m
 /**[m
  * Draw action spots for debugging (optional)[m
  */[m
[31m-function drawActionSpots() {[m
[32m+[m[32mfunction drawActionSpots() {[m[41m[m
     const spots = getSpots();[m
     spots.forEach(spot => {[m
         if (spot.x !== undefined && spot.y !== undefined && spot.r !== undefined) {[m
[36m@@ -474,193 +482,193 @@[m [mfunction drawActionSpots() {[m
             ctx.stroke();[m
         }[m
     });[m
[31m-}[m
[31m-[m
[31m-function drawCollisionDebug(world, playerPos) {[m
[31m-    const walkableBase = world.walkableBase || [];[m
[31m-    const walkableFromZones = world.walkableFromZones || [];[m
[31m-    const walkableFinal = world.walkableInflated || world.walkableFinal || world.walkable || [];[m
[31m-    const worldObstacles = world.worldObstacles || world.obstaclesFinal || world.obstacles || [];[m
[31m-    const deskColliders = world.deskColliders || [];[m
[31m-    const zones = world.zones || [];[m
[31m-    const spots = getSpots() || [];[m
[31m-    const desks = world.desks || [];[m
[31m-    const floorRect = world.desks?.[0]?.__debug?.floorRect;[m
[31m-    const moveDebug = window.__moveDebug;[m
[31m-    const walkDebug = window.__walkDebug;[m
[31m-    const debugCfg = getConfig()?.debug || {};[m
[31m-    const showWorldObstacles = debugCfg.drawWorldObstacles !== false;[m
[31m-    const showDeskColliders = debugCfg.drawDeskColliders !== false;[m
[31m-[m
[31m-    ctx.save();[m
[31m-[m
[31m-    // Walkable base (green fill)[m
[31m-    ctx.fillStyle = 'rgba(34, 197, 94, 0.18)';[m
[31m-    walkableBase.forEach(area => {[m
[31m-        ctx.fillRect(area.x, area.y, area.w, area.h);[m
[31m-    });[m
[31m-[m
[31m-    // Walkable from zones (blue fill)[m
[31m-    ctx.fillStyle = 'rgba(59, 130, 246, 0.18)';[m
[31m-    walkableFromZones.forEach(area => {[m
[31m-        ctx.fillRect(area.x, area.y, area.w, area.h);[m
[31m-    });[m
[31m-[m
[31m-    // Walkable final (green fill)[m
[31m-    ctx.fillStyle = 'rgba(34, 197, 94, 0.14)';[m
[31m-    walkableFinal.forEach(area => {[m
[31m-        ctx.fillRect(area.x, area.y, area.w, area.h);[m
[31m-    });[m
[31m-[m
[31m-    // Walkable final (green outline)[m
[31m-    ctx.strokeStyle = 'rgba(34, 197, 94, 0.85)';[m
[31m-    ctx.lineWidth = 1.5;[m
[31m-    walkableFinal.forEach(area => {[m
[31m-        ctx.strokeRect(area.x, area.y, area.w, area.h);[m
[31m-    });[m
[31m-[m
[31m-    if (showWorldObstacles) {[m
[31m-        // World obstacles (orange)[m
[31m-        ctx.strokeStyle = 'rgba(251, 146, 60, 0.9)';[m
[31m-        ctx.lineWidth = 2;[m
[31m-        ctx.fillStyle = 'rgba(251, 146, 60, 0.95)';[m
[31m-        ctx.font = '12px sans-serif';[m
[31m-        worldObstacles.forEach(obs => {[m
[31m-            ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);[m
[31m-            if (obs.tag) {[m
[31m-                ctx.fillText(String(obs.tag), obs.x + 4, obs.y + 14);[m
[31m-            }[m
[31m-        });[m
[31m-    }[m
[31m-[m
[31m-    if (showDeskColliders) {[m
[31m-        // Desk colliders (red, semi-transparent)[m
[31m-        ctx.fillStyle = 'rgba(239, 68, 68, 0.22)';[m
[31m-        ctx.strokeStyle = 'rgba(239, 68, 68, 0.9)';[m
[31m-        ctx.lineWidth = 1.5;[m
[31m-        deskColliders.forEach(desk => {[m
[31m-            ctx.fillRect(desk.x, desk.y, desk.w, desk.h);[m
[31m-            ctx.strokeRect(desk.x, desk.y, desk.w, desk.h);[m
[31m-        });[m
[31m-    }[m
[31m-[m
[31m-    if (showDeskColliders) {[m
[31m-        desks.forEach(desk => {[m
[31m-            const pos = desk.posAbs || desk.pos;[m
[31m-            const stand = desk.standPointAbs || desk.standPoint;[m
[31m-            const bounds = desk.boundsAbs || desk.bounds;[m
[31m-[m
[31m-            if (bounds) {[m
[31m-                ctx.strokeStyle = 'rgba(250, 204, 21, 0.9)';[m
[31m-                ctx.lineWidth = 1;[m
[31m-                ctx.strokeRect(bounds.x, bounds.y, bounds.w, bounds.h);[m
[31m-            }[m
[31m-[m
[31m-            if (pos) {[m
[31m-                ctx.fillStyle = 'rgba(34, 197, 94, 0.95)';[m
[31m-                ctx.beginPath();[m
[31m-                ctx.arc(pos.x, pos.y, 3, 0, Math.PI * 2);[m
[31m-                ctx.fill();[m
[31m-            }[m
[31m-[m
[31m-            if (stand) {[m
[31m-                ctx.fillStyle = 'rgba(59, 130, 246, 0.95)';[m
[31m-                ctx.beginPath();[m
[31m-                ctx.arc(stand.x, stand.y, 3, 0, Math.PI * 2);[m
[31m-                ctx.fill();[m
[31m-            }[m
[31m-        });[m
[31m-    }[m
[31m-[m
[31m-    if (showDeskColliders && floorRect) {[m
[31m-        ctx.strokeStyle = 'rgba(168, 85, 247, 0.9)';[m
[31m-        ctx.lineWidth = 1.5;[m
[31m-        ctx.strokeRect(floorRect.x, floorRect.y, floorRect.w, floorRect.h);[m
[31m-    }[m
[31m-[m
[31m-    // Zones (blue outline + label)[m
[31m-    ctx.strokeStyle = 'rgba(59, 130, 246, 0.8)';[m
[31m-    ctx.lineWidth = 1;[m
[31m-    ctx.font = '12px sans-serif';[m
[31m-    ctx.fillStyle = 'rgba(59, 130, 246, 0.9)';[m
[31m-    zones.forEach(zone => {[m
[31m-        const b = zone.bounds;[m
[31m-        if (!b) return;[m
[31m-        ctx.strokeRect(b.x, b.y, b.w, b.h);[m
[31m-        if (zone.id) {[m
[31m-            ctx.fillText(zone.id, b.x + 4, b.y + 12);[m
[31m-        }[m
[31m-    });[m
[31m-[m
[31m-    if (walkDebug?.click) {[m
[31m-        // Click point (yellow)[m
[31m-        ctx.fillStyle = 'rgba(234, 179, 8, 0.9)';[m
[31m-        ctx.beginPath();[m
[31m-        ctx.arc(walkDebug.click.x, walkDebug.click.y, 4, 0, Math.PI * 2);[m
[31m-        ctx.fill();[m
[31m-    }[m
[31m-[m
[31m-    if (walkDebug?.snapped) {[m
[31m-        // Line from player to snapped point[m
[31m-        ctx.strokeStyle = 'rgba(34, 211, 238, 0.8)';[m
[31m-        ctx.lineWidth = 1;[m
[31m-        ctx.beginPath();[m
[31m-        ctx.moveTo(playerPos.x, playerPos.y);[m
[31m-        ctx.lineTo(walkDebug.snapped.x, walkDebug.snapped.y);[m
[31m-        ctx.stroke();[m
[31m-[m
[31m-        // Snapped point (cyan)[m
[31m-        ctx.fillStyle = 'rgba(34, 211, 238, 0.9)';[m
[31m-        ctx.beginPath();[m
[31m-        ctx.arc(walkDebug.snapped.x, walkDebug.snapped.y, 4, 0, Math.PI * 2);[m
[31m-        ctx.fill();[m
[31m-    }[m
[31m-[m
[31m-    if (moveDebug?.click && moveDebug?.goal && moveDebug?.start) {[m
[31m-        // Line from start to goal[m
[31m-        ctx.strokeStyle = 'rgba(16, 185, 129, 0.8)';[m
[31m-        ctx.lineWidth = 1.5;[m
[31m-        ctx.beginPath();[m
[31m-        ctx.moveTo(moveDebug.start.x, moveDebug.start.y);[m
[31m-        ctx.lineTo(moveDebug.goal.x, moveDebug.goal.y);[m
[31m-        ctx.stroke();[m
[31m-[m
[31m-        // Click point (red)[m
[31m-        ctx.fillStyle = 'rgba(239, 68, 68, 0.9)';[m
[31m-        ctx.beginPath();[m
[31m-        ctx.arc(moveDebug.click.x, moveDebug.click.y, 4, 0, Math.PI * 2);[m
[31m-        ctx.fill();[m
[31m-[m
[31m-        // Goal point (green)[m
[31m-        ctx.fillStyle = 'rgba(16, 185, 129, 0.9)';[m
[31m-        ctx.beginPath();[m
[31m-        ctx.arc(moveDebug.goal.x, moveDebug.goal.y, 4, 0, Math.PI * 2);[m
[31m-        ctx.fill();[m
[31m-    }[m
[31m-[m
[31m-    // Spots (blue)[m
[31m-    ctx.strokeStyle = 'rgba(59, 130, 246, 0.85)';[m
[31m-    ctx.lineWidth = 2;[m
[31m-    spots.forEach(spot => {[m
[31m-        if (spot.bounds) {[m
[31m-            ctx.strokeRect(spot.bounds.x, spot.bounds.y, spot.bounds.w, spot.bounds.h);[m
[31m-        } else if (spot.x !== undefined && spot.y !== undefined && spot.r !== undefined) {[m
[31m-            ctx.beginPath();[m
[31m-            ctx.arc(spot.x, spot.y, spot.r, 0, Math.PI * 2);[m
[31m-            ctx.stroke();[m
[31m-        }[m
[31m-    });[m
[31m-[m
[31m-    // Avatar radius (white)[m
[31m-    ctx.strokeStyle = 'rgba(255, 255, 255, 0.85)';[m
[31m-    ctx.lineWidth = 2;[m
[31m-    ctx.beginPath();[m
[31m-    ctx.arc(playerPos.x, playerPos.y, AVATAR_RADIUS, 0, Math.PI * 2);[m
[31m-    ctx.stroke();[m
[31m-[m
[31m-    ctx.restore();[m
[31m-}[m
[31m-[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32mfunction drawCollisionDebug(world, playerPos) {[m[41m[m
[32m+[m[32m    const walkableBase = world.walkableBase || [];[m[41m[m
[32m+[m[32m    const walkableFromZones = world.walkableFromZones || [];[m[41m[m
[32m+[m[32m    const walkableFinal = world.walkableInflated || world.walkableFinal || world.walkable || [];[m[41m[m
[32m+[m[32m    const worldObstacles = world.worldObstacles || world.obstaclesFinal || world.obstacles || [];[m[41m[m
[32m+[m[32m    const deskColliders = world.deskColliders || [];[m[41m[m
[32m+[m[32m    const zones = world.zones || [];[m[41m[m
[32m+[m[32m    const spots = getSpots() || [];[m[41m[m
[32m+[m[32m    const desks = world.desks || [];[m[41m[m
[32m+[m[32m    const floorRect = world.desks?.[0]?.__debug?.floorRect;[m[41m[m
[32m+[m[32m    const moveDebug = window.__moveDebug;[m[41m[m
[32m+[m[32m    const walkDebug = window.__walkDebug;[m[41m[m
[32m+[m[32m    const debugCfg = getConfig()?.debug || {};[m[41m[m
[32m+[m[32m    const showWorldObstacles = debugCfg.drawWorldObstacles !== false;[m[41m[m
[32m+[m[32m    const showDeskColliders = debugCfg.drawDeskColliders !== false;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    ctx.save();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Walkable base (green fill)[m[41m[m
[32m+[m[32m    ctx.fillStyle = 'rgba(34, 197, 94, 0.18)';[m[41m[m
[32m+[m[32m    walkableBase.forEach(area => {[m[41m[m
[32m+[m[32m        ctx.fillRect(area.x, area.y, area.w, area.h);[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Walkable from zones (blue fill)[m[41m[m
[32m+[m[32m    ctx.fillStyle = 'rgba(59, 130, 246, 0.18)';[m[41m[m
[32m+[m[32m    walkableFromZones.forEach(area => {[m[41m[m
[32m+[m[32m        ctx.fillRect(area.x, area.y, area.w, area.h);[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Walkable final (green fill)[m[41m[m
[32m+[m[32m    ctx.fillStyle = 'rgba(34, 197, 94, 0.14)';[m[41m[m
[32m+[m[32m    walkableFinal.forEach(area => {[m[41m[m
[32m+[m[32m        ctx.fillRect(area.x, area.y, area.w, area.h);[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Walkable final (green outline)[m[41m[m
[32m+[m[32m    ctx.strokeStyle = 'rgba(34, 197, 94, 0.85)';[m[41m[m
[32m+[m[32m    ctx.lineWidth = 1.5;[m[41m[m
[32m+[m[32m    walkableFinal.forEach(area => {[m[41m[m
[32m+[m[32m        ctx.strokeRect(area.x, area.y, area.w, area.h);[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (showWorldObstacles) {[m[41m[m
[32m+[m[32m        // World obstacles (orange)[m[41m[m
[32m+[m[32m        ctx.strokeStyle = 'rgba(251, 146, 60, 0.9)';[m[41m[m
[32m+[m[32m        ctx.lineWidth = 2;[m[41m[m
[32m+[m[32m        ctx.fillStyle = 'rgba(251, 146, 60, 0.95)';[m[41m[m
[32m+[m[32m        ctx.font = '12px sans-serif';[m[41m[m
[32m+[m[32m        worldObstacles.forEach(obs => {[m[41m[m
[32m+[m[32m            ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);[m[41m[m
[32m+[m[32m            if (obs.tag) {[m[41m[m
[32m+[m[32m                ctx.fillText(String(obs.tag), obs.x + 4, obs.y + 14);[m[41m[m
[32m+[m[32m            }[m[41m[m
[32m+[m[32m        });[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (showDeskColliders) {[m[41m[m
[32m+[m[32m        // Desk colliders (red, semi-transparent)[m[41m[m
[32m+[m[32m        ctx.fillStyle = 'rgba(239, 68, 68, 0.22)';[m[41m[m
[32m+[m[32m        ctx.strokeStyle = 'rgba(239, 68, 68, 0.9)';[m[41m[m
[32m+[m[32m        ctx.lineWidth = 1.5;[m[41m[m
[32m+[m[32m        deskColliders.forEach(desk => {[m[41m[m
[32m+[m[32m            ctx.fillRect(desk.x, desk.y, desk.w, desk.h);[m[41m[m
[32m+[m[32m            ctx.strokeRect(desk.x, desk.y, desk.w, desk.h);[m[41m[m
[32m+[m[32m        });[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (showDeskColliders) {[m[41m[m
[32m+[m[32m        desks.forEach(desk => {[m[41m[m
[32m+[m[32m            const pos = desk.posAbs || desk.pos;[m[41m[m
[32m+[m[32m            const stand = desk.standPointAbs || desk.standPoint;[m[41m[m
[32m+[m[32m            const bounds = desk.boundsAbs || desk.bounds;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m            if (bounds) {[m[41m[m
[32m+[m[32m                ctx.strokeStyle = 'rgba(250, 204, 21, 0.9)';[m[41m[m
[32m+[m[32m                ctx.lineWidth = 1;[m[41m[m
[32m+[m[32m                ctx.strokeRect(bounds.x, bounds.y, bounds.w, bounds.h);[m[41m[m
[32m+[m[32m            }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m            if (pos) {[m[41m[m
[32m+[m[32m                ctx.fillStyle = 'rgba(34, 197, 94, 0.95)';[m[41m[m
[32m+[m[32m                ctx.beginPath();[m[41m[m
[32m+[m[32m                ctx.arc(pos.x, pos.y, 3, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m                ctx.fill();[m[41m[m
[32m+[m[32m            }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m            if (stand) {[m[41m[m
[32m+[m[32m                ctx.fillStyle = 'rgba(59, 130, 246, 0.95)';[m[41m[m
[32m+[m[32m                ctx.beginPath();[m[41m[m
[32m+[m[32m                ctx.arc(stand.x, stand.y, 3, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m                ctx.fill();[m[41m[m
[32m+[m[32m            }[m[41m[m
[32m+[m[32m        });[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (showDeskColliders && floorRect) {[m[41m[m
[32m+[m[32m        ctx.strokeStyle = 'rgba(168, 85, 247, 0.9)';[m[41m[m
[32m+[m[32m        ctx.lineWidth = 1.5;[m[41m[m
[32m+[m[32m        ctx.strokeRect(floorRect.x, floorRect.y, floorRect.w, floorRect.h);[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Zones (blue outline + label)[m[41m[m
[32m+[m[32m    ctx.strokeStyle = 'rgba(59, 130, 246, 0.8)';[m[41m[m
[32m+[m[32m    ctx.lineWidth = 1;[m[41m[m
[32m+[m[32m    ctx.font = '12px sans-serif';[m[41m[m
[32m+[m[32m    ctx.fillStyle = 'rgba(59, 130, 246, 0.9)';[m[41m[m
[32m+[m[32m    zones.forEach(zone => {[m[41m[m
[32m+[m[32m        const b = zone.bounds;[m[41m[m
[32m+[m[32m        if (!b) return;[m[41m[m
[32m+[m[32m        ctx.strokeRect(b.x, b.y, b.w, b.h);[m[41m[m
[32m+[m[32m        if (zone.id) {[m[41m[m
[32m+[m[32m            ctx.fillText(zone.id, b.x + 4, b.y + 12);[m[41m[m
[32m+[m[32m        }[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (walkDebug?.click) {[m[41m[m
[32m+[m[32m        // Click point (yellow)[m[41m[m
[32m+[m[32m        ctx.fillStyle = 'rgba(234, 179, 8, 0.9)';[m[41m[m
[32m+[m[32m        ctx.beginPath();[m[41m[m
[32m+[m[32m        ctx.arc(walkDebug.click.x, walkDebug.click.y, 4, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m        ctx.fill();[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (walkDebug?.snapped) {[m[41m[m
[32m+[m[32m        // Line from player to snapped point[m[41m[m
[32m+[m[32m        ctx.strokeStyle = 'rgba(34, 211, 238, 0.8)';[m[41m[m
[32m+[m[32m        ctx.lineWidth = 1;[m[41m[m
[32m+[m[32m        ctx.beginPath();[m[41m[m
[32m+[m[32m        ctx.moveTo(playerPos.x, playerPos.y);[m[41m[m
[32m+[m[32m        ctx.lineTo(walkDebug.snapped.x, walkDebug.snapped.y);[m[41m[m
[32m+[m[32m        ctx.stroke();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        // Snapped point (cyan)[m[41m[m
[32m+[m[32m        ctx.fillStyle = 'rgba(34, 211, 238, 0.9)';[m[41m[m
[32m+[m[32m        ctx.beginPath();[m[41m[m
[32m+[m[32m        ctx.arc(walkDebug.snapped.x, walkDebug.snapped.y, 4, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m        ctx.fill();[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (moveDebug?.click && moveDebug?.goal && moveDebug?.start) {[m[41m[m
[32m+[m[32m        // Line from start to goal[m[41m[m
[32m+[m[32m        ctx.strokeStyle = 'rgba(16, 185, 129, 0.8)';[m[41m[m
[32m+[m[32m        ctx.lineWidth = 1.5;[m[41m[m
[32m+[m[32m        ctx.beginPath();[m[41m[m
[32m+[m[32m        ctx.moveTo(moveDebug.start.x, moveDebug.start.y);[m[41m[m
[32m+[m[32m        ctx.lineTo(moveDebug.goal.x, moveDebug.goal.y);[m[41m[m
[32m+[m[32m        ctx.stroke();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        // Click point (red)[m[41m[m
[32m+[m[32m        ctx.fillStyle = 'rgba(239, 68, 68, 0.9)';[m[41m[m
[32m+[m[32m        ctx.beginPath();[m[41m[m
[32m+[m[32m        ctx.arc(moveDebug.click.x, moveDebug.click.y, 4, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m        ctx.fill();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        // Goal point (green)[m[41m[m
[32m+[m[32m        ctx.fillStyle = 'rgba(16, 185, 129, 0.9)';[m[41m[m
[32m+[m[32m        ctx.beginPath();[m[41m[m
[32m+[m[32m        ctx.arc(moveDebug.goal.x, moveDebug.goal.y, 4, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m        ctx.fill();[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Spots (blue)[m[41m[m
[32m+[m[32m    ctx.strokeStyle = 'rgba(59, 130, 246, 0.85)';[m[41m[m
[32m+[m[32m    ctx.lineWidth = 2;[m[41m[m
[32m+[m[32m    spots.forEach(spot => {[m[41m[m
[32m+[m[32m        if (spot.bounds) {[m[41m[m
[32m+[m[32m            ctx.strokeRect(spot.bounds.x, spot.bounds.y, spot.bounds.w, spot.bounds.h);[m[41m[m
[32m+[m[32m        } else if (spot.x !== undefined && spot.y !== undefined && spot.r !== undefined) {[m[41m[m
[32m+[m[32m            ctx.beginPath();[m[41m[m
[32m+[m[32m            ctx.arc(spot.x, spot.y, spot.r, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m            ctx.stroke();[m[41m[m
[32m+[m[32m        }[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Avatar radius (white)[m[41m[m
[32m+[m[32m    ctx.strokeStyle = 'rgba(255, 255, 255, 0.85)';[m[41m[m
[32m+[m[32m    ctx.lineWidth = 2;[m[41m[m
[32m+[m[32m    ctx.beginPath();[m[41m[m
[32m+[m[32m    ctx.arc(playerPos.x, playerPos.y, AVATAR_RADIUS, 0, Math.PI * 2);[m[41m[m
[32m+[m[32m    ctx.stroke();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    ctx.restore();[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
 /**[m
  * Draw obstacles with pixel style[m
  */[m
[36m@@ -798,6 +806,81 @@[m [mfunction drawClickMarkerPixel(x, y, startTime) {[m
     ctx.restore();[m
 }[m
 [m
[32m+[m[32m/**[m[41m[m
[32m+[m[32m * Draw occupant labels on desks[m[41m[m
[32m+[m[32m * @param {Array} desks - List of desk objects[m[41m[m
[32m+[m[32m * @param {Map} peopleMap - Map of actorId -> person object (from getPeople())[m[41m[m
[32m+[m[32m */[m[41m[m
[32m+[m[32mfunction drawDeskOccupantLabels(desks, peopleMap) {[m
[32m+[m[32m    if (!desks || !peopleMap || !(peopleMap instanceof Map)) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Build occupant map: deskId -> person[m[41m[m
[32m+[m[32m    const occupantMap = new Map();[m[41m[m
[32m+[m[32m    for (const [actorId, p] of peopleMap) {[m
[32m+[m[32m        const deskId = p?.seatLockedDeskId || p?.seatedDeskId;[m
[32m+[m[32m        if (deskId) {[m
[32m+[m[32m            occupantMap.set(deskId, p);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m[41m[m
[32m+[m[32m    desks.forEach(desk => {[m[41m[m
[32m+[m[32m        const occupant = occupantMap.get(desk.id);[m[41m[m
[32m+[m[32m        if (!occupant) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        const pos = desk.pos || desk.posAbs;[m[41m[m
[32m+[m[32m        if (!pos) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        const label = (occupant.displayName || '??').slice(0, 2).toUpperCase();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        // Draw label background + text[m[41m[m
[32m+[m[32m        ctx.save();[m[41m[m
[32m+[m[32m        ctx.fillStyle = 'rgba(0,0,0,0.65)';[m[41m[m
[32m+[m[32m        ctx.beginPath();[m[41m[m
[32m+[m[32m        ctx.roundRect(pos.x - 14, pos.y - 30, 28, 16, 4);[m[41m[m
[32m+[m[32m        ctx.fill();[m[41m[m
[32m+[m[41m[m
[32m+[m[32m        ctx.fillStyle = '#fff';[m[41m[m
[32m+[m[32m        ctx.font = 'bold 10px sans-serif';[m[41m[m
[32m+[m[32m        ctx.textAlign = 'center';[m[41m[m
[32m+[m[32m        ctx.textBaseline = 'middle';[m[41m[m
[32m+[m[32m        ctx.fillText(label, pos.x, pos.y - 22);[m[41m[m
[32m+[m[32m        ctx.restore();[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction drawCallBadge(x, y, callStatus, zoom = 1) {[m
[32m+[m[32m    if (!callStatus || callStatus === 'idle') return;[m
[32m+[m
[32m+[m[32m    const statusColor = callStatus === 'in_call'[m
[32m+[m[32m        ? '#16a34a'[m
[32m+[m[32m        : (callStatus === 'ringing' ? '#f59e0b' : '#0ea5e9');[m
[32m+[m
[32m+[m[32m    const radius = Math.max(6, 6 / Math.max(0.7, zoom));[m
[32m+[m[32m    const cx = x + 18 / Math.max(0.7, zoom);[m
[32m+[m[32m    const cy = y - 28 / Math.max(0.7, zoom);[m
[32m+[m
[32m+[m[32m    ctx.save();[m
[32m+[m[32m    ctx.fillStyle = statusColor;[m
[32m+[m[32m    ctx.beginPath();[m
[32m+[m[32m    ctx.arc(cx, cy, radius, 0, Math.PI * 2);[m
[32m+[m[32m    ctx.fill();[m
[32m+[m
[32m+[m[32m    if (callStatus === 'in_call') {[m
[32m+[m[32m        ctx.strokeStyle = 'rgba(22,163,74,0.45)';[m
[32m+[m[32m        ctx.lineWidth = Math.max(1, 2 / Math.max(0.7, zoom));[m
[32m+[m[32m        ctx.beginPath();[m
[32m+[m[32m        ctx.arc(cx, cy, radius + 3 / Math.max(0.7, zoom), 0, Math.PI * 2);[m
[32m+[m[32m        ctx.stroke();[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    ctx.fillStyle = '#ffffff';[m
[32m+[m[32m    ctx.font = `${Math.max(8, 8 / Math.max(0.7, zoom))}px sans-serif`;[m
[32m+[m[32m    ctx.textAlign = 'center';[m
[32m+[m[32m    ctx.textBaseline = 'middle';[m
[32m+[m[32m    ctx.fillText('‚òé', cx, cy + 0.5);[m
[32m+[m[32m    ctx.restore();[m
[32m+[m[32m}[m
[32m+[m[41m[m
 /**[m
  * Draw rooms with styled borders[m
  */[m
[36m@@ -1225,49 +1308,49 @@[m [mfunction drawAvatar(x, y, name, status, color, isPlayer) {[m
 /**[m
  * Render minimap[m
  */[m
[31m-export function renderMinimap(minimapCanvas, playerPos, otherPlayers = []) {[m
[31m-    const minimapCtx = minimapCanvas.getContext('2d');[m
[31m-    const world = getWorldModel();[m
[31m-    if (!world || !minimapCtx) return;[m
[31m-[m
[31m-    if (!window.__minimapDebugOnce) {[m
[31m-        window.__minimapDebugOnce = true;[m
[31m-        console.log('[minimap debug]', {[m
[31m-            walkable0: (world.walkable || world.walkableFinal || [])[0],[m
[31m-            obstacle0: (world.obstacles || [])[0],[m
[31m-            zone0: (world.zones || [])[0][m
[31m-        });[m
[31m-    }[m
[31m-[m
[31m-    const scale = minimapCanvas.width / world.size.w;[m
[31m-[m
[31m-    function pickRect(item) {[m
[31m-        if (!item) return null;[m
[31m-        if (item.rect && item.rect.x != null) return item.rect;[m
[31m-        if (item.bounds && item.bounds.x != null) return item.bounds;[m
[31m-        if (item.x != null) return item;[m
[31m-        return null;[m
[31m-    }[m
[31m-[m
[31m-    // Clear[m
[31m-    minimapCtx.fillStyle = getCssVar('--color-bgSecondary') || '#e2e8f0';[m
[31m-    minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);[m
[31m-[m
[31m-    // Draw zones[m
[31m-    world.zones.forEach(zone => {[m
[31m-        const b = pickRect(zone);[m
[31m-        if (!b) return;[m
[31m-        minimapCtx.fillStyle = getCssVar('--color-mapZone') || 'rgba(59, 130, 246, 0.2)';[m
[31m-        minimapCtx.fillRect(b.x * scale, b.y * scale, b.w * scale, b.h * scale);[m
[31m-    });[m
[31m-[m
[31m-    // Draw obstacles[m
[31m-    minimapCtx.fillStyle = getCssVar('--color-mapWall') || '#64748b';[m
[31m-    world.obstacles.forEach(obs => {[m
[31m-        const b = pickRect(obs);[m
[31m-        if (!b) return;[m
[31m-        minimapCtx.fillRect(b.x * scale, b.y * scale, b.w * scale, b.h * scale);[m
[31m-    });[m
[32m+[m[32mexport function renderMinimap(minimapCanvas, playerPos, otherPlayers = []) {[m[41m[m
[32m+[m[32m    const minimapCtx = minimapCanvas.getContext('2d');[m[41m[m
[32m+[m[32m    const world = getWorldModel();[m[41m[m
[32m+[m[32m    if (!world || !minimapCtx) return;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    if (!window.__minimapDebugOnce) {[m[41m[m
[32m+[m[32m        window.__minimapDebugOnce = true;[m[41m[m
[32m+[m[32m        console.log('[minimap debug]', {[m[41m[m
[32m+[m[32m            walkable0: (world.walkable || world.walkableFinal || [])[0],[m[41m[m
[32m+[m[32m            obstacle0: (world.obstacles || [])[0],[m[41m[m
[32m+[m[32m            zone0: (world.zones || [])[0][m[41m[m
[32m+[m[32m        });[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    const scale = minimapCanvas.width / world.size.w;[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    function pickRect(item) {[m[41m[m
[32m+[m[32m        if (!item) return null;[m[41m[m
[32m+[m[32m        if (item.rect && item.rect.x != null) return item.rect;[m[41m[m
[32m+[m[32m        if (item.bounds && item.bounds.x != null) return item.bounds;[m[41m[m
[32m+[m[32m        if (item.x != null) return item;[m[41m[m
[32m+[m[32m        return null;[m[41m[m
[32m+[m[32m    }[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Clear[m[41m[m
[32m+[m[32m    minimapCtx.fillStyle = getCssVar('--color-bgSecondary') || '#e2e8f0';[m[41m[m
[32m+[m[32m    minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Draw zones[m[41m[m
[32m+[m[32m    world.zones.forEach(zone => {[m[41m[m
[32m+[m[32m        const b = pickRect(zone);[m[41m[m
[32m+[m[32m        if (!b) return;[m[41m[m
[32m+[m[32m        minimapCtx.fillStyle = getCssVar('--color-mapZone') || 'rgba(59, 130, 246, 0.2)';[m[41m[m
[32m+[m[32m        minimapCtx.fillRect(b.x * scale, b.y * scale, b.w * scale, b.h * scale);[m[41m[m
[32m+[m[32m    });[m[41m[m
[32m+[m[41m[m
[32m+[m[32m    // Draw obstacles[m[41m[m
[32m+[m[32m    minimapCtx.fillStyle = getCssVar('--color-mapWall') || '#64748b';[m[41m[m
[32m+[m[32m    world.obstacles.forEach(obs => {[m[41m[m
[32m+[m[32m        const b = pickRect(obs);[m[41m[m
[32m+[m[32m        if (!b) return;[m[41m[m
[32m+[m[32m        minimapCtx.fillRect(b.x * scale, b.y * scale, b.w * scale, b.h * scale);[m[41m[m
[32m+[m[32m    });[m[41m[m
 [m
     // Draw other players[m
     otherPlayers.forEach(p => {[m
[36m@@ -1315,11 +1398,11 @@[m [mexport function setShowDebugSpots(enabled) {[m
 /**[m
  * Draw debug spots with IDs and bounds[m
  */[m
[31m-function drawDebugSpots() {[m
[31m-    const spots = getSpots();[m
[31m-    ctx.save();[m
[31m-    ctx.lineWidth = 2;[m
[31m-    ctx.font = '10px monospace';[m
[32m+[m[32mfunction drawDebugSpots() {[m[41m[m
[32m+[m[32m    const spots = getSpots();[m[41m[m
[32m+[m[32m    ctx.save();[m[41m[m
[32m+[m[32m    ctx.lineWidth = 2;[m[41m[m
[32m+[m[32m    ctx.font = '10px monospace';[m[41m[m
     ctx.textAlign = 'left';[m
     ctx.textBaseline = 'top';[m
 [m
[36m@@ -1354,8 +1437,8 @@[m [mfunction drawDebugSpots() {[m
         ctx.stroke();[m
 [m
         // Draw Label Background[m
[31m-        const baseLabel = spot.label || spot.id;[m
[31m-        const labelText = `${baseLabel} (P:${spot.priority || 0})`;[m
[32m+[m[32m        const baseLabel = spot.label || spot.id;[m[41m[m
[32m+[m[32m        const labelText = `${baseLabel} (P:${spot.priority || 0})`;[m[41m[m
         const metrics = ctx.measureText(labelText);[m
         ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';[m
         ctx.fillRect(labelX, labelY - 14, metrics.width + 4, 14);[m
[1mdiff --git a/src/world/movement.js b/src/world/movement.js[m
[1mindex 1452154..8dd13a5 100644[m
[1m--- a/src/world/movement.js[m
[1m+++ b/src/world/movement.js[m
[36m@@ -17,10 +17,11 @@[m [mimport { getWorldModel } from './mapLoader.js';[m
 const MOVE_SPEED = 160; // pixels per second[m
 const DEBUG_COLLISION = false; // Set to true to bypass collision for testing[m
 [m
[31m-let targetPos = null;[m
[31m-let currentPos = { x: 260, y: 260 };[m
[31m-let facing = 'down';[m
[32m+[m[32mlet targetPos = null;[m
[32m+[m[32mlet currentPos = { x: 260, y: 260 };[m
[32m+[m[32mlet facing = 'down';[m
 let isMoving = false;[m
[32m+[m[32mlet movementLocked = false;[m
 let onMoveCallback = null;[m
 let lastLogTime = 0;[m
 let lastMoveMeta = null;[m
[36m@@ -31,19 +32,26 @@[m [mexport let lastPathResult = null;[m
 /**[m
  * Initialize movement system[m
  */[m
[31m-export function initMovement(startPos, onMove) {[m
[31m-    currentPos = { ...startPos };[m
[31m-    targetPos = null;[m
[31m-    isMoving = false;[m
[31m-    onMoveCallback = onMove;[m
[31m-    console.log('[MOVE] initMovement', startPos);[m
[31m-}[m
[32m+[m[32mexport function initMovement(startPos, onMove) {[m
[32m+[m[32m    currentPos = { ...startPos };[m
[32m+[m[32m    targetPos = null;[m
[32m+[m[32m    isMoving = false;[m
[32m+[m[32m    movementLocked = false;[m
[32m+[m[32m    onMoveCallback = onMove;[m
[32m+[m[32m    console.log('[MOVE] initMovement', startPos);[m
[32m+[m[32m}[m
 [m
 /**[m
  * Set movement target (click destination)[m
  * Uses findPath for proper nearby search and reason tracking[m
  */[m
 export function setMoveTarget(x, y) {[m
[32m+[m[32m    if (movementLocked) {[m
[32m+[m[32m        console.log('[MOVE] ignored setMoveTarget because movementLocked');[m
[32m+[m[32m        stopMoving();[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
     console.log('[MOVE] setMoveTarget called', { requested: { x: Math.round(x), y: Math.round(y) } });[m
 [m
     const world = getWorldModel();[m
[36m@@ -197,8 +205,13 @@[m [mexport function setMoveTarget(x, y) {[m
  * @param {number} deltaMs - Time since last update in ms[m
  * @returns {{pos: {x, y}, facing: string, moving: boolean}}[m
  */[m
[31m-export function updateMovement(deltaMs) {[m
[31m-    const now = Date.now();[m
[32m+[m[32mexport function updateMovement(deltaMs) {[m
[32m+[m[32m    if (movementLocked) {[m
[32m+[m[32m        stopMoving();[m
[32m+[m[32m        return { pos: currentPos, facing, moving: false };[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const now = Date.now();[m
 [m
     // Log every 500ms for debugging[m
     if (now - lastLogTime > 500) {[m
[36m@@ -400,8 +413,13 @@[m [mexport function setPosition(x, y) {[m
 /**[m
  * Handle keyboard movement[m
  */[m
[31m-export function handleKeyboardMove(keys, deltaMs) {[m
[31m-    const deltaSeconds = deltaMs / 1000;[m
[32m+[m[32mexport function handleKeyboardMove(keys, deltaMs) {[m
[32m+[m[32m    if (movementLocked) {[m
[32m+[m[32m        stopMoving();[m
[32m+[m[32m        return { pos: currentPos, facing, moving: false };[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const deltaSeconds = deltaMs / 1000;[m
     const moveDistance = MOVE_SPEED * deltaSeconds;[m
 [m
     let dx = 0;[m
[36m@@ -456,9 +474,20 @@[m [mexport function getIsMoving() {[m
     return isMoving;[m
 }[m
 [m
[31m-export function getTarget() {[m
[31m-    return targetPos ? { ...targetPos } : null;[m
[31m-}[m
[32m+[m[32mexport function getTarget() {[m
[32m+[m[32m    return targetPos ? { ...targetPos } : null;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport function setMovementLocked(locked) {[m
[32m+[m[32m    movementLocked = !!locked;[m
[32m+[m[32m    if (movementLocked) {[m
[32m+[m[32m        stopMoving();[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport function isMovementLocked() {[m
[32m+[m[32m    return movementLocked;[m
[32m+[m[32m}[m
 [m
 // Debug: Force move position directly[m
 export function forceMove(dx, dy) {[m
[1mdiff --git a/src/world/spotLogic.js b/src/world/spotLogic.js[m
[1mindex cd869a5..fb8d347 100644[m
[1m--- a/src/world/spotLogic.js[m
[1m+++ b/src/world/spotLogic.js[m
[36m@@ -150,22 +150,27 @@[m [mexport function getRoomChatChannel(insideSpotId, seatedDeskId, areaId) {[m
     return `chat:room:${areaId}`;[m
 }[m
 [m
[31m-/**[m
[31m- * Get location label for display[m
[31m- * @param {string|null} insideSpotId [m
[31m- * @param {string|null} seatedDeskId [m
[31m- * @param {string} areaId [m
[31m- * @returns {string}[m
[31m- */[m
[31m-export function getLocationLabel(insideSpotId, seatedDeskId, areaId) {[m
[31m-    if (insideSpotId) {[m
[31m-        const spot = getSpotById(insideSpotId);[m
[31m-        return spot ? spot.label : insideSpotId;[m
[31m-    }[m
[31m-[m
[31m-    if (seatedDeskId) {[m
[31m-        return `Desk ${seatedDeskId.replace('desk:', '')}`;[m
[31m-    }[m
[31m-[m
[31m-    return areaId.replace('area:', '');[m
[31m-}[m
[32m+[m[32m/**[m
[32m+[m[32m * Get location label for display[m
[32m+[m[32m * @param {string|null} insideSpotId[m[41m [m
[32m+[m[32m * @param {string|null} claimedDeskId[m[41m [m
[32m+[m[32m * @param {string} areaId[m[41m [m
[32m+[m[32m * @param {string|null} seatLockedDeskId[m
[32m+[m[32m * @returns {string}[m
[32m+[m[32m */[m
[32m+[m[32mexport function getLocationLabel(insideSpotId, claimedDeskId, areaId, seatLockedDeskId = null) {[m
[32m+[m[32m    if (insideSpotId) {[m
[32m+[m[32m        const spot = getSpotById(insideSpotId);[m
[32m+[m[32m        return spot ? spot.label : insideSpotId;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (seatLockedDeskId) {[m
[32m+[m[32m        return `„Éá„Çπ„ÇØ ${seatLockedDeskId.replace('desk:', '')} „Å´ÁùÄÂ∏≠‰∏≠`;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (claimedDeskId) {[m
[32m+[m[32m        return `„Éá„Çπ„ÇØ ${claimedDeskId.replace('desk:', '')} „ÇíÁ¢∫‰øù‰∏≠`;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return areaId.replace('area:', '');[m
[32m+[m[32m}[m
[1mdiff --git a/styles/layout.css b/styles/layout.css[m
[1mindex d9ed160..cc88435 100644[m
[1m--- a/styles/layout.css[m
[1m+++ b/styles/layout.css[m
[36m@@ -46,11 +46,11 @@[m
     gap: 4px;[m
 }[m
 [m
[31m-#menubar .nav-btn {[m
[31m-    display: flex;[m
[31m-    align-items: center;[m
[31m-    gap: 6px;[m
[31m-    padding: 8px 12px;[m
[32m+[m[32m#menubar .nav-btn {[m
[32m+[m[32m    display: flex;[m
[32m+[m[32m    align-items: center;[m
[32m+[m[32m    gap: 6px;[m
[32m+[m[32m    padding: 8px 12px;[m
     border-radius: 6px;[m
     color: var(--color-textSecondary);[m
     transition: all 0.2s;[m
[36m@@ -200,6 +200,24 @@[m
 #context-panel .panel-actions {[m
     display: flex;[m
     gap: 8px;[m
[32m+[m[32m    flex-wrap: wrap;[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32m#context-panel {[m[41m[m
[32m+[m[32m    flex-wrap: wrap;[m[41m[m
[32m+[m[32m    max-width: min(92vw, 720px);[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32m.context-status {[m[41m[m
[32m+[m[32m    font-size: 13px;[m[41m[m
[32m+[m[32m    color: var(--color-textSecondary);[m[41m[m
[32m+[m[32m    margin-left: 8px;[m[41m[m
[32m+[m[32m}[m[41m[m
[32m+[m[41m[m
[32m+[m[32m.context-substatus {[m[41m[m
[32m+[m[32m    font-size: 12px;[m[41m[m
[32m+[m[32m    color: var(--color-textMuted, #888);[m[41m[m
[32m+[m[32m    margin-left: 8px;[m[41m[m
 }[m
 [m
 .btn {[m
[36m@@ -391,10 +409,81 @@[m
     margin-left: 8px;[m
 }[m
 [m
[31m-.chat-text {[m
[31m-    color: var(--color-textSecondary);[m
[31m-    word-wrap: break-word;[m
[31m-}[m
[32m+[m[32m.chat-text {[m
[32m+[m[32m    color: var(--color-textSecondary);[m
[32m+[m[32m    word-wrap: break-word;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m#menubar .nav-btn[data-drawer="chat"] {[m
[32m+[m[32m    position: relative;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m#menubar .chat-unread-dot {[m
[32m+[m[32m    position: absolute;[m
[32m+[m[32m    top: 6px;[m
[32m+[m[32m    right: 6px;[m
[32m+[m[32m    width: 8px;[m
[32m+[m[32m    height: 8px;[m
[32m+[m[32m    border-radius: 999px;[m
[32m+[m[32m    background: var(--color-danger);[m
[32m+[m[32m    display: none;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m#menubar .chat-unread-dot.visible {[m
[32m+[m[32m    display: block;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.chat-empty {[m
[32m+[m[32m    margin: 24px 8px;[m
[32m+[m[32m    color: var(--color-textMuted);[m
[32m+[m[32m    font-size: 13px;[m
[32m+[m[32m    text-align: center;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.chat-section-title {[m
[32m+[m[32m    margin: 10px 4px 2px;[m
[32m+[m[32m    font-size: 12px;[m
[32m+[m[32m    font-weight: 700;[m
[32m+[m[32m    letter-spacing: 0.02em;[m
[32m+[m[32m    color: var(--color-textSecondary);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.chat-thread-item {[m
[32m+[m[32m    width: 100%;[m
[32m+[m[32m    text-align: left;[m
[32m+[m[32m    border: 1px solid var(--color-border);[m
[32m+[m[32m    border-radius: 10px;[m
[32m+[m[32m    padding: 10px 12px;[m
[32m+[m[32m    background: var(--color-bgPrimary);[m
[32m+[m[32m    color: var(--color-text);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.chat-thread-item:hover {[m
[32m+[m[32m    background: var(--color-bgSecondary);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.chat-thread-header {[m
[32m+[m[32m    display: flex;[m
[32m+[m[32m    justify-content: space-between;[m
[32m+[m[32m    align-items: center;[m
[32m+[m[32m    gap: 8px;[m
[32m+[m[32m    margin-bottom: 4px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.chat-thread-preview {[m
[32m+[m[32m    color: var(--color-textSecondary);[m
[32m+[m[32m    font-size: 12px;[m
[32m+[m[32m    overflow: hidden;[m
[32m+[m[32m    text-overflow: ellipsis;[m
[32m+[m[32m    white-space: nowrap;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.chat-thread-unread {[m
[32m+[m[32m    margin-top: 6px;[m
[32m+[m[32m    font-size: 11px;[m
[32m+[m[32m    color: #dc2626;[m
[32m+[m[32m    font-weight: 600;[m
[32m+[m[32m}[m
 [m
 .chat-input-container {[m
     padding: 12px 16px;[m
[36m@@ -460,23 +549,40 @@[m
     background: var(--color-danger);[m
 }[m
 [m
[31m-.person-info {[m
[31m-    flex: 1;[m
[31m-    min-width: 0;[m
[31m-}[m
[31m-[m
[31m-.person-name {[m
[31m-    font-weight: 600;[m
[31m-    color: var(--color-text);[m
[31m-    white-space: nowrap;[m
[31m-    overflow: hidden;[m
[31m-    text-overflow: ellipsis;[m
[31m-}[m
[31m-[m
[31m-.person-location {[m
[31m-    font-size: 12px;[m
[31m-    color: var(--color-textMuted);[m
[31m-}[m
[32m+[m[32m.person-info {[m
[32m+[m[32m    flex: 1;[m
[32m+[m[32m    min-width: 0;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.person-name-row {[m
[32m+[m[32m    display: flex;[m
[32m+[m[32m    align-items: center;[m
[32m+[m[32m    gap: 8px;[m
[32m+[m[32m    min-width: 0;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.person-name {[m
[32m+[m[32m    font-weight: 600;[m
[32m+[m[32m    color: var(--color-text);[m
[32m+[m[32m    white-space: nowrap;[m
[32m+[m[32m    overflow: hidden;[m
[32m+[m[32m    text-overflow: ellipsis;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.person-call-badge {[m
[32m+[m[32m    font-size: 11px;[m
[32m+[m[32m    color: var(--color-primary);[m
[32m+[m[32m    background: color-mix(in srgb, var(--color-primary) 12%, transparent);[m
[32m+[m[32m    border: 1px solid color-mix(in srgb, var(--color-primary) 25%, transparent);[m
[32m+[m[32m    border-radius: 999px;[m
[32m+[m[32m    padding: 1px 6px;[m
[32m+[m[32m    white-space: nowrap;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.person-location {[m
[32m+[m[32m    font-size: 12px;[m
[32m+[m[32m    color: var(--color-textMuted);[m
[32m+[m[32m}[m
 [m
 .person-actions {[m
     display: flex;[m
[36m@@ -1642,10 +1748,18 @@[m
     color: var(--color-accent);[m
 }[m
 [m
[31m-.admin-status.error {[m
[31m-    background: rgba(244, 67, 54, 0.1);[m
[31m-    color: var(--color-danger);[m
[31m-}[m
[32m+[m[32m.admin-status.error {[m
[32m+[m[32m    background: rgba(244, 67, 54, 0.1);[m
[32m+[m[32m    color: var(--color-danger);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m#debug-hud {[m
[32m+[m[32m    display: none;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mbody.debug-hud-on #debug-hud {[m
[32m+[m[32m    display: block !important;[m
[32m+[m[32m}[m
 [m
 /* ========== Spot Modal Rich Content ========== */[m
 .spot-link-header {[m
[36m@@ -1727,4 +1841,4 @@[m
 [m
 .bulletin-item.expanded .bulletin-body {[m
     display: block;[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
