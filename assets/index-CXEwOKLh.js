(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();let be=null,Bt=null;async function Ri(){if(Bt)return Bt;const e=await fetch("./data/config/app.config.json");if(!e.ok)throw new Error("Failed to load config");return Bt=await e.json(),Bt}function Tn(){return Bt}async function $l(){if(be)return be;const e=await Ri();return be=supabase.createClient(e.supabase.url,e.supabase.anonKey),be}function T(){return be}function Pl(e){if(!be)return;const t=e?String(e):"";try{be.rest?.headers&&(be.rest.headers["x-actor-id"]=t)}catch(n){console.warn("[supabase] failed to set x-actor-id on rest headers",n)}try{if(be.realtime){const n=be.realtime.headers||{};be.realtime.headers={...n,"x-actor-id":t}}}catch(n){console.warn("[supabase] failed to set x-actor-id on realtime headers",n)}}async function Rl(){const e=T();if(!e)return null;const{data:{session:t}}=await e.auth.getSession();return t}async function Hl(e){const t=T(),n=Tn(),{data:a,error:o}=await t.auth.signInWithPassword({email:n.supabase.sharedEmail,password:e});if(o)throw o;return a}function jl(e){if(!e||typeof e!="string")return{valid:!1,error:"ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"};const t=e.trim();return t.length===0?{valid:!1,error:"ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}:t.length>20?{valid:!1,error:"ÂêçÂâç„ÅØ20ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}:/[<>\"\'&]/.test(t)?{valid:!1,error:"‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô"}:{valid:!0,value:t}}function Wl(e){return!e||typeof e!="string"?{valid:!1,error:"„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}:e.length===0?{valid:!1,error:"„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}:{valid:!0,value:e}}function zl(e){if(!e||typeof e!="string")return{valid:!1};const t=e.trim();return t.length===0||t.length>500?{valid:!1}:{valid:!0,value:t}}let ba=null;function Fl(e){ba=e;const t=document.getElementById("password-submit"),n=document.getElementById("password-input");t.addEventListener("click",zo),n.addEventListener("keypress",a=>{a.key==="Enter"&&zo()})}async function zo(){const e=document.getElementById("password-input"),t=document.getElementById("password-save"),n=document.getElementById("password-error"),a=document.getElementById("password-submit");n.classList.add("hidden"),n.textContent="";const o=Wl(e.value);if(!o.valid){n.textContent=o.error,n.classList.remove("hidden");return}a.disabled=!0,a.textContent="„É≠„Ç∞„Ç§„É≥‰∏≠...";try{ba&&await ba(o.value,t.checked)}catch(i){let s="„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü";i.message&&i.message.includes("Invalid login")?s="„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô":i.message&&i.message.includes("network")&&(s="ÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"),n.textContent=s,n.classList.remove("hidden")}finally{a.disabled=!1,a.textContent="„É≠„Ç∞„Ç§„É≥"}}function Gl(){const e=document.getElementById("modal-overlay"),t=document.getElementById("modal-password"),n=document.getElementById("modal-nameplate"),a=document.getElementById("modal-incoming-call");n?.classList.add("hidden"),a?.classList.add("hidden"),t.classList.remove("hidden"),e.classList.add("visible"),document.getElementById("password-input")?.focus()}function Jl(){const e=document.getElementById("modal-overlay");document.getElementById("modal-password").classList.add("hidden"),e.classList.remove("visible")}function Ul(e){const t=document.getElementById("password-input"),n=document.getElementById("password-save");t&&e&&(t.value=e),n&&e&&(n.checked=!0)}let ha=null;function ql(e){ha=e;const t=document.getElementById("nameplate-submit"),n=document.getElementById("nameplate-input");t.addEventListener("click",Fo),n.addEventListener("keypress",a=>{a.key==="Enter"&&Fo()})}async function Fo(){const e=document.getElementById("nameplate-input"),t=document.getElementById("nameplate-error"),n=document.getElementById("nameplate-submit");t.classList.add("hidden"),t.textContent="";const a=jl(e.value);if(!a.valid){t.textContent=a.error,t.classList.remove("hidden");return}n.disabled=!0,n.textContent="‰øùÂ≠ò‰∏≠...";try{ha&&await ha(a.value)}catch(o){let i="‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü";o.message&&o.message.includes("duplicate")&&(i="„Åì„ÅÆÂêçÂâç„ÅØÊó¢„Å´‰Ωø„Çè„Çå„Å¶„ÅÑ„Åæ„Åô"),t.textContent=i,t.classList.remove("hidden")}finally{n.disabled=!1,n.textContent="‰øùÂ≠ò"}}function Zl(e=""){const t=document.getElementById("modal-overlay"),n=document.getElementById("modal-nameplate"),a=document.getElementById("modal-password"),o=document.getElementById("modal-incoming-call");a?.classList.add("hidden"),o?.classList.add("hidden"),n.classList.remove("hidden"),t.classList.add("visible");const i=document.getElementById("nameplate-input");i&&e&&(i.value=e),i?.focus()}function Kl(){const e=document.getElementById("modal-overlay");document.getElementById("modal-nameplate").classList.add("hidden"),e.classList.remove("visible")}function tt(){return Math.floor(Math.random()*4294967295).toString(16).padStart(8,"0")}function ao(){const e=globalThis?.crypto;if(e&&typeof e.randomUUID=="function")try{return e.randomUUID()}catch{}if(e&&typeof e.getRandomValues=="function"){const t=new Uint8Array(16);e.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128;const n=[...t].map(a=>a.toString(16).padStart(2,"0")).join("");return`${n.slice(0,8)}-${n.slice(8,12)}-${n.slice(12,16)}-${n.slice(16,20)}-${n.slice(20)}`}return`${tt()}-${tt().slice(0,4)}-${tt().slice(0,4)}-${tt().slice(0,4)}-${tt()}${tt()}`}function Hi(){return`sess_${ao()}`}function Kt(){return ao()}function Yl(){return`call_${ao()}`}const Ae={SESSION_ID:"office.session_id",SHARED_PASSWORD:"office.shared_password",DISPLAY_NAME:"office.display_name",THEME_ID:"office.theme_id",TIME_MODE:"vo:timeMode"},Vl=/^sess_[0-9a-fA-F-]{10,}$/;function ji(e){return typeof e=="string"&&Vl.test(e)?e:Hi()}function Ql(){const e=localStorage.getItem(Ae.SESSION_ID);return Wi(e)}function oo(e){localStorage.setItem(Ae.SESSION_ID,ji(e))}function Wi(e){const t=ji(e);return t!==e&&oo(t),t}function Xl(){return localStorage.getItem(Ae.SHARED_PASSWORD)}function er(e){localStorage.setItem(Ae.SHARED_PASSWORD,e)}function Go(){localStorage.removeItem(Ae.SHARED_PASSWORD)}function tr(){return localStorage.getItem(Ae.DISPLAY_NAME)}function zi(e){localStorage.setItem(Ae.DISPLAY_NAME,e)}function nr(){return localStorage.getItem(Ae.THEME_ID)}function ar(e){localStorage.setItem(Ae.THEME_ID,e)}function or(){const e=localStorage.getItem(Ae.TIME_MODE);return e==="day"||e==="dusk"||e==="night"?e:"day"}function ir(e){e!=="day"&&e!=="dusk"&&e!=="night"||localStorage.setItem(Ae.TIME_MODE,e)}const sr=["„ÅÜ„Çì„ÄÅËÅû„ÅÑ„Å¶„Çã„Çà„ÄÇÁ∂ö„Åë„Å¶„ÄÇ","„Å™„Çã„Åª„Å©„ÄÇÊ¨°„ÅÆ‰∏ÄÊâã„Çí‰∏ÄÁ∑í„Å´ËÄÉ„Åà„Çà„ÅÜ„ÄÇ","„ÅÑ„ÅÑË¶ñÁÇπ„Å†„Å≠„ÄÇ„ÇÇ„ÅÜÂ∞ë„ÅóË©≥„Åó„ÅèÊïô„Åà„Å¶„ÄÇ","‰∫ÜËß£„ÄÇÂøÖË¶Å„Å™„ÇâË¶ÅÁÇπ„Å†„ÅëÁü≠„Åè„Åæ„Å®„ÇÅ„Çã„Çà„ÄÇ"];function Jo(e){return e[Math.floor(Math.random()*e.length)]||"„Å©„ÅÜ„Åó„Åü„ÅÆÔºü"}function Ca(e,t={}){const n=typeof e=="string"?e.trim():"";if(!n)return"„Å©„ÅÜ„Åó„Åü„ÅÆÔºü";const a=n.toLowerCase();if(a.includes("„ÅÇ„Çä„Åå„Å®„ÅÜ"))return"„Å©„ÅÜ„ÅÑ„Åü„Åó„Åæ„Åó„Å¶„ÄÇ„ÅÑ„Å§„Åß„ÇÇÂëº„Çì„Åß„Å≠„ÄÇ";if(a.includes("„Åä„ÅØ"))return"„Åä„ÅØ„Çà„ÅÜ„ÄÇ‰ªäÊó•„ÅØ‰Ωï„Åã„ÇâÈÄ≤„ÇÅ„ÇãÔºü";if(a.includes("Áñ≤")||a.includes("„Å§„Åã„Çå"))return"Â∞ë„ÅóÊ∑±ÂëºÂê∏„Åó„Çà„Å£„Åã„ÄÇÁü≠„ÅÑ‰ºëÊÜ©„Åß„ÇÇÂõûÂæ©„Åô„Çã„Çà„ÄÇ";const o=Array.isArray(t?.candidateReplies)?t.candidateReplies:null;return o&&o.length>0?Jo(o):Jo(sr)}function Uo(e,t={}){return Ca(e,t)}const qo={};function Fi(e){if(!(!e||typeof window>"u")&&!(typeof window.speechSynthesis>"u"||typeof window.SpeechSynthesisUtterance>"u"))try{const t=new window.SpeechSynthesisUtterance(String(e));t.rate=1,t.pitch=1,t.volume=.8,window.speechSynthesis.cancel(),window.speechSynthesis.speak(t)}catch{}}function Gi(){if(!(typeof window>"u"||typeof window.speechSynthesis>"u"))try{window.speechSynthesis.cancel()}catch{}}const lr={speak:Fi,stop:Gi},rr=Object.freeze(Object.defineProperty({__proto__:null,default:lr,speak:Fi,stop:Gi},Symbol.toStringTag,{value:"Module"}));function cr(e,t){if(typeof Ca=="function")return Ca(e,t);if(typeof Uo=="function")return Uo(e,t);if(typeof qo=="function")return qo(e,t);throw new Error("dialogue.getReply/reply not found")}const qn=rr,Ji="companion:history:v1",Ui="companion:unread:v1",Cn=120,dr="„Åæ„Çã„ÇÇ„Å°",qi=1e3,Zo=600,ur=1200,H={open:!1,unread:mr(),messages:fr(),characterName:dr},w={dotHost:null,panelHost:null,dotButton:null,miniBubble:null,unreadBadge:null,menuBadge:null,log:null,form:null,input:null,send:null,close:null};let wa=!1,Oe=null,De=null,ut=null,ft=null,Aa=[];function fr(){try{const e=localStorage.getItem(Ji);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t.map(n=>({id:String(n?.id||Kt()),role:n?.role==="user"?"user":"ai",text:typeof n?.text=="string"?n.text:"",ts:Number(n?.ts)||Date.now()})).filter(n=>n.text.trim().length>0).slice(-Cn):[]}catch(e){return console.warn("[companion] failed to load history",e),[]}}function gr(){try{localStorage.setItem(Ji,JSON.stringify(H.messages.slice(-Cn)))}catch(e){console.warn("[companion] failed to persist history",e)}}function mr(){try{const e=localStorage.getItem(Ui),t=Number(e);return Number.isFinite(t)&&t>0?Math.floor(t):0}catch{return 0}}function Zi(){try{localStorage.setItem(Ui,String(H.unread))}catch{}}function pr(){return`${"/virtualoffice/".replace(/\/?$/,"/")}src/companion/assets/mascot.png`}function Ki(e){Aa.push(e)}function rt(e,t,n,a){e&&(e.addEventListener(t,n,a),Ki(()=>e.removeEventListener(t,n,a)))}function Ir(){return Oe=document.getElementById("companion-root"),Oe||(Oe=document.createElement("div"),Oe.id="companion-root",document.body.appendChild(Oe)),Oe}function yr(){const e=Ir();w.dotHost=document.getElementById("companion-dot"),w.dotHost||(w.dotHost=document.createElement("div"),w.dotHost.id="companion-dot"),w.panelHost=document.getElementById("companion-panel"),w.panelHost||(w.panelHost=document.createElement("div"),w.panelHost.id="companion-panel"),w.panelHost.classList.add("is-hidden"),w.dotHost.parentElement!==e&&e.appendChild(w.dotHost),w.panelHost.parentElement!==e&&e.appendChild(w.panelHost)}function br(){const e=pr();w.dotHost.innerHTML=`
        <button type="button" class="companion-dot-button" aria-label="AI„ÇíÈñã„Åè">
            <img src="${e}" alt="${H.characterName}" loading="lazy" />
            <span class="companion-dot-fallback" aria-hidden="true">üç°</span>
        </button>
        <span class="companion-dot-callout">„Å≤„ÅæÔºü</span>
        <span class="companion-dot-badge" aria-live="polite">0</span>
        <span class="companion-dot-mini">„Å™„Å´„ÄúÔºü</span>
    `,w.panelHost.innerHTML=`
        <section aria-label="Áõ∏Ê£í„ÉÅ„É£„ÉÉ„Éà">
            <div class="companion-head">
                <div class="companion-head-main">
                    <img class="companion-head-avatar" src="${e}" alt="${H.characterName}" loading="lazy" />
                    <div>
                        <div class="companion-head-title">${H.characterName}</div>
                        <div class="companion-head-sub">AIÁõ∏Ê£í</div>
                    </div>
                </div>
                <button type="button" class="companion-close" aria-label="Èñâ„Åò„Çã">√ó</button>
            </div>
            <div class="companion-log" role="log" aria-live="polite"></div>
            <form class="companion-form">
                <input class="companion-input" type="text" maxlength="300" placeholder="Ë©±„Åó„Åã„Åë„Çã..." />
                <button class="companion-send" type="submit">ÈÄÅ‰ø°</button>
            </form>
        </section>
    `,w.dotButton=w.dotHost.querySelector(".companion-dot-button"),w.miniBubble=w.dotHost.querySelector(".companion-dot-mini"),w.unreadBadge=w.dotHost.querySelector(".companion-dot-badge"),w.menuBadge=document.getElementById("companion-menu-badge"),w.log=w.panelHost.querySelector(".companion-log"),w.form=w.panelHost.querySelector(".companion-form"),w.input=w.panelHost.querySelector(".companion-input"),w.send=w.panelHost.querySelector(".companion-send"),w.close=w.panelHost.querySelector(".companion-close"),w.dotHost.querySelectorAll("img").forEach(t=>{rt(t,"error",()=>{const n=t.parentElement?.querySelector(".companion-dot-fallback");n&&(n.style.display="inline-block"),t.style.display="none"},{once:!0})})}function hr(){if(w.log){w.log.innerHTML="";for(const e of H.messages)w.log.appendChild(Yi(e.role,e.text));w.log.scrollTop=w.log.scrollHeight}}function Yi(e,t){const n=document.createElement("div");return n.className=`companion-msg ${e==="user"?"user":"ai"}`,n.textContent=t,n}function Cr(){const e=document.createElement("div");return e.className="companion-msg typing",e.innerHTML='„Çø„Ç§„Éó‰∏≠<span class="companion-typing-dots"><span>.</span><span>.</span><span>.</span></span>',e}function va(e,t,{persist:n=!0}={}){const a=typeof t=="string"?t.trim():"";if(!a)return;const o={id:Kt(),role:e==="user"?"user":"ai",text:a,ts:Date.now()};H.messages.push(o),H.messages.length>Cn&&H.messages.splice(0,H.messages.length-Cn),n&&gr(),w.log&&(w.log.appendChild(Yi(o.role,o.text)),w.log.scrollTop=w.log.scrollHeight)}function wr(e){va("ai",e)}function Ar(){w.miniBubble&&(w.miniBubble.classList.add("visible"),ut&&clearTimeout(ut),ut=window.setTimeout(()=>{w.miniBubble?.classList.remove("visible")},qi))}function ka(){H.open||(H.open=!0,w.panelHost?.classList.remove("is-hidden"),H.unread=0,Zi(),io(),w.input?.focus(),w.log&&(w.log.scrollTop=w.log.scrollHeight))}function Ma(){H.open&&(H.open=!1,w.panelHost?.classList.add("is-hidden"))}function vr(){return H.open}function io(){const e=H.unread>0;w.dotHost?.classList.toggle("has-unread",e),w.unreadBadge&&(w.unreadBadge.textContent=String(Math.min(H.unread,99))),w.menuBadge&&(w.menuBadge.textContent=String(Math.min(H.unread,99)),w.menuBadge.classList.toggle("visible",e)),window.dispatchEvent(new CustomEvent("companion:unread",{detail:{count:H.unread}}))}function Vi(){const e=document.body.classList.contains("chat-open");w.dotHost?.classList.toggle("is-left",e)}function kr(){De&&De.disconnect(),De=new MutationObserver(()=>{Vi()}),De.observe(document.body,{attributes:!0,attributeFilter:["class"]}),Ki(()=>{De?.disconnect(),De=null})}function Mr(e){return e?typeof e=="string"?e:typeof e?.text=="string"?e.text:typeof e?.reply=="string"?e.reply:typeof e?.message=="string"?e.message:typeof e?.body=="string"?e.body:"":""}function Er(e){const t=e.trim().toLowerCase();if(!t)return"„Å©„ÅÜ„Åó„Åü„ÅÆÔºü";if(t.includes("„ÅÇ„Çä„Åå„Å®„ÅÜ"))return"„Å©„ÅÜ„ÅÑ„Åü„Åó„Åæ„Åó„Å¶„ÄÇ„ÅÑ„Å§„Åß„ÇÇÂëº„Çì„Åß„Å≠„ÄÇ";if(t.includes("„Åä„ÅØ"))return"„Åä„ÅØ„Çà„ÅÜ„ÄÇ‰ªäÊó•„ÅØ‰Ωï„Åã„ÇâÈÄ≤„ÇÅ„ÇãÔºü";if(t.includes("Áñ≤")||t.includes("„Å§„Åã„Çå"))return"Â∞ë„ÅóÊ∑±ÂëºÂê∏„Åó„Çà„Å£„Åã„ÄÇÁü≠„ÅÑ‰ºëÊÜ©„Åß„ÇÇÂõûÂæ©„Åô„Çã„Çà„ÄÇ";const n=["„ÅÑ„ÅÑ„Å≠„ÄÅ„Åù„ÅÆÁ∂ö„Åç„ÇíËÅû„Åã„Åõ„Å¶„ÄÇ","‰∫ÜËß£„ÄÇÊ¨°„ÅÆ‰∏ÄÊâã„Çí‰∏ÄÁ∑í„Å´Êï¥ÁêÜ„Åó„Çà„ÅÜ„ÄÇ","„É°„É¢„Åó„Å¶„Åä„ÅèÔºüÂøÖË¶Å„Å™„ÇâË¶ÅÁÇπ„ÇíÁü≠„Åè„Åæ„Å®„ÇÅ„Çã„Çà„ÄÇ","„ÅÜ„Çì„ÄÅ‰ªä„ÅÆË©±„ÅØÂ§ß‰∫ã„Å†„Å≠„ÄÇ"];return n[Math.floor(Math.random()*n.length)]}function Sr(){return Math.floor(Math.random()*(ur-Zo+1))+Zo}async function _r(e){va("user",e);const t=H.open&&w.log?Cr():null;t&&w.log&&(w.log.appendChild(t),w.log.scrollTop=w.log.scrollHeight),await Lr(Sr());let n="";try{const a=await Promise.resolve(cr(e,{character:H.characterName,messages:[...H.messages]}));n=Mr(a).trim()||Er(e);try{qn&&typeof qn.speak=="function"&&qn.speak(n)}catch(o){console.warn("[COMPANION] tts failed (non-fatal)",o)}}catch(a){console.error("[COMPANION] send failed",a),n="„Åî„ÇÅ„Çì„ÄÅ‰ªä„Å°„Çá„Å£„Å®„Å†„ÅëË©∞„Åæ„Å£„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂõûÈÄÅ„Å£„Å¶„Åø„Å¶„ÄÇ"}t?.isConnected&&t.remove(),n?va("ai",n):wr("„Åî„ÇÅ„Çì„ÄÅ‰ªä„Å°„Çá„Å£„Å®„Å†„ÅëË©∞„Åæ„Å£„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂõûÈÄÅ„Å£„Å¶„Åø„Å¶„ÄÇ"),H.open||(H.unread+=1,Zi(),io())}function Lr(e){return new Promise(t=>{window.setTimeout(t,e)})}function Dr(){rt(w.dotButton,"click",()=>{Ar(),ft&&clearTimeout(ft),ft=window.setTimeout(()=>{ka()},qi)}),rt(w.close,"click",()=>{Ma()}),rt(w.form,"submit",e=>{e.preventDefault();const t=w.input?.value?.trim()||"";t&&(w.input.value="",w.send&&(w.send.disabled=!0),_r(t).finally(()=>{w.send&&(w.send.disabled=!1),H.open&&w.input?.focus()}))}),rt(document,"keydown",e=>{e.key==="Escape"&&H.open&&Ma()}),rt(document.getElementById("companion-menu-btn"),"click",()=>{ka()})}function xr(){ut&&(clearTimeout(ut),ut=null),ft&&(clearTimeout(ft),ft=null);for(const e of Aa.splice(0,Aa.length))try{e()}catch{}De&&(De.disconnect(),De=null)}function Br(){if(!(wa||window.__COMPANION_DISABLED__))try{yr(),br(),hr(),Dr(),io(),Vi(),kr(),window.Companion={open:ka,close:Ma,isOpen:vr,destroy:Ea},wa=!0}catch(e){console.error("[COMPANION] mount failed (non-fatal)",e),window.__COMPANION_DISABLED__=!0,Ea()}}function Ea(){xr(),H.open=!1;const e=Oe||document.getElementById("companion-root");e&&e.remove(),Oe=null,w.dotHost=null,w.panelHost=null,w.dotButton=null,w.miniBubble=null,w.unreadBadge=null,w.menuBadge=null,w.log=null,w.form=null,w.input=null,w.send=null,w.close=null,wa=!1,window.Companion&&delete window.Companion}const Ko={desk:{width:70,height:36}};let Ke=new Map,gt="area:core";function R(e){console.log("[BOOT]",e);const t=document.getElementById("bootLog");t&&(t.textContent+=`${e}
`)}async function Tr(e){const t=String(e);R(`fetch: ${t}`);const n=await fetch(t,{cache:"no-store"});if(R(`status: ${t} -> ${n.status}`),!n.ok){const o=await n.text().catch(()=>"");throw new Error(`Fetch failed ${n.status} for ${t}
${o.slice(0,200)}`)}n.headers.get("content-type");const a=await n.text().catch(()=>"");try{return JSON.parse(a)}catch(o){throw new Error(`JSON parse failed for ${t}: ${o.message}
body(head): ${a.slice(0,200)}`)}}async function Yo(e="core"){R(`loadMaps: start (${e})`);try{const t=[{key:"core",url:new URL("/virtualoffice/assets/map_core-d322xUfd.json",import.meta.url).href},{key:"desks",url:new URL("data:application/json;base64,ew0KICAgICJtZXRhIjogeyAiaWQiOiAibWFwOmRlc2tzIiwgInZlcnNpb24iOiAyIH0sCiAgICAiZGVza3MiOiBbCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDEiLCAicG9zIjogeyAieCI6IDI2MCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogMjYwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDIiLCAicG9zIjogeyAieCI6IDMyMCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogMzIwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDMiLCAicG9zIjogeyAieCI6IDM4MCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogMzgwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDQiLCAicG9zIjogeyAieCI6IDQ0MCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogNDQwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDUiLCAicG9zIjogeyAieCI6IDUwMCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogNTAwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDYiLCAicG9zIjogeyAieCI6IDU2MCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogNTYwLCAieSI6IDU0OCB9IH0sCgogICAgICAgIHsgImlkIjogImRlc2s6YTA3IiwgInBvcyI6IHsgIngiOiAyNjAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDI2MCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTA4IiwgInBvcyI6IHsgIngiOiAzMjAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDMyMCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTA5IiwgInBvcyI6IHsgIngiOiAzODAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDM4MCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTEwIiwgInBvcyI6IHsgIngiOiA0NDAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDQ0MCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTExIiwgInBvcyI6IHsgIngiOiA1MDAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDUwMCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTEyIiwgInBvcyI6IHsgIngiOiA1NjAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDU2MCwgInkiOiA2MDggfSB9CiAgICBdLAogICAgInpvbmVzIjogWwogICAgICAgIHsKICAgICAgICAgICAgImlkIjogInpvbmU6ZGVza3MiLAogICAgICAgICAgICAiYm91bmRzIjogewogICAgICAgICAgICAgICAgIngiOiAyMTAsCiAgICAgICAgICAgICAgICAieSI6IDQzMCwKICAgICAgICAgICAgICAgICJ3IjogNDA4LAogICAgICAgICAgICAgICAgImgiOiAxODgKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIndhbGthYmxlIjogdHJ1ZQogICAgICAgIH0KICAgIF0sCiAgICAid2Fsa2FibGUiOiBbCiAgICAgICAgewogICAgICAgICAgICAieCI6IDIwOCwKICAgICAgICAgICAgInkiOiA0MjgsCiAgICAgICAgICAgICJ3IjogNDEyLAogICAgICAgICAgICAiaCI6IDE5MiwKICAgICAgICAgICAgInRhZyI6ICJhc3NpZ25lZF9kZXNrc19mbG9vciIKICAgICAgICB9CiAgICBdLAogICAgImRlc2tSdWxlcyI6IHsKICAgICAgICAiaW5pdGlhbE1vZGUiOiAiZml4ZWQiLA0KICAgICAgICAiZnV0dXJlTW9kZSI6ICJmcmVlIiwNCiAgICAgICAgIm5vdGVzIjogWw0KICAgICAgICAgICAgIk1WUOOBp+OBr+W6p+W4reOBr+WbuuWumumBi+eUqO+8iOWJsuOCiuW9k+OBplVJ44Gq44GX77yJ44CCIiwNCiAgICAgICAgICAgICLlsIbmnaXjga/oh6rnlLHluK3pgbjmip5VSeOCkui/veWKoOOBp+OBjeOCi+OCiOOBhiBkZXNr5a6a576p44KS44OH44O844K/44Go44GX44Gm5YiG6Zui44CCIg0KICAgICAgICBdDQogICAgfQ0KfQo=",import.meta.url).href},{key:"expansion",url:new URL("data:application/json;base64,ew0KICAgICJtZXRhIjogew0KICAgICAgICAiaWQiOiAibWFwOmV4cGFuc2lvbiIsDQogICAgICAgICJ2ZXJzaW9uIjogMQ0KICAgIH0sDQogICAgInJvb21zIjogWw0KICAgICAgICB7DQogICAgICAgICAgICAiaWQiOiAicm9vbTpzdHVkaW8iLA0KICAgICAgICAgICAgImxhYmVsIjogIlN0dWRpbyAoc3BhcmUpIiwNCiAgICAgICAgICAgICJib3VuZHMiOiB7DQogICAgICAgICAgICAgICAgIngiOiAxNDAsDQogICAgICAgICAgICAgICAgInkiOiA1MjAsDQogICAgICAgICAgICAgICAgInciOiA0ODAsDQogICAgICAgICAgICAgICAgImgiOiAzNDANCiAgICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgew0KICAgICAgICAgICAgImlkIjogInJvb206cXVpZXQiLA0KICAgICAgICAgICAgImxhYmVsIjogIlF1aWV0IChzcGFyZSkiLA0KICAgICAgICAgICAgImJvdW5kcyI6IHsNCiAgICAgICAgICAgICAgICAieCI6IDE0MCwNCiAgICAgICAgICAgICAgICAieSI6IDkwMCwNCiAgICAgICAgICAgICAgICAidyI6IDQ4MCwNCiAgICAgICAgICAgICAgICAiaCI6IDM2MA0KICAgICAgICAgICAgfQ0KICAgICAgICB9LA0KICAgICAgICB7DQogICAgICAgICAgICAiaWQiOiAicm9vbTpsb3VuZ2UiLA0KICAgICAgICAgICAgImxhYmVsIjogIkxvdW5nZSAoc3BhcmUpIiwNCiAgICAgICAgICAgICJib3VuZHMiOiB7DQogICAgICAgICAgICAgICAgIngiOiAxNzYwLA0KICAgICAgICAgICAgICAgICJ5IjogMjQwLA0KICAgICAgICAgICAgICAgICJ3IjogNDgwLA0KICAgICAgICAgICAgICAgICJoIjogNTIwDQogICAgICAgICAgICB9DQogICAgICAgIH0sDQogICAgICAgIHsNCiAgICAgICAgICAgICJpZCI6ICJyb29tOmdhbGxlcnkiLA0KICAgICAgICAgICAgImxhYmVsIjogIkdhbGxlcnkgKHNwYXJlKSIsDQogICAgICAgICAgICAiYm91bmRzIjogew0KICAgICAgICAgICAgICAgICJ4IjogMTc2MCwNCiAgICAgICAgICAgICAgICAieSI6IDgyMCwNCiAgICAgICAgICAgICAgICAidyI6IDQ4MCwNCiAgICAgICAgICAgICAgICAiaCI6IDQyMA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgXSwKICAgICJ3YWxrYWJsZSI6IFsKICAgICAgICB7CiAgICAgICAgICAgICJ4IjogNDAsCiAgICAgICAgICAgICJ5IjogNDMwLAogICAgICAgICAgICAidyI6IDU2MCwKICAgICAgICAgICAgImgiOiAyNjAsCiAgICAgICAgICAgICJub3RlIjogImFzc2lnbmVkIGRlc2tzIGZsb29yIgogICAgICAgIH0KICAgIF0sCiAgICAiZGVjb3IiOiBbCiAgICAgICAgewogICAgICAgICAgICAidHlwZSI6ICJsYWJlbCIsCiAgICAgICAgICAgICJ4IjogMjAwLA0KICAgICAgICAgICAgInkiOiA1NjAsDQogICAgICAgICAgICAidGV4dCI6ICJTcGFyZSBSb29tcyIsDQogICAgICAgICAgICAic3R5bGUiOiAiaDIiDQogICAgICAgIH0NCiAgICBdDQp9Cg==",import.meta.url).href},{key:"garden",url:new URL("data:application/json;base64,ewogICAgIm1ldGEiOiB7CiAgICAgICAgImlkIjogIm1hcDpnYXJkZW4iLAogICAgICAgICJ2ZXJzaW9uIjogMSwKICAgICAgICAic2l6ZSI6IHsKICAgICAgICAgICAgInciOiA2NDAsCiAgICAgICAgICAgICJoIjogNjQwCiAgICAgICAgfQogICAgfSwKICAgICJzcGF3blBvaW50cyI6IHsKICAgICAgICAibG9iYnkiOiB7ICJ4IjogMzIwLCAieSI6IDQ4MCB9LAogICAgICAgICJnYXJkZW4iOiB7ICJ4IjogMzE5LCAieSI6IDU5OSB9CiAgICB9LAogICAgIndhbGthYmxlIjogWwogICAgICAgIHsgInR5cGUiOiAicmVjdCIsICJ4IjogMCwgInkiOiAwLCAidyI6IDY0MCwgImgiOiA2NDAsICJ0YWciOiAiZ2FyZGVuX2Zsb29yIiB9CiAgICBdLAogICAgIm9ic3RhY2xlcyI6IFsKICAgICAgICB7ICJ0eXBlIjogInJlY3QiLCAieCI6IDAsICJ5IjogMCwgInciOiA2NDAsICJoIjogMjAsICJ0YWciOiAiZ2FyZGVuOndhbGxfbm9ydGgiIH0sCiAgICAgICAgeyAidHlwZSI6ICJyZWN0IiwgIngiOiAwLCAieSI6IDYyMCwgInciOiA2NDAsICJoIjogMjAsICJ0YWciOiAiZ2FyZGVuOndhbGxfc291dGgiIH0sCiAgICAgICAgeyAidHlwZSI6ICJyZWN0IiwgIngiOiAwLCAieSI6IDAsICJ3IjogMjAsICJoIjogNjQwLCAidGFnIjogImdhcmRlbjp3YWxsX3dlc3QiIH0sCiAgICAgICAgeyAidHlwZSI6ICJyZWN0IiwgIngiOiA2MjAsICJ5IjogMCwgInciOiAyMCwgImgiOiA2NDAsICJ0YWciOiAiZ2FyZGVuOndhbGxfZWFzdCIgfSwKICAgICAgICB7ICJ0eXBlIjogInJlY3QiLCAieCI6IDEwNCwgInkiOiAyMzAsICJ3IjogMTc2LCAiaCI6IDEyNiwgInRhZyI6ICJnYXJkZW46cG9uZF9sZWZ0IiB9LAogICAgICAgIHsgInR5cGUiOiAicmVjdCIsICJ4IjogMzYyLCAieSI6IDI1NCwgInciOiAxNzYsICJoIjogMTI2LCAidGFnIjogImdhcmRlbjpwb25kX3JpZ2h0IiB9CiAgICBdLAogICAgInpvbmVzIjogW10sCiAgICAiZGVjb3IiOiBbXSwKICAgICJkZXNrcyI6IFtdLAogICAgInNwb3RzIjogWwogICAgICAgIHsKICAgICAgICAgICAgImlkIjogInNwb3Q6Z2FyZGVuX3NocmluZSIsCiAgICAgICAgICAgICJhcmVhSWQiOiAiYXJlYTpnYXJkZW4iLAogICAgICAgICAgICAia2luZCI6ICJhY3Rpb25fc3BvdCIsCiAgICAgICAgICAgICJsYWJlbCI6ICJTaHJpbmUgQXVkaW8iLAogICAgICAgICAgICAicHJpb3JpdHkiOiAyMCwKICAgICAgICAgICAgImJvdW5kcyI6IHsgIngiOiAyNzEsICJ5IjogNzksICJ3IjogMTAwLCAiaCI6IDEwMCB9LAogICAgICAgICAgICAiaW50ZXJhY3RQb2ludCI6IHsgIngiOiAzMjEsICJ5IjogMTI5IH0sCiAgICAgICAgICAgICJhY3Rpb24iOiB7ICJ0eXBlIjogIm9wZW5CZ21TZWxlY3RvciIsICJ0aXRsZSI6ICJTaHJpbmUgQXVkaW8iIH0KICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImlkIjogInNwb3Q6Z2FyZGVuOnRlYWhvdXNlX2FtYmllbnQiLAogICAgICAgICAgICAiYXJlYUlkIjogImFyZWE6Z2FyZGVuIiwKICAgICAgICAgICAgImtpbmQiOiAiYWN0aW9uX3Nwb3QiLAogICAgICAgICAgICAibGFiZWwiOiAiQW1iaWVudCIsCiAgICAgICAgICAgICJwcmlvcml0eSI6IDUwLAogICAgICAgICAgICAiYm91bmRzIjogeyAieCI6IDQ0MCwgInkiOiAxMjAsICJ3IjogMTIwLCAiaCI6IDkwIH0sCiAgICAgICAgICAgICJpbnRlcmFjdFBvaW50IjogeyAieCI6IDUwMCwgInkiOiAxNjUgfSwKICAgICAgICAgICAgImFjdGlvbiI6IHsgInR5cGUiOiAib3BlbkFtYmllbnRQYXJ0aWNsZXMiLCAidGl0bGUiOiAiQW1iaWVudCBQYXJ0aWNsZXMiIH0KICAgICAgICB9CiAgICBdCn0K",import.meta.url).href},{key:"library",url:new URL("data:application/json;base64,ewogICJtZXRhIjogewogICAgImlkIjogIm1hcDpsaWJyYXJ5IiwKICAgICJ2ZXJzaW9uIjogMSwKICAgICJ3aWR0aCI6IDUxMiwKICAgICJoZWlnaHQiOiA1MTIsCiAgICAiaW1hZ2UiOiAiYXNzZXRzL21hcHMvbGlicmFyeS5wbmciCiAgfSwKICAic3Bhd25Qb2ludHMiOiB7CiAgICAibG9iYnkiOiB7CiAgICAgICJ4IjogMjU2LAogICAgICAieSI6IDEyMAogICAgfQogIH0sCiAgInpvbmVzIjogWwogICAgewogICAgICAiaWQiOiAiTGlicmFyeUhhbGwiLAogICAgICAiYm91bmRzIjogewogICAgICAgICJ4IjogNjQsCiAgICAgICAgInkiOiA0OCwKICAgICAgICAidyI6IDM4NCwKICAgICAgICAiaCI6IDMwNAogICAgICB9CiAgICB9LAogICAgewogICAgICAiaWQiOiAiTG91bmdlQmxvY2tlZCIsCiAgICAgICJib3VuZHMiOiB7CiAgICAgICAgIngiOiAwLAogICAgICAgICJ5IjogMzUyLAogICAgICAgICJ3IjogNTEyLAogICAgICAgICJoIjogMTYwCiAgICAgIH0KICAgIH0KICBdLAogICJ3YWxrYWJsZSI6IFsKICAgIHsKICAgICAgIngiOiAyNCwKICAgICAgInkiOiAyNCwKICAgICAgInciOiA0NjQsCiAgICAgICJoIjogNDY0CiAgICB9CiAgXSwKICAib2JzdGFjbGVzIjogWwogICAgewogICAgICAiaWQiOiAid2FsbF90b3AiLAogICAgICAieCI6IDAsCiAgICAgICJ5IjogMCwKICAgICAgInciOiA1MTIsCiAgICAgICJoIjogMjAKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ3YWxsX2xlZnQiLAogICAgICAieCI6IDAsCiAgICAgICJ5IjogMCwKICAgICAgInciOiAyMCwKICAgICAgImgiOiA1MTIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ3YWxsX3JpZ2h0IiwKICAgICAgIngiOiA0OTIsCiAgICAgICJ5IjogMCwKICAgICAgInciOiAyMCwKICAgICAgImgiOiA1MTIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ3YWxsX2JvdHRvbSIsCiAgICAgICJ4IjogMCwKICAgICAgInkiOiA0OTIsCiAgICAgICJ3IjogNTEyLAogICAgICAiaCI6IDIwCiAgICB9LAogICAgewogICAgICAiaWQiOiAiYm9va3NoZWxmX3dhbGxfbGVmdCIsCiAgICAgICJ4IjogMCwKICAgICAgInkiOiA0MCwKICAgICAgInciOiA2MCwKICAgICAgImgiOiAyOTYKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJsaWJyYXJpYW5fY291bnRlcl9ibG9jayIsCiAgICAgICJ4IjogMzAwLAogICAgICAieSI6IDI4LAogICAgICAidyI6IDIxMiwKICAgICAgImgiOiAxMTIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJyb3VuZF90YWJsZSIsCiAgICAgICJ4IjogMTcwLAogICAgICAieSI6IDE4MiwKICAgICAgInciOiAxNzIsCiAgICAgICJoIjogMTM2CiAgICB9LAogICAgewogICAgICAiaWQiOiAiY2F0YWxvZ19kZXNrIiwKICAgICAgIngiOiA0MDAsCiAgICAgICJ5IjogMjE0LAogICAgICAidyI6IDYyLAogICAgICAiaCI6IDYwCiAgICB9LAogICAgewogICAgICAiaWQiOiAiY2F0YWxvZ19jaGFpciIsCiAgICAgICJ4IjogNDYyLAogICAgICAieSI6IDIzMiwKICAgICAgInciOiAzMCwKICAgICAgImgiOiA1MAogICAgfQogIF0KfQ==",import.meta.url).href},{key:"spots",url:new URL("/virtualoffice/assets/spots-Ctp-iMl6.json",import.meta.url).href}],n=await Promise.allSettled(t.map(L=>Tr(L.url))),a=[],o={};if(n.forEach((L,q)=>{const Z=t[q];L.status==="fulfilled"?o[Z.key]=L.value:a.push({...Z,error:L.reason})}),a.length){a.forEach(Z=>{console.error("[loadMaps] File load failed",Z.key,Z.url,Z.error),R(`loadMaps: FAILED file -> ${Z.key}: ${Z.url}`)});const L=a.map(Z=>`${Z.key}: ${Z.url}`).join(`
`),q=`Map data load failed (${a.length}):
${L}`;throw new Error(q)}const i=o.core,s=o.desks,l=o.expansion,d=o.garden,p=o.library,m=o.spots;R("loadMaps: json loaded"),Ke=new Map;const C=[...i.zones||[],...s.zones||[],...l.zones||[]],g=Rr(s),I=as(s.desks||[],i.meta?.size,g),y=[...i.walkable||[],...s.walkable||[],...l.walkable||[]],b=Qi(C),f=[...y,...b],v=es(Xi(f,4,i.meta?.size),4),_=[...i.obstacles||[],...s.obstacles||[],...l.obstacles||[]],P=_.filter(L=>!ts(L)).map(L=>({...L,source:"world"})),M=ns(I),E={meta:i.meta,size:i.meta.size,isReady:!1,isMapLoading:!0,spawnPoints:i.spawnPoints,walkableBase:y,walkableFromZones:b,walkableFinal:f,walkableInflated:v,walkable:f,worldObstacles:P,deskColliders:M,obstaclesFinal:[...P,...M],obstacles:[...P,...M],zones:C,decor:[...i.decor||[],...l.decor||[]],desks:I,deskRules:s.deskRules||{},rooms:l.rooms||[],spots:m&&m.spots?m.spots.filter(L=>(L?.areaId||"area:core")==="area:core"):[]};E.deskById=new Map,E.desks.forEach(L=>{E.deskById.set(L.id,L)}),E.spotById=new Map,E.spots.forEach(L=>{E.spotById.set(L.id,L)}),E.zoneById=new Map,E.zones.forEach(L=>{E.zoneById.set(L.id,L)}),Ke.set("area:core",E);const $=Vo(d,m,"area:garden");Ke.set("area:garden",$);const O=Vo(p,m,"area:library");return Ke.set("area:library",O),e==="garden"?gt="area:garden":e==="library"?gt="area:library":gt="area:core",R(`walkableBase: ${y.length}`),R(`walkableFromZones: ${b.length}`),R(`walkableFinal: ${f.length}`),R(`walkableInflated: ${v.length}`),R(`obstaclesFinal: ${_.length}`),R(`zones: ${C.length}`),R(`walkable count: ${f.length}`),R(`obstacles count: ${_.length}`),R(`worldObstacles count: ${P.length}`),R(`deskColliders count: ${M.length}`),R(`zones count: ${C.length}`),R(`walkableFromZones count: ${b.length}`),R(`desks count: ${E.desks.length}`),R(`obstacles merged: ${E.obstacles.length}`),R(`walkable merged: ${f.length}`),R(`zones merged: ${C.length}`),R(`desks=${E.desks.length} obstacles=${E.obstacles.length} walkable=${f.length} zones=${C.length}`),console.log("[DEBUG] desk0",E.desks?.[0]),R("loadMaps: officeWorld ready"),R("loadMaps: gardenWorld ready"),R("loadMaps: libraryWorld ready"),U()}catch(t){throw R(`loadMaps: FAILED -> ${t.message}`),console.error("[loadMaps] FAILED",t),t}}function Vo(e,t,n=null){const a=e.meta||{size:e.size},o=a?.size||(a?.width&&a?.height?{w:a.width,h:a.height}:null)||(e?.width&&e?.height?{w:e.width,h:e.height}:null)||e.size;a&&!a.size&&o&&(a.size={w:o.w,h:o.h});const i=e.zones||[],s=e.walkable||e.walkableBase||[],l=Qi(i),d=[...s,...l],p=es(Xi(d,4,o),4),m=as(e.desks||[],o,null),g=(e.obstacles||[]).filter(b=>!ts(b)).map(b=>({...b,source:"world"})),I=ns(m),y={meta:a,size:o,spawnPoints:e.spawnPoints||{lobby:{x:260,y:260}},isReady:!1,isMapLoading:!0,walkableBase:s,walkableFromZones:l,walkableFinal:d,walkableInflated:p,walkable:d,worldObstacles:g,deskColliders:I,obstaclesFinal:[...g,...I],obstacles:[...g,...I],zones:i,decor:e.decor||[],desks:m,deskRules:e.deskRules||{},rooms:e.rooms||[],spots:Nr(e,t,n)};return y.deskById=new Map,y.desks.forEach(b=>y.deskById.set(b.id,b)),y.spotById=new Map,y.spots.forEach(b=>y.spotById.set(b.id,b)),y.zoneById=new Map,y.zones.forEach(b=>y.zoneById.set(b.id,b)),y}function Nr(e,t,n){const a=e?.spots&&Array.isArray(e.spots)?e.spots:[],o=t&&Array.isArray(t.spots)?t.spots:[];if(!n)return[...a,...o];const i=o.filter(s=>s?.areaId===n);return[...a,...i]}function Qi(e=[]){const t=[];return e.forEach(n=>{const a=n?.bounds;if(!a)return;const o=n.walkable===!0,i=String(n.type||n.kind||"").toLowerCase(),s=String(n.id||"").toLowerCase();let l=!1;o||i==="floor"?l=!0:(s.includes("floor")||s.includes("room")||s.includes("desk"))&&(l=!0,console.warn("[loadMaps] walkableFromZones fallback by id match",n.id)),l&&t.push({x:a.x,y:a.y,w:a.w,h:a.h,tag:n.id||"zone"})}),t}function Xi(e=[],t=0,n=null){if(!t)return e.slice();const a=n?.w??1/0,o=n?.h??1/0;return e.map(i=>{const s=i.x-t,l=i.y-t,d=i.w+t*2,p=i.h+t*2,m=Math.max(0,s),C=Math.max(0,l),g=Math.min(a,s+d)-m,I=Math.min(o,l+p)-C;return{...i,x:m,y:C,w:Math.max(0,g),h:Math.max(0,I)}}).filter(i=>i.w>0&&i.h>0)}function es(e=[],t=0){const n=e.slice(),a=[];for(;n.length>0;){let o=n.pop(),i=!0;for(;i;){i=!1;for(let s=n.length-1;s>=0;s--){const l=n[s];Or(o,l,t)&&(o=$r(o,l),n.splice(s,1),i=!0)}}a.push(o)}return a}function Or(e,t,n){return!(e.x>t.x+t.w+n||e.x+e.w+n<t.x||e.y>t.y+t.h+n||e.y+e.h+n<t.y)}function $r(e,t){const n=Math.min(e.x,t.x),a=Math.min(e.y,t.y),o=Math.max(e.x+e.w,t.x+t.w),i=Math.max(e.y+e.h,t.y+t.h);return{x:n,y:a,w:o-n,h:i-a,tag:e.tag||t.tag}}function ts(e){return String(e?.tag||"").toLowerCase().includes("desk")}function ns(e=[]){return e.map(t=>{const n=Pr(t),a=n.x+n.w/2-18,o=n.y+8;return{x:a,y:o,w:36,h:16,tag:`desk:${t.id}`,id:t.id,kind:"desk",source:"desk"}})}function Pr(e){if(e.boundsAbs)return{x:e.boundsAbs.x,y:e.boundsAbs.y,w:e.boundsAbs.w,h:e.boundsAbs.h};if(e.posAbs){const t=Ko.desk.width,n=Ko.desk.height;return{x:e.posAbs.x-t/2,y:e.posAbs.y-n/2,w:t,h:n}}return e.standPointAbs?{x:e.standPointAbs.x-120/2,y:e.standPointAbs.y+8,w:120,h:90}:{x:0,y:0,w:120,h:90}}function as(e=[],t,n){const a=t?.w||t?.width||0,o=t?.h||t?.height||0,i=t?.tileSize||16;let s=0,l=0,d=1/0,p=1/0;e.forEach(b=>{[b.pos,b.standPoint].filter(Boolean).forEach(v=>{Number.isFinite(v.x)&&(s=Math.max(s,v.x),d=Math.min(d,v.x)),Number.isFinite(v.y)&&(l=Math.max(l,v.y),p=Math.min(p,v.y))})});const m=isFinite(d)?s-d:0,C=isFinite(p)?l-p:0,g=a&&o&&s<=a&&l<=o;let I=1;a&&o&&s<=a/4&&l<=o/4&&(I=i);const y=!g&&n&&m>0&&C>0;return e.map(b=>{const f={...b},v=b.pos?{x:b.pos.x*I,y:b.pos.y*I}:null,_=b.standPoint?{x:b.standPoint.x*I,y:b.standPoint.y*I}:null;let P=v,M=_;if(y&&v){const E=(v.x-d)/(m||1),$=(v.y-p)/(C||1);P={x:n.x+E*n.w,y:n.y+$*n.h}}if(y&&_){const E=(_.x-d)/(m||1),$=(_.y-p)/(C||1);M={x:n.x+E*n.w,y:n.y+$*n.h}}return a&&o&&M&&(M.x<0||M.x>a||M.y<0||M.y>o)&&(console.warn("[desk] standPointAbs out of bounds -> fallback to posAbs",b.id,M,{W:a,H:o}),M=P),f.posRaw=v,f.standPointRaw=_,f.posAbs=P,f.standPointAbs=M,f.pos=P,f.standPoint=M,f.__debug={posAbs:P,standAbs:M,floorRect:n},a&&o&&[f.posAbs,f.standPointAbs].filter(Boolean).forEach($=>{($.x<0||$.x>a||$.y<0||$.y>o)&&console.warn("[desk] out of bounds",b.id,$.x,$.y,a,o,b)}),f})}function Rr(e){const n=(e?.walkable||[]).find(i=>i.tag==="assigned_desks_floor");if(n)return{x:n.x,y:n.y,w:n.w,h:n.h};const o=(e?.zones||[]).find(i=>i.id==="zone:desks");return o?.bounds?{x:o.bounds.x,y:o.bounds.y,w:o.bounds.w,h:o.bounds.h}:null}function U(e=null){const t=e||gt;return Ke?.has(t)?Ke.get(t):null}function Qo(e="lobby",t=null){const n=U(t);return n?n.spawnPoints?.[e]||n.spawnPoints?.lobby||{x:260,y:260}:{x:260,y:260}}function os(e=null){return U(e)?.desks||[]}function Xo(e,t=null){return U(t)?.deskById?.get(e)||null}function Nn(e=null){return U(e)?.spots||[]}function Sa(e,t=null){return U(t)?.spotById?.get(e)||null}function Hr(e){Ke?.has(e)?(gt=e,R(`setActiveArea: ${e}`)):(console.warn("[mapLoader] setActiveArea failed (unknown areaId):",e),R(`setActiveArea: FAILED unknown ${e}`))}function Yt(){return gt}const so=14,lo=0;function te(e,t){const n=U();if(!n||!co(n,e,t))return!1;const a=On(n);if(!a||a.length===0)return!1;let o=!1;for(const i of a)if(ro(e,t,i,lo)){o=!0;break}if(!o)return!1;if(!cs()){const i=rs(n);for(const s of i)if(ls(e,t,so,s))return!1}return!0}function is(e,t){const n=U();if(!n)return{ok:!1,reason:"no_world"};if(!co(n,e,t))return{ok:!1,reason:"out_of_world"};let a=!1,o=null,i=1/0;const s=On(n);if(!s||s.length===0)return{ok:!1,reason:"no_walkable"};for(const l of s){if(ro(e,t,l,lo)){a=!0;break}const d=Math.max(l.x,Math.min(e,l.x+l.w)),p=Math.max(l.y,Math.min(t,l.y+l.h)),m=Math.sqrt((e-d)**2+(t-p)**2);m<i&&(i=m,o=l.tag||"unnamed")}if(!a)return{ok:!1,reason:"not_in_walkable_final",nearestArea:o,distance:Math.round(i)};if(!cs()){const l=rs(n);for(const d of l)if(ls(e,t,so,d))return{ok:!1,reason:"hit_obstacle",obstacle:d.tag||d}}return{ok:!0,reason:"ok"}}function ss(e,t,n=0){return t?e.x>=t.x+n&&e.x<=t.x+t.w-n&&e.y>=t.y+n&&e.y<=t.y+t.h-n:!1}function ei(e,t,n=0){if(!t||t.length===0)return{hit:!1,count:0};let a=0;for(const o of t)ss(e,o,n)&&(a+=1);return{hit:a>0,count:a}}function jr(e){return Ct(e.x,e.y)}function ro(e,t,n,a=0){return e>=n.x+a&&e<=n.x+n.w-a&&t>=n.y+a&&t<=n.y+n.h-a}function ls(e,t,n,a){const o=Math.max(a.x,Math.min(e,a.x+a.w)),i=Math.max(a.y,Math.min(t,a.y+a.h)),s=e-o,l=t-i;return s*s+l*l<n*n}function Ct(e,t){const n=U();if(!n)return{x:e,y:t};if(!co(n,e,t))return{x:e,y:t};const a=lo;let o=null,i=1/0;const s=On(n);if(!s||s.length===0)return{x:e,y:t};for(const l of s){const d=l.x+a,p=l.y+a,m=l.x+l.w-a,C=l.y+l.h-a;if(m<=d||C<=p)continue;const g=Math.max(d,Math.min(e,m)),I=Math.max(p,Math.min(t,C)),y=e-g,b=t-I,f=y*y+b*b;f<i&&(i=f,o={x:g,y:I})}if(o&&!te(o.x,o.y)){let p=null,m=1/0;for(let C=8;C<=120;C+=8){for(let g=0;g<360;g+=20){const I=g*Math.PI/180,y=o.x+Math.cos(I)*C,b=o.y+Math.sin(I)*C;if(te(y,b)){const f=(y-e)**2+(b-t)**2;f<m&&(m=f,p={x:y,y:b})}}if(p)break}if(p)return p}return o||{x:e,y:t}}function Wr(e,t,n,a){const o=()=>{if(te(n,a))return{x:n,y:a,reason:"direct",pathLen:Math.hypot(n-e,a-t)};const l=Ct(n,a);if(te(l.x,l.y))return{x:l.x,y:l.y,reason:"snap",pathLen:Math.hypot(l.x-e,l.y-t)};const d=[24,48,72,96,120];let p=null,m=1/0;function C(y,b,f,v,_,P){const M=_-f,E=P-v,$=y-f,O=b-v,L=M*M+E*E;if(L===0)return Math.hypot(y-f,b-v);let q=($*M+O*E)/L;q=Math.max(0,Math.min(1,q));const Z=f+M*q,Lt=v+E*q;return Math.hypot(y-Z,b-Lt)}for(const y of d)for(let b=0;b<360;b+=20){const f=b*Math.PI/180,v=n+Math.cos(f)*y,_=a+Math.sin(f)*y;if(!te(v,_))continue;const P=Math.hypot(v-n,_-a),M=C(v,_,e,t,n,a),E=P*1+M*1.5;E<m&&(m=E,p={x:v,y:_,r:y})}if(p)return{x:p.x,y:p.y,reason:`nearby:${p.r}`,pathLen:Math.hypot(p.x-e,p.y-t)};const g=16,I=320;for(let y=g;y<=I;y+=g)for(let b=0;b<360;b+=30){const f=b*Math.PI/180,v=n+Math.cos(f)*y,_=a+Math.sin(f)*y;if(te(v,_))return{x:v,y:_,reason:`search:${y}`,pathLen:Math.hypot(v-e,_-t)}}return{x:e,y:t,reason:"stuck",pathLen:0}};let i=o();return i.reason!=="stuck"?i:zr(e,t,n,a)&&(i=o(),i.reason!=="stuck")?{...i,reason:`bridge:${i.reason}`}:i}function ti(e,t){const n=U();if(!n)return null;for(const a of n.zones){const o=a.interactBounds||a.bounds;if(ro(e,t,o,0))return a}return null}let tn=!1;function On(e){const t=e.walkableInflated||e.walkableFinal||e.walkable||[];return t.length>0?t:e.zones&&e.zones.length>0?(tn||(console.warn("[collision] walkableFinal empty; falling back to zones"),tn=!0),e.zones.map(n=>n.bounds).filter(Boolean)):(tn||(console.warn("[collision] no walkable data available"),tn=!0),[])}function zr(e,t,n,a){const o=U();if(!o||o._bridgeRects&&o._bridgeRects.length>=12)return!1;const i=Ct(e,t),s=Ct(n,a);if(!Number.isFinite(i.x)||!Number.isFinite(i.y)||!Number.isFinite(s.x)||!Number.isFinite(s.y)||!te(i.x,i.y)||!te(s.x,s.y)||Math.hypot(s.x-i.x,s.y-i.y)<8)return!1;const d=Fr(i,s,24);return d?(o.walkableInflated||(o.walkableInflated=[]),o.walkableInflated.push(d),o._bridgeRects||(o._bridgeRects=[]),o._bridgeRects.push(d),console.warn("[collision] bridge added",{start:{x:Math.round(i.x),y:Math.round(i.y)},goal:{x:Math.round(s.x),y:Math.round(s.y)},bridge:d}),!0):!1}function Fr(e,t,n){const a=t.x-e.x,o=t.y-e.y;if(!Number.isFinite(a)||!Number.isFinite(o))return null;if(Math.abs(a)>=Math.abs(o)){const d=Math.min(e.x,t.x),p=Math.abs(a),m=(e.y+t.y)/2-n/2;return{x:d,y:m,w:p,h:n,tag:"bridge:horizontal"}}const i=Math.min(e.y,t.y),s=Math.abs(o);return{x:(e.x+t.x)/2-n/2,y:i,w:n,h:s,tag:"bridge:vertical"}}function Gr(e,t){const n=U();if(!n)return 1/0;const a=On(n);if(!a||a.length===0)return 1/0;let o=1/0;return a.forEach(i=>{const s=Math.max(i.x,Math.min(e,i.x+i.w)),l=Math.max(i.y,Math.min(t,i.y+i.h)),d=Math.hypot(e-s,t-l);d<o&&(o=d)}),o}function rs(e){return e.obstaclesFinal||e.obstacles||[]}function cs(){return Tn()?.debug?.disableObstacles===!0}function co(e,t,n){const a=e?.meta?.size||e?.size;return a?t>=0&&n>=0&&t<=a.w&&n<=a.h:!0}const wn={sakura:{id:"sakura",label:"Ê°ú",types:[{kind:"petal",count:85,speed:12,size:[2,6],alpha:[.18,.55],drift:[-6,4],flutter:1}]},firefly:{id:"firefly",label:"Ëõç",types:[{kind:"firefly",count:55,speed:9,size:[1,3],alpha:[.16,.55],blink:1.2}]},momiji:{id:"momiji",label:"Á¥ÖËëâ",types:[{kind:"leaf",count:65,speed:12,size:[3,8],alpha:[.18,.55],drift:[-10,6],flutter:.9}]},snow:{id:"snow",label:"Èõ™",types:[{kind:"snow",count:110,speed:10,size:[1,4],alpha:[.12,.4],drift:[-2,12],flutter:.2}]}},uo="firefly";let jt=null,_a=null,Wt=null,fo=uo,An=[],vn=!1;function Le(e,t){return e+Math.random()*(t-e)}function ni(e,t,n){return Math.max(t,Math.min(n,e))}function Jr(e){return wn[e]||wn[uo]}function ds(){const e=Jr(fo),t=Wt?Wt():{w:0,h:0},n=t.w||1,a=t.h||1,o=[];e.types.forEach(i=>{const s=Math.max(0,i.count||0);for(let l=0;l<s;l+=1){const d=Le(15,50),p=Le(55,75),m=Le(48,62);o.push({kind:i.kind,x:Math.random()*n,y:Math.random()*a,size:Le(i.size?.[0]??2,i.size?.[1]??4),alphaBase:Le(i.alpha?.[0]??.2,i.alpha?.[1]??.5),speed:i.speed??10,drift:i.drift||[-4,4],flutter:i.flutter??0,blink:i.blink??0,phase:Math.random()*Math.PI*2,wiggle:Le(.6,1.4),rot:Le(-Math.PI,Math.PI),rotSpeed:Le(-.8,.8),color:{h:d,s:p,l:m}})}}),An=o}function Ur(e={}){jt=e.getAreaId||(()=>"area:core"),_a=e.getZoom||(()=>1),Wt=e.getCanvasSize||(()=>({w:0,h:0}))}function us(e){e&&(fo=e,ds())}function qr(){return fo}function Zr(e=16){if(!vn&&!(jt&&jt()!=="area:garden"))try{An.length||ds();const t=Wt?Wt():{w:0,h:0},n=t.w||1,a=t.h||1,o=e/1e3;An.forEach(i=>{const s=Le(i.drift?.[0]??-2,i.drift?.[1]??2),l=(i.speed||10)*o;i.phase+=o*(i.flutter?1+i.flutter:.5),i.x+=s*o*6+Math.sin(i.phase)*i.flutter*.6,i.y+=l+Math.cos(i.phase)*i.flutter*.4,i.rot+=(i.rotSpeed||0)*o,i.x<-20&&(i.x=n+20),i.x>n+20&&(i.x=-20),i.y>a+20&&(i.y=-20),i.y<-20&&(i.y=a+20)})}catch(t){vn=!0,console.warn("[Ambient] update failed, disabling particles",t)}}function Kr(e){if(!vn&&!(jt&&jt()!=="area:garden")&&e)try{const t=_a?_a():1,n=ni(1/(t||1),.7,1.4);e.save(),An.forEach(a=>{const o=a.blink?.2+.8*Math.sin(a.phase*2)*.5+.5:1,i=ni(a.alphaBase*o,.05,.9),s=a.size*n,l=Math.min(.25,i*.6);switch(a.kind){case"petal":{e.save(),e.translate(a.x,a.y),e.rotate(a.rot+Math.sin(a.phase)*.6),e.fillStyle=`rgba(255, 192, 203, ${i})`,e.strokeStyle=`rgba(255, 255, 255, ${l})`,e.beginPath(),e.ellipse(0,0,s*.6,s,0,0,Math.PI*2),e.fill(),e.lineWidth=1,e.stroke(),e.restore();break}case"leaf":{e.save(),e.translate(a.x,a.y),e.rotate(a.rot+Math.cos(a.phase)*.8),e.fillStyle=`hsla(${a.color?.h??25}, ${a.color?.s??65}%, ${a.color?.l??55}%, ${i})`,e.strokeStyle=`rgba(0, 0, 0, ${l})`,e.beginPath();for(let d=0;d<10;d+=1){const p=Math.PI*2*d/10,m=d%2===0?s:s*.55,C=Math.cos(p)*m,g=Math.sin(p)*m;d===0?e.moveTo(C,g):e.lineTo(C,g)}e.closePath(),e.fill(),e.lineWidth=1,e.stroke(),e.restore();break}case"firefly":{e.fillStyle=`rgba(190, 255, 140, ${i})`,e.beginPath(),e.arc(a.x,a.y,s*.8,0,Math.PI*2),e.fill(),e.fillStyle=`rgba(190, 255, 140, ${i*.25})`,e.beginPath(),e.arc(a.x,a.y,s*2.2,0,Math.PI*2),e.fill();break}default:{e.save(),e.shadowColor="rgba(255, 255, 255, 0.35)",e.shadowBlur=3,e.fillStyle=`rgba(255, 255, 255, ${i})`,e.beginPath(),e.arc(a.x,a.y,s*.7,0,Math.PI*2),e.fill(),e.restore();break}}}),e.restore()}catch(t){vn=!0,console.warn("[Ambient] render failed, disabling particles",t)}}const ai=[{id:"day",label:"Day",overlay:"rgba(0,0,0,0)"},{id:"dusk",label:"Dusk",overlay:"rgba(255,140,80,0.10)"},{id:"night",label:"Night",overlay:"rgba(60,80,140,0.18)"}],nn=["day","dusk","night"];function Yr(e){const t=nn.indexOf(e);return t<0?nn[0]:nn[(t+1)%nn.length]}function fs(e){return ai.find(t=>t.id===e)||ai[0]}const Zn=["#fcd5c5","#f5c4a8","#e8b090","#d49a78","#c48860"],Kn=["#2d1b0e","#4a3020","#8b4513","#d4a86c","#1a1a1a","#6b4423"],Yn=["#5a9bd4","#6ab077","#e6a644","#d46a6a","#7c7c7c","#9b59b6"],Vn=["#34495e","#2c3e50","#5d6d7e"],oi=["#2c2c2c","#4a3020"],ii=["none","none","none","none","glasses","headphones"];function Vr(e){let t=0;for(let n=0;n<e.length;n++){const a=e.charCodeAt(n);t=(t<<5)-t+a,t=t&t}return Math.abs(t)}function nt(e){const t=Math.sin(e++)*1e4;return t-Math.floor(t)}function Qr(e){const t=Vr(e||"default"),n=Math.floor(nt(t)*Zn.length),a=Math.floor(nt(t+1)*Kn.length),o=Math.floor(nt(t+2)*Yn.length),i=Math.floor(nt(t+3)*Vn.length),s=Math.floor(nt(t+4)*oi.length),l=Math.floor(nt(t+5)*ii.length);return{skin:Zn[n],skinDark:an(Zn[n],20),hair:Kn[a],hairDark:an(Kn[a],30),shirt:Yn[o],shirtDark:an(Yn[o],25),pants:Vn[i],pantsDark:an(Vn[i],20),shoes:oi[s],accessory:ii[l],outline:"#3d3d3d"}}function an(e,t){const n=parseInt(e.slice(1),16),a=Math.max(0,(n>>16)-t),o=Math.max(0,(n>>8&255)-t),i=Math.max(0,(n&255)-t);return`#${(a<<16|o<<8|i).toString(16).padStart(6,"0")}`}const Qn=new Map,Xr={W:"E",NW:"NE",SW:"SE"};function ec(e,t){if(Math.abs(e)<.5&&Math.abs(t)<.5)return null;const n=Math.atan2(t,e)*180/Math.PI;return n>=-22.5&&n<22.5?"E":n>=22.5&&n<67.5?"SE":n>=67.5&&n<112.5?"S":n>=112.5&&n<157.5?"SW":n>=157.5||n<-157.5?"W":n>=-157.5&&n<-112.5?"NW":n>=-112.5&&n<-67.5?"N":n>=-67.5&&n<-22.5?"NE":"S"}function tc(e,t,n,a){const o=t||"S",i=a?n%3:1,s=`${e}:${o}:${i}`;if(Qn.has(s))return Qn.get(s);const l=Xr[o];let d;if(l){const p=si(e,l,i);d=lc(p)}else d=si(e,o,i);return Qn.set(s,d),d}function si(e,t,n){const o=document.createElement("canvas");o.width=16,o.height=16;const i=o.getContext("2d");i.imageSmoothingEnabled=!1;const s=Qr(e);return nc(i,16),ac(i,t,n,s,16),oc(i,t,s,16),s.accessory!=="none"&&ic(i,t,s.accessory,16),sc(i,s.outline,16),o}function nc(e,t){e.fillStyle="rgba(0,0,0,0.25)",e.beginPath(),e.ellipse(t/2,t-2,4,2,0,0,Math.PI*2),e.fill()}function ac(e,t,n,a,o){const i=o/2;e.fillStyle=a.pants,e.fillRect(i-3,o-6,2,4),e.fillRect(i+1,o-6,2,4),n!==1&&(e.fillStyle=a.pantsDark,n===0?e.fillRect(i-3,o-5,2,3):e.fillRect(i+1,o-5,2,3)),e.fillStyle=a.shoes,e.fillRect(i-3,o-3,2,2),e.fillRect(i+1,o-3,2,2),e.fillStyle=a.shirt,e.fillRect(i-3,o-10,6,5),e.fillStyle=a.shirtDark,e.fillRect(i+2,o-10,1,4);const s=n===0?1:n===2?-1:0;e.fillStyle=a.shirt,e.fillRect(i-4,o-9+s,1,3),e.fillRect(i+3,o-9-s,1,3),e.fillStyle=a.skin,e.fillRect(i-4,o-7+s,1,1),e.fillRect(i+3,o-7-s,1,1)}function oc(e,t,n,a){const o=a/2,i=3;e.fillStyle=n.skin,e.fillRect(o-3,i,6,5),e.fillRect(o-2,i-1,4,1),e.fillRect(o-2,i+5,4,1),e.fillStyle=n.hair,e.fillRect(o-3,i-1,6,2),e.fillRect(o-2,i-2,4,1),t==="S"||t==="SE"||t==="SW"?(e.fillRect(o-3,i,1,2),e.fillRect(o+2,i,1,2)):t==="E"?e.fillRect(o-3,i,1,3):(t==="N"||t==="NE"||t==="NW")&&e.fillRect(o-3,i,6,3),e.fillStyle=n.hairDark,e.fillRect(o-1,i+1,2,1),t==="S"||t==="SE"||t==="SW"?(e.fillStyle="#2d2d2d",e.fillRect(o-2,i+2,1,1),e.fillRect(o+1,i+2,1,1),e.fillStyle="#ffffff",e.fillRect(o-2,i+2,1,1),e.fillRect(o+1,i+2,1,1),e.fillStyle="#2d2d2d",e.fillRect(o-2,i+2,1,1),e.fillRect(o+1,i+2,1,1)):(t==="E"||t==="NE")&&(e.fillStyle="#2d2d2d",e.fillRect(o+1,i+2,1,1))}function ic(e,t,n,a){const o=a/2;n==="glasses"?(t==="S"||t==="SE"||t==="SW")&&(e.fillStyle="#1a1a1a",e.fillRect(o-3,5,6,1),e.fillRect(o-3,5,2,2),e.fillRect(o+1,5,2,2)):n==="headphones"&&(e.fillStyle="#2d2d2d",e.fillRect(o-4,2,1,4),e.fillRect(o+3,2,1,4),e.fillRect(o-3,1,6,1))}function sc(e,t,n){const o=e.getImageData(0,0,n,n).data,i=[];for(let s=0;s<n;s++)for(let l=0;l<n;l++){const d=(s*n+l)*4;if(o[d+3]>0){const m=[[l-1,s],[l+1,s],[l,s-1],[l,s+1]];for(const[C,g]of m)if(C<0||C>=n||g<0||g>=n)i.push([C,g]);else{const I=(g*n+C)*4;o[I+3]===0&&i.push([C,g])}}}e.fillStyle=t,i.forEach(([s,l])=>{s>=0&&s<n&&l>=0&&l<n&&e.fillRect(s,l,1,1)})}function lc(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");return n.imageSmoothingEnabled=!1,n.translate(e.width,0),n.scale(-1,1),n.drawImage(e,0,0),t}const La=new Map,rc=9,cc=1e3/rc;function dc(e,t,n,a,o){let i=La.get(e);if(i||(i={direction:"S",frame:1,frameTimer:0,isMoving:!1},La.set(e,i)),t&&(Math.abs(n)>.1||Math.abs(a)>.1)){const s=ec(n,a);s&&(i.direction=s)}return i.isMoving=t,t?(i.frameTimer+=o,i.frameTimer>=cc&&(i.frameTimer=0,i.frame=(i.frame+1)%3)):(i.frame=1,i.frameTimer=0),i}function li(e){return La.get(e)||{direction:"S",frame:1,isMoving:!1}}function ri(e,t,n,a,o,i=1,s=!1){const l=tc(a,o.direction,o.frame,o.isMoving);if(!l)return;e.save(),e.imageSmoothingEnabled=!1;const m=16*(Math.max(1,Math.round(2*i))/i),C=t-m/2,g=n-m+4;s&&(e.shadowColor="rgba(66, 133, 244, 0.5)",e.shadowBlur=4),e.drawImage(l,0,0,16,16,C,g,m,m),e.restore()}function ci(e,t,n,a,o,i=1){e.save();const s=n-36;e.font="500 11px Inter, system-ui, sans-serif";const d=e.measureText(a).width+12,p=16,m=t-d/2;e.fillStyle="rgba(255, 255, 255, 0.92)",uc(e,m,s,d,p,4),e.fill(),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.stroke(),e.fillStyle="#374151",e.textAlign="center",e.textBaseline="middle",e.fillText(a,t,s+p/2);const C={online:"#22c55e",away:"#f59e0b",busy:"#ef4444",offline:"#9ca3af"};e.fillStyle=C[o]||C.online,e.beginPath(),e.arc(t+d/2-4,s+p/2,3,0,Math.PI*2),e.fill(),e.strokeStyle="#fff",e.lineWidth=1,e.stroke(),e.restore()}function uc(e,t,n,a,o,i){e.beginPath(),e.moveTo(t+i,n),e.arcTo(t+a,n,t+a,n+o,i),e.arcTo(t+a,n+o,t,n+o,i),e.arcTo(t,n+o,t,n,i),e.arcTo(t,n,t+a,n,i),e.closePath()}let Re=null,c=null,kn=null,D={x:0,y:0,zoom:1},z={w:0,h:0},di=null,Xn=!1,Da=null,on=!1,ea="/assets/maps/map.png",ui=new Set,ta="";const fc=.65,gc=1.6,mc=[{x:126,y:173},{x:374,y:229},{x:274,y:404},{x:529,y:423}],pc=115,Ic=.42,yc=.12;function bc(){return new Promise(e=>requestAnimationFrame(e))}async function hc(e){return Re=e,c=Re.getContext("2d"),kn=document.getElementById("canvas-container"),c&&(c.imageSmoothingEnabled=!1),await gs("/assets/maps/map.png"),sn(),await bc(),sn(),window.addEventListener("resize",sn),di=new ResizeObserver(()=>{sn()}),di.observe(kn),Ur({getAreaId:()=>Yt(),getZoom:()=>D.zoom,getCanvasSize:()=>({w:z.w,h:z.h})}),{canvas:Re,ctx:c}}function Cc(){const e=window.location.pathname||"/";if(e==="/")return"/";const t=e.split("/").filter(Boolean);return t.length?`/${t[0]}/`:"/"}function wc(e){const t=String(e||"");if(!t||/^https?:\/\//i.test(t))return t;if(t.startsWith("./")||t.startsWith("../"))return new URL(t,window.location.href).href;if(t.startsWith("/")){const n=Cc();return`${window.location.origin}${n}${t.slice(1)}`}return new URL(t,window.location.href).href}async function gs(e){if(!e||e===ea&&on)return;ea=e;const t=wc(e);return ui.has(t)||(ui.add(t),console.log("[bg] loading:",t,"from",e)),new Promise(n=>{const a=new Image;on=!1,a.onload=()=>{Da=a,on=!0,console.log("[MapRenderer] Background image loaded:",ea,a.width,"x",a.height),n()},a.onerror=o=>{on=!1,console.warn("[bg] FAILED:",t,"from",e,o),n()},a.src=t})}function sn(){if(!Re||!kn)return;const e=kn.getBoundingClientRect(),t=Math.floor(e.width),n=Math.floor(e.height);if(t<=0||n<=0)return;const a=window.devicePixelRatio||1;Re.width=Math.floor(t*a),Re.height=Math.floor(n*a),Re.style.width=t+"px",Re.style.height=n+"px",c.setTransform(a,0,0,a,0,0),z={w:t,h:n}}function fi(e,t,n=16.67){const a=U();if(!a)return;const o=z.w/D.zoom,i=z.h/D.zoom,s=e,l=t,d=o/2,p=a.size.w-o/2,m=i/2,C=a.size.h-i/2,g=Math.max(d,Math.min(s,p)),I=Math.max(m,Math.min(l,C)),y=1-Math.pow(1-yc,n/16.67);D.x+=(g-D.x)*y,D.y+=(I-D.y)*y,ms()}function ms(){const e=U();if(!e)return;const t=z.w/D.zoom,n=z.h/D.zoom,a=t/2,o=Math.max(a,e.size.w-t/2),i=n/2,s=Math.max(i,e.size.h-n/2);D.x=Math.max(a,Math.min(D.x,o)),D.y=Math.max(i,Math.min(D.y,s))}function Ac(e,t,n){const a=xa(t,n),i=Math.exp(-e*.0015),s=Math.max(fc,Math.min(D.zoom*i,gc));if(Math.abs(s-D.zoom)<1e-4)return;D.zoom=s;const l=xa(t,n);D.x+=a.x-l.x,D.y+=a.y-l.y,ms()}function xa(e,t){const n=e/z.w,a=t/z.h,o=n*z.w,i=a*z.h,s=z.w/2,l=z.h/2,d=(o-s)/D.zoom+D.x,p=(i-l)/D.zoom+D.y;return{x:d,y:p}}function vc(e,t){const n=z.w/2,a=z.h/2,o=(e-D.x)*D.zoom+n,i=(t-D.y)*D.zoom+a;return{x:o,y:i}}function kc(e,t,n=[],a={},o=null,i=0,s=16,l=Yt(),d="day",p=null){if(!c)return;const m=U();if(!m||m.isMapLoading||!m.isReady||!m.size||!e||!Number.isFinite(e.x)||!Number.isFinite(e.y)){Xn||(Xn=!0,console.warn("[render guard] skip frame",{hasWorld:!!m,hasSize:!!m?.size,isReady:m?.isReady,isMapLoading:m?.isMapLoading,playerPos:e,mapId:m?.meta?.id}));return}Xn=!1,c.fillStyle="#2a2520",c.fillRect(0,0,z.w,z.h),c.save();const C=z.w/2,g=z.h/2;c.translate(C,g),c.scale(D.zoom,D.zoom),c.translate(-D.x,-D.y),Da?c.drawImage(Da,0,0,m.size.w,m.size.h):(c.fillStyle="#e8e4dc",c.fillRect(0,0,m.size.w,m.size.h)),ps&&Bc(),p&&m.desks&&Lc(m.desks,p),o&&_c(o.x,o.y,i),n.forEach(y=>{const b=li(y.actorId||y.displayName);ri(c,y.pos.x,y.pos.y,y.displayName,b,D.zoom,!1),ci(c,y.pos.x,y.pos.y,y.displayName,y.status,D.zoom),gi(y.pos.x,y.pos.y,y.callStatus,D.zoom)});const I=li(a.actorId||"me");ri(c,e.x,e.y,a.displayName||"You",I,D.zoom,!0),ci(c,e.x,e.y,a.displayName||"You",a.status||"online",D.zoom),gi(e.x,e.y,a.callStatus,D.zoom),window.DEBUG_COLLISION&&Sc(m,e),c.restore(),Zr(s),Kr(c),Mc(l,d)}function Mc(e,t){if(!c)return;if(e!=="area:garden"){ta="";return}const n=fs(t),a=n?.overlay||"rgba(0,0,0,0)",o=`${e}:${n?.id||"unknown"}`;ta!==o&&(ta=o,console.log("[TimeOverlay] applied",{areaId:e,requested:t,presetId:n?.id||"day",overlay:a})),c.save(),c.fillStyle=a,c.fillRect(0,0,z.w,z.h),c.restore(),n?.id==="night"&&Ec()}function Ec(){c&&(c.save(),c.globalCompositeOperation="screen",mc.forEach(e=>{if(!e)return;const t=vc(e.x,e.y),n=Math.max(1,pc*D.zoom),a=Math.max(0,Math.min(1,Ic));if(t.x+n<0||t.x-n>z.w||t.y+n<0||t.y-n>z.h)return;const o=c.createRadialGradient(t.x,t.y,0,t.x,t.y,n);o.addColorStop(0,`rgba(255,235,170,${a})`),o.addColorStop(1,"rgba(255,235,170,0)"),c.fillStyle=o,c.beginPath(),c.arc(t.x,t.y,n,0,Math.PI*2),c.fill()}),c.globalCompositeOperation="source-over",c.restore())}function Sc(e,t){const n=e.walkableBase||[],a=e.walkableFromZones||[],o=e.walkableInflated||e.walkableFinal||e.walkable||[],i=e.worldObstacles||e.obstaclesFinal||e.obstacles||[],s=e.deskColliders||[],l=e.zones||[],d=Nn()||[],p=e.desks||[],m=e.desks?.[0]?.__debug?.floorRect,C=window.__moveDebug,g=window.__walkDebug,I=Tn()?.debug||{},y=I.drawWorldObstacles!==!1,b=I.drawDeskColliders!==!1;c.save(),c.fillStyle="rgba(34, 197, 94, 0.18)",n.forEach(f=>{c.fillRect(f.x,f.y,f.w,f.h)}),c.fillStyle="rgba(59, 130, 246, 0.18)",a.forEach(f=>{c.fillRect(f.x,f.y,f.w,f.h)}),c.fillStyle="rgba(34, 197, 94, 0.14)",o.forEach(f=>{c.fillRect(f.x,f.y,f.w,f.h)}),c.strokeStyle="rgba(34, 197, 94, 0.85)",c.lineWidth=1.5,o.forEach(f=>{c.strokeRect(f.x,f.y,f.w,f.h)}),y&&(c.strokeStyle="rgba(251, 146, 60, 0.9)",c.lineWidth=2,c.fillStyle="rgba(251, 146, 60, 0.95)",c.font="12px sans-serif",i.forEach(f=>{c.strokeRect(f.x,f.y,f.w,f.h),f.tag&&c.fillText(String(f.tag),f.x+4,f.y+14)})),b&&(c.fillStyle="rgba(239, 68, 68, 0.22)",c.strokeStyle="rgba(239, 68, 68, 0.9)",c.lineWidth=1.5,s.forEach(f=>{c.fillRect(f.x,f.y,f.w,f.h),c.strokeRect(f.x,f.y,f.w,f.h)})),b&&p.forEach(f=>{const v=f.posAbs||f.pos,_=f.standPointAbs||f.standPoint,P=f.boundsAbs||f.bounds;P&&(c.strokeStyle="rgba(250, 204, 21, 0.9)",c.lineWidth=1,c.strokeRect(P.x,P.y,P.w,P.h)),v&&(c.fillStyle="rgba(34, 197, 94, 0.95)",c.beginPath(),c.arc(v.x,v.y,3,0,Math.PI*2),c.fill()),_&&(c.fillStyle="rgba(59, 130, 246, 0.95)",c.beginPath(),c.arc(_.x,_.y,3,0,Math.PI*2),c.fill())}),b&&m&&(c.strokeStyle="rgba(168, 85, 247, 0.9)",c.lineWidth=1.5,c.strokeRect(m.x,m.y,m.w,m.h)),c.strokeStyle="rgba(59, 130, 246, 0.8)",c.lineWidth=1,c.font="12px sans-serif",c.fillStyle="rgba(59, 130, 246, 0.9)",l.forEach(f=>{const v=f.bounds;v&&(c.strokeRect(v.x,v.y,v.w,v.h),f.id&&c.fillText(f.id,v.x+4,v.y+12))}),g?.click&&(c.fillStyle="rgba(234, 179, 8, 0.9)",c.beginPath(),c.arc(g.click.x,g.click.y,4,0,Math.PI*2),c.fill()),g?.snapped&&(c.strokeStyle="rgba(34, 211, 238, 0.8)",c.lineWidth=1,c.beginPath(),c.moveTo(t.x,t.y),c.lineTo(g.snapped.x,g.snapped.y),c.stroke(),c.fillStyle="rgba(34, 211, 238, 0.9)",c.beginPath(),c.arc(g.snapped.x,g.snapped.y,4,0,Math.PI*2),c.fill()),C?.click&&C?.goal&&C?.start&&(c.strokeStyle="rgba(16, 185, 129, 0.8)",c.lineWidth=1.5,c.beginPath(),c.moveTo(C.start.x,C.start.y),c.lineTo(C.goal.x,C.goal.y),c.stroke(),c.fillStyle="rgba(239, 68, 68, 0.9)",c.beginPath(),c.arc(C.click.x,C.click.y,4,0,Math.PI*2),c.fill(),c.fillStyle="rgba(16, 185, 129, 0.9)",c.beginPath(),c.arc(C.goal.x,C.goal.y,4,0,Math.PI*2),c.fill()),c.strokeStyle="rgba(59, 130, 246, 0.85)",c.lineWidth=2,d.forEach(f=>{f.bounds?c.strokeRect(f.bounds.x,f.bounds.y,f.bounds.w,f.bounds.h):f.x!==void 0&&f.y!==void 0&&f.r!==void 0&&(c.beginPath(),c.arc(f.x,f.y,f.r,0,Math.PI*2),c.stroke())}),c.strokeStyle="rgba(255, 255, 255, 0.85)",c.lineWidth=2,c.beginPath(),c.arc(t.x,t.y,so,0,Math.PI*2),c.stroke(),c.restore()}function _c(e,t,n){const a=Date.now()-n,o=Math.min(a/500,1),i=1-o*.6,s=1+o*.4;c.save(),c.translate(e,t),c.scale(s,s),c.globalAlpha=i,c.strokeStyle="#4285f4",c.lineWidth=2,c.beginPath(),c.arc(0,0,12,0,Math.PI*2),c.stroke(),c.fillStyle="rgba(66, 133, 244, 0.25)",c.beginPath(),c.arc(0,0,8,0,Math.PI*2),c.fill(),c.fillStyle="#4285f4",c.beginPath(),c.arc(0,0,3,0,Math.PI*2),c.fill(),c.restore()}function Lc(e,t){if(!e||!t||!(t instanceof Map))return;const n=new Map;for(const[a,o]of t){const i=o?.seatLockedDeskId||o?.seatedDeskId;i&&n.set(i,o)}e.forEach(a=>{const o=n.get(a.id);if(!o)return;const i=a.pos||a.posAbs;if(!i)return;const s=(o.displayName||"??").slice(0,2).toUpperCase();c.save(),c.fillStyle="rgba(0,0,0,0.65)",c.beginPath(),c.roundRect(i.x-14,i.y-30,28,16,4),c.fill(),c.fillStyle="#fff",c.font="bold 10px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText(s,i.x,i.y-22),c.restore()})}function gi(e,t,n,a=1){if(!n||n==="idle")return;const o=n==="in_call"?"#16a34a":n==="ringing"?"#f59e0b":"#0ea5e9",i=Math.max(6,6/Math.max(.7,a)),s=e+18/Math.max(.7,a),l=t-28/Math.max(.7,a);c.save(),c.fillStyle=o,c.beginPath(),c.arc(s,l,i,0,Math.PI*2),c.fill(),n==="in_call"&&(c.strokeStyle="rgba(22,163,74,0.45)",c.lineWidth=Math.max(1,2/Math.max(.7,a)),c.beginPath(),c.arc(s,l,i+3/Math.max(.7,a),0,Math.PI*2),c.stroke()),c.fillStyle="#ffffff",c.font=`${Math.max(8,8/Math.max(.7,a))}px sans-serif`,c.textAlign="center",c.textBaseline="middle",c.fillText("‚òé",s,l+.5),c.restore()}function Dc(){return{...D}}let ps=!1;function xc(e){ps=e}function Bc(){const e=Nn();c.save(),c.lineWidth=2,c.font="10px monospace",c.textAlign="left",c.textBaseline="top",e.forEach(t=>{c.beginPath();let n,a;t.id==="spot:admin"?(c.strokeStyle="#ff00ff",c.fillStyle="rgba(255, 0, 255, 0.2)"):t.id.includes("meeting")?(c.strokeStyle="#ffa500",c.fillStyle="rgba(255, 165, 0, 0.2)"):(c.strokeStyle="#00ffff",c.fillStyle="rgba(0, 255, 255, 0.2)"),t.bounds?(c.rect(t.bounds.x,t.bounds.y,t.bounds.w,t.bounds.h),n=t.bounds.x,a=t.bounds.y):t.r&&(c.arc(t.x,t.y,t.r,0,Math.PI*2),n=t.x-t.r,a=t.y-t.r),c.fill(),c.stroke();const i=`${t.label||t.id} (P:${t.priority||0})`,s=c.measureText(i);c.fillStyle="rgba(0, 0, 0, 0.7)",c.fillRect(n,a-14,s.width+4,14),c.fillStyle="#fff",c.strokeStyle="#000",c.lineWidth=2,c.strokeText(i,n+2,a-12),c.fillText(i,n+2,a-12)}),c.restore()}const Tc=160;let Y=null,S={x:260,y:260},ce="down",ie=!1,zt=!1,xe=null,mi=0,X=null,Is=null;function Nc(e,t){S={...e},Y=null,ie=!1,zt=!1,xe=t,console.log("[MOVE] initMovement",e)}function ys(e,t){if(zt){console.log("[MOVE] ignored setMoveTarget because movementLocked"),He();return}console.log("[MOVE] setMoveTarget called",{requested:{x:Math.round(e),y:Math.round(t)}});const n=U();if(!n){console.warn("[MOVE] No world model!");return}const a=n.walkableInflated||n.walkableFinal||n.walkable||[],o=n.deskColliders||[],i=n.worldObstacles||n.obstaclesFinal||n.obstacles||[],s=n.obstaclesFinal||n.obstacles||[],l={x:e,y:t},d=ei(l,a),p=ei(l,s),m=jr(l),C=ti(e,t),g=d.hit?p.hit?"hit-obstacle":Math.hypot(m.x-e,m.y-t)>.5?"snap":"ok":"not-walkable";if(console.log("[MOVE] click pre-findPath",{click:{x:Math.round(e),y:Math.round(t)},start:{x:Math.round(S.x),y:Math.round(S.y)}}),console.log(`[WALKDBG] click=(${Math.round(e)},${Math.round(t)}) inWalkable=${d.hit} inObstacle=${p.hit} zone=${C?.id||"null"} constrainedBecause=${g} snapped=(${Math.round(m.x)},${Math.round(m.y)})`),p.hit){const L=pi(l,o),q=pi(l,i);console.log(L?`[WALKDBG] blockedBy=desk id=${L}`:q?`[WALKDBG] blockedBy=world id=${q}`:"[WALKDBG] blockedBy=unknown")}const I=ti(S.x,S.y),y=is(e,t),b=Gr(e,t);if(!p.hit&&y?.reason==="hit_obstacle"){const L=String(y.obstacle||"unknown"),q=L.toLowerCase().includes("desk")?"desk":"world";console.log(`[WALKDBG] blockedBy=${q} id=${L}`)}const f=Wr(S.x,S.y,e,t);Is=f;const v=te(S.x,S.y),_=te(f.x,f.y),P=Math.hypot(f.x-S.x,f.y-S.y),M=Math.hypot(e-S.x,t-S.y),E=Math.round(f.x)!==Math.round(e)||Math.round(f.y)!==Math.round(t),$=P<3,O=y?.reason==="out_of_world"?"out-of-world":y?.reason==="not_in_walkable_final"?"not-in-walkableFinal":y?.reason==="hit_obstacle"?"hit-obstacle":f.reason==="stuck"?"unreachable":$&&M>12?"snapped-to-start":"ok";if(X={click:{x:e,y:t},goal:{x:f.x,y:f.y},start:{x:S.x,y:S.y},distStartGoal:P,distClick:M,goalSnapped:E,snappedToStart:$,failReason:O},console.log("[MOVE] click/path debug",{click:{x:Math.round(e),y:Math.round(t)},goal:{x:Math.round(f.x),y:Math.round(f.y)},startInWalkableFinal:v,goalInWalkableFinal:_,nearestWalkableDist:Math.round(b),pathLen:Math.round(f.pathLen||0),failReason:O,zoneAt:C?.id||null,currentZone:I?.id||null,snapped:E,goalNearlyStart:$}),window.__moveDebug={click:{x:e,y:t},goal:{x:f.x,y:f.y},start:{x:S.x,y:S.y}},window.__walkDebug={click:{x:e,y:t},snapped:{x:m.x,y:m.y}},console.log("[MOVE] lastPathResult coords",{x:Math.round(f.x),y:Math.round(f.y),reason:f.reason}),console.log("[MOVE] findPath result",{requested:{x:Math.round(e),y:Math.round(t)},final:{x:Math.round(f.x),y:Math.round(f.y)},reason:f.reason}),$&&M>12){console.warn("[MOVE] snapped to start; treating as unreachable");return}f.reason!=="stuck"?(Y={x:f.x,y:f.y},ie=!0,console.log("[MOVE] target set",Y,"reason:",f.reason)):console.warn("[MOVE] findPath returned stuck for",{x:e,y:t})}function Oc(e){if(zt)return He(),{pos:S,facing:ce,moving:!1};const t=Date.now();if(t-mi>500&&(console.log("[MOVE] tick",{pos:S,target:Y,isMoving:ie,deltaMs:e}),mi=t),!ie||!Y)return{pos:S,facing:ce,moving:!1};const n=e/1e3,a=Tc*n,o=Y.x-S.x,i=Y.y-S.y,s=Math.sqrt(o*o+i*i);if(s<=4){const C={distToGoal:Math.round(s),goal:{x:Math.round(Y.x),y:Math.round(Y.y)},start:X?.start?{x:Math.round(X.start.x),y:Math.round(X.start.y)}:null,distStartGoal:X?Math.round(X.distStartGoal):null,distClick:X?Math.round(X.distClick):null,snappedToStart:X?.snappedToStart||!1};return console.log("[MOVE] arrivedCheck",C),X?.snappedToStart&&X?.distClick>12?(Y=null,ie=!1,console.warn("[MOVE] fail: unreachable (snapped to start)",C),xe&&xe(S,ce,!1),{pos:S,facing:ce,moving:!1}):(S={...Y},Y=null,ie=!1,X=null,console.log("[MOVE] arrived",S),xe&&xe(S,ce,!1),{pos:S,facing:ce,moving:!1})}const l=a/s,d=Math.min(1,l),p=S.x+o*d,m=S.y+i*d;Math.abs(o)>Math.abs(i)?ce=o>0?"right":"left":ce=i>0?"down":"up";{const g=p-S.x,I=m-S.y,y=Math.sqrt(g*g+I*I),b=Math.max(1,Math.ceil(y/4));let f=S.x,v=S.y,_=!1,P=!1;for(let M=0;M<b;M++){const E=(M+1)/b,$=S.x+g*E,O=S.y+I*E;if(te($,O)){f=$,v=O,_=!0;continue}const L=te($,v),q=te(f,O);if(L&&!q){f=$,_=!0;continue}if(!L&&q){v=O,_=!0;continue}if(L&&q){Math.abs(o)>=Math.abs(i)?f=$:v=O,_=!0;continue}P=!0,console.warn("[MOVE] blocked at",{tx:$,ty:O,step:M+1,steps:b});try{const Z=is($,O);console.warn("[MOVE] blocked reason",Z)}catch{}break}S={x:f,y:v},P&&!_&&(Y=null,ie=!1,X=null)}return xe&&xe(S,ce,ie),{pos:S,facing:ce,moving:ie}}function $c(){Y=null,ie=!1,X=null}function He(){try{$c()}catch(e){console.warn("[MOVE] stopMoving failed, forcing stop",e),Y=null,ie=!1,X=null}}function ct(e,t){S=Ct(e,t),Y=null,ie=!1,X=null,xe&&xe(S,ce,!1)}function Ye(){return{...S}}function Mn(){return ce}function ln(){return ie}function na(){return Y?{...Y}:null}function at(e){zt=!!e,zt&&He()}function pi(e,t){if(!t||t.length===0)return null;for(const n of t)if(ss(e,n,0))return n.id||n.tag||"unknown";return null}const Pc=40;function bs(e,t){const n=Nn(),a=[],o=Yt();for(const i of n)if(i?.areaId===o){if(i.x!==void 0&&i.y!==void 0&&i.r!==void 0){const s=e-i.x,l=t-i.y;Math.sqrt(s*s+l*l)<=i.r&&a.push(i)}else if(i.bounds){const s=i.bounds;e>=s.x&&e<=s.x+s.w&&t>=s.y&&t<=s.y+s.h&&a.push(i)}}return a.sort((i,s)=>(s.priority||0)-(i.priority||0))}function hs(e,t){const n=bs(e,t);return n.length>0?n[0]:null}function Rc(e,t){const n=os();let a=null,o=Pc;for(const i of n){const s=i.standPointAbs||i.standPoint||i.posAbs||i.pos;if(i.standPointAbs||console.warn("[desk] missing standPointAbs",i.id),!s)continue;const l=e-s.x,d=t-s.y,p=Math.sqrt(l*l+d*d);p<o&&(a=i,o=p)}if(a){const i=a.standPoint||a.pos;console.log("[desk] nearest",a.id,Math.round(o),e,t,i?.x,i?.y)}return a}function Hc(e,t){const n=hs(e,t);if(n)return{kind:"spot",data:n};const a=os();for(const o of a){const i=o.boundsAbs||o.colliderAbs;if(i){if(e>=i.x&&e<=i.x+i.w&&t>=i.y&&t<=i.y+i.h)return{kind:"desk",data:o};continue}const s=o.posAbs||o.pos;if(!s)continue;const l=e-s.x,d=t-s.y,p=60;if(Math.abs(l)<p/2&&Math.abs(d)<p/2)return{kind:"desk",data:o}}return{kind:null,data:null}}function Ii(e,t,n,a=null){if(e){const o=Sa(e);return o?o.label:e}return a?`„Éá„Çπ„ÇØ ${a.replace("desk:","")} „Å´ÁùÄÂ∏≠‰∏≠`:t?`„Éá„Çπ„ÇØ ${t.replace("desk:","")} „ÇíÁ¢∫‰øù‰∏≠`:n.replace("area:","")}const re=50;function jc(e,t){const n=[{x:re,y:0},{x:-re,y:0},{x:0,y:re},{x:0,y:-re},{x:re,y:re},{x:-re,y:re},{x:re,y:-re},{x:-re,y:-re}];for(const o of n){const i=e+o.x,s=t+o.y;if(te(i,s))return ct(i,s),{success:!0,pos:{x:i,y:s}}}const a=Ct(e,t);return te(a.x,a.y)?(ct(a.x,a.y),{success:!0,pos:a}):{success:!1,pos:Ye()}}function yi(e){return jc(e.x,e.y)}let dt=null,K={pos:{x:0,y:0},target:null,camera:{x:0,y:0},dt:0,lastTickMoveAt:0,lastRenderAt:0,lastClickWorld:null,isMoving:!1};function Wc(){dt=document.createElement("div"),dt.id="debug-hud",dt.style.cssText=`
    position: fixed;
    top: 60px;
    left: 10px;
    background: rgba(0, 0, 0, 0.8);
    color: #0f0;
    font-family: monospace;
    font-size: 11px;
    padding: 8px 12px;
    border-radius: 6px;
    z-index: 9999;
    pointer-events: none;
    line-height: 1.6;
    white-space: pre;
  `,document.body.appendChild(dt)}function zc(e){if(Object.assign(K,e),!dt)return;const t=[`pos: (${K.pos.x.toFixed(1)}, ${K.pos.y.toFixed(1)})`,`target: ${K.target?`(${K.target.x.toFixed(1)}, ${K.target.y.toFixed(1)})`:"null"}`,`camera: (${K.camera.x.toFixed(1)}, ${K.camera.y.toFixed(1)})`,`zoom: ${(K.camera.zoom||1).toFixed(2)}`,`dt: ${K.dt.toFixed(1)}ms`,`isMoving: ${K.isMoving}`,`lastTick: ${Date.now()-K.lastTickMoveAt}ms ago`,K.lastClickWorld?`lastClick: (${K.lastClickWorld.x.toFixed(1)}, ${K.lastClickWorld.y.toFixed(1)})`:"lastClick: null",`canMoveTo: ${K.canMoveTo??"-"}`,K.pathReason?`pathReason: ${K.pathReason}`:""].filter(Boolean);dt.textContent=t.join(`
`)}const Fc=/^sess_[0-9a-fA-F-]{10,}$/;function wt(e){const t=typeof e=="string"?e:"";if(Fc.test(t))return t;const n=Hi();try{oo(n)}catch{}return console.warn("[DB] fallback session_id was not sess_. regenerated.",{old:e,new:n}),n}function go(e,t){const n=typeof e?.message=="string"?e.message:"";return n.includes(`'${t}'`)||n.includes(t)}async function Cs(e,t){t=wt(t);const n=T();let{data:a,error:o}=await n.from("nameplates").select("user_id").eq("display_name",e).neq("user_id",t).maybeSingle();return o&&go(o,"user_id")&&(console.warn("[DB] nameplates.user_id missing, falling back to session_id for duplicate check."),t=wt(t),console.log("[DBG] nameplates fallback session_id =",t),{data:a,error:o}=await n.from("nameplates").select("session_id").eq("display_name",e).neq("session_id",t).maybeSingle()),o?(console.error("Error checking display name:",o),!1):a!==null}async function mo({sessionId:e,displayName:t,avatarKey:n=null,avatarColor:a=null}){e=wt(e);const o=T();let i=e,s=e,{data:l,error:d}=await o.from("nameplates").upsert({user_id:i,display_name:t,avatar_key:n,avatar_color:a,updated_at:new Date().toISOString()},{onConflict:"user_id"}).select().single();if(d&&go(d,"user_id")&&(console.warn("[DB] nameplates.user_id missing, falling back to session_id for upsert."),s=wt(s),console.log("[DBG] nameplates fallback session_id =",s),{data:l,error:d}=await o.from("nameplates").upsert({session_id:s,display_name:t,avatar_key:n,avatar_color:a,updated_at:new Date().toISOString()},{onConflict:"session_id"}).select().single()),d)throw console.error("[DB] Error upserting nameplate:",{message:d?.message,details:d?.details,hint:d?.hint,code:d?.code,raw:d}),d;return l}async function Gc(){const e=T(),{data:t,error:n}=await e.from("room_settings").select("*"),a=new Map;return n?(console.error("Error fetching room settings:",n),a):(t&&t.forEach(o=>{a.set(o.room_key,{zoomUrl:o.zoom_url||null,isEnabled:o.is_enabled!==!1})}),a)}async function Jc(e){e=wt(e);const t=T();let{data:n,error:a}=await t.from("nameplates").select("*").eq("user_id",e).maybeSingle();return a&&go(a,"user_id")&&(console.warn("[DB] nameplates.user_id missing, falling back to session_id for lookup."),e=wt(e),console.log("[DBG] nameplates fallback session_id =",e),{data:n,error:a}=await t.from("nameplates").select("*").eq("session_id",e).maybeSingle()),a?(console.error("Error fetching nameplate by session:",a),null):n}let he=null,En=[],bi=[],mt=null;const Be={onPresenceChange:null,onEvent:null,onChat:null};function Uc({supabase:e,me:t,onPresenceChange:n,onEvent:a,onChat:o}){Be.onPresenceChange=n,Be.onEvent=a,Be.onChat=o}async function qc({presenceChannelKey:e,initialState:t}){const n=T();return mt={...t||{}},he=n.channel(e,{config:{presence:{key:t.actorId}}}),he.on("presence",{event:"sync"},()=>{const a=he.presenceState();Be.onPresenceChange&&Be.onPresenceChange(a)}).on("presence",{event:"join"},({key:a,newPresences:o})=>{console.log("Presence join:",a,o)}).on("presence",{event:"leave"},({key:a,leftPresences:o})=>{console.log("Presence leave:",a,o)}).subscribe(async a=>{a==="SUBSCRIBED"&&await he.track(mt||{})}),he}async function ot(e){he&&(!e||typeof e!="object"||(mt={...mt||{},...e},await he.track(mt)))}async function Zc(){he&&(await he.untrack(),await he.unsubscribe(),he=null,mt=null)}function Kc({myActorId:e}){const t=T(),n=t.channel(`evt:to:${e}`);n.on("broadcast",{event:"evt"},o=>{const i=o?.payload;if(!(!Be.onEvent||!i))try{Be.onEvent(i)}catch(s){console.error("[realtime] onEvent callback failed (direct)",s,i)}}).subscribe(),En.push(n);const a=t.channel("evt:all");a.on("broadcast",{event:"evt"},o=>{const i=o?.payload;if(!(!Be.onEvent||!i))try{Be.onEvent(i)}catch(s){console.error("[realtime] onEvent callback failed (all)",s,i)}}).subscribe(),En.push(a)}async function ze(e,{type:t,payload:n}){const o=T().channel(`evt:to:${e}`);await o.subscribe(),await o.send({type:"broadcast",event:"evt",payload:{type:t,...n}}),setTimeout(()=>o.unsubscribe(),1e3)}async function Yc(){await Zc();for(const e of En)await e.unsubscribe();En=[];for(const e of bi)await e.unsubscribe();bi=[]}let $n="none",Ft=null;function Vc(e){Ft=e,document.querySelectorAll("#menubar .nav-btn[data-drawer]").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.drawer;Qc(a)})})}function Qc(e){$n===e?Gt():mn(e)}function mn(e){$n=e,ws(),Ft&&Ft(e)}function Gt(){$n="none",ws(),Ft&&Ft("none")}function ws(){document.querySelectorAll("#menubar .nav-btn[data-drawer]").forEach(t=>{const n=t.dataset.drawer===$n;t.classList.toggle("active",n)})}function Sn(e){const t=document.getElementById("my-display-name");t&&(t.textContent=e)}function hi(e){const t=document.getElementById("my-status-dot");t&&(t.className="status-dot",e!=="online"&&t.classList.add(e))}function Xc({hasUnread:e=!1,count:t=0}={}){const n=document.getElementById("chat-unread-dot"),a=Math.max(0,Number(t)||0);n&&n.classList.toggle("visible",!!e||a>0)}const ed=4e3;function B(e,t="info"){const n=document.getElementById("toast-container");if(!n)return;const a=document.createElement("div");a.className="toast";const o={info:"üí¨",success:"‚úÖ",warning:"‚ö†Ô∏è",error:"‚ùå",poke:"üëÜ"};a.innerHTML=`
    <span class="toast-icon">${o[t]||o.info}</span>
    <span class="toast-message">${td(e)}</span>
    <button class="toast-close">√ó</button>
  `,a.querySelector(".toast-close").addEventListener("click",()=>Ci(a)),n.appendChild(a),setTimeout(()=>Ci(a),ed)}function Ci(e){e.parentElement&&(e.classList.add("leaving"),setTimeout(()=>{e.parentElement&&e.parentElement.removeChild(e)},300))}function td(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function nd(e){B(`${e} „ÅåËÇ©„Éù„É≥„Åó„Åæ„Åó„Åü`,"poke")}function As(e){return(e instanceof Date?e:new Date(e)).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"})}function ad(e,t){if(!e||!t)return null;const n=[String(e),String(t)].sort();return`${n[0]}:${n[1]}`}async function od({threadKey:e,senderId:t,recipientId:n,body:a}){const o=T();if(!o)throw new Error("Supabase client is not initialized");const i={thread_key:e,sender_id:t,recipient_id:n,body:String(a||"").slice(0,500)},{data:s,error:l}=await o.from("dm_messages").insert(i).select("*").single();if(l)throw l;return s}async function id(e,t=200){const n=T();if(!n)throw new Error("Supabase client is not initialized");if(!e)return[];const{data:a,error:o}=await n.from("dm_messages").select("*").eq("thread_key",e).order("created_at",{ascending:!0}).limit(Math.max(1,Math.min(500,Number(t)||200)));if(o)throw o;return a||[]}async function sd(e,t=300){const n=T();if(!n)throw new Error("Supabase client is not initialized");if(!e)return[];const{data:a,error:o}=await n.from("dm_messages").select("thread_key,sender_id,recipient_id,body,created_at").or(`sender_id.eq.${e},recipient_id.eq.${e}`).order("created_at",{ascending:!1}).limit(Math.max(1,Math.min(1e3,Number(t)||300)));if(o)throw o;return a||[]}function ld({threadKey:e,onInsert:t,onError:n}){const a=T();if(!a||!e)return async()=>{};const o=a.channel(`dm:thread:${e}`);return o.on("postgres_changes",{event:"INSERT",schema:"public",table:"dm_messages",filter:`thread_key=eq.${e}`},i=>{try{t?.(i?.new||null)}catch(s){n?.(s)}}),o.subscribe(i=>{i==="CHANNEL_ERROR"&&n?.(new Error("dm realtime channel error"))}),async()=>{try{await a.removeChannel(o)}catch(i){n?.(i)}}}function rd({actorId:e,onInsert:t,onError:n}){const a=T();if(!a||!e)return async()=>{};const o=a.channel(`dm:inbox:${e}`);return o.on("postgres_changes",{event:"INSERT",schema:"public",table:"dm_messages"},i=>{try{const s=i?.new||null;if(!s||s.sender_id!==e&&s.recipient_id!==e)return;t?.(s)}catch(s){n?.(s)}}),o.subscribe(i=>{i==="CHANNEL_ERROR"&&n?.(new Error("dm inbox realtime channel error"))}),async()=>{try{await a.removeChannel(o)}catch(i){n?.(i)}}}async function cd(e){const t=T();if(!t)throw new Error("Supabase client is not initialized");const n=Math.max(1,Number(e)||30),{data:a,error:o}=await t.rpc("admin_purge_dm_before",{p_days:n});if(o)throw o;return Number(a)||0}async function dd(){const e=T();if(!e)throw new Error("Supabase client is not initialized");const{data:t,error:n}=await e.rpc("admin_purge_dm_all");if(n)throw n;return Number(t)||0}const Ve="room:default";async function ud({roomId:e=Ve,message:t,senderActorId:n,senderDisplayName:a,clientMsgId:o=null}){const i=T();if(!i)throw new Error("Supabase client is not initialized");const s={room_id:e||Ve,sender_actor_id:n,sender_display_name:String(a).slice(0,80),message:String(t||"").slice(0,500),client_msg_id:o||null},{data:l,error:d}=await i.from("global_messages").insert(s).select("*").single();if(d)throw d;return l}async function fd({roomId:e=Ve,limit:t=200,before:n=null}={}){const a=T();if(!a)throw new Error("Supabase client is not initialized");let o=a.from("global_messages").select("*").eq("room_id",e||Ve).eq("deleted",!1).order("created_at",{ascending:!0}).limit(Math.max(1,Math.min(500,Number(t)||200)));n&&(o=o.lt("created_at",n));const{data:i,error:s}=await o;if(s)throw s;return i||[]}function gd({roomId:e=Ve,onInsert:t,onDeleteOrUpdate:n,onError:a}={}){const o=T();if(!o)return async()=>{};const i=e||Ve,s=o.channel(`global:messages:${i}`);return s.on("postgres_changes",{event:"INSERT",schema:"public",table:"global_messages",filter:`room_id=eq.${i}`},l=>{try{t?.(l?.new||null)}catch(d){a?.(d)}}),s.on("postgres_changes",{event:"UPDATE",schema:"public",table:"global_messages",filter:`room_id=eq.${i}`},l=>{try{n?.(l?.new||null,l?.old||null)}catch(d){a?.(d)}}),s.on("postgres_changes",{event:"DELETE",schema:"public",table:"global_messages",filter:`room_id=eq.${i}`},l=>{try{n?.(null,l?.old||null)}catch(d){a?.(d)}}),s.subscribe(l=>{l==="CHANNEL_ERROR"&&a?.(new Error("global_messages realtime channel error"))}),async()=>{try{await o.removeChannel(s)}catch(l){a?.(l)}}}async function md({roomId:e=null,limit:t=200}={}){const n=T();if(!n)throw new Error("Supabase client is not initialized");let a=n.from("global_messages").select("id,created_at,room_id,sender_actor_id,sender_display_name,message,deleted").order("created_at",{ascending:!1}).limit(Math.max(1,Math.min(1e3,Number(t)||200)));e&&(a=a.eq("room_id",e));const{data:o,error:i}=await a;if(i)throw i;return o||[]}async function pd(e){const t=T();if(!t)throw new Error("Supabase client is not initialized");if(!e)return 0;const{data:n,error:a}=await t.rpc("admin_delete_global_message",{p_id:e});if(a)throw a;return Number(n)||0}async function Id(e,t=null){const n=T();if(!n)throw new Error("Supabase client is not initialized");const a=Math.max(1,Number(e)||30),{data:o,error:i}=await n.rpc("admin_purge_global_before",{p_days:a,p_room_id:t||null});if(i)throw i;return Number(o)||0}async function yd(e=null){const t=T();if(!t)throw new Error("Supabase client is not initialized");const{data:n,error:a}=await t.rpc("admin_purge_global_all",{p_room_id:e||null});if(a)throw a;return Number(n)||0}const vs="vo:lastReadDmTsByThread",bd="vo.dm.lastReadAt.v1",ks="vo:lastReadGlobalTs",po=Ve;let we=[],pt=new Set,Pn=0,Jt=new Map,Ba=new Map,Fe=new Map,Ge=[],Ta=$d(),Ot=Nd(),ge="all",At=null,Ce=null,wi=null,pn=null,Ai=null,Ms=null,Es=null,Ss=null,_s=null,j=null,ue=null,$e=null,Et=!1;function hd({getMyName:e,getMyActorId:t,getPersonName:n,getPeople:a}){Ms=e,Es=t,Ss=n,_s=a,document.querySelectorAll(".chat-tab").forEach(i=>{i.dataset.chatTab==="room"&&(i.disabled=!0,i.classList.add("disabled"),i.setAttribute("aria-disabled","true"),i.title="Ê∫ñÂÇô‰∏≠"),i.addEventListener("click",()=>{i.disabled||Ls(i.dataset.chatTab||"all")})}),j=document.getElementById("chat-messages"),ue=document.getElementById("chat-input"),$e=document.getElementById("chat-send"),$e?.addEventListener("click",()=>{vi()}),ue?.addEventListener("keydown",i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),vi())}),Md(),yo(),bo(),Ut(),Ne(),$s()}function Cd(e){if(Et=e,e){ge==="all"&&yo(),ge==="dm"&&Io(),vt();return}Rn()}function _n(e){if(!e?.actorId)return;const t=Se();if(!t){B("DM„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error");return}At={actorId:e.actorId,displayName:e.displayName||kt(e.actorId)},Ce=ad(t,e.actorId),Ls("dm"),Io()}function Ls(e){ge=e,document.querySelectorAll(".chat-tab").forEach(t=>{t.classList.toggle("active",t.dataset.chatTab===e)}),$s(),e==="dm"?(bo(),Io()):e==="all"?yo():Rn(),vt()}async function Io(){if(!Ce){Rn(),await bo(),vt();return}await kd(Ce),Ed(Ce),Os(Ce),Ns(Ce),ge==="dm"&&vt()}async function vi(){const e=zl(ue?.value);if(e.valid){if(ge==="dm")await wd(e.value);else{const t=Se();if(!t){B("„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error");return}try{const n=await ud({roomId:po,message:e.value,senderActorId:t,senderDisplayName:Ms?.()||"‰∏çÊòé",clientMsgId:Kt()});Na(n)}catch(n){console.error("[chat] ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°Â§±Êïó",n),B("ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}}ue&&(ue.value="")}}async function wd(e){const t=Se(),n=At?.actorId,a=Ce;if(!t||!n||!a){B("DM„ÅÆÈÄÅ‰ø°ÂÖà„ÅåÊú™ÈÅ∏Êäû„Åß„Åô","error");return}try{const o=await od({threadKey:a,senderId:t,recipientId:n,body:e});ho(o)}catch(o){console.error("[chat] DMÈÄÅ‰ø°Â§±Êïó",o),B("DMÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}}async function yo(){await Ad(),vd(),Et&&ge==="all"&&(Ds(),vt())}async function Ad(){try{const t=(await fd({roomId:po,limit:200})).map(Bs).filter(n=>!!n);we=t,pt=new Set(t.map(n=>String(n.id))),xs(),Ne()}catch(e){console.error("[chat] ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂèñÂæóÂ§±Êïó",e),B("ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}}function vd(){wi||(wi=gd({roomId:po,onInsert:e=>{e&&Na(e)},onDeleteOrUpdate:(e,t)=>{if(e?.deleted){aa(e.id);return}if(!e&&t?.id){aa(t.id);return}e&&t?.id&&String(e.id)===String(t.id)&&(aa(e.id),Na(e))},onError:e=>{console.warn("[chat] global realtime error",e)}}))}function Na(e){const t=Bs(e);if(!t)return;const n=String(t.id);if(pt.has(n))return;if(pt.add(n),we.push(t),we.length>300){const o=we.length-300;we.splice(0,o).forEach(s=>pt.delete(String(s.id)))}if(Et&&ge==="all"){Ds(),j&&(j.appendChild(Hn(t)),j.scrollTop=j.scrollHeight);return}!(t.senderActorId&&t.senderActorId===Se())&&St(t.ts)>Ot&&(Pn+=1,Ne())}function aa(e){if(!e)return;const t=String(e);pt.has(t)&&(pt.delete(t),we=we.filter(n=>String(n.id)!==t),xs(),Ne(),Et&&ge==="all"&&vt())}function Ds(){const e=we.reduce((t,n)=>Math.max(t,St(n.ts)),0);Ot=Math.max(Ot,e),Od(Ot),Pn=0,Ne()}function xs(){const e=Se();Pn=we.reduce((t,n)=>!n||e&&n.senderActorId===e?t:St(n.ts)>Ot?t+1:t,0)}async function kd(e){try{const n=(await id(e,200)).map(Ts).filter(a=>!!a);Jt.set(e,n),Ba.set(e,new Set(n.map(a=>String(a.id))))}catch(t){console.error("[chat] DMÂ±•Ê≠¥ÂèñÂæóÂ§±Êïó",t,e),B("DMÂ±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}}async function bo(){const e=Se();if(!e){Ge=[],Fe=new Map,Ut(),Ne();return}try{const t=await sd(e,300),n=new Map,a=new Map;for(const o of t){const i=o?.thread_key;if(!i)continue;const s=o?.sender_id||null,l=o?.recipient_id||null,d=s===e?l:s;if(!d)continue;n.has(i)||n.set(i,{threadKey:i,peerActorId:d,peerName:kt(d),lastMessage:o?.body||"",ts:o?.created_at||Date.now()});const p=Number(Ta[i]||0),m=St(o?.created_at);s!==e&&m>p&&a.set(i,(a.get(i)||0)+1)}Ge=Array.from(n.values()),Fe=a,Ut(),Ne()}catch(t){console.warn("[chat] DM„Çπ„É¨„ÉÉ„Éâ‰∏ÄË¶ßÂèñÂæóÂ§±Êïó",t)}}function Md(){if(Ai)return;const e=Se();e&&(Ai=rd({actorId:e,onInsert:t=>{t&&ho(t)},onError:t=>{console.warn("[chat] DM inbox realtime error",t)}}))}function Ed(e){Rn(),pn=ld({threadKey:e,onInsert:t=>{t&&ho(t)},onError:t=>{console.warn("[chat] DM realtime error",t)}})}function Rn(){if(!pn)return;const e=pn;pn=null,Promise.resolve(e()).catch(t=>{console.warn("[chat] DM subscription cleanup failed",t)})}function ho(e){const t=Ts(e);if(!t)return;const n=t.threadKey;if(!n)return;const a=Ba.get(n)||new Set,o=String(t.id);if(a.has(o))return;const i=Jt.get(n)||[];i.push(t),Jt.set(n,i),a.add(o),Ba.set(n,a),Dd(t);const s=Se();!Mi(n)&&t.senderId!==s&&Fe.set(n,(Fe.get(n)||0)+1),Mi(n)&&(Os(n,St(t.ts)),Ns(n)),Ut(),Ne(),!(!Et||ge!=="dm"||Ce!==n||!j)&&(j.appendChild(Hn(t)),j.scrollTop=j.scrollHeight)}function vt(){if(j){if(j.innerHTML="",ge==="dm"){Sd();return}we.length===0?j.appendChild(In("ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ")):we.forEach(e=>{j.appendChild(Hn(e))}),j.scrollTop=j.scrollHeight}}function Sd(){if(!j)return;if(!Ce||!At?.actorId){j.appendChild(ki("ÊúÄËøë„ÅÆDM")),Ge.length===0?j.appendChild(In("„Åæ„Å†DMÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ")):Ge.forEach(n=>{j.appendChild(_d(n))}),j.appendChild(ki("Áõ∏Êâã„ÇíÈÅ∏ÊäûÔºà„Ç™„É≥„É©„Ç§„É≥Ôºâ"));const t=xd();t.length===0?j.appendChild(In("„Ç™„É≥„É©„Ç§„É≥„ÅÆÁõ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ")):t.forEach(n=>{j.appendChild(Ld(n))});return}const e=Jt.get(Ce)||[];if(e.length===0){j.appendChild(In(`${At.displayName||"Áõ∏Êâã"} „Å®„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`));return}e.forEach(t=>{j.appendChild(Hn(t))}),j.scrollTop=j.scrollHeight}function In(e){const t=document.createElement("div");return t.className="chat-empty",t.textContent=e,t}function ki(e){const t=document.createElement("div");return t.className="chat-section-title",t.textContent=e,t}function _d(e){const t=document.createElement("button");t.className="chat-thread-item",t.type="button";const n=Fe.get(e.threadKey)||0,a=(e.lastMessage||"").slice(0,40);return t.innerHTML=`
        <div class="chat-thread-header">
            <strong>${$t(e.peerName||"‰∏çÊòé")}</strong>
            <span class="chat-time">${As(e.ts)}</span>
        </div>
        <div class="chat-thread-preview">${$t(a||"„É°„ÉÉ„Çª„Éº„Ç∏„Å™„Åó")}</div>
        ${n>0?`<div class="chat-thread-unread">Êú™Ë™≠ ${n}</div>`:""}
    `,t.addEventListener("click",()=>{_n({actorId:e.peerActorId,displayName:e.peerName})}),t}function Ld(e){const t=document.createElement("button");t.className="chat-thread-item",t.type="button";const n=e.status==="online"?"„Ç™„É≥„É©„Ç§„É≥":e.status==="away"?"Èõ¢Â∏≠":e.status==="focus"?"ÈõÜ‰∏≠":"",a=e.hasHistory?"Â±•Ê≠¥„ÅÇ„Çä":"Êñ∞Ë¶èDM„ÇíÈñãÂßã";return t.innerHTML=`
        <div class="chat-thread-header">
            <strong>${$t(e.displayName||"‰∏çÊòé")}</strong>
            <span class="chat-time">${$t(n)}</span>
        </div>
        <div class="chat-thread-preview">${$t(a)}</div>
    `,t.addEventListener("click",()=>{_n({actorId:e.actorId,displayName:e.displayName})}),t}function Hn(e){const t=document.createElement("div");t.className="chat-message";const n=document.createElement("div");n.className="chat-avatar",n.textContent=Td(e.name);const a=document.createElement("div");a.className="chat-body";const o=document.createElement("span");o.className="chat-name",o.textContent=e.name;const i=document.createElement("span");i.className="chat-time",i.textContent=As(e.ts);const s=document.createElement("div");return s.className="chat-text",s.textContent=e.text,a.appendChild(o),a.appendChild(i),a.appendChild(s),t.appendChild(n),t.appendChild(a),t}function Bs(e){if(!e||typeof e!="object")return null;const t=e.message||e.text||"";return t?{id:e.id||e.message_id||Kt(),senderActorId:e.sender_actor_id||e.senderActorId||null,name:e.sender_display_name||e.name||"‰∏çÊòé",text:t,ts:e.created_at||e.ts||Date.now()}:null}function Ts(e){if(!e||typeof e!="object")return null;const t=e.thread_key||e.threadKey||null,n=e.sender_id||e.senderId||null,a=e.recipient_id||e.recipientId||null,o=e.body||e.text||"";return!t||!n||!a||!o?null:{id:e.id||e.message_id||Kt(),threadKey:t,senderId:n,recipientId:a,name:kt(n),text:o,ts:e.created_at||e.ts||Date.now()}}function Dd(e){const t=Se(),n=e.senderId===t?e.recipientId:e.senderId;if(!n)return;const a={threadKey:e.threadKey,peerActorId:n,peerName:kt(n),lastMessage:e.text||"",ts:e.ts||Date.now()},o=Ge.filter(i=>i.threadKey!==e.threadKey);Ge=[a,...o]}function kt(e){return e?Ss?.(e)||e.slice(0,6):"‰∏çÊòé"}function xd(){const e=Se(),t=new Map,n=_s?.();if(n&&n instanceof Map)for(const a of n.values())!a?.actorId||a.actorId===e||t.set(a.actorId,{actorId:a.actorId,displayName:a.displayName||kt(a.actorId),status:a.status||"online",hasHistory:Ge.some(o=>o.peerActorId===a.actorId)});for(const a of Ge)if(!(!a?.peerActorId||a.peerActorId===e)){if(t.has(a.peerActorId)){const o=t.get(a.peerActorId);o.hasHistory=!0;continue}t.set(a.peerActorId,{actorId:a.peerActorId,displayName:a.peerName||kt(a.peerActorId),status:"offline",hasHistory:!0})}return Array.from(t.values()).sort(Bd)}function Bd(e,t){const n=o=>o==="online"?0:o==="focus"?1:o==="away"?2:3,a=n(e.status)-n(t.status);return a!==0?a:String(e.displayName||"").localeCompare(String(t.displayName||""),"ja")}function Ne(){const e=Array.from(Fe.values()).reduce((n,a)=>n+(Number(a)||0),0),t=Pn+e;Xc({hasUnread:t>0,count:t})}function Ut(){const e=document.querySelector('.chat-tab[data-chat-tab="dm"]');if(!e)return;const t=Array.from(Fe.values()).reduce((n,a)=>n+(Number(a)||0),0);e.textContent=t>0?`DM (${t})`:"DM"}function Ns(e){e&&(Fe.delete(e),Ut(),Ne())}function Os(e,t=null){if(!e)return;let n=Number(t)||0;n||(n=(Jt.get(e)||[]).reduce((o,i)=>Math.max(o,St(i.ts)),0)),n||(n=Date.now()),Ta[e]=n,Pd(Ta)}function $s(){if(!(!ue||!$e)){if(ge==="dm"){At?.actorId?(ue.placeholder=`${At.displayName||"Áõ∏Êâã"} „Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...`,ue.disabled=!1,$e.disabled=!1):(ue.placeholder="DMÁõ∏Êâã„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ",ue.disabled=!0,$e.disabled=!0),$e.textContent="ÈÄÅ‰ø°";return}ue.placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...",ue.disabled=!1,$e.disabled=!1,$e.textContent="ÈÄÅ‰ø°"}}function Se(){return Es?.()||null}function Mi(e){return Et&&ge==="dm"&&Ce===e}function Td(e){return e?e.slice(0,2).toUpperCase():"?"}function $t(e){const t=document.createElement("div");return t.textContent=String(e??""),t.innerHTML}function St(e){if(typeof e=="number"&&Number.isFinite(e))return e;const t=Number(e);if(Number.isFinite(t)&&t>0)return t;const a=new Date(e||0).getTime();return Number.isFinite(a)?a:0}function Nd(){try{const e=localStorage.getItem(ks),t=Number(e||0);return Number.isFinite(t)?t:0}catch{return 0}}function Od(e){try{localStorage.setItem(ks,String(Number(e)||0))}catch(t){console.warn("[chat] failed to persist global lastRead",t)}}function $d(){const e=[vs,bd];for(const t of e)try{const n=localStorage.getItem(t);if(!n)continue;const a=JSON.parse(n);if(!a||typeof a!="object")continue;return a}catch{}return{}}function Pd(e){try{localStorage.setItem(vs,JSON.stringify(e||{}))}catch(t){console.warn("[chat] failed to persist DM lastRead",t)}}let qt=new Map,Oa=null,$a=null,Pa=null;function Rd({warpCallback:e,pokeCallback:t,dmCallback:n}){Oa=e,$a=t,Pa=n}function Hd(e){qt=new Map,Object.entries(e).forEach(([t,n])=>{if(n&&n.length>0){const a=n[0],o=a.displayName||a.claimedByDisplayName||"‰∏çÊòé";qt.set(a.actorId,{actorId:a.actorId,displayName:o,status:a.status||"online",callStatus:a.callStatus||"idle",pos:a.pos||{x:0,y:0},avatarColor:a.avatarColor||null,location:a.location||"",seatedDeskId:a.seatedDeskId||null,seatLockedDeskId:a.seatLockedDeskId||null,areaId:a.areaId||null,claimedByActorId:a.claimedByActorId||a.actorId||null,claimedByDisplayName:a.claimedByDisplayName||o})}}),jd()}function jd(){const e=document.getElementById("people-list");if(!e)return;const t=Array.from(qt.values()).sort((n,a)=>n.status==="online"&&a.status!=="online"?-1:n.status!=="online"&&a.status==="online"?1:n.displayName.localeCompare(a.displayName));e.innerHTML=t.map(n=>{const a=n.seatLockedDeskId?`ü™ëüîí „Éá„Çπ„ÇØ ${n.seatLockedDeskId.replace("desk:","")}`:n.seatedDeskId?`ü™ë Á¢∫‰øù‰∏≠ ${n.seatedDeskId.replace("desk:","")}`:n.location||"",o=n.callStatus==="in_call"?"üìû ÈÄöË©±‰∏≠":n.callStatus==="calling"?"üìû Áô∫‰ø°‰∏≠":n.callStatus==="ringing"?"üìû ÁùÄ‰ø°‰∏≠":"";return`
    <div class="person-item" data-actor-id="${n.actorId}">
      <div class="person-avatar" style="background-color: ${n.avatarColor||"var(--color-avatarDefault)"}">
        ${Wd(n.displayName)}
        <div class="person-status ${n.status}"></div>
      </div>
      <div class="person-info">
        <div class="person-name-row">
          <div class="person-name">${oa(n.displayName)}</div>
          ${o?`<div class="person-call-badge">${oa(o)}</div>`:""}
        </div>
        <div class="person-location">${oa(a)}</div>
      </div>
      <div class="person-actions">
        <button class="person-action-btn" data-action="warp" title="Ëøë„Åè„Å´„ÉØ„Éº„Éó">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M12 3v18"/>
          </svg>
        </button>
        <button class="person-action-btn" data-action="poke" title="„Å§„Å§„Åè">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 12c2.5 0 4.5-2 4.5-4.5S14.5 3 12 3 7.5 5 7.5 7.5 9.5 12 12 12zm0 2c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/>
          </svg>
        </button>
        <button class="person-action-btn" data-action="dm" title="„ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </button>
      </div>
    </div>
  `}).join(""),e.querySelectorAll(".person-action-btn").forEach(n=>{n.addEventListener("click",a=>{a.stopPropagation();const i=n.closest(".person-item").dataset.actorId,s=n.dataset.action,l=qt.get(i);l&&(s==="warp"&&Oa?Oa(l):s==="poke"&&$a?$a(l):s==="dm"&&Pa&&Pa(l))})})}function Wd(e){return e?e.slice(0,2).toUpperCase():"?"}function oa(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function ve(){return qt}let Ra=null,Ln=[];function zd({warpCallback:e}){Ra=e;const t=document.getElementById("search-input");t&&t.addEventListener("input",n=>{Ps(n.target.value)})}function Ps(e){const t=e.toLowerCase().trim(),n=ve();t.length===0?Ln=Array.from(n.values()):Ln=Array.from(n.values()).filter(a=>a.displayName.toLowerCase().includes(t)),Fd()}function Fd(){const e=document.getElementById("search-results");if(e){if(Ln.length===0){e.innerHTML='<div style="text-align: center; padding: 20px; color: var(--color-textMuted);">Ë©≤ÂΩì„Åô„Çã„É°„É≥„Éê„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';return}e.innerHTML=Ln.map(t=>`
    <div class="person-item" data-actor-id="${t.actorId}">
      <div class="person-avatar" style="background-color: ${t.avatarColor||"var(--color-avatarDefault)"}">
        ${Gd(t.displayName)}
        <div class="person-status ${t.status}"></div>
      </div>
      <div class="person-info">
        <div class="person-name">${Ei(t.displayName)}</div>
        <div class="person-location">${Ei(t.location)}</div>
      </div>
      <button class="btn btn-secondary" data-action="warp">Ëøë„Åè„Å´„ÉØ„Éº„Éó</button>
    </div>
  `).join(""),e.querySelectorAll('[data-action="warp"]').forEach(t=>{t.addEventListener("click",n=>{const o=t.closest(".person-item").dataset.actorId,i=ve().get(o);i&&Ra&&Ra(i)})})}}function Gd(e){return e?e.slice(0,2).toUpperCase():"?"}function Ei(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Jd(){const e=document.getElementById("search-input");e&&Ps(e.value)}const Ha="audio.selectedMicId",ja="audio.selectedSpeakerId";function Ud(){return localStorage.getItem(Ha)||null}function qd(e){e?localStorage.setItem(Ha,e):localStorage.removeItem(Ha)}function Zd(){return localStorage.getItem(ja)||null}function Kd(e){e?localStorage.setItem(ja,e):localStorage.removeItem(ja)}async function Yd(){try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(o=>o.stop()),console.log("[audioDevices] permission unlocked")}catch(a){console.warn("[audioDevices] permission denied or error",a)}const e=await navigator.mediaDevices.enumerateDevices(),t=e.filter(a=>a.kind==="audioinput"),n=e.filter(a=>a.kind==="audiooutput");return console.log("[audioDevices] inputs:",t.length,"outputs:",n.length),{inputs:t,outputs:n}}function Vd(){return typeof document.createElement("audio").setSinkId=="function"}let ia=null,sa=null,la=null,ra=null;function Qd({nameChangeCallback:e,statusChangeCallback:t,logoutCallback:n,clearPasswordCallback:a}){ia=e,sa=t,la=n,ra=a;const o=document.querySelectorAll("#theme-options .theme-option");o.forEach(m=>{m.addEventListener("click",()=>{const C=m.dataset.theme;Rs(C),o.forEach(g=>g.classList.remove("active")),m.classList.add("active")})});const i=document.querySelectorAll("[data-status]");i.forEach(m=>{m.addEventListener("click",()=>{const C=m.dataset.status;i.forEach(g=>g.classList.remove("active")),m.classList.add("active"),sa&&sa(C)})});const s=document.getElementById("settings-name-save"),l=document.getElementById("settings-name");s&&l&&s.addEventListener("click",()=>{const m=l.value.trim();m&&ia&&ia(m)});const d=document.getElementById("settings-logout");d&&d.addEventListener("click",()=>{la&&la()});const p=document.getElementById("settings-clear-pw");p&&p.addEventListener("click",()=>{ra&&ra()}),Xd()}async function Xd(){const e=document.getElementById("audio-mic"),t=document.getElementById("audio-speaker"),n=document.getElementById("audio-speaker-hint"),a=document.getElementById("audio-refresh");if(!e||!t)return;Vd()||(t.disabled=!0,n&&(n.textContent="„Çπ„Éî„Éº„Ç´„ÉºÂàáÊõø„ÅØÊú™ÂØæÂøú„Åß„ÅôÔºàChromeÊé®Â•®Ôºâ")),e.addEventListener("change",()=>{const i=e.value;qd(i||null),console.log("[Audio] Mic selected:",i||"default")}),t.addEventListener("change",()=>{const i=t.value;Kd(i||null),console.log("[Audio] Speaker selected:",i||"default")}),a&&a.addEventListener("click",()=>{Si()}),setTimeout(()=>{Si()},100)}async function Si(){const e=document.getElementById("audio-mic"),t=document.getElementById("audio-speaker");if(!(!e||!t))try{const{inputs:n,outputs:a}=await Yd(),o=Ud(),i=Zd();e.innerHTML='<option value="">-- „Éá„Éï„Ç©„É´„Éà --</option>',n.forEach((s,l)=>{const d=s.label||`„Éû„Ç§„ÇØ ${l+1}`,p=document.createElement("option");p.value=s.deviceId,p.textContent=d,p.selected=s.deviceId===o,e.appendChild(p)}),t.innerHTML='<option value="">-- „Éá„Éï„Ç©„É´„Éà --</option>',a.forEach((s,l)=>{const d=s.label||`„Çπ„Éî„Éº„Ç´„Éº ${l+1}`,p=document.createElement("option");p.value=s.deviceId,p.textContent=d,p.selected=s.deviceId===i,t.appendChild(p)}),console.log("[Audio] Devices populated:",n.length,"inputs,",a.length,"outputs")}catch(n){console.error("[Audio] Failed to enumerate devices:",n)}}function Rs(e){document.body.setAttribute("data-theme",e),ar(e)}function Wa(e){const t=document.getElementById("settings-name");t&&(t.value=e)}function eu(e){document.querySelectorAll("#theme-options .theme-option").forEach(n=>{n.classList.toggle("active",n.dataset.theme===e)})}let ca=null,da=null;function tu({acceptCallback:e,rejectCallback:t}){ca=e,da=t;const n=document.getElementById("call-accept"),a=document.getElementById("call-reject");n?.addEventListener("click",()=>{ca&&ca(),za()}),a?.addEventListener("click",()=>{da&&da(),za()})}function nu(e){const t=document.getElementById("modal-overlay"),n=document.getElementById("modal-incoming-call"),a=document.getElementById("modal-password"),o=document.getElementById("modal-nameplate");a?.classList.add("hidden"),o?.classList.add("hidden"),n.classList.remove("hidden"),t.classList.add("visible");const i=document.getElementById("incoming-call-from");i&&(i.textContent=`${e} „Åã„Çâ„ÅÆÁùÄ‰ø°`)}function za(){const e=document.getElementById("modal-overlay");document.getElementById("modal-incoming-call").classList.add("hidden");const n=document.getElementById("modal-password"),a=document.getElementById("modal-nameplate");n?.classList.contains("hidden")&&a?.classList.contains("hidden")&&e.classList.remove("visible")}let Fa=new Map,Ga=null,Ja=null,Hs=null,js=null,Ws=null,zs=null,Co=null,wo=null,Fs=null,Gs=null,Js=null,Us=null,qs=null,Zs=null;function au(e){Ga=e.openZoom,Ja=e.openRoomChat,Hs=e.claimDesk,js=e.seatDesk,Ws=e.leaveSeat,zs=e.unclaimDesk,Co=e.poke,wo=e.dm,Fs=e.call,Gs=e.callAccept,Js=e.callReject,Us=e.callCancel,qs=e.callMute,Zs=e.callEnd}async function ou(){Fa=await Gc()}function iu(e,t={}){const n=document.getElementById("context-panel"),a=document.getElementById("context-title"),o=document.getElementById("context-actions");if(!n||!e){Dn();return}const{kind:i,data:s}=e;if(i==="spot")su(s,a,o);else if(i==="desk")Ks(s,a,o,t);else if(i==="user")lu(s,a,o);else{Dn();return}n.classList.add("visible")}function su(e,t,n){t.textContent=e.label;let a="";if(e.ui?.showOpenZoom){const l=Fa.get(e.roomKey)?.zoomUrl;a+=`
      <button class="btn btn-primary" id="ctx-open-zoom" ${l?"":"disabled"}>
	        ${l?"üìπ Zoom„ÇíÈñã„Åè":"Zoom URLÊú™Ë®≠ÂÆö"}
      </button>
    `}e.ui?.showRoomChat&&(a+='<button class="btn btn-secondary" id="ctx-room-chat">üí¨ „É´„Éº„É†„ÉÅ„É£„ÉÉ„Éà</button>'),n.innerHTML=a;const o=document.getElementById("ctx-open-zoom");o&&!o.disabled&&o.addEventListener("click",()=>{const s=Fa.get(e.roomKey);s?.zoomUrl&&Ga&&Ga(s.zoomUrl)});const i=document.getElementById("ctx-room-chat");i&&Ja&&i.addEventListener("click",()=>Ja(e.id))}function Ks(e,t,n,a={}){const o=a.claimed===!0,i=a.seatLocked===!0,s=a.occupant||null,l=a.callState?.peerDisplayName||null,d=a.claimedByDisplayName||s?.claimedByDisplayName||s?.displayName||l||null,p=a.callState||{},m=a.forced===!0,C=p.status||"idle",g=p.peerActorId||null,I=p.peerDisplayName||(g?g.slice(0,6):""),y=p.startedAt?Math.max(0,Math.floor((Date.now()-p.startedAt)/1e3)):0;function b(E){switch(E){case"idle":return"ÈùûÈÄöË©±";case"calling":return"Áô∫‰ø°‰∏≠‚Ä¶";case"ringing":return"ÁùÄ‰ø°‰∏≠";case"in_call":return"ÈÄöË©±‰∏≠";default:return E||"‰∏çÊòé"}}function f(E){const $=String(Math.floor(E/60)).padStart(2,"0"),O=String(E%60).padStart(2,"0");return`${$}:${O}`}function v(){return C==="calling"?'<button class="btn btn-secondary" id="ctx-call-cancel">‚èπ „Ç≠„É£„É≥„Çª„É´</button>':C==="ringing"?`
            <button class="btn btn-primary" id="ctx-call-accept">‚úÖ ÂøúÁ≠î</button>
            <button class="btn btn-secondary" id="ctx-call-reject">‚ùå ÊãíÂê¶</button>
          `:C==="in_call"?`
            <button class="btn btn-secondary" id="ctx-call-mute">${p.muted?"üîà „Éü„É•„Éº„ÉàËß£Èô§":"üîá „Éü„É•„Éº„Éà"}</button>
            <button class="btn btn-secondary" id="ctx-call-end">‚èπ ÈÄöË©±ÁµÇ‰∫Ü</button>
          `:s?'<button class="btn btn-primary" id="ctx-call">üìû Áô∫‰ø°</button>':""}function _(){return i?'<button class="btn btn-secondary" id="ctx-stand">üö∂ Á´ã„Å§</button>':o?`
            <button class="btn btn-primary" id="ctx-seat">ü™ë ÁùÄÂ∏≠</button>
            <button class="btn btn-secondary" id="ctx-unclaim">‚Ü© Á¢∫‰øùËß£Èô§</button>
          `:'<button class="btn btn-primary" id="ctx-claim">ü™ë Â∏≠„ÇíÁ¢∫‰øù</button>'}function P(){return i?`ü™ë ÁùÄÂ∏≠‰∏≠ÔºàÁßªÂãïÂõ∫ÂÆöÔºâ${m?"ÔºàÂº∑Âà∂Ôºâ":""}`:o?"ü™ë Â∏≠„ÇíÁ¢∫‰øù‰∏≠":"ü™ë Êú™Á¢∫‰øù"}t.textContent=`„Éá„Çπ„ÇØ ${e.id.replace("desk:","")}`;let M="";M+=`<div class="context-status">${P()}</div>`,(o||i||s||d)&&(M+=`<div class="context-status">üë§ Á¢∫‰øùËÄÖ: ${cu(d||"‰∏çÊòé")}</div>`),M+=`<div class="context-status">üìû ${b(C)}${C==="in_call"?`Ôºà${f(y)}Ôºâ`:""}${I?` / ${I}`:""}</div>`,s&&(M+=`
        <button class="btn btn-secondary" id="ctx-dm">üí¨ DM</button>
        <button class="btn btn-secondary" id="ctx-poke">üëÜ „Å§„Å§„Åè</button>
      `),M+=v(),M+=_(),n.innerHTML=M,document.getElementById("ctx-claim")?.addEventListener("click",()=>Hs?.(e)),document.getElementById("ctx-seat")?.addEventListener("click",()=>js?.(e)),document.getElementById("ctx-stand")?.addEventListener("click",()=>Ws?.(e)),document.getElementById("ctx-unclaim")?.addEventListener("click",()=>zs?.(e)),document.getElementById("ctx-dm")?.addEventListener("click",()=>wo?.(s)),document.getElementById("ctx-poke")?.addEventListener("click",()=>Co?.(s)),document.getElementById("ctx-call")?.addEventListener("click",()=>Fs?.(s)),document.getElementById("ctx-call-accept")?.addEventListener("click",()=>Gs?.()),document.getElementById("ctx-call-reject")?.addEventListener("click",()=>Js?.()),document.getElementById("ctx-call-cancel")?.addEventListener("click",()=>Us?.()),document.getElementById("ctx-call-mute")?.addEventListener("click",()=>qs?.()),document.getElementById("ctx-call-end")?.addEventListener("click",()=>Zs?.())}function lu(e,t,n){t.textContent=e.displayName,n.innerHTML=`
    <button class="btn btn-secondary" id="ctx-dm">üí¨ DM</button>
    <button class="btn btn-secondary" id="ctx-poke">üëÜ „Å§„Å§„Åè</button>
    <button class="btn btn-primary" id="ctx-warp">üìç Ëøë„Åè„Å´„ÉØ„Éº„Éó</button>
  `,document.getElementById("ctx-dm")?.addEventListener("click",()=>wo?.(e)),document.getElementById("ctx-poke")?.addEventListener("click",()=>Co?.(e)),document.getElementById("ctx-warp")?.addEventListener("click",()=>{})}function Dn(){const e=document.getElementById("context-panel");e&&e.classList.remove("visible")}function ru(e,t,n,a,o,i=!1,s=null){const l=document.getElementById("context-title"),d=document.getElementById("context-actions");l&&d&&Ks(e,l,d,{claimed:t,seatLocked:n,occupant:a,callState:o,forced:i,claimedByDisplayName:s})}function cu(e){const t=document.createElement("div");return t.textContent=e??"",t.innerHTML}let ke=null,Pe=null,Ao=!1;function du(){ke=document.createElement("div"),ke.id="spot-modal-overlay",ke.className="spot-modal-overlay",document.getElementById("app").appendChild(ke),Pe=document.createElement("div"),Pe.className="spot-modal",Pe.id="modal-spot",Pe.innerHTML=`
        <div class="modal-header">
            <h2 class="modal-title" id="spot-modal-title">Spot</h2>
            <button class="modal-close-btn" id="spot-modal-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="spot-modal-body"></div>
    `,ke.appendChild(Pe),document.getElementById("spot-modal-close").addEventListener("click",e=>{e.stopPropagation(),It()}),ke.addEventListener("click",e=>{e.target===ke&&It()}),Pe.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Ao&&It()})}function uu(e,t){if(!Pe)return;document.getElementById("spot-modal-title").textContent=e;const n=document.getElementById("spot-modal-body");n.innerHTML=`
        <div class="spot-links-list">
            ${t.map(a=>`
                <a href="${a.url}" target="_blank" rel="noopener noreferrer" class="spot-link-item">
                    <div class="spot-link-header">
                        <span class="spot-link-label">${a.label}</span>
                        <svg class="spot-link-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                            <polyline points="15 3 21 3 21 9" />
                            <line x1="10" y1="14" x2="21" y2="3" />
                        </svg>
                    </div>
                    ${a.desc?`<div class="spot-link-desc">${a.desc}</div>`:""}
                    ${a.tags&&a.tags.length>0?`
                        <div class="spot-link-tags">
                            ${a.tags.map(o=>`<span class="spot-tag">${o}</span>`).join("")}
                        </div>
                    `:""}
                </a>
            `).join("")}
        </div>
    `,Ys()}function fu(e,t=[]){if(!Pe)return;document.getElementById("spot-modal-title").textContent=e;const n=document.getElementById("spot-modal-body");if(!t||t.length===0)n.innerHTML=`
            <div class="bulletin-content">
                <div class="bulletin-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4;">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18" />
                        <path d="M9 21V9" />
                    </svg>
                    <p>„ÅäÁü•„Çâ„Åõ„ÉªÊõ¥Êñ∞ÊÉÖÂ†±„ÅØ„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</p>
                    <span class="bulletin-hint">ÔºàÁèæÂú®Ë®ò‰∫ã„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ</span>
                </div>
            </div>
        `;else{const a=[...t].sort((o,i)=>new Date(i.date)-new Date(o.date));n.innerHTML=`
            <div class="bulletin-list">
                ${a.map(o=>`
                    <div class="bulletin-item" onclick="this.classList.toggle('expanded')">
                        <div class="bulletin-header">
                            <span class="bulletin-title">${o.title}</span>
                            <span class="bulletin-date">${o.date}</span>
                        </div>
                        <div class="bulletin-body">${o.body.replace(/\n/g,"<br>")}</div>
                    </div>
                `).join("")}
            </div>
        `}Ys()}function Ys(){ke.classList.add("visible"),Ao=!0}function It(){ke&&(ke.classList.remove("visible"),Ao=!1)}const gu="8713",Pt="virtualoffice_admin_session",mu=1440*60*1e3;function _t(){const e=localStorage.getItem(Pt);if(!e)return!1;try{const t=JSON.parse(e);return t.expiresAt&&Date.now()<t.expiresAt?!0:(localStorage.removeItem(Pt),!1)}catch{return localStorage.removeItem(Pt),!1}}function pu(e){if(e!==gu)return{success:!1,error:"„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô"};const t={loggedInAt:Date.now(),expiresAt:Date.now()+mu};return localStorage.setItem(Pt,JSON.stringify(t)),console.log("[AdminAuth] Logged in, expires:",new Date(t.expiresAt)),{success:!0}}function Iu(){localStorage.removeItem(Pt),console.log("[AdminAuth] Logged out")}const vo="virtualoffice_gallery_override",ko="virtualoffice_news_override";let Ie=null,ye=null;async function yu(){const e=localStorage.getItem(vo);if(e)try{return Ie=JSON.parse(e),console.log("[ContentLoader] Loaded gallery from localStorage override"),Ie}catch{console.warn("[ContentLoader] Invalid gallery override, using default")}try{return Ie=await(await fetch("./data/gallery.json")).json(),console.log("[ContentLoader] Loaded gallery from file:",Ie.items.length,"items"),Ie}catch(t){return console.error("[ContentLoader] Failed to load gallery:",t),Ie={version:1,items:[]},Ie}}async function bu(){const e=localStorage.getItem(ko);if(e)try{return ye=JSON.parse(e),console.log("[ContentLoader] Loaded news from localStorage override"),ye}catch{console.warn("[ContentLoader] Invalid news override, using default")}try{return ye=await(await fetch("./data/news.json")).json(),console.log("[ContentLoader] Loaded news from file:",ye.items.length,"items"),ye}catch(t){return console.error("[ContentLoader] Failed to load news:",t),ye={version:1,items:[]},ye}}function jn(){return Ie}function Wn(){return ye}function Rt(e){localStorage.setItem(vo,JSON.stringify(e)),Ie=e,console.log("[ContentLoader] Saved gallery override:",e.items.length,"items")}function Ht(e){localStorage.setItem(ko,JSON.stringify(e)),ye=e,console.log("[ContentLoader] Saved news override:",e.items.length,"items")}function hu(){localStorage.removeItem(vo),localStorage.removeItem(ko),Ie=null,ye=null,console.log("[ContentLoader] Cleared overrides")}function Cu(){return JSON.stringify({gallery:Ie,news:ye,exportedAt:new Date().toISOString()},null,2)}function wu(e){try{const t=JSON.parse(e);return t.gallery&&t.gallery.items&&Rt(t.gallery),t.news&&t.news.items&&Ht(t.news),{success:!0}}catch(t){return{success:!1,error:t.message}}}let oe=null,Mo=!1,je="gallery",Vs=null,Qs=null;const Xs="vo:debugHudEnabled";function Au(e={}){Vs=typeof e.onDebugHudToggle=="function"?e.onDebugHudToggle:null,Qs=typeof e.getDebugHudEnabled=="function"?e.getDebugHudEnabled:null,oe=document.createElement("div"),oe.id="admin-modal-overlay",oe.className="admin-modal-overlay",oe.innerHTML=`
        <div id="admin-modal" class="admin-modal">
            <div id="admin-login-view" class="admin-view">
                <h2>üîê ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥</h2>
                <input type="password" id="admin-password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" maxlength="10">
                <div id="admin-login-error" class="admin-error"></div>
                <div class="admin-buttons">
                    <button id="admin-login-btn" class="admin-btn primary">„É≠„Ç∞„Ç§„É≥</button>
                    <button id="admin-cancel-btn" class="admin-btn">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </div>
            <div id="admin-panel-view" class="admin-view" style="display:none;">
                <div class="admin-header">
                    <h2>‚öôÔ∏è ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´</h2>
                    <button id="admin-logout-btn" class="admin-btn small">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="gallery">„ÇÆ„É£„É©„É™„Éº</button>
                    <button class="admin-tab" data-tab="news">„ÅäÁü•„Çâ„Åõ</button>
                    <button class="admin-tab" data-tab="export">„Ç®„ÇØ„Çπ„Éù„Éº„Éà/„Ç§„É≥„Éù„Éº„Éà</button>
                    <button class="admin-tab" data-tab="dm">DMÁÆ°ÁêÜ</button>
                    <button class="admin-tab" data-tab="global">ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÁÆ°ÁêÜ</button>
                </div>
                <div class="form-group" id="admin-debug-hud-wrap">
                    <label class="form-checkbox" for="admin-debug-hud-toggle">
                        <input type="checkbox" id="admin-debug-hud-toggle">
                        „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫„ÇíÊúâÂäπ„Å´„Åô„Çã
                    </label>
                </div>
                <div id="admin-tab-content" class="admin-tab-content">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="admin-footer">
                    <button id="admin-save-btn" class="admin-btn primary">üíæ ‰øùÂ≠ò</button>
                    <button id="admin-close-btn" class="admin-btn">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    `,document.getElementById("app").appendChild(oe),document.getElementById("admin-login-btn").addEventListener("click",_i),document.getElementById("admin-cancel-btn").addEventListener("click",Tt),document.getElementById("admin-logout-btn").addEventListener("click",vu),document.getElementById("admin-save-btn").addEventListener("click",ku),document.getElementById("admin-close-btn").addEventListener("click",Tt),document.getElementById("admin-debug-hud-toggle")?.addEventListener("change",Mu),document.getElementById("admin-password").addEventListener("keydown",t=>{t.key==="Enter"&&_i()}),oe.querySelectorAll(".admin-tab").forEach(t=>{t.addEventListener("click",()=>{je=t.dataset.tab,oe.querySelectorAll(".admin-tab").forEach(n=>n.classList.remove("active")),t.classList.add("active"),le()})}),oe.addEventListener("click",t=>{t.target===oe&&Tt()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&Mo&&Tt()})}function el(){oe&&(_t()?(document.getElementById("admin-login-view").style.display="none",document.getElementById("admin-panel-view").style.display="block",tl(),le()):(document.getElementById("admin-login-view").style.display="block",document.getElementById("admin-panel-view").style.display="none",document.getElementById("admin-password").value="",document.getElementById("admin-login-error").textContent="",Zt(!1)),oe.classList.add("visible"),Mo=!0,setTimeout(()=>{document.getElementById("admin-password")?.focus()},100))}function Tt(){oe&&(oe.classList.remove("visible"),Mo=!1)}function _i(){const e=document.getElementById("admin-password").value,t=pu(e);t.success?(document.getElementById("admin-login-view").style.display="none",document.getElementById("admin-panel-view").style.display="block",tl(),le()):document.getElementById("admin-login-error").textContent=t.error}function vu(){Iu(),Ua(!1),Zt(!1),Tt()}function ku(){je==="gallery"?Lu():je==="news"&&Bu()}function le(){const e=document.getElementById("admin-tab-content"),t=document.getElementById("admin-save-btn");je==="gallery"?(Su(e),t&&(t.style.display="")):je==="news"?(Du(e),t&&(t.style.display="")):je==="export"?(Tu(e),t&&(t.style.display="none")):je==="dm"?(Nu(e),t&&(t.style.display="none")):je==="global"&&(Ou(e),t&&(t.style.display="none"))}function Mu(){const e=document.getElementById("admin-debug-hud-toggle");if(!e)return;if(!_t()){e.checked=!1,Ua(!1),Zt(!1);return}const t=e.checked===!0;Ua(t),Zt(t)}function tl(){const e=document.getElementById("admin-debug-hud-toggle");if(!e)return;const t=_t(),n=t&&(Qs?.()??Eu());e.checked=n,e.disabled=!t,Zt(n)}function Eu(){try{return localStorage.getItem(Xs)==="1"}catch{return!1}}function Ua(e){try{localStorage.setItem(Xs,e?"1":"0")}catch(t){console.warn("[admin] failed to persist debug hud preference",t)}}function Zt(e){const t=e===!0&&_t();Vs?.(t)}function Su(e){const n=jn()?.items||[];e.innerHTML=`
        <div class="admin-editor">
            <div class="admin-list" id="gallery-list">
                ${n.map((a,o)=>`
                    <div class="admin-item" data-index="${o}">
                        <div class="item-header">
                            <span class="item-title">${a.title||"(ÁÑ°È°å)"}</span>
                            <div class="item-actions">
                                <button class="item-btn" data-action="up" ${o===0?"disabled":""}>‚Üë</button>
                                <button class="item-btn" data-action="down" ${o===n.length-1?"disabled":""}>‚Üì</button>
                                <button class="item-btn" data-action="edit">‚úèÔ∏è</button>
                                <button class="item-btn danger" data-action="delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="item-meta">${a.url||""}</div>
                    </div>
                `).join("")}
            </div>
            <button id="gallery-add-btn" class="admin-btn">+ „Ç¢„Ç§„ÉÜ„É†ËøΩÂä†</button>
        </div>
    `,e.querySelectorAll(".item-btn").forEach(a=>{a.addEventListener("click",o=>{const i=o.target.closest(".admin-item"),s=parseInt(i.dataset.index);_u(o.target.dataset.action,s)})}),document.getElementById("gallery-add-btn").addEventListener("click",()=>{nl(-1)})}function _u(e,t){const n=jn(),a=[...n.items];e==="up"&&t>0?([a[t],a[t-1]]=[a[t-1],a[t]],Rt({...n,items:a}),le()):e==="down"&&t<a.length-1?([a[t],a[t+1]]=[a[t+1],a[t]],Rt({...n,items:a}),le()):e==="delete"?confirm("„Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")&&(a.splice(t,1),Rt({...n,items:a}),le()):e==="edit"&&nl(t)}function nl(e){const t=jn(),n=e>=0?t.items[e]:{id:`tool-${Date.now()}`,title:"",url:"",desc:"",tags:[]},a=document.getElementById("admin-tab-content");a.innerHTML=`
        <div class="admin-form">
            <h3>${e>=0?"„Ç¢„Ç§„ÉÜ„É†Á∑®ÈõÜ":"Êñ∞Ë¶è„Ç¢„Ç§„ÉÜ„É†"}</h3>
            <label>„Çø„Ç§„Éà„É´</label>
            <input type="text" id="gallery-edit-title" value="${n.title||""}">
            <label>URL</label>
            <input type="url" id="gallery-edit-url" value="${n.url||""}">
            <label>Ë™¨Êòé</label>
            <input type="text" id="gallery-edit-desc" value="${n.desc||""}">
            <label>„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä)</label>
            <input type="text" id="gallery-edit-tags" value="${(n.tags||[]).join(", ")}">
            <div class="admin-buttons">
                <button id="gallery-edit-save" class="admin-btn primary">‰øùÂ≠ò</button>
                <button id="gallery-edit-cancel" class="admin-btn">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    `,document.getElementById("gallery-edit-save").addEventListener("click",()=>{const o={id:n.id,title:document.getElementById("gallery-edit-title").value,url:document.getElementById("gallery-edit-url").value,desc:document.getElementById("gallery-edit-desc").value,tags:document.getElementById("gallery-edit-tags").value.split(",").map(s=>s.trim()).filter(Boolean)},i=[...t.items];e>=0?i[e]=o:i.push(o),Rt({...t,items:i}),le()}),document.getElementById("gallery-edit-cancel").addEventListener("click",le)}function Lu(){alert("„ÇÆ„É£„É©„É™„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü")}function Du(e){const n=Wn()?.items||[];e.innerHTML=`
        <div class="admin-editor">
            <div class="admin-list" id="news-list">
                ${n.map((a,o)=>`
                    <div class="admin-item" data-index="${o}">
                        <div class="item-header">
                            <span class="item-title">${a.title||"(ÁÑ°È°å)"}</span>
                            <span class="item-date">${a.date||""}</span>
                            <div class="item-actions">
                                <button class="item-btn" data-action="up" ${o===0?"disabled":""}>‚Üë</button>
                                <button class="item-btn" data-action="down" ${o===n.length-1?"disabled":""}>‚Üì</button>
                                <button class="item-btn" data-action="edit">‚úèÔ∏è</button>
                                <button class="item-btn danger" data-action="delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="item-meta">${(a.body||"").substring(0,50)}...</div>
                    </div>
                `).join("")}
            </div>
            <button id="news-add-btn" class="admin-btn">+ „Éã„É•„Éº„ÇπËøΩÂä†</button>
        </div>
    `,e.querySelectorAll(".item-btn").forEach(a=>{a.addEventListener("click",o=>{const i=o.target.closest(".admin-item"),s=parseInt(i.dataset.index);xu(o.target.dataset.action,s)})}),document.getElementById("news-add-btn").addEventListener("click",()=>{al(-1)})}function xu(e,t){const n=Wn(),a=[...n.items];e==="up"&&t>0?([a[t],a[t-1]]=[a[t-1],a[t]],Ht({...n,items:a}),le()):e==="down"&&t<a.length-1?([a[t],a[t+1]]=[a[t+1],a[t]],Ht({...n,items:a}),le()):e==="delete"?confirm("„Åì„ÅÆ„Éã„É•„Éº„Çπ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")&&(a.splice(t,1),Ht({...n,items:a}),le()):e==="edit"&&al(t)}function al(e){const t=Wn(),n=e>=0?t.items[e]:{id:`news-${Date.now()}`,title:"",body:"",date:new Date().toISOString().split("T")[0]},a=document.getElementById("admin-tab-content");a.innerHTML=`
        <div class="admin-form">
            <h3>${e>=0?"„Éã„É•„Éº„ÇπÁ∑®ÈõÜ":"Êñ∞Ë¶è„Éã„É•„Éº„Çπ"}</h3>
            <label>„Çø„Ç§„Éà„É´</label>
            <input type="text" id="news-edit-title" value="${n.title||""}">
            <label>Êó•‰ªò</label>
            <input type="date" id="news-edit-date" value="${n.date||""}">
            <label>Êú¨Êñá</label>
            <textarea id="news-edit-body" rows="5">${n.body||""}</textarea>
            <div class="admin-buttons">
                <button id="news-edit-save" class="admin-btn primary">‰øùÂ≠ò</button>
                <button id="news-edit-cancel" class="admin-btn">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    `,document.getElementById("news-edit-save").addEventListener("click",()=>{const o={id:n.id,title:document.getElementById("news-edit-title").value,date:document.getElementById("news-edit-date").value,body:document.getElementById("news-edit-body").value},i=[...t.items];e>=0?i[e]=o:i.push(o),Ht({...t,items:i}),le()}),document.getElementById("news-edit-cancel").addEventListener("click",le)}function Bu(){alert("„ÅäÁü•„Çâ„Åõ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü")}function Tu(e){const t=Cu();e.innerHTML=`
        <div class="admin-export">
            <h3>üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</h3>
            <p>ÁèæÂú®„ÅÆ„ÇÆ„É£„É©„É™„Éº/„ÅäÁü•„Çâ„Åõ„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åæ„Åü„ÅØ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô</p>
            <textarea id="export-text" readonly rows="8">${t}</textarea>
            <div class="admin-buttons">
                <button id="export-copy-btn" class="admin-btn">üìã „Ç≥„Éî„Éº</button>
                <button id="export-download-btn" class="admin-btn">üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
            </div>
            
            <h3>üì• „Ç§„É≥„Éù„Éº„Éà</h3>
            <p>JSON„ÇíË≤º„Çä‰ªò„Åë„Å¶„Ç§„É≥„Éù„Éº„Éà</p>
            <textarea id="import-text" rows="5" placeholder='{"gallery": {...}, "news": {...}}'></textarea>
            <div id="import-status" class="admin-status"></div>
            <div class="admin-buttons">
                <button id="import-btn" class="admin-btn primary">„Ç§„É≥„Éù„Éº„Éà</button>
                <button id="clear-overrides-btn" class="admin-btn danger">üóëÔ∏è „Ç™„Éº„Éê„Éº„É©„Ç§„Éâ„Çí„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>
    `,document.getElementById("export-copy-btn").addEventListener("click",()=>{navigator.clipboard.writeText(t),alert("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü")}),document.getElementById("export-download-btn").addEventListener("click",()=>{const n=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`virtualoffice-content-${new Date().toISOString().split("T")[0]}.json`,o.click(),URL.revokeObjectURL(a)}),document.getElementById("import-btn").addEventListener("click",()=>{const n=document.getElementById("import-text").value,a=wu(n),o=document.getElementById("import-status");a.success?(o.textContent="‚úÖ „Ç§„É≥„Éù„Éº„ÉàÊàêÂäü",o.className="admin-status success"):(o.textContent=`‚ùå „Ç®„É©„Éº: ${a.error}`,o.className="admin-status error")}),document.getElementById("clear-overrides-btn").addEventListener("click",()=>{confirm(`localStorage„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ„Çí„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü
„Éá„Éï„Ç©„É´„Éà„ÅÆJSON„Å´Êàª„Çä„Åæ„Åô„ÄÇ`)&&(hu(),alert("„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"))})}function Nu(e){e.innerHTML=`
        <div class="admin-export">
            <h3>üßπ DM„Éá„Éº„ÇøÂâäÈô§</h3>
            <p>ÁÑ°ÊñôÊû†ÁØÄÁ¥Ñ„ÅÆ„Åü„ÇÅ„ÄÅÂè§„ÅÑDM„ÇÑÂÖ®‰ª∂DM„ÇíÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
                <label class="form-label" for="dm-purge-days">ÂâäÈô§ÂØæË±°ÔºàÊó•Êï∞„Çà„ÇäÂâçÔºâ</label>
                <input type="number" id="dm-purge-days" class="form-input" min="1" step="1" value="30">
            </div>
            <div class="admin-buttons">
                <button id="dm-purge-before-btn" class="admin-btn">30Êó•„Çà„ÇäÂâç„ÇíÂâäÈô§</button>
                <button id="dm-purge-all-btn" class="admin-btn danger">üóëÔ∏è DM„ÇíÂÖ®ÂâäÈô§</button>
            </div>
            <div id="dm-purge-status" class="admin-status"></div>
        </div>
    `;const t=document.getElementById("dm-purge-status"),n=document.getElementById("dm-purge-days"),a=document.getElementById("dm-purge-before-btn"),o=document.getElementById("dm-purge-all-btn");function i(l,d){t&&(t.textContent=l,t.className=d?"admin-status success":"admin-status error")}function s(l){a&&(a.disabled=l),o&&(o.disabled=l)}a?.addEventListener("click",async()=>{const l=Math.max(1,Number(n?.value)||30);if(confirm(`${l}Êó•„Çà„ÇäÂâç„ÅÆDM„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)){s(!0);try{const d=await cd(l);i(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${d}Ôºâ`,!0)}catch(d){console.error("[admin] DM purge before failed",d),i("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{s(!1)}}}),o?.addEventListener("click",async()=>{if(confirm("DM„ÇíÂÖ®‰ª∂ÂâäÈô§„Åó„Åæ„Åô„ÄÇÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü")){s(!0);try{const l=await dd();i(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${l}Ôºâ`,!0)}catch(l){console.error("[admin] DM purge all failed",l),i("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{s(!1)}}})}function Ou(e){e.innerHTML=`
        <div class="admin-export">
            <h3>üßπ ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂâäÈô§</h3>
            <p>ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí‰∏ÄË¶ßÁ¢∫Ë™ç„Åó„ÄÅ1‰ª∂ÂâäÈô§„Åæ„Åü„ÅØ‰∏ÄÊã¨ÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
                <label class="form-label" for="global-room-id">room_idÔºàÁ©∫Ê¨Ñ„ÅßÂÖ®„É´„Éº„É†Ôºâ</label>
                <input type="text" id="global-room-id" class="form-input" value="room:default" placeholder="room:default">
            </div>
            <div class="form-group">
                <label class="form-label" for="global-purge-days">ÂâäÈô§ÂØæË±°ÔºàÊó•Êï∞„Çà„ÇäÂâçÔºâ</label>
                <input type="number" id="global-purge-days" class="form-input" min="1" step="1" value="30">
            </div>
            <div class="admin-buttons">
                <button id="global-refresh-btn" class="admin-btn">‰∏ÄË¶ß„ÇíÊõ¥Êñ∞</button>
                <button id="global-purge-before-btn" class="admin-btn">30Êó•„Çà„ÇäÂâç„ÇíÂâäÈô§</button>
                <button id="global-purge-all-btn" class="admin-btn danger">üóëÔ∏è ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂÖ®ÂâäÈô§</button>
            </div>
            <div id="global-purge-status" class="admin-status"></div>
            <div class="admin-list" id="global-message-list"></div>
        </div>
    `;const t=document.getElementById("global-purge-status"),n=document.getElementById("global-room-id"),a=document.getElementById("global-purge-days"),o=document.getElementById("global-message-list"),i=document.getElementById("global-refresh-btn"),s=document.getElementById("global-purge-before-btn"),l=document.getElementById("global-purge-all-btn");function d(){return String(n?.value||"").trim()||null}function p(g,I){t&&(t.textContent=g,t.className=I?"admin-status success":"admin-status error")}function m(g){i&&(i.disabled=g),s&&(s.disabled=g),l&&(l.disabled=g),o&&o.querySelectorAll('button[data-action="delete"]').forEach(I=>{I.disabled=g})}async function C(){if(o){o.innerHTML='<div class="chat-empty">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';try{const g=await md({roomId:d(),limit:200});if(!g.length){o.innerHTML='<div class="chat-empty">ÂØæË±°„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>';return}o.innerHTML=g.map(I=>{const y=String(I?.message||"").slice(0,120),b=I?.sender_display_name||I?.sender_actor_id||"‰∏çÊòé";return`
                    <div class="admin-item">
                        <div class="item-header">
                            <span class="item-title">${rn(b)}</span>
                            <span class="item-date">${rn($u(I?.created_at))}</span>
                            <div class="item-actions">
                                <button class="item-btn danger" data-action="delete" data-id="${rn(I?.id||"")}" title="ÂâäÈô§">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="item-meta">${rn(y||"(Á©∫„É°„ÉÉ„Çª„Éº„Ç∏)")}</div>
                    </div>
                `}).join("")}catch(g){console.error("[admin] global list fetch failed",g),o.innerHTML='<div class="chat-empty">‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</div>'}}}i?.addEventListener("click",()=>{C()}),s?.addEventListener("click",async()=>{const g=Math.max(1,Number(a?.value)||30);if(confirm(`${g}Êó•„Çà„ÇäÂâç„ÅÆÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)){m(!0);try{const I=await Id(g,d());p(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${I}Ôºâ`,!0),await C()}catch(I){console.error("[admin] global purge before failed",I),p("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{m(!1)}}}),l?.addEventListener("click",async()=>{if(confirm("ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂÖ®‰ª∂ÂâäÈô§„Åó„Åæ„Åô„ÄÇÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü")){m(!0);try{const g=await yd(d());p(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${g}Ôºâ`,!0),await C()}catch(g){console.error("[admin] global purge all failed",g),p("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{m(!1)}}}),o?.addEventListener("click",async g=>{const I=g.target.closest?.('button[data-action="delete"]');if(!I)return;const y=I.dataset.id;if(y&&confirm("„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")){m(!0);try{await pd(y)>0?p("ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: 1Ôºâ",!0):p("ÂØæË±°„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü",!1),await C()}catch(b){console.error("[admin] global delete failed",b),p("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{m(!1)}}}),C()}function $u(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?String(e):t.toLocaleString("ja-JP",{hour12:!1})}function rn(e){const t=document.createElement("div");return t.textContent=String(e??""),t.innerHTML}let J=null,qa=!1,yt=null,xn="area:core";const ol="bgm:volume",il="area:garden",Ee={playingId:null,playingTitle:null,isPlaying:!1};function sl(e){return Math.max(0,Math.min(1,Number(e)))}function Pu(e){if(!e)return"";if(e.src)return String(e.src);if(e.url)return String(e.url);if(!e.file)return"";const t="/virtualoffice/".replace(/\/+$/,""),n=String(e.file).replace(/^\/+/,"");return`${t}/${n}`.replace(/^\/\//,"/")}function Eo(){if(J)return J;J=new Audio,J.loop=!0,J.preload="auto";const e=Number(localStorage.getItem(ol));return J.volume=Number.isFinite(e)?sl(e):.25,J}function ua(e){xn=e||"area:core",xn!==il&&We()}function cn(){if(!qa&&(qa=!0,yt)){const e=yt;yt=null,So(e)}}async function So(e,{areaId:t}={}){if(!e?.file)return!1;J||Eo();const n=t||xn;if(n!==il)return We(),!1;if(xn=n,!qa)return yt=e,!1;const a=Pu(e);if(!a)return!1;try{return J.pause(),J.src=a,J.load(),J.currentTime=0,await J.play(),Ee.playingId=e.id||null,Ee.playingTitle=e.title||null,Ee.isPlaying=!0,yt=null,!0}catch(o){return Ee.isPlaying=!1,console.warn("[BGM] play failed",o),!1}}function We(){if(Ee.playingId=null,Ee.playingTitle=null,Ee.isPlaying=!1,yt=null,!!J)try{J.pause(),J.currentTime=0,J.src=""}catch(e){console.warn("[BGM] stop failed",e)}}function Ru(e){J||Eo();const t=sl(e);J.volume=t,localStorage.setItem(ol,String(t))}function ll(){return{playingId:Ee.playingId,playingTitle:Ee.playingTitle,isPlaying:Ee.isPlaying,volume:J?J.volume:null}}let me=null,Ue=null,_o=!1;const fa="bgm:garden:selected";function Hu(){me||(me=document.createElement("div"),me.id="bgm-modal-overlay",me.className="spot-modal-overlay",document.getElementById("app").appendChild(me),Ue=document.createElement("div"),Ue.className="spot-modal",Ue.id="modal-bgm",Ue.innerHTML=`
        <div class="modal-header">
            <h2 class="modal-title" id="bgm-modal-title">„Ç¨„Éº„Éá„É≥BGM</h2>
            <button type="button" class="modal-close-btn" id="bgm-modal-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="bgm-modal-body"></div>
    `,me.appendChild(Ue),document.getElementById("bgm-modal-close").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),yn()}),me.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.target===me&&yn()}),Ue.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&_o&&yn()}))}function Za({tracks:e=[],selectedId:t=null,title:n="„Ç¨„Éº„Éá„É≥BGM"}={}){if(!Ue)return;const a=document.getElementById("bgm-modal-title");a&&(a.textContent=n);const o=document.getElementById("bgm-modal-body"),i=t||localStorage.getItem(fa)||"none",s=ll?.()||{},l=s.isPlaying?s.playingId:i,d=s.isPlaying?s.playingTitle||"‰∏çÊòé":"ÂÅúÊ≠¢‰∏≠",p=e.map(g=>{const I=g.id===l?'data-active="true"':"";return`
            <button type="button" class="spot-link-item" data-track-id="${g.id}" ${I}>
                <div class="spot-link-header">
                    <span class="spot-link-label">${g.title}</span>
                    ${s.playingId===g.id&&s.isPlaying?'<span class="spot-playing">ÂÜçÁîü‰∏≠</span>':""}
                </div>
            </button>
        `}).join("");o.innerHTML=`
        <div class="spot-link-item bgm-now-playing">
            <span>ÂÜçÁîü‰∏≠</span>
            <strong>${d}</strong>
        </div>
        <div class="spot-links-list bgm-track-list">
            ${p||'<div class="spot-link-item">„Éà„É©„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'}
        </div>
        <div class="spot-links-list" style="margin-top: 12px; gap: 12px;">
            <div class="spot-link-item" style="align-items: center;">
                <label style="flex: 1;">Èü≥Èáè</label>
                <input id="bgm-volume" type="range" min="0" max="1" step="0.01" value="${Wu()}" />
            </div>
            <button type="button" class="spot-link-item" id="bgm-stop-btn">ÂÅúÊ≠¢</button>
        </div>
    `,o.querySelectorAll("[data-track-id]").forEach(g=>{g.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation();const y=g.getAttribute("data-track-id"),b=e.find(f=>f.id===y);b&&So(b).then(f=>{f&&localStorage.setItem(fa,b.id),Za({tracks:e,selectedId:b.id,title:n})})})});const m=document.getElementById("bgm-stop-btn");m&&m.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),We(),localStorage.setItem(fa,"none"),Za({tracks:e,selectedId:"none",title:n})});const C=document.getElementById("bgm-volume");C&&C.addEventListener("input",g=>{Ru(g.target.value)}),ju()}function yn(){me&&(me.classList.remove("visible"),_o=!1)}function ju(){me.classList.add("visible"),_o=!0}function Wu(){const e=Number(localStorage.getItem("bgm:volume"));return Number.isFinite(e)?Math.max(0,Math.min(1,e)):.25}const zu="data:text/plain;base64,44GT44GT44Gr5ZCM5ZCN44GuIG1wMy9vZ2cg44KS572u44GR44Gw5beu44GX5pu/44GI5Y+v6IO9CkdpdEh1YiBQYWdlcyDjgafjga/jg5HjgrnjgYwgL3ZpcnR1YWxvZmZpY2UvYXNzZXRzL2JnbS8uLi4g44Gr44Gq44KLCuaOqOWlqO+8mm1wMyDjgYsgb2dn44CC5a656YeP44Gv6Lu944KB5o6o5aWoCg==",Fu="/virtualoffice/assets/akai_ha-B_hf7WkC.mp3",Gu="/virtualoffice/assets/fuuga-CWoASvj_.mp3",Ju="/virtualoffice/assets/kagaribi_no_yado-Cvb6jlw4.mp3",Uu="/virtualoffice/assets/kouyou_no_kourankei-Ch89g2qC.mp3",qu="/virtualoffice/assets/noyama-vXIInRqD.mp3",Zu="/virtualoffice/assets/onsengai_no_yube-Bv9QH5JC.mp3",Ku="/virtualoffice/assets/ryugujo-CAxxej4u.mp3",Yu="/virtualoffice/assets/ryuuou_no_houkou-H2UHkJuG.mp3",Vu="/virtualoffice/assets/sato_no_kosakura-CNVGWNb1.mp3",Qu="/virtualoffice/assets/seihitsu_o_yadosu_niwa-vE9nKOl2.mp3",Xu="/virtualoffice/assets/shiro_ni_somatte-DXPyewuz.mp3",ef="/virtualoffice/assets/suzukaze_ni_chiru-CBTXpfSH.mp3",tf="/virtualoffice/assets/yozakura_wa_maichiru-Bvlet8ek.mp3",Ka="kagaribi_no_yado",ga=[{id:"kagaribi_no_yado",title:"ÁØùÁÅ´„ÅÆ„ÅäÂÆø",file:"kagaribi_no_yado.mp3"},{id:"noyama",title:"ÈáéÂ±±",file:"noyama.mp3"},{id:"onsengai_no_yube",title:"Ê∏©Ê≥âË°ó„ÅÆÂ§ï„Åπ",file:"onsengai_no_yube.mp3"},{id:"ryugujo",title:"Á´úÂÆÆÂüé",file:"ryugujo.mp3"},{id:"sato_no_kosakura",title:"Èáå„ÅÆÂè§Ê°ú",file:"sato_no_kosakura.mp3"},{id:"shiro_ni_somatte",title:"ÁôΩ„Å´Êüì„Åæ„Å£„Å¶",file:"shiro_ni_somatte.mp3"},{id:"yozakura_wa_maichiru",title:"Â§úÊ°ú„ÅØËàû„ÅÑÊï£„Çã",file:"yozakura_wa_maichiru.mp3"},{id:"suzukaze_ni_chiru",title:"Ê∂ºÈ¢®„Å´Êï£„Çã",file:"suzukaze_ni_chiru.mp3"},{id:"akai_ha",title:"Ëµ§„ÅÑËëâ",file:"akai_ha.mp3"},{id:"fuuga",title:"È¢®ÈõÖ",file:"fuuga.mp3"},{id:"ryuuou_no_houkou",title:"ÈæçÁéã„ÅÆÂíÜÂìÆ",file:"ryuuou_no_houkou.mp3"},{id:"seihitsu_o_yadosu_niwa",title:"ÈùôË¨ê„ÇíÂÆø„ÅôÂ∫≠",file:"seihitsu_o_yadosu_niwa.mp3"},{id:"kouyou_no_kourankei",title:"Á¥ÖËëâ„ÅÆÈ¶ôÂµêÊ∏ì",file:"kouyou_no_kourankei.mp3"}];function Li(e){const t=String(e||"").replace(/^\/+/,"");return new URL(Object.assign({"../../assets/bgm/README.txt":zu,"../../assets/bgm/akai_ha.mp3":Fu,"../../assets/bgm/fuuga.mp3":Gu,"../../assets/bgm/kagaribi_no_yado.mp3":Ju,"../../assets/bgm/kouyou_no_kourankei.mp3":Uu,"../../assets/bgm/noyama.mp3":qu,"../../assets/bgm/onsengai_no_yube.mp3":Zu,"../../assets/bgm/ryugujo.mp3":Ku,"../../assets/bgm/ryuuou_no_houkou.mp3":Yu,"../../assets/bgm/sato_no_kosakura.mp3":Vu,"../../assets/bgm/seihitsu_o_yadosu_niwa.mp3":Qu,"../../assets/bgm/shiro_ni_somatte.mp3":Xu,"../../assets/bgm/suzukaze_ni_chiru.mp3":ef,"../../assets/bgm/yozakura_wa_maichiru.mp3":tf})[`../../assets/bgm/${t}`],import.meta.url).href}let pe=null,qe=null,Lo=!1;const Di="ambientPreset:garden";function nf(){pe||(pe=document.createElement("div"),pe.id="ambient-modal-overlay",pe.className="spot-modal-overlay",document.getElementById("app").appendChild(pe),qe=document.createElement("div"),qe.className="spot-modal",qe.id="modal-ambient",qe.innerHTML=`
        <div class="modal-header">
            <h2 class="modal-title" id="ambient-modal-title">Ambient Particles</h2>
            <button type="button" class="modal-close-btn" id="ambient-modal-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="ambient-modal-body"></div>
    `,pe.appendChild(qe),document.getElementById("ambient-modal-close").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),bn()}),pe.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.target===pe&&bn()}),qe.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Lo&&bn()}))}function rl(){if(!qe)return;const e=qr()||localStorage.getItem(Di)||"firefly",t=Object.values(wn),n=document.getElementById("ambient-modal-body");n.innerHTML=`
        <div class="spot-links-list ambient-list">
            ${t.map(a=>{const o=a.id===e?'data-active="true"':"";return`
                    <button type="button" class="spot-link-item" data-ambient-id="${a.id}" ${o}>
                        <div class="spot-link-header">
                            <span class="spot-link-label">${a.label}</span>
                            ${a.id===e?'<span class="spot-playing">Selected</span>':""}
                        </div>
                    </button>
                `}).join("")}
        </div>
    `,n.querySelectorAll("[data-ambient-id]").forEach(a=>{a.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const i=a.getAttribute("data-ambient-id");if(i)try{us(i),localStorage.setItem(Di,i),B(`Ambient: ${wn[i]?.label||i}`,"success"),rl()}catch(s){console.warn("[Ambient] preset failed",s),B("Ambient„ÅÆÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}})}),af()}function bn(){pe&&(pe.classList.remove("visible"),Lo=!1)}function af(){pe.classList.add("visible"),Lo=!0}let de=null,it=null,Ya=null,bt=null,Do=!1;function cl(){de||(de=document.createElement("div"),de.id="library-modal-overlay",de.className="spot-modal-overlay",document.getElementById("app").appendChild(de),it=document.createElement("div"),it.id="library-modal",it.className="spot-modal",it.innerHTML=`
        <div class="modal-header">
            <h2 class="modal-title" id="library-modal-title"></h2>
            <button type="button" class="modal-close-btn" id="library-modal-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="library-modal-body"></div>
    `,de.appendChild(it),document.getElementById("library-modal-close").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),hn()}),de.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.target===de&&hn()}),it.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Do&&hn()}),Ya=document.getElementById("library-modal-title"),bt=document.getElementById("library-modal-body"))}function zn({title:e,contentEl:t}){de||cl(),Ya&&(Ya.textContent=e||""),bt&&(bt.innerHTML="",t&&bt.appendChild(t)),de.classList.add("visible"),Do=!0}function hn(){de&&(de.classList.remove("visible"),Do=!1,bt&&(bt.innerHTML=""))}async function xo(){const e=T();if(!e)return console.error("[ProfileStore] Supabase not initialized"),[];const{data:t,error:n}=await e.from("profiles").select("*").order("updated_at",{ascending:!1});if(n)throw console.error("[ProfileStore] listProfiles error:",n),n;return t||[]}async function Mt(e){if(!e)return null;const t=T();if(!t)return null;const{data:n,error:a}=await t.from("profiles").select("*").eq("id",e).maybeSingle();if(a)throw console.error("[ProfileStore] getProfileById error:",a),a;return n}async function of(e,t){const n=T();if(!n)throw new Error("Supabase not initialized");const{data:{user:a}}=await n.auth.getUser(),o=a?.id||null;if(e.id){const l=await Mt(e.id);if(l){const{error:d}=await n.from("profile_revisions").insert({profile_id:l.id,editor_id:o,editor_label:t,snapshot:l});d&&console.error("[ProfileStore] revision save error:",d)}}const i={display_name:e.display_name||e.name||"Unnamed",role:e.role||null,team:e.team||null,bio:e.bio||null,tags:e.tags||[],avatar_color:e.avatar_color||e.avatarColor||null,updated_by:o,updated_by_label:t};e.handle&&(i.handle=e.handle);let s;if(e.id){const{data:l,error:d}=await n.from("profiles").update(i).eq("id",e.id).select().single();if(d)throw console.error("[ProfileStore] update error:",d),d;s=l}else{const{data:l,error:d}=await n.from("profiles").insert(i).select().single();if(d)throw console.error("[ProfileStore] insert error:",d),d;s=l}return s}async function sf(e){if(!e)return;const t=T();if(!t)throw new Error("Supabase not initialized");const{error:n}=await t.from("profiles").delete().eq("id",e);if(n)throw console.error("[ProfileStore] delete error:",n),n}async function lf(e){const t=await xo(),n=String(e||"").trim().toLowerCase();return n?t.filter(a=>[a.display_name,a.role,a.team,a.bio,...Array.isArray(a.tags)?a.tags:[]].filter(Boolean).join(" ").toLowerCase().includes(n)):t}async function rf(e=20){const t=T();if(!t)return[];const{data:n,error:a}=await t.from("profiles").select("*").order("updated_at",{ascending:!1}).limit(e);if(a)throw console.error("[ProfileStore] getRecentProfiles error:",a),a;return n||[]}async function cf(e){if(!e)return[];const t=T();if(!t)return[];const{data:n,error:a}=await t.from("profile_notes").select("*").eq("profile_id",e).order("created_at",{ascending:!1});if(a)throw console.error("[ProfileStore] listNotes error:",a),a;return n||[]}async function df(e,t,n){if(!e||!t?.content)throw new Error("profileId and content are required");const a=T();if(!a)throw new Error("Supabase not initialized");const{data:{user:o}}=await a.auth.getUser(),{data:i,error:s}=await a.from("profile_notes").insert({profile_id:e,kind:t.kind||"note",content:t.content,author_id:o?.id||null,author_label:n}).select().single();if(s)throw console.error("[ProfileStore] addNote error:",s),s;return i}async function uf(e,t=20){if(!e)return[];const n=T();if(!n)return[];const{data:a,error:o}=await n.from("profile_revisions").select("*").eq("profile_id",e).order("created_at",{ascending:!1}).limit(t);if(o)throw console.error("[ProfileStore] listRevisions error:",o),o;return a||[]}async function ff(e,t,n){const a=T();if(!a)throw new Error("Supabase not initialized");const{data:o,error:i}=await a.from("profile_revisions").select("*").eq("id",t).single();if(i||!o)throw new Error("Revision not found");const s=await Mt(e);if(s){const{data:{user:C}}=await a.auth.getUser();await a.from("profile_revisions").insert({profile_id:e,editor_id:C?.id||null,editor_label:`${n} (revert)`,snapshot:s})}const l=o.snapshot,{data:{user:d}}=await a.auth.getUser(),{data:p,error:m}=await a.from("profiles").update({display_name:l.display_name,role:l.role,team:l.team,bio:l.bio,tags:l.tags,avatar_color:l.avatar_color,updated_by:d?.id||null,updated_by_label:`${n} (revert)`}).eq("id",e).select().single();if(m)throw console.error("[ProfileStore] revert error:",m),m;return p}function gf(e){if(!e)return"‰∏çÊòé„Å™„Ç®„É©„Éº";const t=e.message||String(e);return t.includes("JWT")||t.includes("token")||t.includes("auth")?"„É≠„Ç∞„Ç§„É≥„ÅåÂàá„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂÜç„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ":t.includes("network")||t.includes("fetch")?"„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ":t.includes("duplicate")||t.includes("unique")?"„Åô„Åß„Å´Âêå„Åò„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Åæ„Åô„ÄÇ":`„Ç®„É©„Éº: ${t}`}const dl="vo.editorLabel.v1";function ul(){try{return localStorage.getItem(dl)||null}catch{return null}}function mf(e){try{localStorage.setItem(dl,e)}catch(t){console.warn("[EditorLabel] save failed",t)}}function pf(){const e=ul();return e!==null&&e.trim()!==""}function Va(){return new Promise(e=>{if(pf()){e(ul());return}const t=document.createElement("div");t.className="editor-label-modal-overlay",t.innerHTML=`
            <div class="editor-label-modal">
                <div class="editor-label-modal-header">
                    <h3>„ÅÇ„Å™„Åü„ÅÆË°®Á§∫Âêç</h3>
                </div>
                <div class="editor-label-modal-body">
                    <p class="editor-label-hint">
                        Á∑®ÈõÜÂ±•Ê≠¥„Å´Ë®òÈå≤„Åï„Çå„ÇãË°®Á§∫Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </p>
                    <input type="text" 
                           class="form-input" 
                           id="editor-label-input" 
                           placeholder="‰æã: Â±±Áî∞Â§™ÈÉé" 
                           maxlength="50" />
                    <div class="editor-label-error" id="editor-label-error"></div>
                </div>
                <div class="editor-label-modal-footer">
                    <button type="button" class="btn btn-secondary" id="editor-label-cancel">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" id="editor-label-save">‰øùÂ≠ò</button>
                </div>
            </div>
        `,document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("visible")});const n=t.querySelector("#editor-label-input"),a=t.querySelector("#editor-label-error"),o=t.querySelector("#editor-label-save"),i=t.querySelector("#editor-label-cancel");function s(d){t.classList.remove("visible"),setTimeout(()=>{t.remove()},200),e(d)}function l(){const d=n.value.trim();if(!d){a.textContent="Ë°®Á§∫Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",n.focus();return}mf(d),s(d)}n.addEventListener("keydown",d=>{d.key==="Enter"?(d.preventDefault(),l()):d.key==="Escape"&&s(null)}),o.addEventListener("click",d=>{d.preventDefault(),l()}),i.addEventListener("click",d=>{d.preventDefault(),s(null)}),t.addEventListener("click",d=>{d.target===t&&s(null)}),setTimeout(()=>n.focus(),100)})}function ee(e,t,n){const a=document.createElement(e);return t&&(a.className=t),n!=null&&(a.textContent=n),a}function ht(e){if(!e)return"";const t=e instanceof Date?e:new Date(e),n=Date.now()-t.getTime(),a=Math.round(n/6e4);if(a<1)return"just now";if(a<60)return`${a}m ago`;const o=Math.round(a/60);return o<24?`${o}h ago`:`${Math.round(o/24)}d ago`}function If(e){return e?e.split(",").map(t=>t.trim()).filter(Boolean).slice(0,5):[]}function Me(e,t){const n=e.querySelector(".library-error");n&&n.remove();const a=ee("div","library-error",gf(t));e.insertBefore(a,e.firstChild)}function fe(e,t=!0){const n=e.querySelector(".library-loading");if(n&&n.remove(),t){const a=ee("div","library-loading","Loading...");e.appendChild(a)}}function Bo(e,t,n,a=null){if(e.innerHTML="",!t.length){e.appendChild(ee("div","library-empty","No profiles"));return}t.forEach(o=>{const i=ee("button","library-list-item");i.type="button",i.dataset.profileId=o.id;const s=o.display_name||o.name||"Unnamed";i.innerHTML=`
            <div class="library-list-title">${s}</div>
            <div class="library-list-meta">${o.role||""} ${o.team||""}</div>
        `,o.id===a&&i.classList.add("active"),i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),n(o.id)}),e.appendChild(i)})}async function yf(){const e=ee("div","library-modal-content");e.innerHTML=`
        <div id="profile-editor-error"></div>
        <div class="library-grid">
            <div class="library-pane">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="profile-name" />
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <input type="text" class="form-input" id="profile-role" />
                </div>
                <div class="form-group">
                    <label class="form-label">Team</label>
                    <input type="text" class="form-input" id="profile-team" />
                </div>
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-input" id="profile-bio" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (comma)</label>
                    <input type="text" class="form-input" id="profile-tags" />
                </div>
                <div class="form-group">
                    <label class="form-label">Avatar Color</label>
                    <input type="color" id="profile-color" value="#5b7cff" />
                </div>
                <div class="library-actions">
                    <button class="btn btn-primary" id="profile-save" type="button">Save</button>
                    <button class="btn btn-secondary" id="profile-new" type="button">New</button>
                    <button class="btn btn-secondary" id="profile-history" type="button">History</button>
                    <button class="btn btn-secondary" id="profile-delete" type="button">Delete</button>
                </div>
                <div id="profile-editor-info"></div>
            </div>
            <div class="library-pane">
                <div class="library-section-title">Profiles</div>
                <div id="profile-list" class="library-list"></div>
            </div>
        </div>
        <div id="profile-revisions-panel" style="display:none;">
            <div class="library-section-title" style="margin-top:16px;">Á∑®ÈõÜÂ±•Ê≠¥</div>
            <div id="profile-revisions-list" class="library-revisions-list"></div>
        </div>
    `;const t=e.querySelector("#profile-list"),n=e.querySelector("#profile-editor-error"),a=e.querySelector("#profile-editor-info"),o=e.querySelector("#profile-revisions-panel"),i=e.querySelector("#profile-revisions-list");let s=null,l=!1;function d(g){e.querySelector("#profile-name").value=g?.display_name||g?.name||"",e.querySelector("#profile-role").value=g?.role||"",e.querySelector("#profile-team").value=g?.team||"",e.querySelector("#profile-bio").value=g?.bio||"",e.querySelector("#profile-tags").value=(g?.tags||[]).join(", "),e.querySelector("#profile-color").value=g?.avatar_color||g?.avatarColor||"#5b7cff",g?.updated_by_label?a.innerHTML=`
                <div class="library-editor-info">
                    ÊúÄÁµÇÁ∑®ÈõÜ: <span class="library-editor-label">${g.updated_by_label}</span>
                    ¬∑ ${ht(g.updated_at)}
                </div>
            `:a.innerHTML=""}async function p(){if(!l){l=!0,fe(t,!0);try{const g=await xo();fe(t,!1),Bo(t,g,async I=>{s=I;const y=await Mt(I);d(y),p(),o.style.display="none"},s)}catch(g){fe(t,!1),Me(n,g)}finally{l=!1}}}async function m(){if(!s){B("Select a profile first","info");return}try{const g=await uf(s);if(o.style.display="block",i.innerHTML="",!g.length){i.appendChild(ee("div","library-empty","No revision history"));return}g.forEach(I=>{const y=ee("div","library-revision-item");y.innerHTML=`
                    <div class="library-revision-info">
                        <div class="library-revision-editor">${I.editor_label||"Unknown"}</div>
                        <div class="library-revision-date">${ht(I.created_at)}</div>
                    </div>
                    <button type="button" class="library-revert-btn">„Åì„ÅÆÁâà„Å´Êàª„Åô</button>
                `,y.querySelector(".library-revert-btn").addEventListener("click",async b=>{b.preventDefault(),b.stopPropagation(),await C(I.id)}),i.appendChild(y)})}catch(g){Me(n,g)}}async function C(g){const I=await Va();if(!I){B("Ë°®Á§∫Âêç„ÅåÂøÖË¶Å„Åß„Åô","error");return}try{await ff(s,g,I),B("Reverted successfully","success");const y=await Mt(s);d(y),await m()}catch(y){Me(n,y)}}e.querySelector("#profile-save").addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation();const I=e.querySelector("#profile-name").value.trim();if(!I){B("Name is required","error");return}const y=await Va();if(!y){B("Ë°®Á§∫Âêç„ÅåÂøÖË¶Å„Åß„Åô","error");return}const b={id:s||void 0,display_name:I,role:e.querySelector("#profile-role").value.trim(),team:e.querySelector("#profile-team").value.trim(),bio:e.querySelector("#profile-bio").value.trim(),tags:If(e.querySelector("#profile-tags").value),avatar_color:e.querySelector("#profile-color").value};try{const f=await of(b,y);s=f.id,d(f),await p(),B("Profile saved","success"),o.style.display="none"}catch(f){Me(n,f)}}),e.querySelector("#profile-new").addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),s=null,d(null),p(),o.style.display="none"}),e.querySelector("#profile-history").addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),m()}),e.querySelector("#profile-delete").addEventListener("click",async g=>{if(g.preventDefault(),g.stopPropagation(),!!s&&confirm("Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü"))try{await sf(s),s=null,d(null),await p(),B("Profile deleted","info"),o.style.display="none"}catch(I){Me(n,I)}}),await p(),d(null),zn({title:"„Éó„É≠„Éï„Ç£„Éº„É´ÁôªÈå≤„ÉªÁ∑®ÈõÜ",contentEl:e})}async function bf(){const e=ee("div","library-modal-content");e.innerHTML=`
        <div id="directory-error"></div>
        <div class="form-group">
            <label class="form-label">Search</label>
            <input type="text" class="form-input" id="directory-search" placeholder="name, team, tag..." />
        </div>
        <div class="library-list" id="directory-results"></div>
    `;const t=e.querySelector("#directory-search"),n=e.querySelector("#directory-results"),a=e.querySelector("#directory-error");async function o(s){fe(n,!0);try{const l=await lf(s);fe(n,!1),Bo(n,l,d=>{To(d)})}catch(l){fe(n,!1),Me(a,l)}}let i=null;t.addEventListener("input",()=>{clearTimeout(i),i=setTimeout(()=>{o(t.value)},300)}),await o(""),zn({title:"ÁõÆÈå≤Ê§úÁ¥¢",contentEl:e})}async function hf(){const e=ee("div","library-modal-content"),t=ee("div");e.appendChild(t);const n=ee("div","library-list");e.appendChild(n),fe(n,!0);try{const a=await rf(20);fe(n,!1),a.length?a.forEach(o=>{const i=ee("button","library-list-item");i.type="button";const s=o.display_name||o.name||"Unnamed";i.innerHTML=`
                    <div class="library-list-title">${s}</div>
                    <div class="library-list-meta">${ht(o.updated_at)} ¬∑ ${o.role||""} ${o.team||""}</div>
                `,i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),To(o.id)}),n.appendChild(i)}):n.appendChild(ee("div","library-empty","No recent updates"))}catch(a){fe(n,!1),Me(t,a)}zn({title:"ÊúÄËøë„ÅÆÊõ¥Êñ∞",contentEl:e})}async function To(e=null){const t=ee("div","library-modal-content");t.innerHTML=`
        <div id="viewer-error"></div>
        <div class="library-grid">
            <div class="library-pane">
                <div class="library-section-title">Profiles</div>
                <div id="viewer-list" class="library-list"></div>
            </div>
            <div class="library-pane">
                <div id="viewer-detail" class="library-detail"></div>
                <div id="viewer-notes" class="library-notes-section" style="display:none;">
                    <div class="library-notes-title">„Åø„Çì„Å™„ÅÆ„É°„É¢</div>
                    <div id="notes-list" class="library-notes-list"></div>
                    <div class="library-note-form">
                        <div class="library-note-form-row">
                            <select id="note-kind" class="form-input">
                                <option value="note">„É°„É¢</option>
                                <option value="kudos">Kudos</option>
                                <option value="info">Info</option>
                                <option value="skill">Skill</option>
                            </select>
                            <button type="button" class="btn btn-primary" id="note-submit">ÊäïÁ®ø</button>
                        </div>
                        <textarea id="note-content" class="form-input" placeholder="Ê∞ó„Å•„Åç„ÇÑ„É°„É¢„ÇíÊÆã„Åô..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    `;const n=t.querySelector("#viewer-list"),a=t.querySelector("#viewer-detail"),o=t.querySelector("#viewer-notes"),i=t.querySelector("#notes-list"),s=t.querySelector("#viewer-error");let l=e,d=[];async function p(I){if(!I){a.innerHTML='<div class="library-empty">Select a profile</div>',o.style.display="none";return}const y=I.display_name||I.name||"Unnamed";a.innerHTML=`
            <div class="library-detail-name">${y}</div>
            <div class="library-detail-meta">${I.role||""} ${I.team||""}</div>
            <div class="library-detail-bio">${I.bio||""}</div>
            <div class="library-detail-tags">${(I.tags||[]).map(b=>`<span class="library-tag">${b}</span>`).join("")}</div>
            ${I.updated_by_label?`
                <div class="library-editor-info">
                    ÊúÄÁµÇÁ∑®ÈõÜ: <span class="library-editor-label">${I.updated_by_label}</span>
                    ¬∑ ${ht(I.updated_at)}
                </div>
            `:`<div class="library-detail-updated">Updated: ${ht(I.updated_at)}</div>`}
        `,o.style.display="block",await m(I.id)}async function m(I){i.innerHTML="";try{const y=await cf(I);y.length?y.forEach(b=>{const f=ee("div","library-note-item");f.innerHTML=`
                        <div class="library-note-header">
                            <span class="library-note-kind ${b.kind}">${b.kind}</span>
                            <span class="library-note-author">${b.author_label||"Unknown"} ¬∑ ${ht(b.created_at)}</span>
                        </div>
                        <div class="library-note-content">${b.content}</div>
                    `,i.appendChild(f)}):i.appendChild(ee("div","library-empty","„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"))}catch(y){Me(s,y)}}async function C(I){l=I;const y=await Mt(I);await p(y),g()}function g(){Bo(n,d,C,l)}t.querySelector("#note-submit").addEventListener("click",async I=>{if(I.preventDefault(),I.stopPropagation(),!l){B("Select a profile first","info");return}const y=t.querySelector("#note-content").value.trim();if(!y){B("„É°„É¢ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ","error");return}const b=await Va();if(!b){B("Ë°®Á§∫Âêç„ÅåÂøÖË¶Å„Åß„Åô","error");return}const f=t.querySelector("#note-kind").value;try{await df(l,{kind:f,content:y},b),t.querySelector("#note-content").value="",await m(l),B("„É°„É¢„ÇíÊäïÁ®ø„Åó„Åæ„Åó„Åü","success")}catch(v){Me(s,v)}}),fe(n,!0);try{if(d=await xo(),fe(n,!1),g(),l){const I=await Mt(l);await p(I)}else await p(null)}catch(I){fe(n,!1),Me(s,I)}zn({title:"„Éó„É≠„Éï„Ç£„Éº„É´Èñ≤Ë¶ß",contentEl:t})}let ne={state:"idle",peerActorId:null,callId:null,lastError:null},Qa=null;function Cf(e){Qa=e}function Je(){return{...ne}}function Vt(e,t={}){const n=ne.state;ne={state:e,peerActorId:t.peerActorId||null,callId:t.callId||null,lastError:t.error||null},console.log(`Call state: ${n} -> ${e}`,ne),Qa&&Qa(ne,n)}function wf(e,t){return ne.state!=="idle"?(console.warn("Cannot request call, not in idle state"),!1):(Vt("requesting",{peerActorId:e,callId:t}),!0)}function Af(e,t){return ne.state!=="idle"?(console.warn("Cannot receive call, not in idle state"),!1):(Vt("incoming",{peerActorId:e,callId:t}),!0)}function vf(){return ne.state!=="incoming"?(console.warn("Cannot accept call, not in incoming state"),!1):(Vt("connecting",{peerActorId:ne.peerActorId,callId:ne.callId}),!0)}function No(){return ne.state!=="connecting"&&ne.state!=="requesting"?(console.warn("Cannot connect call, not in connecting/requesting state"),!1):(Vt("in_call",{peerActorId:ne.peerActorId,callId:ne.callId}),!0)}function kf(){return Vt("idle"),!0}let G=null,Te=null,Xa=null,fl=null,eo=null,to=null;function Mf(e){fl=e?.onIceCandidate||null,eo=e?.onTrack||null,to=e?.onConnectionStateChange||null}async function gl(){const t=Tn()?.webrtc?.iceServers||[{urls:["stun:stun.cloudflare.com:3478"]}];return G=new RTCPeerConnection({iceServers:t}),G.onicecandidate=n=>{try{const a=n?.candidate;if(!a)return;console.log("[ICE] local candidate",a);const o=fl?.({candidate:a});o&&typeof o.catch=="function"&&o.catch(i=>{console.warn("[webrtc] onIceCandidate callback failed",i)})}catch(a){console.warn("[webrtc] onicecandidate handler failed",a)}},G.ontrack=n=>{Xa=n.streams[0],eo&&eo(Xa)},G.onconnectionstatechange=()=>{to&&to(G.connectionState)},G}async function ml(){try{return Te=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),Te}catch(e){throw console.error("Failed to get user media:",e),e}}async function pl(){!G||!Te||Te.getTracks().forEach(e=>{G.addTrack(e,Te)})}async function Ef(){if(!G)return null;const e=await G.createOffer();return await G.setLocalDescription(e),e}async function Sf(){if(!G)return null;const e=await G.createAnswer();return await G.setLocalDescription(e),e}async function Il(e){G&&await G.setRemoteDescription(new RTCSessionDescription(e))}async function yl(e){if(!G)return;const t=e?.candidate;if(!t)return;console.log("[ICE] remote candidate received",t);const n=typeof t=="string"?{candidate:t}:t;try{const a=t instanceof RTCIceCandidate?t:new RTCIceCandidate(n);await G.addIceCandidate(a)}catch(a){console.warn("[webrtc] addIceCandidate failed",a,n)}}function _f(){Te&&(Te.getTracks().forEach(e=>e.stop()),Te=null),G&&(G.close(),G=null),Xa=null}function Qt(){return G}function Lf(){return Te}let se=null;const Df=3e3,xf=2e4,xi=new Map,N={callId:null,deskId:null,role:null,peerActorId:null,status:"idle",pendingOffer:null,pendingCandidates:[],timers:{noAnswerTimeout:null}};function Qe(e,t,n){const a=Date.now(),o=xi.get(e)||0;a-o<Df||(xi.set(e,a),console.warn(t,n))}function Bf(e){if(typeof e!="string")return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch{return null}}function Tf(e){return e?typeof e=="string"?Bf(e):typeof e!="object"?null:e:null}function Nt(e,t,n,a=0){if(a>2)return;const o=Tf(e);o&&(n.has(o)||(n.add(o),t.push(o),Nt(o.payload,t,n,a+1),Nt(o.data,t,n,a+1),Nt(o.new,t,n,a+1),Nt(o.message,t,n,a+1)))}function Nf(e){if(!e)return null;const t=[];Nt(e,t,new Set);let n=null;for(const a of t){const o=typeof a.type=="string"?a.type:"";if(o.startsWith("call_"))return a;!n&&(o||a.callId||a.offer||a.answer||a.candidate)&&(n=a)}return n}function Xt(){N.timers.noAnswerTimeout&&(clearTimeout(N.timers.noAnswerTimeout),N.timers.noAnswerTimeout=null)}function Xe(e={}){Object.assign(N,e)}function Of(e){const t=Je();N.status==="idle"&&t.state==="idle"||ae(e)}async function bl(){if(!Qt()?.remoteDescription||N.pendingCandidates.length===0)return;const t=[...N.pendingCandidates];N.pendingCandidates=[];for(const n of t)try{await yl({candidate:n})}catch(a){console.warn("[call] failed to flush ICE candidate",a,n)}}function $f(){Xt(),N.timers.noAnswerTimeout=setTimeout(()=>{if(N.status==="idle")return;const e=N.callId,t=N.peerActorId;console.log("[call] hangup",{callId:e,reason:"no_answer_timeout"}),e&&t&&ze(t,{type:"call_hangup",payload:{callId:e,from:se,to:t,deskId:null,fromActorId:se,toActorId:t,reason:"no_answer_timeout",data:{reason:"no_answer_timeout"}}}).catch(n=>{console.warn("[call] failed to send timeout hangup",n)}),ae("no_answer_timeout")},xf)}function ae(e){console.warn("[call] reset",e),Xt(),N.pendingCandidates=[],N.pendingOffer=null;const t=Qt();if(t)try{t.onicecandidate=null,t.ontrack=null,t.onconnectionstatechange=null}catch(n){console.warn("[call] reset handler cleanup failed",n)}try{_f()}catch(n){console.warn("[call] reset closePeerConnection failed",n)}Xe({callId:null,deskId:null,role:null,peerActorId:null,status:"idle",pendingOffer:null,pendingCandidates:[]}),Je().state!=="idle"&&kf()}function Pf({actorId:e}){se=e}async function Rf(e){if(!e)return!1;(N.status!=="idle"||Je().state!=="idle")&&ae("start_call_while_busy");const t=Yl();if(!wf(e,t))return ae("start_call_request_failed"),!1;Xe({callId:t,deskId:null,role:"caller",peerActorId:e,status:"calling",pendingOffer:null,pendingCandidates:[]}),$f(),console.log("[call] start",{callId:t,deskId:null,to:e});try{await gl(),await ml(),await pl();const n=await Ef();return await ze(e,{type:"call_request",payload:{callId:t,from:se,to:e,deskId:null,fromActorId:se,toActorId:e,data:{offer:n},offer:n}}),!0}catch(n){return console.error("[call] start failed",n),ae("start_call_failed"),!1}}function Hf(e){const t=typeof e?.callId=="string"?e.callId:null,n=e?.from||e?.fromActorId||null,a=e?.data?.offer||e?.offer||null;if(!t||!n||!a)return Qe("call_request_invalid","[call] dropped event (missing callId/type)",e),!1;if(N.callId===t&&N.status==="ringing")return!0;if(N.status!=="idle"||Je().state!=="idle"){const o=Qt();if(!!o&&o.connectionState!=="closed")return ze(n,{type:"call_busy",payload:{callId:t,from:se,to:n,deskId:null,fromActorId:se,toActorId:n,data:{reason:"busy"},reason:"busy"}}).catch(s=>{console.warn("[call] failed to send busy signal",s)}),!1;Of("incoming_offer_when_busy")}return Af(n,t)?(Xe({callId:t,deskId:null,role:"callee",peerActorId:n,status:"ringing",pendingOffer:a,pendingCandidates:[]}),console.log("[call] incoming",{callId:t,deskId:null,from:n}),!0):(ze(n,{type:"call_busy",payload:{callId:t,from:se,to:n,deskId:null,fromActorId:se,toActorId:n,data:{reason:"busy"},reason:"busy"}}).catch(o=>{console.warn("[call] failed to send busy signal",o)}),!1)}async function Bi(){const e=Je(),t=N.pendingOffer,n=N.callId||e.callId,a=N.peerActorId||e.peerActorId;if(!t||!n||!a||e.state!=="incoming")return ae("accept_invalid_state"),!1;if(!vf())return ae("accept_state_transition_failed"),!1;Xe({status:"connecting"}),console.log("[call] accept",{callId:n});try{await gl(),await ml(),await pl(),await Il(t),await bl();const o=await Sf();return await ze(a,{type:"call_answer",payload:{callId:n,from:se,to:a,deskId:null,fromActorId:se,toActorId:a,data:{answer:o},answer:o}}),console.log("[call] send_answer",{callId:n}),No(),Xt(),Xe({status:"connected",pendingOffer:null}),!0}catch(o){return console.error("[call] accept failed",o),ae("accept_failed"),!1}}async function jf(e){const t=typeof e?.callId=="string"?e.callId:null,n=e?.data?.answer||e?.answer||null;if(!t||!n)return Qe("call_answer_invalid","[call] dropped event (missing callId/type)",e),!1;const a=Je();if(a.callId&&a.callId!==t||N.callId&&N.callId!==t)return!1;console.log("[call] recv_answer",{callId:t});try{return Qt()?(await Il(n),await bl(),No(),Xt(),Xe({status:"connected",pendingOffer:null}),!0):(ae("answer_without_peer_connection"),!1)}catch(o){return console.error("[call] failed to handle answer",o),ae("handle_answer_failed"),!1}}async function Wf(e){const t=typeof e?.callId=="string"?e.callId:null,n=e?.data?.candidate||e?.candidate||null;if(!t||!n)return Qe("call_ice_invalid","[call] dropped event (missing callId/type)",e),!1;const a=Je();if(a?.callId&&a.callId!==t||N.callId&&N.callId!==t)return!1;const o=Qt();if(!o||!o.remoteDescription)return N.pendingCandidates.push(n),!0;try{return await yl({candidate:n}),!0}catch(i){return console.warn("[signaling] handleIceCandidate failed",i,n),!1}}async function dn(e="hangup"){const t=Je(),n=N.peerActorId||t.peerActorId,a=N.callId||t.callId;return console.log("[call] hangup",{callId:a,reason:e}),n&&a&&await ze(n,{type:"call_hangup",payload:{callId:a,from:se,to:n,deskId:null,fromActorId:se,toActorId:n,reason:e,data:{reason:e}}}).catch(o=>{console.warn("[call] failed to send hangup",o)}),ae(e),!0}function zf(e){const t=typeof e?.callId=="string"?e.callId:null;if(!t)return Qe("call_hangup_invalid","[call] dropped event (missing callId/type)",e),!1;if(N.callId&&N.callId!==t)return!1;const n=e?.reason||e?.data?.reason||"remote_hangup";return console.log("[call] hangup",{callId:t,reason:n}),ae(n),!0}function Ff(e){const t=typeof e?.callId=="string"?e.callId:null;return t?N.callId&&N.callId!==t?!1:(ae("busy"),!0):(Qe("call_busy_invalid","[call] dropped event (missing callId/type)",e),!1)}function Gf(e){if(e){if(e==="connected"){Xt(),N.status!=="connected"&&(Xe({status:"connected"}),No());return}(e==="failed"||e==="disconnected"||e==="closed")&&ae(`connection_${e}`)}}function Jf(e){try{const t=Nf(e);if(!t)return Qe("invalid_msg","[call] dropped event (invalid msg)",e),!1;const n=typeof t.type=="string"?t.type:null,a=typeof t.callId=="string"?t.callId:null;if(!n||!a)return Qe("missing_type_or_callid","[call] dropped event (missing callId/type)",t),!1;switch(n){case"call_request":return Hf(t);case"call_answer":return jf(t).catch(o=>(console.warn("[signaling] handleCallAnswer failed",o),!1));case"call_ice_candidate":return Wf(t).catch(o=>(console.warn("[signaling] handleIceCandidate failed",o),!1));case"call_hangup":return zf(t);case"call_busy":return Ff(t);default:return console.warn("[call] unknown event type",n,t),!1}}catch(t){return console.error("[call] handleCallEvent failed",t,e),!1}}const u={ui:{drawer:"none",chatTab:"all",selected:null,modal:"none",themeId:"theme:day",timeMode:"day",toastQueue:[]},world:{areaId:"area:core",pos:{x:260,y:260},facing:"down",seatedDeskId:null,seatLockedDeskId:null,insideSpotId:null,forcedSeated:!1},me:{actorId:null,displayName:"",status:"online",avatar:{key:null,color:null}},queuedAction:null,rt:{people:new Map},call:{status:"idle",peerActorId:null,peerDisplayName:null,deskId:null,callId:null,muted:!1,startedAt:null},debug:{showSpots:!1,canMoveTo:null,lastPathResult:null}};let Ti=0,un=Date.now(),ma=null,fn=!1;const Uf={canMoveTo:null},qf=1500;let pa=null,Ia=0,st=null,lt=null,Ni=0;const Zf="vo:debugHudEnabled";function gn(e){const t=U();t&&(t.isMapLoading=e,t.isReady=!e)}function hl(){const e=Yt?.()||u.world.areaId||"area:core",t=Kf();try{return(ga||[]).map(a=>({...a,url:Li(a.file),src:Li(a.file)}))}catch(n){return console.warn("[BGM] resolveGardenTracks failed; continue without BGM",{activeArea:e,base:t,trackCount:Array.isArray(ga)?ga.length:0,err:n}),[]}}function Kf(){try{const e="/virtualoffice/";if(typeof e=="string"&&e.length)return e}catch{}return"/"}function ya(){(Yt?.()||u.world.areaId||"area:core")!=="area:garden"&&We()}function Cl(){return(typeof u.me.displayName=="string"?u.me.displayName.trim():"")||"anonymous"}function Ze(e={}){if(!u.me.actorId)return null;const t={actorId:u.me.actorId,displayName:Cl(),status:u.me.status,callStatus:u.call.status,pos:Ye(),facing:Mn(),avatarColor:u.me.avatar.color||null,areaId:u.world.areaId||null,seatedDeskId:u.world.seatedDeskId||null,seatLockedDeskId:u.world.seatLockedDeskId||null,location:Ii(u.world.insideSpotId,u.world.seatedDeskId,u.world.areaId,u.world.seatLockedDeskId),...e};return t.displayName=(typeof t.displayName=="string"?t.displayName.trim():"")||"anonymous",t.areaId=t.areaId||null,t.seatedDeskId=t.seatedDeskId||null,t.seatLockedDeskId=t.seatLockedDeskId||null,t.claimedByActorId=t.seatedDeskId?u.me.actorId:null,t.claimedByDisplayName=t.seatedDeskId?t.displayName:null,t.location||(t.location=Ii(u.world.insideSpotId,t.seatedDeskId,t.areaId,t.seatLockedDeskId)),t}function Yf(){try{return localStorage.getItem(Zf)==="1"}catch{return!1}}function Vf(){const e=_t()&&Yf();return document.body.classList.toggle("debug-hud-on",e),e}async function Qf(e,t){ma=e,window.DEBUG_COLLISION===void 0&&(window.DEBUG_COLLISION=!1);let n=Wi(Ql());oo(n),u.me.actorId=n,Pl(n);const a=nr();a&&(u.ui.themeId=a,Rs(a),eu(a)),u.ui.timeMode=or(),console.log("[TimeMode] restored from storage",{timeMode:u.ui.timeMode});const o=r=>{window.bootLog?window.bootLog(r):console.log("[BOOT-Main]",r)};o("app: init start");const i=setTimeout(()=>{window.showFatal&&window.showFatal(`Ëµ∑Âãï„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„ÅüÔºà10ÁßíÔºâ„ÄÇ
JSONË™≠Ëæº/JS‰æãÂ§ñ/„Éë„Çπ‰∏çÊï¥Âêà„ÅÆÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ„Åß„Åô„ÄÇ`)},1e4);try{o("app: calling loadMaps"),await Yo("core"),o("app: loadMaps done"),clearTimeout(i)}catch(r){throw clearTimeout(i),r}await ou();const s=document.getElementById("map-canvas");await hc(s),console.log("[Map] current meta.id",U()?.meta?.id),Wc(),Vf();const l=Qo("lobby");u.world.pos={...l},gn(!0),Nc(l,(r,h,A)=>{if(u.world.pos=r,u.world.facing=h,u.me.actorId){const x=Ze({pos:r,facing:h});x&&ot(x)}const k=hs(r.x,r.y);k?.id!==u.world.insideSpotId&&(u.world.insideSpotId=k?.id||null)}),gn(!1),Vc(r=>{u.ui.drawer=r,Xf()}),hd({getMyName:()=>u.me.displayName||"‰∏çÊòé",getMyActorId:()=>u.me.actorId,getPersonName:r=>ve().get(r)?.displayName||r?.slice?.(0,6)||"‰∏çÊòé",getPeople:()=>ve()}),Rd({warpCallback:r=>{yi(r.pos),Gt(),B(`${r.displayName} „ÅÆËøë„Åè„Å´„ÉØ„Éº„Éó„Åó„Åæ„Åó„Åü`)},pokeCallback:r=>{$i(r.actorId),B(`${r.displayName} „Çí„Å§„Å§„Åç„Åæ„Åó„Åü`)},dmCallback:r=>{mn("chat"),_n(r)}}),zd({warpCallback:r=>{yi(r.pos),Gt(),B(`${r.displayName} „ÅÆËøë„Åè„Å´„ÉØ„Éº„Éó„Åó„Åæ„Åó„Åü`)}}),Qd({nameChangeCallback:async r=>{try{if(await Cs(r,u.me.actorId)){B("„Åì„ÅÆÂêçÂâç„ÅØÊó¢„Å´‰Ωø„Çè„Çå„Å¶„ÅÑ„Åæ„Åô","error");return}await mo({sessionId:u.me.actorId,displayName:r}),u.me.displayName=r,zi(r),Sn(r),B("ÂêçÂâç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü","success")}catch{B("Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}},statusChangeCallback:r=>{u.me.status=r,hi(r);const h=Ze({status:r});h&&ot(h)},logoutCallback:async()=>{await Yc(),await T().auth.signOut(),Go(),window.location.reload()},clearPasswordCallback:()=>{Go(),B("‰øùÂ≠ò„Åï„Çå„Åü„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü","success")}});try{Br()}catch(r){console.error("[MAIN] companion init failed (non-fatal):",r),window.__COMPANION_DISABLED__=!0}const d=document.getElementById("map-menu"),p=document.getElementById("map-menu-btn");document.getElementById("map-menu-label");const m=document.getElementById("map-dropdown"),C={"area:core":"„Ç™„Éï„Ç£„Çπ","area:garden":"„Ç¨„Éº„Éá„É≥","area:library":"„É©„Ç§„Éñ„É©„É™"};function g(r){m?.querySelectorAll(".nav-dropdown-item")?.forEach(A=>{A.classList.toggle("active",A.dataset.area===r)})}function I(){d?.classList.remove("open")}p&&p.addEventListener("click",r=>{r.stopPropagation(),d?.classList.toggle("open")}),m&&m.querySelectorAll(".nav-dropdown-item").forEach(r=>{r.addEventListener("click",h=>{h.stopPropagation();const A=r.dataset.area;if(!A||A===u.world.areaId){I();return}g(A),I(),en(A)})}),document.addEventListener("click",()=>{I()}),g(u.world.areaId);function y(){const r=Lf();r&&(r.getAudioTracks().forEach(h=>{h.enabled=!h.enabled}),u.call.muted=!u.call.muted,O())}function b(){const r=Ze();r&&ot(r)}function f(r){if(!r?.id)return;const h=u.world.seatLockedDeskId;h&&h!==r.id&&_(Xo(h)),u.world.seatedDeskId&&u.world.seatedDeskId!==r.id&&(u.world.seatLockedDeskId=null,u.world.forcedSeated=!1,at(!1),He()),u.world.seatedDeskId=r.id,b(),O()}function v(r){if(!r?.id)return;u.world.seatedDeskId=r.id,u.world.seatLockedDeskId=r.id,u.world.forcedSeated=!1,He(),at(!0);const h=r.posAbs||r.pos||null;h&&ct(h.x,h.y),b(),O()}function _(r){const h=u.world.seatLockedDeskId;if(!h)return;const A=r||Xo(h);He(),at(!1),u.world.seatLockedDeskId=null,u.world.forcedSeated=!1;const k=A?.standPointAbs||A?.standPoint||A?.posAbs||A?.pos||null;k&&ct(k.x,k.y),b(),O()}function P(r){const h=r?.id||u.world.seatedDeskId;!h||u.world.seatedDeskId!==h||(u.world.seatLockedDeskId===h&&_(r),u.world.seatedDeskId=null,b(),O())}au({openZoom:r=>{window.open(r,"_blank")},openRoomChat:r=>{mn("chat")},claimDesk:r=>{f(r)},seatDesk:r=>{v(r)},leaveSeat:r=>{_(r)},unclaimDesk:r=>{P(r)},poke:r=>{$i(r.actorId),B(`${r.displayName} „Çí„Å§„Å§„Åç„Åæ„Åó„Åü`)},dm:r=>{mn("chat"),_n(r)},call:async r=>{r?.actorId&&(cn(),await Rf(r.actorId),O())},callAccept:async()=>{cn(),await Bi(),O()},callReject:async()=>{await dn("declined"),O()},callCancel:async()=>{await dn("cancelled"),O()},callMute:()=>{y(),O()},callEnd:async()=>{await dn("hangup"),O()}});function M(r){if(!r)return null;const h=ve();for(const[A,k]of h)if((k.seatLockedDeskId||k.seatedDeskId)===r&&A!==u.me.actorId)return k;return null}function E(r,h=null){if(!r)return null;if(u.world.seatedDeskId===r)return Cl();const A=h||M(r);return A&&(A.claimedByDisplayName||A.displayName)||null}function $(r){if(r?.kind!=="desk")return{};const h=u.world.seatedDeskId===r.data.id,A=u.world.seatLockedDeskId===r.data.id,k=h?null:M(r.data.id),x=E(r.data.id,k);return{claimed:h,seatLocked:A,occupant:k,claimedByDisplayName:x,callState:u.call,forced:u.world.forcedSeated===!0&&A}}function O(){const r=u.ui.selected;if(r?.kind!=="desk")return;const h=u.world.seatedDeskId===r.data.id,A=u.world.seatLockedDeskId===r.data.id,k=h?null:M(r.data.id),x=E(r.data.id,k);ru(r.data,h,A,k,u.call,u.world.forcedSeated===!0&&A,x)}tu({acceptCallback:async()=>{cn(),await Bi()},rejectCallback:async()=>{await dn("declined")}}),du(),Eo(),ua(u.world.areaId),Hu(),Po(u.world.areaId),nf(),cl(),Au({onDebugHudToggle:r=>{const h=r===!0&&_t();document.body.classList.toggle("debug-hud-on",h)},getDebugHudEnabled:()=>document.body.classList.contains("debug-hud-on")}),yu(),bu();try{const h=localStorage.getItem("ambientPreset:garden")||uo;us(h)}catch(r){console.warn("[Ambient] preset init failed",r)}function L(r){switch(r){case"requesting":case"connecting":return"calling";case"incoming":return"ringing";case"in_call":return"in_call";default:return"idle"}}Cf((r,h)=>{const A=u.call.status,k=L(r?.state),x=k==="in_call",V=A==="in_call",W=r?.peerActorId||null,Q=W?ve().get(W):null;if(u.call={status:k,peerActorId:W,peerDisplayName:Q?.displayName||null,deskId:null,callId:r?.callId||null,muted:x?u.call.muted:!1,startedAt:x?V?u.call.startedAt:Date.now():null},k==="ringing"){const et=W?ve().get(W):null;nu(et?.displayName||"‰∏çÊòé„Å™Áõ∏Êâã")}else A==="ringing"&&k!=="ringing"&&za();r?.state==="error"&&B(r?.lastError||"ÈÄöË©±„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error");const _e=Ze({callStatus:u.call.status});_e&&ot(_e),O()}),Mf({onIceCandidate:r=>{const h=r?.candidate;h&&u.call.peerActorId&&u.call.callId&&ze(u.call.peerActorId,{type:"call_ice_candidate",payload:{callId:u.call.callId,from:u.me.actorId,to:u.call.peerActorId,deskId:null,fromActorId:u.me.actorId,toActorId:u.call.peerActorId,data:{candidate:h},candidate:h}}).catch(A=>{console.warn("[main] failed to send ICE candidate",A)})},onTrack:r=>{const h=new Audio;h.srcObject=r,h.play()},onConnectionStateChange:r=>{Gf(r),console.log("WebRTC connection state:",r)}}),Pf({actorId:u.me.actorId}),Uc({supabase:T(),me:u.me,onPresenceChange:r=>{if(u.rt.people=new Map,Object.entries(r).forEach(([h,A])=>{if(A&&A.length>0){const k=A[0];k.actorId!==u.me.actorId&&u.rt.people.set(k.actorId,k)}}),Hd(r),u.call.peerActorId){const h=ve().get(u.call.peerActorId);u.call.peerDisplayName=h?.displayName||u.call.peerDisplayName}O(),Jd()},onEvent:r=>{try{eg(r)}catch(h){console.error("[realtime] event handler failed",h,r)}}}),window.addEventListener("keydown",r=>{if(r.code==="Enter"&&(document.activeElement===document.getElementById("chat-input")||document.getElementById("chat-input")?.focus()),r.code==="F3"&&(r.preventDefault(),u.debug.showSpots=!u.debug.showSpots,xc(u.debug.showSpots),console.log("[Debug] Spots overlay:",u.debug.showSpots?"ON":"OFF")),r.key.toLowerCase()==="e"&&st){const h=Date.now();if(st===pa&&h-Ia<qf)return;const A=Sa(st);A?.action&&(r.preventDefault(),pa=st,Ia=h,Oi(A.action,A))}}),Kc({myActorId:u.me.actorId});function q(r){return r.closest("#menubar, #drawer, #modal-overlay, #context-panel, button, input, textarea, a, .toast, .spot-modal-overlay")}function Z(){return lt||(lt=document.createElement("div"),lt.id="interact-hint",document.getElementById("app").appendChild(lt),lt)}function Lt(r){const h=Z();if(!r){h.classList.remove("visible"),h.textContent="";return}const A=window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;h.textContent=A?"Tap: Open":"E: Open",h.classList.add("visible")}function vl(r){return r?.interactPoint?r.interactPoint:r?.bounds?{x:r.bounds.x+r.bounds.w/2,y:r.bounds.y+r.bounds.h/2}:r?.x!==void 0&&r?.y!==void 0?{x:r.x,y:r.y}:null}function kl(r){const h=Nn();let A=null,k=1/0;return h.forEach(x=>{if(!x?.action)return;const V=vl(x);if(!V)return;const W=r.x-V.x,Q=r.y-V.y,_e=Math.sqrt(W*W+Q*Q),et=x.proximity||90;_e<=et&&_e<k&&(A=x,k=_e)}),A}const Fn=document.getElementById("canvas-container");s.style.touchAction="none",Fn.style.touchAction="none",Fn.addEventListener("pointerdown",r=>{if(r.button!==0||q(r.target))return;cn(),r.preventDefault(),un=Date.now();const h=s.getBoundingClientRect(),A=r.clientX-h.left,k=r.clientY-h.top,x=xa(A,k);r.shiftKey&&console.log("[COORD]",{x:Math.round(x.x),y:Math.round(x.y)}),console.log("[MOVE] click received",{claimedDeskId:u.world.seatedDeskId,seatLockedDeskId:u.world.seatLockedDeskId,forcedSeated:u.world.forcedSeated===!0,inputTarget:na(),isMoving:ln()});const V=bs(x.x,x.y);console.log("[Click]",{screenX:A,screenY:k,worldX:Math.round(x.x),worldY:Math.round(x.y),hits:V.map(Q=>`${Q.id}(P:${Q.priority||0})`)});const W=Hc(x.x,x.y);W.kind==="spot"&&W.data?.action?Oi(W.data.action,W.data):W.kind?(u.ui.selected=W,iu(W,$(W)),It()):(u.ui.selected=null,Dn(),It(),ys(x.x,x.y),xl(x.x,x.y))}),Fn.addEventListener("wheel",r=>{if(r.preventDefault(),q(r.target))return;un=Date.now();const h=s.getBoundingClientRect(),A=r.clientX-h.left,k=r.clientY-h.top;Ac(r.deltaY,A,k)},{passive:!1});function Ml(r){return r==="area:garden"?"./assets/maps/garden_day.png":r==="area:library"?"./assets/maps/library.png":"./assets/maps/map.png"}function El(r){return r==="area:garden"?"garden":"lobby"}function Sl(r){return r==="area:garden"?"garden":r==="area:library"?"library":"core"}function $o(r){return hl().find(h=>h.id===r)||null}function Po(r){if(ua(r),r==="area:garden"){const h=localStorage.getItem("bgm:garden:selected"),A=h&&h.length?h:Ka;if(A==="none"){We();return}const k=$o(A)||$o(Ka);k&&So(k,{areaId:r})}else We();ya()}async function en(r){try{r!=="area:garden"&&(ua(r),We()),fn=!0,gn(!0),u.ui.selected=null,u.queuedAction=null,u.world.insideSpotId=null,Dn(),It(),yn(),bn(),hn(),st=null,pa=null,Ia=0,Lt(null),He(),u.world.seatedDeskId=null,u.world.seatLockedDeskId=null,u.world.forcedSeated=!1,at(!1);const h=Sl(r);await Yo(h),Hr(r),u.world.areaId=r,ya();const A=El(r),k=Qo(A);ct(k.x,k.y),fi(k.x,k.y,16.67);const x=Ml(r);await gs(x),Po(r),g(r),B(`„Ç®„É™„Ç¢„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åó„Åü: ${C[r]||r}`,"success"),console.log("[Area] switched",{areaId:r,spawnName:A,sp:k,bg:x})}catch(h){console.error("[Area] switch failed",h),B("„Ç®„É™„Ç¢Âàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}finally{gn(!1),fn=!1}}document.addEventListener("keydown",r=>{un=Date.now();const h=(document.activeElement?.tagName||"").toLowerCase();if(!(h==="input"||h==="textarea"||h==="select"||document.activeElement?.isContentEditable)){if(r.key,r.key,r.key,r.key,r.key.toLowerCase(),r.key.toLowerCase(),r.key.toLowerCase(),r.key.toLowerCase(),r.key==="F9"&&(window.DEBUG_COLLISION=!window.DEBUG_COLLISION,console.log("[DEBUG] Collision Debug",window.DEBUG_COLLISION?"ON":"OFF")),r.key==="F6"){if(u.world.forcedSeated)u.world.seatedDeskId=null,u.world.seatLockedDeskId=null,u.world.forcedSeated=!1,at(!1),B("Âº∑Âà∂Â∫ßÂ∏≠Âõ∫ÂÆö„ÇíËß£Èô§„Åó„Åæ„Åó„Åü","info");else{const x=Ye(),V=Rc(x.x,x.y);if(V){u.world.seatedDeskId=V.id,u.world.seatLockedDeskId=V.id,u.world.forcedSeated=!0,He(),at(!0);const W=V.posAbs||V.pos;W&&ct(W.x,W.y),B(`Â∫ßÂ∏≠Âõ∫ÂÆö: ${V.id}ÔºàÂº∑Âà∂Ôºâ`,"info")}else B("Ëøë„Åè„Å´„Éá„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì","error")}O()}if(r.key.toLowerCase()==="g"&&en("area:garden"),r.key.toLowerCase()==="o"&&en("area:core"),r.key.toLowerCase()==="l"){if(r.repeat)return;const k=u.world.areaId==="area:library"?"area:core":"area:library";if(!U(k)){console.warn("[Area] missing id:",k);return}en(k)}}}),document.addEventListener("keyup",r=>{r.key,r.key,r.key,r.key,r.key.toLowerCase(),r.key.toLowerCase(),r.key.toLowerCase(),r.key.toLowerCase()});let Ro=0,Gn={x:0,y:0};const _l=200,Ll=6;let Dt=null,Jn=0;const Dl=500;function xl(r,h){Dt={x:r,y:h},Jn=Date.now()}function Un(r){const h=r-Ti;if(Ti=r,fn||U()?.isMapLoading||!U()?.isReady){Lt(null),requestAnimationFrame(Un);return}Oc(h);const A=Ye(),k=na(),x=ln(),V=k?k.x-A.x:0,W=k?k.y-A.y:0;dc(u.me.actorId||"me",x,V,W,h),fi(A.x,A.y,h);const Q=Date.now();u.call.status==="in_call"&&u.ui.selected?.kind==="desk"&&Q-Ni>=1e3&&(O(),Ni=Q);const _e=Math.sqrt(Math.pow(A.x-Gn.x,2)+Math.pow(A.y-Gn.y,2));if((_e>Ll||Q-Ro>_l)&&_e>.1){const F=Ze({pos:A,facing:Mn()});F&&ot(F),Gn={...A},Ro=Q}if(ma.presence?.awayAfterMs&&Q-un>ma.presence.awayAfterMs&&u.me.status==="online"){u.me.status="away",hi("away");const xt=Ze({status:"away"});xt&&ot(xt)}Dt&&Q-Jn>Dl&&(Dt=null);const et=kl(A);st=et?.id||null,Lt(et),ya(),u.world.areaId!=="area:garden"&&ll().isPlaying&&We();const Bl=Array.from(u.rt.people.values()).map(F=>({pos:F.pos||{x:0,y:0},displayName:F.displayName||"‰∏çÊòé",status:F.status||"online",callStatus:F.callStatus||"idle",avatarColor:F.avatarColor,actorId:F.actorId}));if(fn||kc(A,Mn(),Bl,{...u.me,callStatus:u.call.status},Dt,Jn,h,u.world.areaId,u.ui.timeMode,ve()),u.queuedAction){const F=Sa(u.queuedAction.spotId);if(F){const xt=F.interactPoint||{x:F.bounds?F.bounds.x+F.bounds.w/2:F.x||0,y:F.bounds?F.bounds.y+F.bounds.h/2:F.y||0},Ho=Ye(),jo=Ho.x-xt.x,Wo=Ho.y-xt.y,Nl=Math.sqrt(jo*jo+Wo*Wo),Ol=F.proximity||90;Nl<=Ol?(u.queuedAction.actionType==="openAdmin"&&el(),u.queuedAction=null):ln()||(u.queuedAction=null)}else u.queuedAction=null}const Tl=Dc();u.debug.lastPathResult=Is??null,zc({pos:A,target:na(),camera:Tl,dt:h,isMoving:ln(),lastTickMoveAt:Q,lastRenderAt:Q,lastClickWorld:Dt,canMoveTo:Uf.canMoveTo,pathReason:u.debug.lastPathResult?.reason}),requestAnimationFrame(Un)}requestAnimationFrame(Un)}function Xf(){const e=document.getElementById("drawer-overlay"),t=document.getElementById("drawer"),n=document.getElementById("drawer-title"),a=u.ui.drawer!=="none",o=u.ui.drawer==="chat";if(document.body.classList.toggle("chat-open",o),e.classList.toggle("visible",a),t.classList.toggle("open",a),document.querySelectorAll('[id^="drawer-"]').forEach(i=>{i.id!=="drawer-overlay"&&i.id!=="drawer"&&i.id!=="drawer-title"&&i.id!=="drawer-close"&&i.classList.add("hidden")}),u.ui.drawer!=="none"){const i=document.getElementById(`drawer-${u.ui.drawer}`);i&&i.classList.remove("hidden");const s={chat:"„ÉÅ„É£„ÉÉ„Éà",people:"„É°„É≥„Éê„Éº",search:"Ê§úÁ¥¢",settings:"Ë®≠ÂÆö"};n.textContent=s[u.ui.drawer]||"„Éâ„É≠„ÉØ„Éº"}Cd(o),document.getElementById("drawer-close")?.addEventListener("click",()=>{Gt()}),e.addEventListener("click",()=>{Gt()})}function eg(e){const t=typeof e?.type=="string"?e.type:null;if(!t){console.warn("[event] dropped invalid event",e);return}e?.payload;const n=e?.fromActorId,a=e?.fromDisplayName;if(t.startsWith("call_")){try{const o=Jf(e);o&&typeof o.catch=="function"&&o.catch(i=>{console.error("[call] handleCallEvent promise rejected",i,e)})}catch(o){console.error("[call] handleCallEvent failed",o,e)}return}if(t==="poke"){const o=ve().get(n);nd(o?.displayName||a||"Someone")}}function Oi(e,t){if(!(!e||!e.type))switch(e.type){case"openToolLinks":const a=jn()?.items?.map(g=>({label:g.title,url:g.url,desc:g.desc}))||e.links||[];uu(e.title||"Tools",a);break;case"openBulletin":const o=Wn();fu(e.title||"Bulletin",o?.items||[]);break;case"openBgmSelector":{if(u.world.areaId!=="area:garden"){console.log("[BGM] ignored openBgmSelector outside garden",{areaId:u.world.areaId});return}const g=localStorage.getItem("bgm:garden:selected"),I=g&&g.length?g:Ka;Za({tracks:hl(),selectedId:I,title:"„Ç¨„Éº„Éá„É≥BGM"});break}case"openAmbientParticles":rl();break;case"openProfileEditor":yf();break;case"openDirectorySearch":bf();break;case"openRecentUpdates":hf();break;case"openProfileViewer":To();break;case"openAdmin":const i=t?.proximity||90,s=Ye();let l,d;t.interactPoint?(l=t.interactPoint.x,d=t.interactPoint.y):t.bounds?(l=t.bounds.x+t.bounds.w/2,d=t.bounds.y+t.bounds.h/2):(l=t.x||320,d=t.y||85);const p=s.x-l,m=s.y-d,C=Math.sqrt(p*p+m*m);C<=i?el():(console.log("[Main] Admin spot far, auto-approaching...",C),ys(l,d),u.queuedAction={spotId:t.id,actionType:e.type});break;case"cycleTimeMode":if(u.world.areaId!=="area:garden"){console.log("[Temizu] ignored cycleTimeMode outside garden",{areaId:u.world.areaId});return}{const g=u.world.areaId,I=u.ui.timeMode||"day",y=Yr(I);u.ui.timeMode=y,ir(y),console.log("[Temizu] cycleTimeMode",{areaId:g,prev:I,next:y}),B(`ÊôÇÈñì: ${fs(y).label.toLowerCase()}`,"success")}break;default:console.log("[Main] Unknown spot action type:",e.type)}}async function $i(e){await ze(e,{type:"poke",payload:{}})}async function tg(){const e=await Jc(u.me.actorId),t=tr();return e?(u.me.displayName=e.display_name,Sn(e.display_name),Wa(e.display_name),!0):t&&!await Cs(t,u.me.actorId)?(await mo({sessionId:u.me.actorId,displayName:t}),u.me.displayName=t,Sn(t),Wa(t),!0):!1}async function ng(e){let t=!1;try{await mo({sessionId:u.me.actorId,displayName:e})}catch(n){const a=typeof n?.message=="string"?n.message:"";if(n?.code==="23505"||a.includes("duplicate")||a.includes("unique"))t=!0,console.warn("[Nameplate] Duplicate detected; continuing without blocking boot.",n);else throw n}u.me.displayName=e,zi(e),Sn(e),Wa(e),t&&console.warn("[Nameplate] Duplicate prevented remote save; local name retained.")}async function ag(){const e=Ye(),t=Ze({pos:e,facing:Mn(),avatarColor:u.me.avatar.color||null});t&&await qc({presenceChannelKey:"presence:office",initialState:t})}window.bootLog=function(e){console.log("[BOOT]",e);const t=document.getElementById("bootLog");t&&(t.textContent+=`${e}
`)};window.showFatal=function(e){console.error("[FATAL]",e);try{Ea()}catch{}const t=document.getElementById("fatalError");t?(t.style.display="block",t.textContent=`Ëµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:
${e}

DevTools Console„ÇÇÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`):alert(e);const n=document.getElementById("loading-screen");if(n){n.classList.remove("hidden");const a=n.querySelector(".loading-spinner");a&&(a.style.display="none");const o=n.querySelector(".loading-text");o&&(o.style.display="none")}};function Bn(e){const t=String(e||"").toLowerCase();return t?t.includes("/companion/")||t.includes("companion/voicechat")||t.includes("dialogue.js")||t.includes("tts.js"):!1}window.addEventListener("error",e=>{if(Bn(e?.message)||Bn(e?.filename)){console.error("[BOOT] companion runtime error (non-fatal):",{message:e?.message,filename:e?.filename,lineno:e?.lineno,colno:e?.colno});return}window.showFatal(`JS Error: ${e.message}
${e.filename}:${e.lineno}:${e.colno}`)});window.addEventListener("unhandledrejection",e=>{if(Bn(e?.reason?.message)||Bn(e?.reason)){console.error("[BOOT] companion promise rejection (non-fatal):",e?.reason);return}const t=e.reason?.message||String(e.reason);window.showFatal(`Unhandled Promise Rejection: ${t}`)});async function Pi(){window.bootLog("Virtual Office - Booting...");try{window.bootLog("Loading config...");const e=await Ri();window.bootLog("Initializing Supabase..."),await $l(),window.bootLog("Checking session...");const t=await Rl();t?(window.bootLog("Session found, proceeding..."),await wl(e,t)):(window.bootLog("No session, showing login..."),og(e))}catch(e){console.error("Boot failed:",e),window.showFatal(`Ëµ∑Âãï„Ç®„É©„Éº:
${e.message||e}`)}}function og(e){Fl(async(n,a)=>{try{const{session:o}=await Hl(n);a&&er(n),Jl(),await wl(e,o)}catch(o){console.error("Login flow failed:",o),showError(`„É≠„Ç∞„Ç§„É≥Âæå„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:
${o.message||o}`)}});const t=Xl();if(t){if(!e){window.showFatal("Config not loaded");return}Ul(t)}Oo(),Gl()}async function wl(e,t){try{window.bootLog("Login successful"),no("„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„Åø‰∏≠..."),window.bootLog("Initializing app logic..."),await Qf(e,t),window.bootLog("Checking nameplate..."),no("ÂêçÊú≠„ÇíÁ¢∫Ë™ç‰∏≠..."),await tg()?await Al():(Oo(),ig())}catch(n){console.error("Proceed failed:",n),window.showFatal(`ÂàùÊúüÂåñ„Ç®„É©„Éº:
${n.message||n}`)}}function ig(){ql(async e=>{try{await ng(e),Kl(),await Al()}catch(t){console.error("Nameplate flow failed:",t),window.showFatal(`ÂêçÊú≠Ë®≠ÂÆö„Ç®„É©„Éº:
${t.message||t}`)}}),Zl()}async function Al(){no("Êé•Á∂ö‰∏≠...");try{window.bootLog("Starting presence..."),await ag(),Oo(),sg(),window.bootLog("Virtual Office - Ready!"),console.log("Virtual Office - Ready!")}catch(e){console.error("Finish boot failed:",e),window.showFatal(`Êé•Á∂ö„Ç®„É©„Éº:
${e.message||e}`)}}function no(e="Loading..."){const t=document.getElementById("loading-screen"),n=t?.querySelector(".loading-text");t&&t.classList.remove("hidden"),n&&(n.textContent=e)}function Oo(){const e=document.getElementById("loading-screen");e&&e.classList.add("hidden")}function sg(){document.getElementById("menubar")?.classList.remove("hidden"),document.getElementById("main")?.classList.remove("hidden")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pi):Pi();
