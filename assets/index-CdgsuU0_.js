(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();let Ce=null,qt=null;async function fs(){if(qt)return qt;const e=await fetch("./data/config/app.config.json");if(!e.ok)throw new Error("Failed to load config");return qt=await e.json(),qt}function Vn(){return qt}async function dr(){if(Ce)return Ce;const e=await fs();return Ce=supabase.createClient(e.supabase.url,e.supabase.anonKey),Ce}function R(){return Ce}function ur(e){if(!Ce)return;const t=e?String(e):"";try{Ce.rest?.headers&&(Ce.rest.headers["x-actor-id"]=t)}catch(n){console.warn("[supabase] failed to set x-actor-id on rest headers",n)}try{if(Ce.realtime){const n=Ce.realtime.headers||{};Ce.realtime.headers={...n,"x-actor-id":t}}}catch(n){console.warn("[supabase] failed to set x-actor-id on realtime headers",n)}}async function fr(){const e=R();if(!e)return null;const{data:{session:t}}=await e.auth.getSession();return t}async function gr(e){const t=R(),n=Vn(),{data:a,error:o}=await t.auth.signInWithPassword({email:n.supabase.sharedEmail,password:e});if(o)throw o;return a}function mr(e){if(!e||typeof e!="string")return{valid:!1,error:"ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"};const t=e.trim();return t.length===0?{valid:!1,error:"ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}:t.length>20?{valid:!1,error:"ÂêçÂâç„ÅØ20ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}:/[<>\"\'&]/.test(t)?{valid:!1,error:"‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô"}:{valid:!0,value:t}}function pr(e){return!e||typeof e!="string"?{valid:!1,error:"„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}:e.length===0?{valid:!1,error:"„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}:{valid:!0,value:e}}function Ir(e){if(!e||typeof e!="string")return{valid:!1};const t=e.trim();return t.length===0||t.length>500?{valid:!1}:{valid:!0,value:t}}let Pa=null;function br(e){Pa=e;const t=document.getElementById("password-submit"),n=document.getElementById("password-input");t.addEventListener("click",pi),n.addEventListener("keypress",a=>{a.key==="Enter"&&pi()})}async function pi(){const e=document.getElementById("password-input"),t=document.getElementById("password-save"),n=document.getElementById("password-error"),a=document.getElementById("password-submit");n.classList.add("hidden"),n.textContent="";const o=pr(e.value);if(!o.valid){n.textContent=o.error,n.classList.remove("hidden");return}a.disabled=!0,a.textContent="„É≠„Ç∞„Ç§„É≥‰∏≠...";try{Pa&&await Pa(o.value,t.checked)}catch(i){let s="„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü";i.message&&i.message.includes("Invalid login")?s="„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô":i.message&&i.message.includes("network")&&(s="ÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"),n.textContent=s,n.classList.remove("hidden")}finally{a.disabled=!1,a.textContent="„É≠„Ç∞„Ç§„É≥"}}function yr(){const e=document.getElementById("modal-overlay"),t=document.getElementById("modal-password"),n=document.getElementById("modal-nameplate"),a=document.getElementById("modal-incoming-call");n?.classList.add("hidden"),a?.classList.add("hidden"),t.classList.remove("hidden"),e.classList.add("visible"),document.getElementById("password-input")?.focus()}function hr(){const e=document.getElementById("modal-overlay");document.getElementById("modal-password").classList.add("hidden"),e.classList.remove("visible")}function vr(e){const t=document.getElementById("password-input"),n=document.getElementById("password-save");t&&e&&(t.value=e),n&&e&&(n.checked=!0)}let Ha=null;function wr(e){Ha=e;const t=document.getElementById("nameplate-submit"),n=document.getElementById("nameplate-input");t.addEventListener("click",Ii),n.addEventListener("keypress",a=>{a.key==="Enter"&&Ii()})}async function Ii(){const e=document.getElementById("nameplate-input"),t=document.getElementById("nameplate-error"),n=document.getElementById("nameplate-submit");t.classList.add("hidden"),t.textContent="";const a=mr(e.value);if(!a.valid){t.textContent=a.error,t.classList.remove("hidden");return}n.disabled=!0,n.textContent="‰øùÂ≠ò‰∏≠...";try{Ha&&await Ha(a.value)}catch(o){let i="‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü";o.message&&o.message.includes("duplicate")&&(i="„Åì„ÅÆÂêçÂâç„ÅØÊó¢„Å´‰Ωø„Çè„Çå„Å¶„ÅÑ„Åæ„Åô"),t.textContent=i,t.classList.remove("hidden")}finally{n.disabled=!1,n.textContent="‰øùÂ≠ò"}}function Cr(e=""){const t=document.getElementById("modal-overlay"),n=document.getElementById("modal-nameplate"),a=document.getElementById("modal-password"),o=document.getElementById("modal-incoming-call");a?.classList.add("hidden"),o?.classList.add("hidden"),n.classList.remove("hidden"),t.classList.add("visible");const i=document.getElementById("nameplate-input");i&&e&&(i.value=e),i?.focus()}function Ar(){const e=document.getElementById("modal-overlay");document.getElementById("modal-nameplate").classList.add("hidden"),e.classList.remove("visible")}function pt(){return Math.floor(Math.random()*4294967295).toString(16).padStart(8,"0")}function Lo(){const e=globalThis?.crypto;if(e&&typeof e.randomUUID=="function")try{return e.randomUUID()}catch{}if(e&&typeof e.getRandomValues=="function"){const t=new Uint8Array(16);e.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128;const n=[...t].map(a=>a.toString(16).padStart(2,"0")).join("");return`${n.slice(0,8)}-${n.slice(8,12)}-${n.slice(12,16)}-${n.slice(16,20)}-${n.slice(20)}`}return`${pt()}-${pt().slice(0,4)}-${pt().slice(0,4)}-${pt().slice(0,4)}-${pt()}${pt()}`}function gs(){return`sess_${Lo()}`}function gn(){return Lo()}function kr(){return`call_${Lo()}`}const Ee={SESSION_ID:"office.session_id",SHARED_PASSWORD:"office.shared_password",DISPLAY_NAME:"office.display_name",THEME_ID:"office.theme_id",TIME_MODE:"vo:timeMode"},Sr=/^sess_[0-9a-fA-F-]{10,}$/;function ms(e){return typeof e=="string"&&Sr.test(e)?e:gs()}function Er(){const e=localStorage.getItem(Ee.SESSION_ID);return ps(e)}function _o(e){localStorage.setItem(Ee.SESSION_ID,ms(e))}function ps(e){const t=ms(e);return t!==e&&_o(t),t}function Mr(){return localStorage.getItem(Ee.SHARED_PASSWORD)}function Lr(e){localStorage.setItem(Ee.SHARED_PASSWORD,e)}function bi(){localStorage.removeItem(Ee.SHARED_PASSWORD)}function _r(){return localStorage.getItem(Ee.DISPLAY_NAME)}function Is(e){localStorage.setItem(Ee.DISPLAY_NAME,e)}function Dr(){return localStorage.getItem(Ee.THEME_ID)}function xr(e){localStorage.setItem(Ee.THEME_ID,e)}function Br(){const e=localStorage.getItem(Ee.TIME_MODE);return e==="day"||e==="dusk"||e==="night"?e:"day"}function Tr(e){e!=="day"&&e!=="dusk"&&e!=="night"||localStorage.setItem(Ee.TIME_MODE,e)}const Nr=["„ÅÜ„Çì„ÄÅËÅû„ÅÑ„Å¶„Çã„Çà„ÄÇÁ∂ö„Åë„Å¶„ÄÇ","„Å™„Çã„Åª„Å©„ÄÇÊ¨°„ÅÆ‰∏ÄÊâã„Çí‰∏ÄÁ∑í„Å´ËÄÉ„Åà„Çà„ÅÜ„ÄÇ","„ÅÑ„ÅÑË¶ñÁÇπ„Å†„Å≠„ÄÇ„ÇÇ„ÅÜÂ∞ë„ÅóË©≥„Åó„ÅèÊïô„Åà„Å¶„ÄÇ","‰∫ÜËß£„ÄÇÂøÖË¶Å„Å™„ÇâË¶ÅÁÇπ„Å†„ÅëÁü≠„Åè„Åæ„Å®„ÇÅ„Çã„Çà„ÄÇ"];function yi(e){return e[Math.floor(Math.random()*e.length)]||"„Å©„ÅÜ„Åó„Åü„ÅÆÔºü"}function ja(e,t={}){const n=typeof e=="string"?e.trim():"";if(!n)return"„Å©„ÅÜ„Åó„Åü„ÅÆÔºü";const a=n.toLowerCase();if(a.includes("„ÅÇ„Çä„Åå„Å®„ÅÜ"))return"„Å©„ÅÜ„ÅÑ„Åü„Åó„Åæ„Åó„Å¶„ÄÇ„ÅÑ„Å§„Åß„ÇÇÂëº„Çì„Åß„Å≠„ÄÇ";if(a.includes("„Åä„ÅØ"))return"„Åä„ÅØ„Çà„ÅÜ„ÄÇ‰ªäÊó•„ÅØ‰Ωï„Åã„ÇâÈÄ≤„ÇÅ„ÇãÔºü";if(a.includes("Áñ≤")||a.includes("„Å§„Åã„Çå"))return"Â∞ë„ÅóÊ∑±ÂëºÂê∏„Åó„Çà„Å£„Åã„ÄÇÁü≠„ÅÑ‰ºëÊÜ©„Åß„ÇÇÂõûÂæ©„Åô„Çã„Çà„ÄÇ";const o=Array.isArray(t?.candidateReplies)?t.candidateReplies:null;return o&&o.length>0?yi(o):yi(Nr)}function hi(e,t={}){return ja(e,t)}const vi={};function Or(e,t){if(typeof ja=="function")return ja(e,t);if(typeof hi=="function")return hi(e,t);if(typeof vi=="function")return vi(e,t);throw new Error("dialogue.getReply/reply not found")}const bs="companion:history:v1",ys="companion:unread:v1",nn="companion:settings:v1",hs="companion:ui:v1",ua="companion:settings:migrated:v1",Rr=["companion:settings","companion.settings.v1","voicechat:settings:v1"],Me={displayName:"„ÇÇ„Å°„Åæ„Çã",avatarImage:null,bubbleX:0,bubbleY:0,bubbleScale:1,ttsEnabled:!1,ttsVoiceURI:"",ttsRate:1,ttsPitch:1},wi={isOpen:!1,activeTab:"chat"};function Zn(e,t){try{return JSON.parse(e)}catch{return t}}function ct(e){try{return localStorage.getItem(e)}catch{return null}}function Ze(e,t){try{localStorage.setItem(e,t)}catch{}}function Jt(e,t,n,a){const o=Number(e);return Number.isFinite(o)?Number.isFinite(n)&&o<n?n:Number.isFinite(a)&&o>a?a:o:t}function Do(e){const t=e&&typeof e=="object"?e:{},n=typeof t.displayName=="string"?t.displayName:typeof t.characterName=="string"?t.characterName:Me.displayName,a=typeof t.avatarImage=="string"?t.avatarImage:typeof t.characterImageDataUrl=="string"?t.characterImageDataUrl:null,o=typeof t.ttsVoiceURI=="string"?t.ttsVoiceURI:typeof t.ttsVoiceUri=="string"?t.ttsVoiceUri:"";return{displayName:n.trim()?n.trim().slice(0,30):Me.displayName,avatarImage:a&&a.trim()?a:null,bubbleX:Jt(t.bubbleX,Me.bubbleX,-160,160),bubbleY:Jt(t.bubbleY,Me.bubbleY,-160,160),bubbleScale:Jt(t.bubbleScale,Me.bubbleScale,.6,1.6),ttsEnabled:!!t.ttsEnabled,ttsVoiceURI:o,ttsRate:Jt(t.ttsRate,Me.ttsRate,.6,1.6),ttsPitch:Jt(t.ttsPitch,Me.ttsPitch,.6,1.6)}}function vs(e){const t=e&&typeof e=="object"?e:{};return{isOpen:!!t.isOpen,activeTab:t.activeTab==="settings"?"settings":"chat"}}function ws(e=120){const t=ct(bs);if(!t)return[];const n=Zn(t,[]);return Array.isArray(n)?n.filter(a=>a&&typeof a=="object").map(a=>({id:String(a.id||""),role:a.role==="user"?"user":"ai",text:typeof a.text=="string"?a.text:"",ts:Number(a.ts)||Date.now()})).filter(a=>a.text.trim().length>0).slice(-e):[]}function $r(e,t=120){const n=Array.isArray(e)?e.slice(-t):[];Ze(bs,JSON.stringify(n))}function Cs(){const e=Number(ct(ys));return Number.isFinite(e)&&e>0?Math.floor(e):0}function As(e){const t=Number.isFinite(Number(e))?Math.max(0,Math.floor(Number(e))):0;Ze(ys,String(t))}function ks(){const e=ct(nn);return e?Do(Zn(e,Me)):{...Me}}function Pr(e){const t=Do(e);return Ze(nn,JSON.stringify(t)),t}function Hr(){const e={...Me};return Ze(nn,JSON.stringify(e)),e}function jr(){const e=ct(hs);return e?vs(Zn(e,wi)):{...wi}}function Ss(e){const t=vs(e);return Ze(hs,JSON.stringify(t)),t}function Wr(){if(ct(ua)!=="1"){if(ct(nn)){Ze(ua,"1");return}for(const e of Rr){const t=ct(e);if(!t)continue;const n=Do(Zn(t,null));Ze(nn,JSON.stringify(n));break}Ze(ua,"1")}}const Fr="„ÉÜ„Çπ„Éà„Åß„Åô„ÄÇ„Å≤„ÅæÔºü",ze={displayName:"„ÇÇ„Å°„Åæ„Çã",avatarImage:null,bubbleX:0,bubbleY:0,bubbleScale:1,ttsEnabled:!1,ttsVoiceURI:"",ttsRate:1,ttsPitch:1};function zr(){const e="/virtualoffice/";if(e.length>0)return e.replace(/\/?$/,"/");if(typeof window<"u"){const n=(window.location.pathname||"/").split("/").filter(Boolean);if(n.length>0)return`/${n[0]}/`}return"/"}function Ur(){return`${zr()}src/companion/assets/mascot.png`}function De(e,t,n,a){const o=Number(e);return Number.isFinite(o)?Number.isFinite(n)&&o<n?n:Number.isFinite(a)&&o>a?a:o:t}function fa(e){const t=e&&typeof e=="object"?e:{};return{displayName:typeof t.displayName=="string"&&t.displayName.trim()?t.displayName.trim().slice(0,30):ze.displayName,avatarImage:typeof t.avatarImage=="string"&&t.avatarImage.trim()?t.avatarImage:null,bubbleX:De(t.bubbleX,ze.bubbleX,-160,160),bubbleY:De(t.bubbleY,ze.bubbleY,-160,160),bubbleScale:De(t.bubbleScale,ze.bubbleScale,.6,1.6),ttsEnabled:!!t.ttsEnabled,ttsVoiceURI:typeof t.ttsVoiceURI=="string"?t.ttsVoiceURI:"",ttsRate:De(t.ttsRate,ze.ttsRate,.6,1.6),ttsPitch:De(t.ttsPitch,ze.ttsPitch,.6,1.6)}}function K(e,t=0){return Number(e).toFixed(t).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1")}function Vt(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function It(e,t){e&&(e.textContent=t)}function Gr(e,t,n,a="„Å≤„ÅæÔºü"){n&&(n.src=e.avatarImage||Ur(),n.alt=e.displayName||ze.displayName),t&&(t.textContent=a,t.style.transform=`translate(${e.bubbleX}px, ${e.bubbleY}px) scale(${e.bubbleScale})`)}function ga(e,t,n){if(!e)return;const a=['<option value="">„Ç∑„Çπ„ÉÜ„É†Êó¢ÂÆö</option>'];for(const o of t){const i=Vt(o.voiceURI||""),s=Vt(o.name||o.voiceURI||"Unknown"),l=Vt(o.lang||"");a.push(`<option value="${i}">${s}${l?` (${l})`:""}</option>`)}e.innerHTML=a.join(""),n&&(e.value=n)}function Jr(e,t){if(!(typeof window>"u"||typeof window.SpeechSynthesisUtterance>"u"||!window.speechSynthesis))try{window.speechSynthesis.cancel();const n=new window.SpeechSynthesisUtterance(Fr);if(n.rate=e.ttsRate,n.pitch=e.ttsPitch,e.ttsVoiceURI){const a=t.find(o=>o.voiceURI===e.ttsVoiceURI);a&&(n.voice=a)}window.speechSynthesis.speak(n)}catch{}}function qr(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>t(String(a.result||"")),a.onerror=n,a.readAsDataURL(e)})}function le(e,t,n,a,o){t?.addEventListener?.(n,a,o),e.push(()=>t?.removeEventListener?.(n,a,o))}function Yr(e,t,n,a){if(!e)return{update(){},destroy(){}};let o=fa(t),i="„Å≤„ÅæÔºü",s=[];const l=[];e.innerHTML=`
        <div class="vc-settings" data-role="settings-root">
            <div class="vc-preview" data-role="preview-wrap">
                <div class="vc-preview-avatar-wrap">
                    <img class="vc-preview-avatar" data-role="preview-avatar" alt="${Vt(o.displayName)}" loading="lazy" />
                </div>
                <div class="vc-preview-bubble" data-role="preview-bubble">„Å≤„ÅæÔºü</div>
            </div>

            <label class="vc-field">
                <span class="vc-label">„Ç≠„É£„É©Âêç</span>
                <input class="vc-input" data-role="displayName" type="text" maxlength="30" value="${Vt(o.displayName)}" />
            </label>

            <label class="vc-field">
                <span class="vc-label">„Ç≠„É£„É©ÁîªÂÉè</span>
                <input class="vc-input" data-role="avatarFile" type="file" accept="image/png,image/jpeg,image/webp" />
            </label>

            <div class="vc-settings-actions">
                <button type="button" class="companion-btn-sub" data-role="avatarReset">ÁîªÂÉè„ÇíÊó¢ÂÆö„Å´Êàª„Åô</button>
            </div>

            <label class="vc-field">
                <span class="vc-label">Âêπ„ÅçÂá∫„Åó X</span>
                <input class="vc-range" data-role="bubbleX" type="range" min="-160" max="160" step="1" value="${K(o.bubbleX)}" />
                <span class="vc-value" data-role="bubbleXValue">${K(o.bubbleX)}</span>
            </label>

            <label class="vc-field">
                <span class="vc-label">Âêπ„ÅçÂá∫„Åó Y</span>
                <input class="vc-range" data-role="bubbleY" type="range" min="-160" max="160" step="1" value="${K(o.bubbleY)}" />
                <span class="vc-value" data-role="bubbleYValue">${K(o.bubbleY)}</span>
            </label>

            <label class="vc-field">
                <span class="vc-label">Âêπ„ÅçÂá∫„Åó Scale</span>
                <input class="vc-range" data-role="bubbleScale" type="range" min="0.6" max="1.6" step="0.01" value="${K(o.bubbleScale,2)}" />
                <span class="vc-value" data-role="bubbleScaleValue">${K(o.bubbleScale,2)}</span>
            </label>

            <label class="vc-field vc-switch-field">
                <span class="vc-label">TTS</span>
                <input data-role="ttsEnabled" type="checkbox" ${o.ttsEnabled?"checked":""} />
                <span data-role="ttsEnabledValue">${o.ttsEnabled?"ON":"OFF"}</span>
            </label>

            <label class="vc-field">
                <span class="vc-label">Voice</span>
                <select class="vc-input" data-role="ttsVoice"></select>
            </label>

            <label class="vc-field">
                <span class="vc-label">Rate</span>
                <input class="vc-range" data-role="ttsRate" type="range" min="0.6" max="1.6" step="0.01" value="${K(o.ttsRate,2)}" />
                <span class="vc-value" data-role="ttsRateValue">${K(o.ttsRate,2)}</span>
            </label>

            <label class="vc-field">
                <span class="vc-label">Pitch</span>
                <input class="vc-range" data-role="ttsPitch" type="range" min="0.6" max="1.6" step="0.01" value="${K(o.ttsPitch,2)}" />
                <span class="vc-value" data-role="ttsPitchValue">${K(o.ttsPitch,2)}</span>
            </label>

            <div class="vc-settings-actions">
                <button type="button" class="companion-btn-sub" data-role="ttsTest">„ÉÜ„Çπ„ÉàË™≠„Åø‰∏ä„Åí</button>
                <button type="button" class="companion-btn-sub" data-role="resetAll">„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>
    `;const d=e.querySelector('[data-role="settings-root"]'),I=e.querySelector('[data-role="preview-bubble"]'),p=e.querySelector('[data-role="preview-avatar"]'),v=e.querySelector('[data-role="displayName"]'),g=e.querySelector('[data-role="avatarFile"]'),b=e.querySelector('[data-role="avatarReset"]'),y=e.querySelector('[data-role="bubbleX"]'),h=e.querySelector('[data-role="bubbleY"]'),f=e.querySelector('[data-role="bubbleScale"]'),k=e.querySelector('[data-role="bubbleXValue"]'),D=e.querySelector('[data-role="bubbleYValue"]'),$=e.querySelector('[data-role="bubbleScaleValue"]'),E=e.querySelector('[data-role="ttsEnabled"]'),M=e.querySelector('[data-role="ttsEnabledValue"]'),B=e.querySelector('[data-role="ttsVoice"]'),T=e.querySelector('[data-role="ttsRate"]'),L=e.querySelector('[data-role="ttsPitch"]'),W=e.querySelector('[data-role="ttsRateValue"]'),J=e.querySelector('[data-role="ttsPitchValue"]'),nt=e.querySelector('[data-role="ttsTest"]'),la=e.querySelector('[data-role="resetAll"]');function se(V){o=fa(V),n?.(o),at()}function at(){v&&(v.value=o.displayName),y&&(y.value=K(o.bubbleX)),h&&(h.value=K(o.bubbleY)),f&&(f.value=K(o.bubbleScale,2)),k&&It(k,K(o.bubbleX)),D&&It(D,K(o.bubbleY)),$&&It($,K(o.bubbleScale,2)),E&&(E.checked=o.ttsEnabled),M&&It(M,o.ttsEnabled?"ON":"OFF"),T&&(T.value=K(o.ttsRate,2)),L&&(L.value=K(o.ttsPitch,2)),W&&It(W,K(o.ttsRate,2)),J&&It(J,K(o.ttsPitch,2)),ga(B,s,o.ttsVoiceURI),Gr(o,I,p,i)}function yn(){if(typeof window>"u"||!window.speechSynthesis){s=[],ga(B,s,o.ttsVoiceURI);return}const V=window.speechSynthesis.getVoices();Array.isArray(V)&&V.length&&(s=[...V],ga(B,s,o.ttsVoiceURI))}if(le(l,v,"input",()=>{se({...o,displayName:v.value})}),le(l,g,"change",async()=>{const V=g?.files?.[0];if(V)try{const We=await qr(V);We&&se({...o,avatarImage:We})}catch{}finally{g&&(g.value="")}}),le(l,b,"click",()=>{se({...o,avatarImage:null})}),le(l,y,"input",()=>{se({...o,bubbleX:De(y.value,o.bubbleX,-160,160)})}),le(l,h,"input",()=>{se({...o,bubbleY:De(h.value,o.bubbleY,-160,160)})}),le(l,f,"input",()=>{se({...o,bubbleScale:De(f.value,o.bubbleScale,.6,1.6)})}),le(l,E,"change",()=>{se({...o,ttsEnabled:E.checked})}),le(l,B,"change",()=>{se({...o,ttsVoiceURI:B.value||""})}),le(l,T,"input",()=>{se({...o,ttsRate:De(T.value,o.ttsRate,.6,1.6)})}),le(l,L,"input",()=>{se({...o,ttsPitch:De(L.value,o.ttsPitch,.6,1.6)})}),le(l,nt,"click",()=>{Jr(o,s)}),le(l,la,"click",()=>{const V=a?.();se(V||ze)}),typeof window<"u"&&window.speechSynthesis){const V=()=>yn();le(l,window.speechSynthesis,"voiceschanged",V),yn(),s.length||window.setTimeout(V,250)}return at(),{update(V,We){o=fa(V||o),typeof We=="string"&&We.trim()&&(i=We),at()},destroy(){for(const V of l.splice(0,l.length))try{V()}catch{}d&&d.remove()}}}const St=120,Es=1e3,Ci=600,Kr=1200,A={open:!1,activeTab:"chat",unread:Cs(),messages:ws(St),settings:ks()},m={dotHost:null,panelHost:null,dotButton:null,dotCallout:null,dotMini:null,dotImage:null,headImage:null,title:null,close:null,tabChat:null,tabSettings:null,panelChat:null,panelSettings:null,settingsRoot:null,unreadBadge:null,menuBadge:null,log:null,form:null,input:null,send:null};let Wa=!1,Ue=null,Re=null,Et=null,Mt=null,Fa=[],lt=null;function Vr(){const e="/virtualoffice/";if(e.length>0)return e.replace(/\/?$/,"/");if(typeof window<"u"){const n=(window.location.pathname||"/").split("/").filter(Boolean);if(n.length>0)return`/${n[0]}/`}return"/"}function Zr(){return`${Vr()}src/companion/assets/mascot.png`}function xo(){return(typeof A.settings.displayName=="string"?A.settings.displayName.trim():"")||"„ÇÇ„Å°„Åæ„Çã"}function Ms(){return A.settings.avatarImage||Zr()}function Xr(e){return Array.isArray(e)?e.filter(t=>t&&typeof t=="object").map(t=>({id:String(t.id||gn()),role:t.role==="user"?"user":"ai",text:typeof t.text=="string"?t.text:"",ts:Number(t.ts)||Date.now()})).filter(t=>t.text.trim().length>0).slice(-St):[]}function Ls(e){Fa.push(e)}function Fe(e,t,n,a){e?.addEventListener&&(e.addEventListener(t,n,a),Ls(()=>e.removeEventListener(t,n,a)))}function Qr(){return Ue=document.getElementById("companion-root"),Ue||(Ue=document.createElement("div"),Ue.id="companion-root",document.body.appendChild(Ue)),Ue}function ec(){const e=Qr();m.dotHost=document.getElementById("companion-dot"),m.dotHost||(m.dotHost=document.createElement("div"),m.dotHost.id="companion-dot"),m.panelHost=document.getElementById("companion-panel"),m.panelHost||(m.panelHost=document.createElement("div"),m.panelHost.id="companion-panel"),m.dotHost.parentElement!==e&&e.appendChild(m.dotHost),m.panelHost.parentElement!==e&&e.appendChild(m.panelHost)}function tc(){const e=xo(),t=Ms();m.dotHost.innerHTML=`
        <button type="button" class="companion-dot-button" aria-label="AI„ÇíÈñã„Åè">
            <img src="${t}" alt="${e}" loading="lazy" data-role="dot-image" />
            <span class="companion-dot-fallback" aria-hidden="true">üç°</span>
        </button>
        <span class="companion-dot-callout" data-role="dot-callout">„Å≤„ÅæÔºü</span>
        <span class="companion-dot-badge" aria-live="polite">0</span>
        <span class="companion-dot-mini" data-role="dot-mini">„Å™„Å´„ÄúÔºü</span>
    `,m.panelHost.innerHTML=`
        <section class="vc companion-shell" aria-label="Áõ∏Ê£í„ÉÅ„É£„ÉÉ„Éà">
            <div class="companion-head">
                <div class="companion-head-main">
                    <img class="companion-head-avatar" src="${t}" alt="${e}" loading="lazy" data-role="head-image" />
                    <div>
                        <div class="companion-head-title" data-role="head-title">${e}</div>
                        <div class="companion-head-sub">AIÁõ∏Ê£í</div>
                    </div>
                </div>
                <button type="button" class="companion-close" aria-label="Èñâ„Åò„Çã">√ó</button>
            </div>

            <div class="companion-tabs" role="tablist">
                <button type="button" class="companion-tab is-active" data-tab="chat" role="tab" aria-selected="true">CHAT</button>
                <button type="button" class="companion-tab" data-tab="settings" role="tab" aria-selected="false">SETTINGS</button>
            </div>

            <div class="companion-tab-panel" data-panel="chat">
                <div class="companion-log" role="log" aria-live="polite"></div>
                <form class="companion-form">
                    <input class="companion-input" type="text" maxlength="300" placeholder="Ë©±„Åó„Åã„Åë„Çã..." />
                    <button class="companion-send" type="submit">ÈÄÅ‰ø°</button>
                </form>
            </div>

            <div class="companion-tab-panel is-hidden" data-panel="settings">
                <div class="companion-settings-root" data-role="settings-root"></div>
            </div>
        </section>
    `,m.dotButton=m.dotHost.querySelector(".companion-dot-button"),m.dotCallout=m.dotHost.querySelector('[data-role="dot-callout"]'),m.dotMini=m.dotHost.querySelector('[data-role="dot-mini"]'),m.unreadBadge=m.dotHost.querySelector(".companion-dot-badge"),m.menuBadge=document.getElementById("companion-menu-badge"),m.dotImage=m.dotHost.querySelector('[data-role="dot-image"]'),m.headImage=m.panelHost.querySelector('[data-role="head-image"]'),m.title=m.panelHost.querySelector('[data-role="head-title"]'),m.close=m.panelHost.querySelector(".companion-close"),m.tabChat=m.panelHost.querySelector('[data-tab="chat"]'),m.tabSettings=m.panelHost.querySelector('[data-tab="settings"]'),m.panelChat=m.panelHost.querySelector('[data-panel="chat"]'),m.panelSettings=m.panelHost.querySelector('[data-panel="settings"]'),m.settingsRoot=m.panelHost.querySelector('[data-role="settings-root"]'),m.log=m.panelHost.querySelector(".companion-log"),m.form=m.panelHost.querySelector(".companion-form"),m.input=m.panelHost.querySelector(".companion-input"),m.send=m.panelHost.querySelector(".companion-send"),m.dotHost.querySelectorAll("img").forEach(n=>{Fe(n,"error",()=>{const a=m.dotHost?.querySelector(".companion-dot-fallback");a&&(a.style.display="inline-block"),n.style.display="none"},{once:!0})}),Ja(),nc()}function nc(){m.settingsRoot&&(lt?.destroy?.(),lt=Yr(m.settingsRoot,A.settings,e=>{A.settings=Pr(e),Ja(),Ga(),lt?.update?.(A.settings,Ua())},()=>(A.settings=Hr(),Ja(),Ga(),A.settings)),lt?.update?.(A.settings,Ua()))}function ac(){if(m.log){m.log.innerHTML="";for(const e of A.messages)m.log.appendChild(_s(e.role,e.text));m.log.scrollTop=m.log.scrollHeight}}function _s(e,t){const n=document.createElement("div");return n.className=`companion-msg ${e==="user"?"user":"ai"}`,n.textContent=t,n}function oc(){const e=document.createElement("div");return e.className="companion-msg typing",e.innerHTML='„Çø„Ç§„Éó‰∏≠<span class="companion-typing-dots"><span>.</span><span>.</span><span>.</span></span>',e}function za(e,t,{persist:n=!0}={}){const a=typeof t=="string"?t.trim():"";if(!a)return;const o={id:gn(),role:e==="user"?"user":"ai",text:a,ts:Date.now()};A.messages.push(o),A.messages.length>St&&A.messages.splice(0,A.messages.length-St),n&&$r(A.messages,St),m.log&&(m.log.appendChild(_s(o.role,o.text)),m.log.scrollTop=m.log.scrollHeight),lt?.update?.(A.settings,Ua())}function ic(e){za("ai",e)}function Ua(){for(let e=A.messages.length-1;e>=0;e-=1){const t=A.messages[e];if(t?.role==="ai"&&t?.text)return t.text}return"„Å≤„ÅæÔºü"}function Ga(){const e=Number(A.settings.bubbleX)||0,t=Number(A.settings.bubbleY)||0,n=Number(A.settings.bubbleScale)||1,a=`translate(${e}px, ${t}px) scale(${n})`;m.dotCallout&&(m.dotCallout.style.transform=a),m.dotMini&&(m.dotMini.style.transform=a)}function Ja(){const e=xo(),t=Ms();m.title&&(m.title.textContent=e),m.dotImage&&(m.dotImage.src=t,m.dotImage.alt=e),m.headImage&&(m.headImage.src=t,m.headImage.alt=e),Ga()}function sc(){m.dotMini&&(m.dotMini.classList.add("visible"),Et&&clearTimeout(Et),Et=window.setTimeout(()=>{m.dotMini?.classList.remove("visible")},Es))}function qa(e,{persist:t=!0}={}){A.activeTab=e==="settings"?"settings":"chat";const n=A.activeTab==="chat";m.tabChat?.classList.toggle("is-active",n),m.tabSettings?.classList.toggle("is-active",!n),m.tabChat?.setAttribute("aria-selected",String(n)),m.tabSettings?.setAttribute("aria-selected",String(!n)),m.panelChat?.classList.toggle("is-hidden",!n),m.panelSettings?.classList.toggle("is-hidden",n),n&&A.open&&(m.input?.focus(),m.log&&(m.log.scrollTop=m.log.scrollHeight)),t&&Ss({isOpen:A.open,activeTab:A.activeTab})}function Bo(e,{persist:t=!0}={}){A.open=!!e,m.panelHost?.classList.toggle("is-hidden",!A.open),m.panelHost?.classList.toggle("is-closed",!A.open),m.panelHost&&(m.panelHost.setAttribute("aria-hidden",String(!A.open)),m.panelHost.style.pointerEvents=A.open?"auto":"none"),document.body.classList.toggle("chat-open",A.open),A.open&&(m.dotMini?.classList.remove("visible"),m.log&&(m.log.scrollTop=m.log.scrollHeight),A.activeTab==="chat"&&m.input?.focus()),t&&Ss({isOpen:A.open,activeTab:A.activeTab})}function Ya(){Bo(!0),A.unread=0,As(A.unread),To()}function Ka(){Bo(!1)}function lc(){return A.open}function To(){const e=A.unread>0;m.dotHost?.classList.toggle("has-unread",e),m.unreadBadge&&(m.unreadBadge.textContent=String(Math.min(A.unread,99))),m.menuBadge&&(m.menuBadge.textContent=String(Math.min(A.unread,99)),m.menuBadge.classList.toggle("visible",e)),window.dispatchEvent(new CustomEvent("companion:unread",{detail:{count:A.unread}}))}function Ds(){const e=document.body.classList.contains("chat-open");m.dotHost?.classList.toggle("is-left",e)}function rc(){Re&&Re.disconnect(),Re=new MutationObserver(()=>{Ds()}),Re.observe(document.body,{attributes:!0,attributeFilter:["class"]}),Ls(()=>{Re?.disconnect(),Re=null})}function cc(e){return e?typeof e=="string"?e:typeof e?.text=="string"?e.text:typeof e?.reply=="string"?e.reply:typeof e?.message=="string"?e.message:typeof e?.body=="string"?e.body:"":""}function dc(){return Math.floor(Math.random()*(Kr-Ci+1))+Ci}function uc(e){if(!e||typeof window>"u"||!window.speechSynthesis)return null;const t=window.speechSynthesis.getVoices();return Array.isArray(t)&&t.find(n=>n.voiceURI===e)||null}function fc(e){if(!A.settings.ttsEnabled||typeof window>"u"||typeof window.SpeechSynthesisUtterance>"u"||!window.speechSynthesis)return;const t=String(e||"").trim();if(t)try{window.speechSynthesis.cancel();const n=new window.SpeechSynthesisUtterance(t);n.rate=Number(A.settings.ttsRate)||1,n.pitch=Number(A.settings.ttsPitch)||1;const a=uc(A.settings.ttsVoiceURI);a&&(n.voice=a),window.speechSynthesis.speak(n)}catch{}}async function gc(e){za("user",e);const t=A.open&&m.log?oc():null;t&&m.log&&(m.log.appendChild(t),m.log.scrollTop=m.log.scrollHeight),await mc(dc());let n="";try{const a=await Promise.resolve(Or(e,{character:xo(),messages:[...A.messages]}));n=cc(a).trim()||"„ÅÜ„Çì„ÄÅËÅû„ÅÑ„Å¶„Çã„Çà„ÄÇÁ∂ö„Åë„Å¶„ÄÇ"}catch(a){console.error("[COMPANION] send failed",a),n="„Åî„ÇÅ„Çì„ÄÅ‰ªä„Å°„Çá„Å£„Å®„Å†„ÅëË©∞„Åæ„Å£„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂõûÈÄÅ„Å£„Å¶„Åø„Å¶„ÄÇ"}t?.isConnected&&t.remove(),n?(za("ai",n),fc(n)):ic("„Åî„ÇÅ„Çì„ÄÅ‰ªä„Å°„Çá„Å£„Å®„Å†„ÅëË©∞„Åæ„Å£„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂõûÈÄÅ„Å£„Å¶„Åø„Å¶„ÄÇ"),A.open||(A.unread+=1,As(A.unread),To())}function mc(e){return new Promise(t=>{window.setTimeout(t,e)})}function pc(){Fe(m.dotButton,"click",()=>{sc(),Mt&&clearTimeout(Mt),Mt=window.setTimeout(()=>{Ya()},Es)}),Fe(m.close,"click",()=>{Ka()}),Fe(m.tabChat,"click",()=>{qa("chat")}),Fe(m.tabSettings,"click",()=>{qa("settings")}),Fe(m.form,"submit",e=>{e.preventDefault();const t=m.input?.value?.trim()||"";t&&(m.input.value="",m.send&&(m.send.disabled=!0),gc(t).finally(()=>{m.send&&(m.send.disabled=!1),A.open&&A.activeTab==="chat"&&m.input?.focus()}))}),Fe(document,"keydown",e=>{e.key==="Escape"&&A.open&&Ka()}),Fe(document.getElementById("companion-menu-btn"),"click",()=>{Ya()})}function Ic(){Et&&(clearTimeout(Et),Et=null),Mt&&(clearTimeout(Mt),Mt=null),lt?.destroy?.(),lt=null;for(const e of Fa.splice(0,Fa.length))try{e()}catch{}Re&&(Re.disconnect(),Re=null),document.body.classList.remove("chat-open")}function bc(){if(!(Wa||window.__COMPANION_DISABLED__))try{Wr(),A.messages=Xr(ws(St)),A.unread=Cs(),A.settings=ks();const e=jr();A.open=!!e.isOpen,A.activeTab=e.activeTab==="settings"?"settings":"chat",ec(),tc(),ac(),pc(),To(),Ds(),rc(),qa(A.activeTab,{persist:!1}),Bo(A.open,{persist:!1}),window.Companion={open:Ya,close:Ka,isOpen:lc,destroy:Va},Wa=!0}catch(e){console.error("[COMPANION] mount failed (non-fatal)",e),window.__COMPANION_DISABLED__=!0,Va()}}function Va(){Ic(),A.open=!1;const e=Ue||document.getElementById("companion-root");e&&e.remove(),Ue=null,m.dotHost=null,m.panelHost=null,m.dotButton=null,m.dotCallout=null,m.dotMini=null,m.dotImage=null,m.headImage=null,m.title=null,m.close=null,m.tabChat=null,m.tabSettings=null,m.panelChat=null,m.panelSettings=null,m.settingsRoot=null,m.unreadBadge=null,m.menuBadge=null,m.log=null,m.form=null,m.input=null,m.send=null,Wa=!1,window.Companion&&delete window.Companion}const Ai={desk:{width:70,height:36}};let rt=new Map,Lt="area:core";function H(e){console.log("[BOOT]",e);const t=document.getElementById("bootLog");t&&(t.textContent+=`${e}
`)}async function yc(e){const t=String(e);H(`fetch: ${t}`);const n=await fetch(t,{cache:"no-store"});if(H(`status: ${t} -> ${n.status}`),!n.ok){const o=await n.text().catch(()=>"");throw new Error(`Fetch failed ${n.status} for ${t}
${o.slice(0,200)}`)}n.headers.get("content-type");const a=await n.text().catch(()=>"");try{return JSON.parse(a)}catch(o){throw new Error(`JSON parse failed for ${t}: ${o.message}
body(head): ${a.slice(0,200)}`)}}async function ki(e="core"){H(`loadMaps: start (${e})`);try{const t=[{key:"core",url:new URL("/virtualoffice/assets/map_core-d322xUfd.json",import.meta.url).href},{key:"desks",url:new URL("data:application/json;base64,ew0KICAgICJtZXRhIjogeyAiaWQiOiAibWFwOmRlc2tzIiwgInZlcnNpb24iOiAyIH0sCiAgICAiZGVza3MiOiBbCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDEiLCAicG9zIjogeyAieCI6IDI2MCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogMjYwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDIiLCAicG9zIjogeyAieCI6IDMyMCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogMzIwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDMiLCAicG9zIjogeyAieCI6IDM4MCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogMzgwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDQiLCAicG9zIjogeyAieCI6IDQ0MCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogNDQwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDUiLCAicG9zIjogeyAieCI6IDUwMCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogNTAwLCAieSI6IDU0OCB9IH0sCiAgICAgICAgeyAiaWQiOiAiZGVzazphMDYiLCAicG9zIjogeyAieCI6IDU2MCwgInkiOiA1MjAgfSwgInN0YW5kUG9pbnQiOiB7ICJ4IjogNTYwLCAieSI6IDU0OCB9IH0sCgogICAgICAgIHsgImlkIjogImRlc2s6YTA3IiwgInBvcyI6IHsgIngiOiAyNjAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDI2MCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTA4IiwgInBvcyI6IHsgIngiOiAzMjAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDMyMCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTA5IiwgInBvcyI6IHsgIngiOiAzODAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDM4MCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTEwIiwgInBvcyI6IHsgIngiOiA0NDAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDQ0MCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTExIiwgInBvcyI6IHsgIngiOiA1MDAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDUwMCwgInkiOiA2MDggfSB9LAogICAgICAgIHsgImlkIjogImRlc2s6YTEyIiwgInBvcyI6IHsgIngiOiA1NjAsICJ5IjogNTgwIH0sICJzdGFuZFBvaW50IjogeyAieCI6IDU2MCwgInkiOiA2MDggfSB9CiAgICBdLAogICAgInpvbmVzIjogWwogICAgICAgIHsKICAgICAgICAgICAgImlkIjogInpvbmU6ZGVza3MiLAogICAgICAgICAgICAiYm91bmRzIjogewogICAgICAgICAgICAgICAgIngiOiAyMTAsCiAgICAgICAgICAgICAgICAieSI6IDQzMCwKICAgICAgICAgICAgICAgICJ3IjogNDA4LAogICAgICAgICAgICAgICAgImgiOiAxODgKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIndhbGthYmxlIjogdHJ1ZQogICAgICAgIH0KICAgIF0sCiAgICAid2Fsa2FibGUiOiBbCiAgICAgICAgewogICAgICAgICAgICAieCI6IDIwOCwKICAgICAgICAgICAgInkiOiA0MjgsCiAgICAgICAgICAgICJ3IjogNDEyLAogICAgICAgICAgICAiaCI6IDE5MiwKICAgICAgICAgICAgInRhZyI6ICJhc3NpZ25lZF9kZXNrc19mbG9vciIKICAgICAgICB9CiAgICBdLAogICAgImRlc2tSdWxlcyI6IHsKICAgICAgICAiaW5pdGlhbE1vZGUiOiAiZml4ZWQiLA0KICAgICAgICAiZnV0dXJlTW9kZSI6ICJmcmVlIiwNCiAgICAgICAgIm5vdGVzIjogWw0KICAgICAgICAgICAgIk1WUOOBp+OBr+W6p+W4reOBr+WbuuWumumBi+eUqO+8iOWJsuOCiuW9k+OBplVJ44Gq44GX77yJ44CCIiwNCiAgICAgICAgICAgICLlsIbmnaXjga/oh6rnlLHluK3pgbjmip5VSeOCkui/veWKoOOBp+OBjeOCi+OCiOOBhiBkZXNr5a6a576p44KS44OH44O844K/44Go44GX44Gm5YiG6Zui44CCIg0KICAgICAgICBdDQogICAgfQ0KfQo=",import.meta.url).href},{key:"expansion",url:new URL("data:application/json;base64,ew0KICAgICJtZXRhIjogew0KICAgICAgICAiaWQiOiAibWFwOmV4cGFuc2lvbiIsDQogICAgICAgICJ2ZXJzaW9uIjogMQ0KICAgIH0sDQogICAgInJvb21zIjogWw0KICAgICAgICB7DQogICAgICAgICAgICAiaWQiOiAicm9vbTpzdHVkaW8iLA0KICAgICAgICAgICAgImxhYmVsIjogIlN0dWRpbyAoc3BhcmUpIiwNCiAgICAgICAgICAgICJib3VuZHMiOiB7DQogICAgICAgICAgICAgICAgIngiOiAxNDAsDQogICAgICAgICAgICAgICAgInkiOiA1MjAsDQogICAgICAgICAgICAgICAgInciOiA0ODAsDQogICAgICAgICAgICAgICAgImgiOiAzNDANCiAgICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgew0KICAgICAgICAgICAgImlkIjogInJvb206cXVpZXQiLA0KICAgICAgICAgICAgImxhYmVsIjogIlF1aWV0IChzcGFyZSkiLA0KICAgICAgICAgICAgImJvdW5kcyI6IHsNCiAgICAgICAgICAgICAgICAieCI6IDE0MCwNCiAgICAgICAgICAgICAgICAieSI6IDkwMCwNCiAgICAgICAgICAgICAgICAidyI6IDQ4MCwNCiAgICAgICAgICAgICAgICAiaCI6IDM2MA0KICAgICAgICAgICAgfQ0KICAgICAgICB9LA0KICAgICAgICB7DQogICAgICAgICAgICAiaWQiOiAicm9vbTpsb3VuZ2UiLA0KICAgICAgICAgICAgImxhYmVsIjogIkxvdW5nZSAoc3BhcmUpIiwNCiAgICAgICAgICAgICJib3VuZHMiOiB7DQogICAgICAgICAgICAgICAgIngiOiAxNzYwLA0KICAgICAgICAgICAgICAgICJ5IjogMjQwLA0KICAgICAgICAgICAgICAgICJ3IjogNDgwLA0KICAgICAgICAgICAgICAgICJoIjogNTIwDQogICAgICAgICAgICB9DQogICAgICAgIH0sDQogICAgICAgIHsNCiAgICAgICAgICAgICJpZCI6ICJyb29tOmdhbGxlcnkiLA0KICAgICAgICAgICAgImxhYmVsIjogIkdhbGxlcnkgKHNwYXJlKSIsDQogICAgICAgICAgICAiYm91bmRzIjogew0KICAgICAgICAgICAgICAgICJ4IjogMTc2MCwNCiAgICAgICAgICAgICAgICAieSI6IDgyMCwNCiAgICAgICAgICAgICAgICAidyI6IDQ4MCwNCiAgICAgICAgICAgICAgICAiaCI6IDQyMA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgXSwKICAgICJ3YWxrYWJsZSI6IFsKICAgICAgICB7CiAgICAgICAgICAgICJ4IjogNDAsCiAgICAgICAgICAgICJ5IjogNDMwLAogICAgICAgICAgICAidyI6IDU2MCwKICAgICAgICAgICAgImgiOiAyNjAsCiAgICAgICAgICAgICJub3RlIjogImFzc2lnbmVkIGRlc2tzIGZsb29yIgogICAgICAgIH0KICAgIF0sCiAgICAiZGVjb3IiOiBbCiAgICAgICAgewogICAgICAgICAgICAidHlwZSI6ICJsYWJlbCIsCiAgICAgICAgICAgICJ4IjogMjAwLA0KICAgICAgICAgICAgInkiOiA1NjAsDQogICAgICAgICAgICAidGV4dCI6ICJTcGFyZSBSb29tcyIsDQogICAgICAgICAgICAic3R5bGUiOiAiaDIiDQogICAgICAgIH0NCiAgICBdDQp9Cg==",import.meta.url).href},{key:"garden",url:new URL("data:application/json;base64,ewogICAgIm1ldGEiOiB7CiAgICAgICAgImlkIjogIm1hcDpnYXJkZW4iLAogICAgICAgICJ2ZXJzaW9uIjogMSwKICAgICAgICAic2l6ZSI6IHsKICAgICAgICAgICAgInciOiA2NDAsCiAgICAgICAgICAgICJoIjogNjQwCiAgICAgICAgfQogICAgfSwKICAgICJzcGF3blBvaW50cyI6IHsKICAgICAgICAibG9iYnkiOiB7ICJ4IjogMzIwLCAieSI6IDQ4MCB9LAogICAgICAgICJnYXJkZW4iOiB7ICJ4IjogMzE5LCAieSI6IDU5OSB9CiAgICB9LAogICAgIndhbGthYmxlIjogWwogICAgICAgIHsgInR5cGUiOiAicmVjdCIsICJ4IjogMCwgInkiOiAwLCAidyI6IDY0MCwgImgiOiA2NDAsICJ0YWciOiAiZ2FyZGVuX2Zsb29yIiB9CiAgICBdLAogICAgIm9ic3RhY2xlcyI6IFsKICAgICAgICB7ICJ0eXBlIjogInJlY3QiLCAieCI6IDAsICJ5IjogMCwgInciOiA2NDAsICJoIjogMjAsICJ0YWciOiAiZ2FyZGVuOndhbGxfbm9ydGgiIH0sCiAgICAgICAgeyAidHlwZSI6ICJyZWN0IiwgIngiOiAwLCAieSI6IDYyMCwgInciOiA2NDAsICJoIjogMjAsICJ0YWciOiAiZ2FyZGVuOndhbGxfc291dGgiIH0sCiAgICAgICAgeyAidHlwZSI6ICJyZWN0IiwgIngiOiAwLCAieSI6IDAsICJ3IjogMjAsICJoIjogNjQwLCAidGFnIjogImdhcmRlbjp3YWxsX3dlc3QiIH0sCiAgICAgICAgeyAidHlwZSI6ICJyZWN0IiwgIngiOiA2MjAsICJ5IjogMCwgInciOiAyMCwgImgiOiA2NDAsICJ0YWciOiAiZ2FyZGVuOndhbGxfZWFzdCIgfSwKICAgICAgICB7ICJ0eXBlIjogInJlY3QiLCAieCI6IDEwNCwgInkiOiAyMzAsICJ3IjogMTc2LCAiaCI6IDEyNiwgInRhZyI6ICJnYXJkZW46cG9uZF9sZWZ0IiB9LAogICAgICAgIHsgInR5cGUiOiAicmVjdCIsICJ4IjogMzYyLCAieSI6IDI1NCwgInciOiAxNzYsICJoIjogMTI2LCAidGFnIjogImdhcmRlbjpwb25kX3JpZ2h0IiB9CiAgICBdLAogICAgInpvbmVzIjogW10sCiAgICAiZGVjb3IiOiBbXSwKICAgICJkZXNrcyI6IFtdLAogICAgInNwb3RzIjogWwogICAgICAgIHsKICAgICAgICAgICAgImlkIjogInNwb3Q6Z2FyZGVuX3NocmluZSIsCiAgICAgICAgICAgICJhcmVhSWQiOiAiYXJlYTpnYXJkZW4iLAogICAgICAgICAgICAia2luZCI6ICJhY3Rpb25fc3BvdCIsCiAgICAgICAgICAgICJsYWJlbCI6ICJTaHJpbmUgQXVkaW8iLAogICAgICAgICAgICAicHJpb3JpdHkiOiAyMCwKICAgICAgICAgICAgImJvdW5kcyI6IHsgIngiOiAyNzEsICJ5IjogNzksICJ3IjogMTAwLCAiaCI6IDEwMCB9LAogICAgICAgICAgICAiaW50ZXJhY3RQb2ludCI6IHsgIngiOiAzMjEsICJ5IjogMTI5IH0sCiAgICAgICAgICAgICJhY3Rpb24iOiB7ICJ0eXBlIjogIm9wZW5CZ21TZWxlY3RvciIsICJ0aXRsZSI6ICJTaHJpbmUgQXVkaW8iIH0KICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgImlkIjogInNwb3Q6Z2FyZGVuOnRlYWhvdXNlX2FtYmllbnQiLAogICAgICAgICAgICAiYXJlYUlkIjogImFyZWE6Z2FyZGVuIiwKICAgICAgICAgICAgImtpbmQiOiAiYWN0aW9uX3Nwb3QiLAogICAgICAgICAgICAibGFiZWwiOiAiQW1iaWVudCIsCiAgICAgICAgICAgICJwcmlvcml0eSI6IDUwLAogICAgICAgICAgICAiYm91bmRzIjogeyAieCI6IDQ0MCwgInkiOiAxMjAsICJ3IjogMTIwLCAiaCI6IDkwIH0sCiAgICAgICAgICAgICJpbnRlcmFjdFBvaW50IjogeyAieCI6IDUwMCwgInkiOiAxNjUgfSwKICAgICAgICAgICAgImFjdGlvbiI6IHsgInR5cGUiOiAib3BlbkFtYmllbnRQYXJ0aWNsZXMiLCAidGl0bGUiOiAiQW1iaWVudCBQYXJ0aWNsZXMiIH0KICAgICAgICB9CiAgICBdCn0K",import.meta.url).href},{key:"library",url:new URL("data:application/json;base64,ewogICJtZXRhIjogewogICAgImlkIjogIm1hcDpsaWJyYXJ5IiwKICAgICJ2ZXJzaW9uIjogMSwKICAgICJ3aWR0aCI6IDUxMiwKICAgICJoZWlnaHQiOiA1MTIsCiAgICAiaW1hZ2UiOiAiYXNzZXRzL21hcHMvbGlicmFyeS5wbmciCiAgfSwKICAic3Bhd25Qb2ludHMiOiB7CiAgICAibG9iYnkiOiB7CiAgICAgICJ4IjogMjU2LAogICAgICAieSI6IDEyMAogICAgfQogIH0sCiAgInpvbmVzIjogWwogICAgewogICAgICAiaWQiOiAiTGlicmFyeUhhbGwiLAogICAgICAiYm91bmRzIjogewogICAgICAgICJ4IjogNjQsCiAgICAgICAgInkiOiA0OCwKICAgICAgICAidyI6IDM4NCwKICAgICAgICAiaCI6IDMwNAogICAgICB9CiAgICB9LAogICAgewogICAgICAiaWQiOiAiTG91bmdlQmxvY2tlZCIsCiAgICAgICJib3VuZHMiOiB7CiAgICAgICAgIngiOiAwLAogICAgICAgICJ5IjogMzUyLAogICAgICAgICJ3IjogNTEyLAogICAgICAgICJoIjogMTYwCiAgICAgIH0KICAgIH0KICBdLAogICJ3YWxrYWJsZSI6IFsKICAgIHsKICAgICAgIngiOiAyNCwKICAgICAgInkiOiAyNCwKICAgICAgInciOiA0NjQsCiAgICAgICJoIjogNDY0CiAgICB9CiAgXSwKICAib2JzdGFjbGVzIjogWwogICAgewogICAgICAiaWQiOiAid2FsbF90b3AiLAogICAgICAieCI6IDAsCiAgICAgICJ5IjogMCwKICAgICAgInciOiA1MTIsCiAgICAgICJoIjogMjAKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ3YWxsX2xlZnQiLAogICAgICAieCI6IDAsCiAgICAgICJ5IjogMCwKICAgICAgInciOiAyMCwKICAgICAgImgiOiA1MTIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ3YWxsX3JpZ2h0IiwKICAgICAgIngiOiA0OTIsCiAgICAgICJ5IjogMCwKICAgICAgInciOiAyMCwKICAgICAgImgiOiA1MTIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ3YWxsX2JvdHRvbSIsCiAgICAgICJ4IjogMCwKICAgICAgInkiOiA0OTIsCiAgICAgICJ3IjogNTEyLAogICAgICAiaCI6IDIwCiAgICB9LAogICAgewogICAgICAiaWQiOiAiYm9va3NoZWxmX3dhbGxfbGVmdCIsCiAgICAgICJ4IjogMCwKICAgICAgInkiOiA0MCwKICAgICAgInciOiA2MCwKICAgICAgImgiOiAyOTYKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJsaWJyYXJpYW5fY291bnRlcl9ibG9jayIsCiAgICAgICJ4IjogMzAwLAogICAgICAieSI6IDI4LAogICAgICAidyI6IDIxMiwKICAgICAgImgiOiAxMTIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJyb3VuZF90YWJsZSIsCiAgICAgICJ4IjogMTcwLAogICAgICAieSI6IDE4MiwKICAgICAgInciOiAxNzIsCiAgICAgICJoIjogMTM2CiAgICB9LAogICAgewogICAgICAiaWQiOiAiY2F0YWxvZ19kZXNrIiwKICAgICAgIngiOiA0MDAsCiAgICAgICJ5IjogMjE0LAogICAgICAidyI6IDYyLAogICAgICAiaCI6IDYwCiAgICB9LAogICAgewogICAgICAiaWQiOiAiY2F0YWxvZ19jaGFpciIsCiAgICAgICJ4IjogNDYyLAogICAgICAieSI6IDIzMiwKICAgICAgInciOiAzMCwKICAgICAgImgiOiA1MAogICAgfQogIF0KfQ==",import.meta.url).href},{key:"spots",url:new URL("/virtualoffice/assets/spots-Ctp-iMl6.json",import.meta.url).href}],n=await Promise.allSettled(t.map(L=>yc(L.url))),a=[],o={};if(n.forEach((L,W)=>{const J=t[W];L.status==="fulfilled"?o[J.key]=L.value:a.push({...J,error:L.reason})}),a.length){a.forEach(J=>{console.error("[loadMaps] File load failed",J.key,J.url,J.error),H(`loadMaps: FAILED file -> ${J.key}: ${J.url}`)});const L=a.map(J=>`${J.key}: ${J.url}`).join(`
`),W=`Map data load failed (${a.length}):
${L}`;throw new Error(W)}const i=o.core,s=o.desks,l=o.expansion,d=o.garden,I=o.library,p=o.spots;H("loadMaps: json loaded"),rt=new Map;const v=[...i.zones||[],...s.zones||[],...l.zones||[]],g=Ac(s),b=Rs(s.desks||[],i.meta?.size,g),y=[...i.walkable||[],...s.walkable||[],...l.walkable||[]],h=xs(v),f=[...y,...h],k=Ts(Bs(f,4,i.meta?.size),4),D=[...i.obstacles||[],...s.obstacles||[],...l.obstacles||[]],$=D.filter(L=>!Ns(L)).map(L=>({...L,source:"world"})),E=Os(b),M={meta:i.meta,size:i.meta.size,isReady:!1,isMapLoading:!0,spawnPoints:i.spawnPoints,walkableBase:y,walkableFromZones:h,walkableFinal:f,walkableInflated:k,walkable:f,worldObstacles:$,deskColliders:E,obstaclesFinal:[...$,...E],obstacles:[...$,...E],zones:v,decor:[...i.decor||[],...l.decor||[]],desks:b,deskRules:s.deskRules||{},rooms:l.rooms||[],spots:p&&p.spots?p.spots.filter(L=>(L?.areaId||"area:core")==="area:core"):[]};M.deskById=new Map,M.desks.forEach(L=>{M.deskById.set(L.id,L)}),M.spotById=new Map,M.spots.forEach(L=>{M.spotById.set(L.id,L)}),M.zoneById=new Map,M.zones.forEach(L=>{M.zoneById.set(L.id,L)}),rt.set("area:core",M);const B=Si(d,p,"area:garden");rt.set("area:garden",B);const T=Si(I,p,"area:library");return rt.set("area:library",T),e==="garden"?Lt="area:garden":e==="library"?Lt="area:library":Lt="area:core",H(`walkableBase: ${y.length}`),H(`walkableFromZones: ${h.length}`),H(`walkableFinal: ${f.length}`),H(`walkableInflated: ${k.length}`),H(`obstaclesFinal: ${D.length}`),H(`zones: ${v.length}`),H(`walkable count: ${f.length}`),H(`obstacles count: ${D.length}`),H(`worldObstacles count: ${$.length}`),H(`deskColliders count: ${E.length}`),H(`zones count: ${v.length}`),H(`walkableFromZones count: ${h.length}`),H(`desks count: ${M.desks.length}`),H(`obstacles merged: ${M.obstacles.length}`),H(`walkable merged: ${f.length}`),H(`zones merged: ${v.length}`),H(`desks=${M.desks.length} obstacles=${M.obstacles.length} walkable=${f.length} zones=${v.length}`),console.log("[DEBUG] desk0",M.desks?.[0]),H("loadMaps: officeWorld ready"),H("loadMaps: gardenWorld ready"),H("loadMaps: libraryWorld ready"),Y()}catch(t){throw H(`loadMaps: FAILED -> ${t.message}`),console.error("[loadMaps] FAILED",t),t}}function Si(e,t,n=null){const a=e.meta||{size:e.size},o=a?.size||(a?.width&&a?.height?{w:a.width,h:a.height}:null)||(e?.width&&e?.height?{w:e.width,h:e.height}:null)||e.size;a&&!a.size&&o&&(a.size={w:o.w,h:o.h});const i=e.zones||[],s=e.walkable||e.walkableBase||[],l=xs(i),d=[...s,...l],I=Ts(Bs(d,4,o),4),p=Rs(e.desks||[],o,null),g=(e.obstacles||[]).filter(h=>!Ns(h)).map(h=>({...h,source:"world"})),b=Os(p),y={meta:a,size:o,spawnPoints:e.spawnPoints||{lobby:{x:260,y:260}},isReady:!1,isMapLoading:!0,walkableBase:s,walkableFromZones:l,walkableFinal:d,walkableInflated:I,walkable:d,worldObstacles:g,deskColliders:b,obstaclesFinal:[...g,...b],obstacles:[...g,...b],zones:i,decor:e.decor||[],desks:p,deskRules:e.deskRules||{},rooms:e.rooms||[],spots:hc(e,t,n)};return y.deskById=new Map,y.desks.forEach(h=>y.deskById.set(h.id,h)),y.spotById=new Map,y.spots.forEach(h=>y.spotById.set(h.id,h)),y.zoneById=new Map,y.zones.forEach(h=>y.zoneById.set(h.id,h)),y}function hc(e,t,n){const a=e?.spots&&Array.isArray(e.spots)?e.spots:[],o=t&&Array.isArray(t.spots)?t.spots:[];if(!n)return[...a,...o];const i=o.filter(s=>s?.areaId===n);return[...a,...i]}function xs(e=[]){const t=[];return e.forEach(n=>{const a=n?.bounds;if(!a)return;const o=n.walkable===!0,i=String(n.type||n.kind||"").toLowerCase(),s=String(n.id||"").toLowerCase();let l=!1;o||i==="floor"?l=!0:(s.includes("floor")||s.includes("room")||s.includes("desk"))&&(l=!0,console.warn("[loadMaps] walkableFromZones fallback by id match",n.id)),l&&t.push({x:a.x,y:a.y,w:a.w,h:a.h,tag:n.id||"zone"})}),t}function Bs(e=[],t=0,n=null){if(!t)return e.slice();const a=n?.w??1/0,o=n?.h??1/0;return e.map(i=>{const s=i.x-t,l=i.y-t,d=i.w+t*2,I=i.h+t*2,p=Math.max(0,s),v=Math.max(0,l),g=Math.min(a,s+d)-p,b=Math.min(o,l+I)-v;return{...i,x:p,y:v,w:Math.max(0,g),h:Math.max(0,b)}}).filter(i=>i.w>0&&i.h>0)}function Ts(e=[],t=0){const n=e.slice(),a=[];for(;n.length>0;){let o=n.pop(),i=!0;for(;i;){i=!1;for(let s=n.length-1;s>=0;s--){const l=n[s];vc(o,l,t)&&(o=wc(o,l),n.splice(s,1),i=!0)}}a.push(o)}return a}function vc(e,t,n){return!(e.x>t.x+t.w+n||e.x+e.w+n<t.x||e.y>t.y+t.h+n||e.y+e.h+n<t.y)}function wc(e,t){const n=Math.min(e.x,t.x),a=Math.min(e.y,t.y),o=Math.max(e.x+e.w,t.x+t.w),i=Math.max(e.y+e.h,t.y+t.h);return{x:n,y:a,w:o-n,h:i-a,tag:e.tag||t.tag}}function Ns(e){return String(e?.tag||"").toLowerCase().includes("desk")}function Os(e=[]){return e.map(t=>{const n=Cc(t),a=n.x+n.w/2-18,o=n.y+8;return{x:a,y:o,w:36,h:16,tag:`desk:${t.id}`,id:t.id,kind:"desk",source:"desk"}})}function Cc(e){if(e.boundsAbs)return{x:e.boundsAbs.x,y:e.boundsAbs.y,w:e.boundsAbs.w,h:e.boundsAbs.h};if(e.posAbs){const t=Ai.desk.width,n=Ai.desk.height;return{x:e.posAbs.x-t/2,y:e.posAbs.y-n/2,w:t,h:n}}return e.standPointAbs?{x:e.standPointAbs.x-120/2,y:e.standPointAbs.y+8,w:120,h:90}:{x:0,y:0,w:120,h:90}}function Rs(e=[],t,n){const a=t?.w||t?.width||0,o=t?.h||t?.height||0,i=t?.tileSize||16;let s=0,l=0,d=1/0,I=1/0;e.forEach(h=>{[h.pos,h.standPoint].filter(Boolean).forEach(k=>{Number.isFinite(k.x)&&(s=Math.max(s,k.x),d=Math.min(d,k.x)),Number.isFinite(k.y)&&(l=Math.max(l,k.y),I=Math.min(I,k.y))})});const p=isFinite(d)?s-d:0,v=isFinite(I)?l-I:0,g=a&&o&&s<=a&&l<=o;let b=1;a&&o&&s<=a/4&&l<=o/4&&(b=i);const y=!g&&n&&p>0&&v>0;return e.map(h=>{const f={...h},k=h.pos?{x:h.pos.x*b,y:h.pos.y*b}:null,D=h.standPoint?{x:h.standPoint.x*b,y:h.standPoint.y*b}:null;let $=k,E=D;if(y&&k){const M=(k.x-d)/(p||1),B=(k.y-I)/(v||1);$={x:n.x+M*n.w,y:n.y+B*n.h}}if(y&&D){const M=(D.x-d)/(p||1),B=(D.y-I)/(v||1);E={x:n.x+M*n.w,y:n.y+B*n.h}}return a&&o&&E&&(E.x<0||E.x>a||E.y<0||E.y>o)&&(console.warn("[desk] standPointAbs out of bounds -> fallback to posAbs",h.id,E,{W:a,H:o}),E=$),f.posRaw=k,f.standPointRaw=D,f.posAbs=$,f.standPointAbs=E,f.pos=$,f.standPoint=E,f.__debug={posAbs:$,standAbs:E,floorRect:n},a&&o&&[f.posAbs,f.standPointAbs].filter(Boolean).forEach(B=>{(B.x<0||B.x>a||B.y<0||B.y>o)&&console.warn("[desk] out of bounds",h.id,B.x,B.y,a,o,h)}),f})}function Ac(e){const n=(e?.walkable||[]).find(i=>i.tag==="assigned_desks_floor");if(n)return{x:n.x,y:n.y,w:n.w,h:n.h};const o=(e?.zones||[]).find(i=>i.id==="zone:desks");return o?.bounds?{x:o.bounds.x,y:o.bounds.y,w:o.bounds.w,h:o.bounds.h}:null}function Y(e=null){const t=e||Lt;return rt?.has(t)?rt.get(t):null}function Ei(e="lobby",t=null){const n=Y(t);return n?n.spawnPoints?.[e]||n.spawnPoints?.lobby||{x:260,y:260}:{x:260,y:260}}function $s(e=null){return Y(e)?.desks||[]}function Mi(e,t=null){return Y(t)?.deskById?.get(e)||null}function Xn(e=null){return Y(e)?.spots||[]}function Za(e,t=null){return Y(t)?.spotById?.get(e)||null}function kc(e){rt?.has(e)?(Lt=e,H(`setActiveArea: ${e}`)):(console.warn("[mapLoader] setActiveArea failed (unknown areaId):",e),H(`setActiveArea: FAILED unknown ${e}`))}function mn(){return Lt}const No=14,Oo=0;function ae(e,t){const n=Y();if(!n||!$o(n,e,t))return!1;const a=Qn(n);if(!a||a.length===0)return!1;let o=!1;for(const i of a)if(Ro(e,t,i,Oo)){o=!0;break}if(!o)return!1;if(!Fs()){const i=Ws(n);for(const s of i)if(js(e,t,No,s))return!1}return!0}function Ps(e,t){const n=Y();if(!n)return{ok:!1,reason:"no_world"};if(!$o(n,e,t))return{ok:!1,reason:"out_of_world"};let a=!1,o=null,i=1/0;const s=Qn(n);if(!s||s.length===0)return{ok:!1,reason:"no_walkable"};for(const l of s){if(Ro(e,t,l,Oo)){a=!0;break}const d=Math.max(l.x,Math.min(e,l.x+l.w)),I=Math.max(l.y,Math.min(t,l.y+l.h)),p=Math.sqrt((e-d)**2+(t-I)**2);p<i&&(i=p,o=l.tag||"unnamed")}if(!a)return{ok:!1,reason:"not_in_walkable_final",nearestArea:o,distance:Math.round(i)};if(!Fs()){const l=Ws(n);for(const d of l)if(js(e,t,No,d))return{ok:!1,reason:"hit_obstacle",obstacle:d.tag||d}}return{ok:!0,reason:"ok"}}function Hs(e,t,n=0){return t?e.x>=t.x+n&&e.x<=t.x+t.w-n&&e.y>=t.y+n&&e.y<=t.y+t.h-n:!1}function Li(e,t,n=0){if(!t||t.length===0)return{hit:!1,count:0};let a=0;for(const o of t)Hs(e,o,n)&&(a+=1);return{hit:a>0,count:a}}function Sc(e){return Ot(e.x,e.y)}function Ro(e,t,n,a=0){return e>=n.x+a&&e<=n.x+n.w-a&&t>=n.y+a&&t<=n.y+n.h-a}function js(e,t,n,a){const o=Math.max(a.x,Math.min(e,a.x+a.w)),i=Math.max(a.y,Math.min(t,a.y+a.h)),s=e-o,l=t-i;return s*s+l*l<n*n}function Ot(e,t){const n=Y();if(!n)return{x:e,y:t};if(!$o(n,e,t))return{x:e,y:t};const a=Oo;let o=null,i=1/0;const s=Qn(n);if(!s||s.length===0)return{x:e,y:t};for(const l of s){const d=l.x+a,I=l.y+a,p=l.x+l.w-a,v=l.y+l.h-a;if(p<=d||v<=I)continue;const g=Math.max(d,Math.min(e,p)),b=Math.max(I,Math.min(t,v)),y=e-g,h=t-b,f=y*y+h*h;f<i&&(i=f,o={x:g,y:b})}if(o&&!ae(o.x,o.y)){let I=null,p=1/0;for(let v=8;v<=120;v+=8){for(let g=0;g<360;g+=20){const b=g*Math.PI/180,y=o.x+Math.cos(b)*v,h=o.y+Math.sin(b)*v;if(ae(y,h)){const f=(y-e)**2+(h-t)**2;f<p&&(p=f,I={x:y,y:h})}}if(I)break}if(I)return I}return o||{x:e,y:t}}function Ec(e,t,n,a){const o=()=>{if(ae(n,a))return{x:n,y:a,reason:"direct",pathLen:Math.hypot(n-e,a-t)};const l=Ot(n,a);if(ae(l.x,l.y))return{x:l.x,y:l.y,reason:"snap",pathLen:Math.hypot(l.x-e,l.y-t)};const d=[24,48,72,96,120];let I=null,p=1/0;function v(y,h,f,k,D,$){const E=D-f,M=$-k,B=y-f,T=h-k,L=E*E+M*M;if(L===0)return Math.hypot(y-f,h-k);let W=(B*E+T*M)/L;W=Math.max(0,Math.min(1,W));const J=f+E*W,nt=k+M*W;return Math.hypot(y-J,h-nt)}for(const y of d)for(let h=0;h<360;h+=20){const f=h*Math.PI/180,k=n+Math.cos(f)*y,D=a+Math.sin(f)*y;if(!ae(k,D))continue;const $=Math.hypot(k-n,D-a),E=v(k,D,e,t,n,a),M=$*1+E*1.5;M<p&&(p=M,I={x:k,y:D,r:y})}if(I)return{x:I.x,y:I.y,reason:`nearby:${I.r}`,pathLen:Math.hypot(I.x-e,I.y-t)};const g=16,b=320;for(let y=g;y<=b;y+=g)for(let h=0;h<360;h+=30){const f=h*Math.PI/180,k=n+Math.cos(f)*y,D=a+Math.sin(f)*y;if(ae(k,D))return{x:k,y:D,reason:`search:${y}`,pathLen:Math.hypot(k-e,D-t)}}return{x:e,y:t,reason:"stuck",pathLen:0}};let i=o();return i.reason!=="stuck"?i:Mc(e,t,n,a)&&(i=o(),i.reason!=="stuck")?{...i,reason:`bridge:${i.reason}`}:i}function _i(e,t){const n=Y();if(!n)return null;for(const a of n.zones){const o=a.interactBounds||a.bounds;if(Ro(e,t,o,0))return a}return null}let vn=!1;function Qn(e){const t=e.walkableInflated||e.walkableFinal||e.walkable||[];return t.length>0?t:e.zones&&e.zones.length>0?(vn||(console.warn("[collision] walkableFinal empty; falling back to zones"),vn=!0),e.zones.map(n=>n.bounds).filter(Boolean)):(vn||(console.warn("[collision] no walkable data available"),vn=!0),[])}function Mc(e,t,n,a){const o=Y();if(!o||o._bridgeRects&&o._bridgeRects.length>=12)return!1;const i=Ot(e,t),s=Ot(n,a);if(!Number.isFinite(i.x)||!Number.isFinite(i.y)||!Number.isFinite(s.x)||!Number.isFinite(s.y)||!ae(i.x,i.y)||!ae(s.x,s.y)||Math.hypot(s.x-i.x,s.y-i.y)<8)return!1;const d=Lc(i,s,24);return d?(o.walkableInflated||(o.walkableInflated=[]),o.walkableInflated.push(d),o._bridgeRects||(o._bridgeRects=[]),o._bridgeRects.push(d),console.warn("[collision] bridge added",{start:{x:Math.round(i.x),y:Math.round(i.y)},goal:{x:Math.round(s.x),y:Math.round(s.y)},bridge:d}),!0):!1}function Lc(e,t,n){const a=t.x-e.x,o=t.y-e.y;if(!Number.isFinite(a)||!Number.isFinite(o))return null;if(Math.abs(a)>=Math.abs(o)){const d=Math.min(e.x,t.x),I=Math.abs(a),p=(e.y+t.y)/2-n/2;return{x:d,y:p,w:I,h:n,tag:"bridge:horizontal"}}const i=Math.min(e.y,t.y),s=Math.abs(o);return{x:(e.x+t.x)/2-n/2,y:i,w:n,h:s,tag:"bridge:vertical"}}function _c(e,t){const n=Y();if(!n)return 1/0;const a=Qn(n);if(!a||a.length===0)return 1/0;let o=1/0;return a.forEach(i=>{const s=Math.max(i.x,Math.min(e,i.x+i.w)),l=Math.max(i.y,Math.min(t,i.y+i.h)),d=Math.hypot(e-s,t-l);d<o&&(o=d)}),o}function Ws(e){return e.obstaclesFinal||e.obstacles||[]}function Fs(){return Vn()?.debug?.disableObstacles===!0}function $o(e,t,n){const a=e?.meta?.size||e?.size;return a?t>=0&&n>=0&&t<=a.w&&n<=a.h:!0}const Pn={sakura:{id:"sakura",label:"Ê°ú",types:[{kind:"petal",count:85,speed:12,size:[2,6],alpha:[.18,.55],drift:[-6,4],flutter:1}]},firefly:{id:"firefly",label:"Ëõç",types:[{kind:"firefly",count:55,speed:9,size:[1,3],alpha:[.16,.55],blink:1.2}]},momiji:{id:"momiji",label:"Á¥ÖËëâ",types:[{kind:"leaf",count:65,speed:12,size:[3,8],alpha:[.18,.55],drift:[-10,6],flutter:.9}]},snow:{id:"snow",label:"Èõ™",types:[{kind:"snow",count:110,speed:10,size:[1,4],alpha:[.12,.4],drift:[-2,12],flutter:.2}]}},Po="firefly";let an=null,Xa=null,on=null,Ho=Po,Hn=[],jn=!1;function Oe(e,t){return e+Math.random()*(t-e)}function Di(e,t,n){return Math.max(t,Math.min(n,e))}function Dc(e){return Pn[e]||Pn[Po]}function zs(){const e=Dc(Ho),t=on?on():{w:0,h:0},n=t.w||1,a=t.h||1,o=[];e.types.forEach(i=>{const s=Math.max(0,i.count||0);for(let l=0;l<s;l+=1){const d=Oe(15,50),I=Oe(55,75),p=Oe(48,62);o.push({kind:i.kind,x:Math.random()*n,y:Math.random()*a,size:Oe(i.size?.[0]??2,i.size?.[1]??4),alphaBase:Oe(i.alpha?.[0]??.2,i.alpha?.[1]??.5),speed:i.speed??10,drift:i.drift||[-4,4],flutter:i.flutter??0,blink:i.blink??0,phase:Math.random()*Math.PI*2,wiggle:Oe(.6,1.4),rot:Oe(-Math.PI,Math.PI),rotSpeed:Oe(-.8,.8),color:{h:d,s:I,l:p}})}}),Hn=o}function xc(e={}){an=e.getAreaId||(()=>"area:core"),Xa=e.getZoom||(()=>1),on=e.getCanvasSize||(()=>({w:0,h:0}))}function Us(e){e&&(Ho=e,zs())}function Bc(){return Ho}function Tc(e=16){if(!jn&&!(an&&an()!=="area:garden"))try{Hn.length||zs();const t=on?on():{w:0,h:0},n=t.w||1,a=t.h||1,o=e/1e3;Hn.forEach(i=>{const s=Oe(i.drift?.[0]??-2,i.drift?.[1]??2),l=(i.speed||10)*o;i.phase+=o*(i.flutter?1+i.flutter:.5),i.x+=s*o*6+Math.sin(i.phase)*i.flutter*.6,i.y+=l+Math.cos(i.phase)*i.flutter*.4,i.rot+=(i.rotSpeed||0)*o,i.x<-20&&(i.x=n+20),i.x>n+20&&(i.x=-20),i.y>a+20&&(i.y=-20),i.y<-20&&(i.y=a+20)})}catch(t){jn=!0,console.warn("[Ambient] update failed, disabling particles",t)}}function Nc(e){if(!jn&&!(an&&an()!=="area:garden")&&e)try{const t=Xa?Xa():1,n=Di(1/(t||1),.7,1.4);e.save(),Hn.forEach(a=>{const o=a.blink?.2+.8*Math.sin(a.phase*2)*.5+.5:1,i=Di(a.alphaBase*o,.05,.9),s=a.size*n,l=Math.min(.25,i*.6);switch(a.kind){case"petal":{e.save(),e.translate(a.x,a.y),e.rotate(a.rot+Math.sin(a.phase)*.6),e.fillStyle=`rgba(255, 192, 203, ${i})`,e.strokeStyle=`rgba(255, 255, 255, ${l})`,e.beginPath(),e.ellipse(0,0,s*.6,s,0,0,Math.PI*2),e.fill(),e.lineWidth=1,e.stroke(),e.restore();break}case"leaf":{e.save(),e.translate(a.x,a.y),e.rotate(a.rot+Math.cos(a.phase)*.8),e.fillStyle=`hsla(${a.color?.h??25}, ${a.color?.s??65}%, ${a.color?.l??55}%, ${i})`,e.strokeStyle=`rgba(0, 0, 0, ${l})`,e.beginPath();for(let d=0;d<10;d+=1){const I=Math.PI*2*d/10,p=d%2===0?s:s*.55,v=Math.cos(I)*p,g=Math.sin(I)*p;d===0?e.moveTo(v,g):e.lineTo(v,g)}e.closePath(),e.fill(),e.lineWidth=1,e.stroke(),e.restore();break}case"firefly":{e.fillStyle=`rgba(190, 255, 140, ${i})`,e.beginPath(),e.arc(a.x,a.y,s*.8,0,Math.PI*2),e.fill(),e.fillStyle=`rgba(190, 255, 140, ${i*.25})`,e.beginPath(),e.arc(a.x,a.y,s*2.2,0,Math.PI*2),e.fill();break}default:{e.save(),e.shadowColor="rgba(255, 255, 255, 0.35)",e.shadowBlur=3,e.fillStyle=`rgba(255, 255, 255, ${i})`,e.beginPath(),e.arc(a.x,a.y,s*.7,0,Math.PI*2),e.fill(),e.restore();break}}}),e.restore()}catch(t){jn=!0,console.warn("[Ambient] render failed, disabling particles",t)}}const xi=[{id:"day",label:"Day",overlay:"rgba(0,0,0,0)"},{id:"dusk",label:"Dusk",overlay:"rgba(255,140,80,0.10)"},{id:"night",label:"Night",overlay:"rgba(60,80,140,0.18)"}],wn=["day","dusk","night"];function Oc(e){const t=wn.indexOf(e);return t<0?wn[0]:wn[(t+1)%wn.length]}function Gs(e){return xi.find(t=>t.id===e)||xi[0]}const ma=["#fcd5c5","#f5c4a8","#e8b090","#d49a78","#c48860"],pa=["#2d1b0e","#4a3020","#8b4513","#d4a86c","#1a1a1a","#6b4423"],Ia=["#5a9bd4","#6ab077","#e6a644","#d46a6a","#7c7c7c","#9b59b6"],ba=["#34495e","#2c3e50","#5d6d7e"],Bi=["#2c2c2c","#4a3020"],Ti=["none","none","none","none","glasses","headphones"];function Rc(e){let t=0;for(let n=0;n<e.length;n++){const a=e.charCodeAt(n);t=(t<<5)-t+a,t=t&t}return Math.abs(t)}function bt(e){const t=Math.sin(e++)*1e4;return t-Math.floor(t)}function $c(e){const t=Rc(e||"default"),n=Math.floor(bt(t)*ma.length),a=Math.floor(bt(t+1)*pa.length),o=Math.floor(bt(t+2)*Ia.length),i=Math.floor(bt(t+3)*ba.length),s=Math.floor(bt(t+4)*Bi.length),l=Math.floor(bt(t+5)*Ti.length);return{skin:ma[n],skinDark:Cn(ma[n],20),hair:pa[a],hairDark:Cn(pa[a],30),shirt:Ia[o],shirtDark:Cn(Ia[o],25),pants:ba[i],pantsDark:Cn(ba[i],20),shoes:Bi[s],accessory:Ti[l],outline:"#3d3d3d"}}function Cn(e,t){const n=parseInt(e.slice(1),16),a=Math.max(0,(n>>16)-t),o=Math.max(0,(n>>8&255)-t),i=Math.max(0,(n&255)-t);return`#${(a<<16|o<<8|i).toString(16).padStart(6,"0")}`}const ya=new Map,Pc={W:"E",NW:"NE",SW:"SE"};function Hc(e,t){if(Math.abs(e)<.5&&Math.abs(t)<.5)return null;const n=Math.atan2(t,e)*180/Math.PI;return n>=-22.5&&n<22.5?"E":n>=22.5&&n<67.5?"SE":n>=67.5&&n<112.5?"S":n>=112.5&&n<157.5?"SW":n>=157.5||n<-157.5?"W":n>=-157.5&&n<-112.5?"NW":n>=-112.5&&n<-67.5?"N":n>=-67.5&&n<-22.5?"NE":"S"}function jc(e,t,n,a){const o=t||"S",i=a?n%3:1,s=`${e}:${o}:${i}`;if(ya.has(s))return ya.get(s);const l=Pc[o];let d;if(l){const I=Ni(e,l,i);d=Jc(I)}else d=Ni(e,o,i);return ya.set(s,d),d}function Ni(e,t,n){const o=document.createElement("canvas");o.width=16,o.height=16;const i=o.getContext("2d");i.imageSmoothingEnabled=!1;const s=$c(e);return Wc(i,16),Fc(i,t,n,s,16),zc(i,t,s,16),s.accessory!=="none"&&Uc(i,t,s.accessory,16),Gc(i,s.outline,16),o}function Wc(e,t){e.fillStyle="rgba(0,0,0,0.25)",e.beginPath(),e.ellipse(t/2,t-2,4,2,0,0,Math.PI*2),e.fill()}function Fc(e,t,n,a,o){const i=o/2;e.fillStyle=a.pants,e.fillRect(i-3,o-6,2,4),e.fillRect(i+1,o-6,2,4),n!==1&&(e.fillStyle=a.pantsDark,n===0?e.fillRect(i-3,o-5,2,3):e.fillRect(i+1,o-5,2,3)),e.fillStyle=a.shoes,e.fillRect(i-3,o-3,2,2),e.fillRect(i+1,o-3,2,2),e.fillStyle=a.shirt,e.fillRect(i-3,o-10,6,5),e.fillStyle=a.shirtDark,e.fillRect(i+2,o-10,1,4);const s=n===0?1:n===2?-1:0;e.fillStyle=a.shirt,e.fillRect(i-4,o-9+s,1,3),e.fillRect(i+3,o-9-s,1,3),e.fillStyle=a.skin,e.fillRect(i-4,o-7+s,1,1),e.fillRect(i+3,o-7-s,1,1)}function zc(e,t,n,a){const o=a/2,i=3;e.fillStyle=n.skin,e.fillRect(o-3,i,6,5),e.fillRect(o-2,i-1,4,1),e.fillRect(o-2,i+5,4,1),e.fillStyle=n.hair,e.fillRect(o-3,i-1,6,2),e.fillRect(o-2,i-2,4,1),t==="S"||t==="SE"||t==="SW"?(e.fillRect(o-3,i,1,2),e.fillRect(o+2,i,1,2)):t==="E"?e.fillRect(o-3,i,1,3):(t==="N"||t==="NE"||t==="NW")&&e.fillRect(o-3,i,6,3),e.fillStyle=n.hairDark,e.fillRect(o-1,i+1,2,1),t==="S"||t==="SE"||t==="SW"?(e.fillStyle="#2d2d2d",e.fillRect(o-2,i+2,1,1),e.fillRect(o+1,i+2,1,1),e.fillStyle="#ffffff",e.fillRect(o-2,i+2,1,1),e.fillRect(o+1,i+2,1,1),e.fillStyle="#2d2d2d",e.fillRect(o-2,i+2,1,1),e.fillRect(o+1,i+2,1,1)):(t==="E"||t==="NE")&&(e.fillStyle="#2d2d2d",e.fillRect(o+1,i+2,1,1))}function Uc(e,t,n,a){const o=a/2;n==="glasses"?(t==="S"||t==="SE"||t==="SW")&&(e.fillStyle="#1a1a1a",e.fillRect(o-3,5,6,1),e.fillRect(o-3,5,2,2),e.fillRect(o+1,5,2,2)):n==="headphones"&&(e.fillStyle="#2d2d2d",e.fillRect(o-4,2,1,4),e.fillRect(o+3,2,1,4),e.fillRect(o-3,1,6,1))}function Gc(e,t,n){const o=e.getImageData(0,0,n,n).data,i=[];for(let s=0;s<n;s++)for(let l=0;l<n;l++){const d=(s*n+l)*4;if(o[d+3]>0){const p=[[l-1,s],[l+1,s],[l,s-1],[l,s+1]];for(const[v,g]of p)if(v<0||v>=n||g<0||g>=n)i.push([v,g]);else{const b=(g*n+v)*4;o[b+3]===0&&i.push([v,g])}}}e.fillStyle=t,i.forEach(([s,l])=>{s>=0&&s<n&&l>=0&&l<n&&e.fillRect(s,l,1,1)})}function Jc(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");return n.imageSmoothingEnabled=!1,n.translate(e.width,0),n.scale(-1,1),n.drawImage(e,0,0),t}const Qa=new Map,qc=9,Yc=1e3/qc;function Kc(e,t,n,a,o){let i=Qa.get(e);if(i||(i={direction:"S",frame:1,frameTimer:0,isMoving:!1},Qa.set(e,i)),t&&(Math.abs(n)>.1||Math.abs(a)>.1)){const s=Hc(n,a);s&&(i.direction=s)}return i.isMoving=t,t?(i.frameTimer+=o,i.frameTimer>=Yc&&(i.frameTimer=0,i.frame=(i.frame+1)%3)):(i.frame=1,i.frameTimer=0),i}function Oi(e){return Qa.get(e)||{direction:"S",frame:1,isMoving:!1}}function Ri(e,t,n,a,o,i=1,s=!1){const l=jc(a,o.direction,o.frame,o.isMoving);if(!l)return;e.save(),e.imageSmoothingEnabled=!1;const p=16*(Math.max(1,Math.round(2*i))/i),v=t-p/2,g=n-p+4;s&&(e.shadowColor="rgba(66, 133, 244, 0.5)",e.shadowBlur=4),e.drawImage(l,0,0,16,16,v,g,p,p),e.restore()}function $i(e,t,n,a,o,i=1){e.save();const s=n-36;e.font="500 11px Inter, system-ui, sans-serif";const d=e.measureText(a).width+12,I=16,p=t-d/2;e.fillStyle="rgba(255, 255, 255, 0.92)",Vc(e,p,s,d,I,4),e.fill(),e.strokeStyle="rgba(0, 0, 0, 0.1)",e.lineWidth=1,e.stroke(),e.fillStyle="#374151",e.textAlign="center",e.textBaseline="middle",e.fillText(a,t,s+I/2);const v={online:"#22c55e",away:"#f59e0b",busy:"#ef4444",offline:"#9ca3af"};e.fillStyle=v[o]||v.online,e.beginPath(),e.arc(t+d/2-4,s+I/2,3,0,Math.PI*2),e.fill(),e.strokeStyle="#fff",e.lineWidth=1,e.stroke(),e.restore()}function Vc(e,t,n,a,o,i){e.beginPath(),e.moveTo(t+i,n),e.arcTo(t+a,n,t+a,n+o,i),e.arcTo(t+a,n+o,t,n+o,i),e.arcTo(t,n+o,t,n,i),e.arcTo(t,n,t+a,n,i),e.closePath()}let qe=null,c=null,Wn=null,x={x:0,y:0,zoom:1},z={w:0,h:0},Pi=null,ha=!1,eo=null,An=!1,va="/assets/maps/map.png",Hi=new Set,wa="";const Zc=.65,Xc=1.6,Qc=[{x:126,y:173},{x:374,y:229},{x:274,y:404},{x:529,y:423}],ed=115,td=.42,nd=.12;function ad(){return new Promise(e=>requestAnimationFrame(e))}async function od(e){return qe=e,c=qe.getContext("2d"),Wn=document.getElementById("canvas-container"),c&&(c.imageSmoothingEnabled=!1),await Js("/assets/maps/map.png"),kn(),await ad(),kn(),window.addEventListener("resize",kn),Pi=new ResizeObserver(()=>{kn()}),Pi.observe(Wn),xc({getAreaId:()=>mn(),getZoom:()=>x.zoom,getCanvasSize:()=>({w:z.w,h:z.h})}),{canvas:qe,ctx:c}}function id(){const e=window.location.pathname||"/";if(e==="/")return"/";const t=e.split("/").filter(Boolean);return t.length?`/${t[0]}/`:"/"}function sd(e){const t=String(e||"");if(!t||/^https?:\/\//i.test(t))return t;if(t.startsWith("./")||t.startsWith("../"))return new URL(t,window.location.href).href;if(t.startsWith("/")){const n=id();return`${window.location.origin}${n}${t.slice(1)}`}return new URL(t,window.location.href).href}async function Js(e){if(!e||e===va&&An)return;va=e;const t=sd(e);return Hi.has(t)||(Hi.add(t),console.log("[bg] loading:",t,"from",e)),new Promise(n=>{const a=new Image;An=!1,a.onload=()=>{eo=a,An=!0,console.log("[MapRenderer] Background image loaded:",va,a.width,"x",a.height),n()},a.onerror=o=>{An=!1,console.warn("[bg] FAILED:",t,"from",e,o),n()},a.src=t})}function kn(){if(!qe||!Wn)return;const e=Wn.getBoundingClientRect(),t=Math.floor(e.width),n=Math.floor(e.height);if(t<=0||n<=0)return;const a=window.devicePixelRatio||1;qe.width=Math.floor(t*a),qe.height=Math.floor(n*a),qe.style.width=t+"px",qe.style.height=n+"px",c.setTransform(a,0,0,a,0,0),z={w:t,h:n}}function ji(e,t,n=16.67){const a=Y();if(!a)return;const o=z.w/x.zoom,i=z.h/x.zoom,s=e,l=t,d=o/2,I=a.size.w-o/2,p=i/2,v=a.size.h-i/2,g=Math.max(d,Math.min(s,I)),b=Math.max(p,Math.min(l,v)),y=1-Math.pow(1-nd,n/16.67);x.x+=(g-x.x)*y,x.y+=(b-x.y)*y,qs()}function qs(){const e=Y();if(!e)return;const t=z.w/x.zoom,n=z.h/x.zoom,a=t/2,o=Math.max(a,e.size.w-t/2),i=n/2,s=Math.max(i,e.size.h-n/2);x.x=Math.max(a,Math.min(x.x,o)),x.y=Math.max(i,Math.min(x.y,s))}function ld(e,t,n){const a=to(t,n),i=Math.exp(-e*.0015),s=Math.max(Zc,Math.min(x.zoom*i,Xc));if(Math.abs(s-x.zoom)<1e-4)return;x.zoom=s;const l=to(t,n);x.x+=a.x-l.x,x.y+=a.y-l.y,qs()}function to(e,t){const n=e/z.w,a=t/z.h,o=n*z.w,i=a*z.h,s=z.w/2,l=z.h/2,d=(o-s)/x.zoom+x.x,I=(i-l)/x.zoom+x.y;return{x:d,y:I}}function rd(e,t){const n=z.w/2,a=z.h/2,o=(e-x.x)*x.zoom+n,i=(t-x.y)*x.zoom+a;return{x:o,y:i}}function cd(e,t,n=[],a={},o=null,i=0,s=16,l=mn(),d="day",I=null){if(!c)return;const p=Y();if(!p||p.isMapLoading||!p.isReady||!p.size||!e||!Number.isFinite(e.x)||!Number.isFinite(e.y)){ha||(ha=!0,console.warn("[render guard] skip frame",{hasWorld:!!p,hasSize:!!p?.size,isReady:p?.isReady,isMapLoading:p?.isMapLoading,playerPos:e,mapId:p?.meta?.id}));return}ha=!1,c.fillStyle="#2a2520",c.fillRect(0,0,z.w,z.h),c.save();const v=z.w/2,g=z.h/2;c.translate(v,g),c.scale(x.zoom,x.zoom),c.translate(-x.x,-x.y),eo?c.drawImage(eo,0,0,p.size.w,p.size.h):(c.fillStyle="#e8e4dc",c.fillRect(0,0,p.size.w,p.size.h)),Ys&&bd(),I&&p.desks&&md(p.desks,I),o&&gd(o.x,o.y,i),n.forEach(y=>{const h=Oi(y.actorId||y.displayName);Ri(c,y.pos.x,y.pos.y,y.displayName,h,x.zoom,!1),$i(c,y.pos.x,y.pos.y,y.displayName,y.status,x.zoom),Wi(y.pos.x,y.pos.y,y.callStatus,x.zoom)});const b=Oi(a.actorId||"me");Ri(c,e.x,e.y,a.displayName||"You",b,x.zoom,!0),$i(c,e.x,e.y,a.displayName||"You",a.status||"online",x.zoom),Wi(e.x,e.y,a.callStatus,x.zoom),window.DEBUG_COLLISION&&fd(p,e),c.restore(),Tc(s),Nc(c),dd(l,d)}function dd(e,t){if(!c)return;if(e!=="area:garden"){wa="";return}const n=Gs(t),a=n?.overlay||"rgba(0,0,0,0)",o=`${e}:${n?.id||"unknown"}`;wa!==o&&(wa=o,console.log("[TimeOverlay] applied",{areaId:e,requested:t,presetId:n?.id||"day",overlay:a})),c.save(),c.fillStyle=a,c.fillRect(0,0,z.w,z.h),c.restore(),n?.id==="night"&&ud()}function ud(){c&&(c.save(),c.globalCompositeOperation="screen",Qc.forEach(e=>{if(!e)return;const t=rd(e.x,e.y),n=Math.max(1,ed*x.zoom),a=Math.max(0,Math.min(1,td));if(t.x+n<0||t.x-n>z.w||t.y+n<0||t.y-n>z.h)return;const o=c.createRadialGradient(t.x,t.y,0,t.x,t.y,n);o.addColorStop(0,`rgba(255,235,170,${a})`),o.addColorStop(1,"rgba(255,235,170,0)"),c.fillStyle=o,c.beginPath(),c.arc(t.x,t.y,n,0,Math.PI*2),c.fill()}),c.globalCompositeOperation="source-over",c.restore())}function fd(e,t){const n=e.walkableBase||[],a=e.walkableFromZones||[],o=e.walkableInflated||e.walkableFinal||e.walkable||[],i=e.worldObstacles||e.obstaclesFinal||e.obstacles||[],s=e.deskColliders||[],l=e.zones||[],d=Xn()||[],I=e.desks||[],p=e.desks?.[0]?.__debug?.floorRect,v=window.__moveDebug,g=window.__walkDebug,b=Vn()?.debug||{},y=b.drawWorldObstacles!==!1,h=b.drawDeskColliders!==!1;c.save(),c.fillStyle="rgba(34, 197, 94, 0.18)",n.forEach(f=>{c.fillRect(f.x,f.y,f.w,f.h)}),c.fillStyle="rgba(59, 130, 246, 0.18)",a.forEach(f=>{c.fillRect(f.x,f.y,f.w,f.h)}),c.fillStyle="rgba(34, 197, 94, 0.14)",o.forEach(f=>{c.fillRect(f.x,f.y,f.w,f.h)}),c.strokeStyle="rgba(34, 197, 94, 0.85)",c.lineWidth=1.5,o.forEach(f=>{c.strokeRect(f.x,f.y,f.w,f.h)}),y&&(c.strokeStyle="rgba(251, 146, 60, 0.9)",c.lineWidth=2,c.fillStyle="rgba(251, 146, 60, 0.95)",c.font="12px sans-serif",i.forEach(f=>{c.strokeRect(f.x,f.y,f.w,f.h),f.tag&&c.fillText(String(f.tag),f.x+4,f.y+14)})),h&&(c.fillStyle="rgba(239, 68, 68, 0.22)",c.strokeStyle="rgba(239, 68, 68, 0.9)",c.lineWidth=1.5,s.forEach(f=>{c.fillRect(f.x,f.y,f.w,f.h),c.strokeRect(f.x,f.y,f.w,f.h)})),h&&I.forEach(f=>{const k=f.posAbs||f.pos,D=f.standPointAbs||f.standPoint,$=f.boundsAbs||f.bounds;$&&(c.strokeStyle="rgba(250, 204, 21, 0.9)",c.lineWidth=1,c.strokeRect($.x,$.y,$.w,$.h)),k&&(c.fillStyle="rgba(34, 197, 94, 0.95)",c.beginPath(),c.arc(k.x,k.y,3,0,Math.PI*2),c.fill()),D&&(c.fillStyle="rgba(59, 130, 246, 0.95)",c.beginPath(),c.arc(D.x,D.y,3,0,Math.PI*2),c.fill())}),h&&p&&(c.strokeStyle="rgba(168, 85, 247, 0.9)",c.lineWidth=1.5,c.strokeRect(p.x,p.y,p.w,p.h)),c.strokeStyle="rgba(59, 130, 246, 0.8)",c.lineWidth=1,c.font="12px sans-serif",c.fillStyle="rgba(59, 130, 246, 0.9)",l.forEach(f=>{const k=f.bounds;k&&(c.strokeRect(k.x,k.y,k.w,k.h),f.id&&c.fillText(f.id,k.x+4,k.y+12))}),g?.click&&(c.fillStyle="rgba(234, 179, 8, 0.9)",c.beginPath(),c.arc(g.click.x,g.click.y,4,0,Math.PI*2),c.fill()),g?.snapped&&(c.strokeStyle="rgba(34, 211, 238, 0.8)",c.lineWidth=1,c.beginPath(),c.moveTo(t.x,t.y),c.lineTo(g.snapped.x,g.snapped.y),c.stroke(),c.fillStyle="rgba(34, 211, 238, 0.9)",c.beginPath(),c.arc(g.snapped.x,g.snapped.y,4,0,Math.PI*2),c.fill()),v?.click&&v?.goal&&v?.start&&(c.strokeStyle="rgba(16, 185, 129, 0.8)",c.lineWidth=1.5,c.beginPath(),c.moveTo(v.start.x,v.start.y),c.lineTo(v.goal.x,v.goal.y),c.stroke(),c.fillStyle="rgba(239, 68, 68, 0.9)",c.beginPath(),c.arc(v.click.x,v.click.y,4,0,Math.PI*2),c.fill(),c.fillStyle="rgba(16, 185, 129, 0.9)",c.beginPath(),c.arc(v.goal.x,v.goal.y,4,0,Math.PI*2),c.fill()),c.strokeStyle="rgba(59, 130, 246, 0.85)",c.lineWidth=2,d.forEach(f=>{f.bounds?c.strokeRect(f.bounds.x,f.bounds.y,f.bounds.w,f.bounds.h):f.x!==void 0&&f.y!==void 0&&f.r!==void 0&&(c.beginPath(),c.arc(f.x,f.y,f.r,0,Math.PI*2),c.stroke())}),c.strokeStyle="rgba(255, 255, 255, 0.85)",c.lineWidth=2,c.beginPath(),c.arc(t.x,t.y,No,0,Math.PI*2),c.stroke(),c.restore()}function gd(e,t,n){const a=Date.now()-n,o=Math.min(a/500,1),i=1-o*.6,s=1+o*.4;c.save(),c.translate(e,t),c.scale(s,s),c.globalAlpha=i,c.strokeStyle="#4285f4",c.lineWidth=2,c.beginPath(),c.arc(0,0,12,0,Math.PI*2),c.stroke(),c.fillStyle="rgba(66, 133, 244, 0.25)",c.beginPath(),c.arc(0,0,8,0,Math.PI*2),c.fill(),c.fillStyle="#4285f4",c.beginPath(),c.arc(0,0,3,0,Math.PI*2),c.fill(),c.restore()}function md(e,t){if(!e||!t||!(t instanceof Map))return;const n=new Map;for(const[a,o]of t){const i=o?.seatLockedDeskId||o?.seatedDeskId;i&&n.set(i,o)}e.forEach(a=>{const o=n.get(a.id);if(!o)return;const i=a.pos||a.posAbs;if(!i)return;const s=(o.displayName||"??").slice(0,2).toUpperCase();c.save(),c.fillStyle="rgba(0,0,0,0.65)",c.beginPath(),c.roundRect(i.x-14,i.y-30,28,16,4),c.fill(),c.fillStyle="#fff",c.font="bold 10px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText(s,i.x,i.y-22),c.restore()})}function Wi(e,t,n,a=1){if(!n||n==="idle")return;const o=n==="in_call"?"#16a34a":n==="ringing"?"#f59e0b":"#0ea5e9",i=Math.max(6,6/Math.max(.7,a)),s=e+18/Math.max(.7,a),l=t-28/Math.max(.7,a);c.save(),c.fillStyle=o,c.beginPath(),c.arc(s,l,i,0,Math.PI*2),c.fill(),n==="in_call"&&(c.strokeStyle="rgba(22,163,74,0.45)",c.lineWidth=Math.max(1,2/Math.max(.7,a)),c.beginPath(),c.arc(s,l,i+3/Math.max(.7,a),0,Math.PI*2),c.stroke()),c.fillStyle="#ffffff",c.font=`${Math.max(8,8/Math.max(.7,a))}px sans-serif`,c.textAlign="center",c.textBaseline="middle",c.fillText("‚òé",s,l+.5),c.restore()}function pd(){return{...x}}let Ys=!1;function Id(e){Ys=e}function bd(){const e=Xn();c.save(),c.lineWidth=2,c.font="10px monospace",c.textAlign="left",c.textBaseline="top",e.forEach(t=>{c.beginPath();let n,a;t.id==="spot:admin"?(c.strokeStyle="#ff00ff",c.fillStyle="rgba(255, 0, 255, 0.2)"):t.id.includes("meeting")?(c.strokeStyle="#ffa500",c.fillStyle="rgba(255, 165, 0, 0.2)"):(c.strokeStyle="#00ffff",c.fillStyle="rgba(0, 255, 255, 0.2)"),t.bounds?(c.rect(t.bounds.x,t.bounds.y,t.bounds.w,t.bounds.h),n=t.bounds.x,a=t.bounds.y):t.r&&(c.arc(t.x,t.y,t.r,0,Math.PI*2),n=t.x-t.r,a=t.y-t.r),c.fill(),c.stroke();const i=`${t.label||t.id} (P:${t.priority||0})`,s=c.measureText(i);c.fillStyle="rgba(0, 0, 0, 0.7)",c.fillRect(n,a-14,s.width+4,14),c.fillStyle="#fff",c.strokeStyle="#000",c.lineWidth=2,c.strokeText(i,n+2,a-12),c.fillText(i,n+2,a-12)}),c.restore()}const yd=160;let X=null,_={x:260,y:260},ge="down",ce=!1,sn=!1,$e=null,Fi=0,te=null,Ks=null;function hd(e,t){_={...e},X=null,ce=!1,sn=!1,$e=t,console.log("[MOVE] initMovement",e)}function Vs(e,t){if(sn){console.log("[MOVE] ignored setMoveTarget because movementLocked"),Ye();return}console.log("[MOVE] setMoveTarget called",{requested:{x:Math.round(e),y:Math.round(t)}});const n=Y();if(!n){console.warn("[MOVE] No world model!");return}const a=n.walkableInflated||n.walkableFinal||n.walkable||[],o=n.deskColliders||[],i=n.worldObstacles||n.obstaclesFinal||n.obstacles||[],s=n.obstaclesFinal||n.obstacles||[],l={x:e,y:t},d=Li(l,a),I=Li(l,s),p=Sc(l),v=_i(e,t),g=d.hit?I.hit?"hit-obstacle":Math.hypot(p.x-e,p.y-t)>.5?"snap":"ok":"not-walkable";if(console.log("[MOVE] click pre-findPath",{click:{x:Math.round(e),y:Math.round(t)},start:{x:Math.round(_.x),y:Math.round(_.y)}}),console.log(`[WALKDBG] click=(${Math.round(e)},${Math.round(t)}) inWalkable=${d.hit} inObstacle=${I.hit} zone=${v?.id||"null"} constrainedBecause=${g} snapped=(${Math.round(p.x)},${Math.round(p.y)})`),I.hit){const L=zi(l,o),W=zi(l,i);console.log(L?`[WALKDBG] blockedBy=desk id=${L}`:W?`[WALKDBG] blockedBy=world id=${W}`:"[WALKDBG] blockedBy=unknown")}const b=_i(_.x,_.y),y=Ps(e,t),h=_c(e,t);if(!I.hit&&y?.reason==="hit_obstacle"){const L=String(y.obstacle||"unknown"),W=L.toLowerCase().includes("desk")?"desk":"world";console.log(`[WALKDBG] blockedBy=${W} id=${L}`)}const f=Ec(_.x,_.y,e,t);Ks=f;const k=ae(_.x,_.y),D=ae(f.x,f.y),$=Math.hypot(f.x-_.x,f.y-_.y),E=Math.hypot(e-_.x,t-_.y),M=Math.round(f.x)!==Math.round(e)||Math.round(f.y)!==Math.round(t),B=$<3,T=y?.reason==="out_of_world"?"out-of-world":y?.reason==="not_in_walkable_final"?"not-in-walkableFinal":y?.reason==="hit_obstacle"?"hit-obstacle":f.reason==="stuck"?"unreachable":B&&E>12?"snapped-to-start":"ok";if(te={click:{x:e,y:t},goal:{x:f.x,y:f.y},start:{x:_.x,y:_.y},distStartGoal:$,distClick:E,goalSnapped:M,snappedToStart:B,failReason:T},console.log("[MOVE] click/path debug",{click:{x:Math.round(e),y:Math.round(t)},goal:{x:Math.round(f.x),y:Math.round(f.y)},startInWalkableFinal:k,goalInWalkableFinal:D,nearestWalkableDist:Math.round(h),pathLen:Math.round(f.pathLen||0),failReason:T,zoneAt:v?.id||null,currentZone:b?.id||null,snapped:M,goalNearlyStart:B}),window.__moveDebug={click:{x:e,y:t},goal:{x:f.x,y:f.y},start:{x:_.x,y:_.y}},window.__walkDebug={click:{x:e,y:t},snapped:{x:p.x,y:p.y}},console.log("[MOVE] lastPathResult coords",{x:Math.round(f.x),y:Math.round(f.y),reason:f.reason}),console.log("[MOVE] findPath result",{requested:{x:Math.round(e),y:Math.round(t)},final:{x:Math.round(f.x),y:Math.round(f.y)},reason:f.reason}),B&&E>12){console.warn("[MOVE] snapped to start; treating as unreachable");return}f.reason!=="stuck"?(X={x:f.x,y:f.y},ce=!0,console.log("[MOVE] target set",X,"reason:",f.reason)):console.warn("[MOVE] findPath returned stuck for",{x:e,y:t})}function vd(e){if(sn)return Ye(),{pos:_,facing:ge,moving:!1};const t=Date.now();if(t-Fi>500&&(console.log("[MOVE] tick",{pos:_,target:X,isMoving:ce,deltaMs:e}),Fi=t),!ce||!X)return{pos:_,facing:ge,moving:!1};const n=e/1e3,a=yd*n,o=X.x-_.x,i=X.y-_.y,s=Math.sqrt(o*o+i*i);if(s<=4){const v={distToGoal:Math.round(s),goal:{x:Math.round(X.x),y:Math.round(X.y)},start:te?.start?{x:Math.round(te.start.x),y:Math.round(te.start.y)}:null,distStartGoal:te?Math.round(te.distStartGoal):null,distClick:te?Math.round(te.distClick):null,snappedToStart:te?.snappedToStart||!1};return console.log("[MOVE] arrivedCheck",v),te?.snappedToStart&&te?.distClick>12?(X=null,ce=!1,console.warn("[MOVE] fail: unreachable (snapped to start)",v),$e&&$e(_,ge,!1),{pos:_,facing:ge,moving:!1}):(_={...X},X=null,ce=!1,te=null,console.log("[MOVE] arrived",_),$e&&$e(_,ge,!1),{pos:_,facing:ge,moving:!1})}const l=a/s,d=Math.min(1,l),I=_.x+o*d,p=_.y+i*d;Math.abs(o)>Math.abs(i)?ge=o>0?"right":"left":ge=i>0?"down":"up";{const g=I-_.x,b=p-_.y,y=Math.sqrt(g*g+b*b),h=Math.max(1,Math.ceil(y/4));let f=_.x,k=_.y,D=!1,$=!1;for(let E=0;E<h;E++){const M=(E+1)/h,B=_.x+g*M,T=_.y+b*M;if(ae(B,T)){f=B,k=T,D=!0;continue}const L=ae(B,k),W=ae(f,T);if(L&&!W){f=B,D=!0;continue}if(!L&&W){k=T,D=!0;continue}if(L&&W){Math.abs(o)>=Math.abs(i)?f=B:k=T,D=!0;continue}$=!0,console.warn("[MOVE] blocked at",{tx:B,ty:T,step:E+1,steps:h});try{const J=Ps(B,T);console.warn("[MOVE] blocked reason",J)}catch{}break}_={x:f,y:k},$&&!D&&(X=null,ce=!1,te=null)}return $e&&$e(_,ge,ce),{pos:_,facing:ge,moving:ce}}function wd(){X=null,ce=!1,te=null}function Ye(){try{wd()}catch(e){console.warn("[MOVE] stopMoving failed, forcing stop",e),X=null,ce=!1,te=null}}function At(e,t){_=Ot(e,t),X=null,ce=!1,te=null,$e&&$e(_,ge,!1)}function dt(){return{..._}}function Fn(){return ge}function Sn(){return ce}function Ca(){return X?{...X}:null}function yt(e){sn=!!e,sn&&Ye()}function zi(e,t){if(!t||t.length===0)return null;for(const n of t)if(Hs(e,n,0))return n.id||n.tag||"unknown";return null}const Cd=40;function Zs(e,t){const n=Xn(),a=[],o=mn();for(const i of n)if(i?.areaId===o){if(i.x!==void 0&&i.y!==void 0&&i.r!==void 0){const s=e-i.x,l=t-i.y;Math.sqrt(s*s+l*l)<=i.r&&a.push(i)}else if(i.bounds){const s=i.bounds;e>=s.x&&e<=s.x+s.w&&t>=s.y&&t<=s.y+s.h&&a.push(i)}}return a.sort((i,s)=>(s.priority||0)-(i.priority||0))}function Xs(e,t){const n=Zs(e,t);return n.length>0?n[0]:null}function Ad(e,t){const n=$s();let a=null,o=Cd;for(const i of n){const s=i.standPointAbs||i.standPoint||i.posAbs||i.pos;if(i.standPointAbs||console.warn("[desk] missing standPointAbs",i.id),!s)continue;const l=e-s.x,d=t-s.y,I=Math.sqrt(l*l+d*d);I<o&&(a=i,o=I)}if(a){const i=a.standPoint||a.pos;console.log("[desk] nearest",a.id,Math.round(o),e,t,i?.x,i?.y)}return a}function kd(e,t){const n=Xs(e,t);if(n)return{kind:"spot",data:n};const a=$s();for(const o of a){const i=o.boundsAbs||o.colliderAbs;if(i){if(e>=i.x&&e<=i.x+i.w&&t>=i.y&&t<=i.y+i.h)return{kind:"desk",data:o};continue}const s=o.posAbs||o.pos;if(!s)continue;const l=e-s.x,d=t-s.y,I=60;if(Math.abs(l)<I/2&&Math.abs(d)<I/2)return{kind:"desk",data:o}}return{kind:null,data:null}}function Ui(e,t,n,a=null){if(e){const o=Za(e);return o?o.label:e}return a?`„Éá„Çπ„ÇØ ${a.replace("desk:","")} „Å´ÁùÄÂ∏≠‰∏≠`:t?`„Éá„Çπ„ÇØ ${t.replace("desk:","")} „ÇíÁ¢∫‰øù‰∏≠`:n.replace("area:","")}const fe=50;function Sd(e,t){const n=[{x:fe,y:0},{x:-fe,y:0},{x:0,y:fe},{x:0,y:-fe},{x:fe,y:fe},{x:-fe,y:fe},{x:fe,y:-fe},{x:-fe,y:-fe}];for(const o of n){const i=e+o.x,s=t+o.y;if(ae(i,s))return At(i,s),{success:!0,pos:{x:i,y:s}}}const a=Ot(e,t);return ae(a.x,a.y)?(At(a.x,a.y),{success:!0,pos:a}):{success:!1,pos:dt()}}function Gi(e){return Sd(e.x,e.y)}let kt=null,Z={pos:{x:0,y:0},target:null,camera:{x:0,y:0},dt:0,lastTickMoveAt:0,lastRenderAt:0,lastClickWorld:null,isMoving:!1};function Ed(){kt=document.createElement("div"),kt.id="debug-hud",kt.style.cssText=`
    position: fixed;
    top: 60px;
    left: 10px;
    background: rgba(0, 0, 0, 0.8);
    color: #0f0;
    font-family: monospace;
    font-size: 11px;
    padding: 8px 12px;
    border-radius: 6px;
    z-index: 9999;
    pointer-events: none;
    line-height: 1.6;
    white-space: pre;
  `,document.body.appendChild(kt)}function Md(e){if(Object.assign(Z,e),!kt)return;const t=[`pos: (${Z.pos.x.toFixed(1)}, ${Z.pos.y.toFixed(1)})`,`target: ${Z.target?`(${Z.target.x.toFixed(1)}, ${Z.target.y.toFixed(1)})`:"null"}`,`camera: (${Z.camera.x.toFixed(1)}, ${Z.camera.y.toFixed(1)})`,`zoom: ${(Z.camera.zoom||1).toFixed(2)}`,`dt: ${Z.dt.toFixed(1)}ms`,`isMoving: ${Z.isMoving}`,`lastTick: ${Date.now()-Z.lastTickMoveAt}ms ago`,Z.lastClickWorld?`lastClick: (${Z.lastClickWorld.x.toFixed(1)}, ${Z.lastClickWorld.y.toFixed(1)})`:"lastClick: null",`canMoveTo: ${Z.canMoveTo??"-"}`,Z.pathReason?`pathReason: ${Z.pathReason}`:""].filter(Boolean);kt.textContent=t.join(`
`)}const Ld=/^sess_[0-9a-fA-F-]{10,}$/;function Rt(e){const t=typeof e=="string"?e:"";if(Ld.test(t))return t;const n=gs();try{_o(n)}catch{}return console.warn("[DB] fallback session_id was not sess_. regenerated.",{old:e,new:n}),n}function jo(e,t){const n=typeof e?.message=="string"?e.message:"";return n.includes(`'${t}'`)||n.includes(t)}async function Qs(e,t){t=Rt(t);const n=R();let{data:a,error:o}=await n.from("nameplates").select("user_id").eq("display_name",e).neq("user_id",t).maybeSingle();return o&&jo(o,"user_id")&&(console.warn("[DB] nameplates.user_id missing, falling back to session_id for duplicate check."),t=Rt(t),console.log("[DBG] nameplates fallback session_id =",t),{data:a,error:o}=await n.from("nameplates").select("session_id").eq("display_name",e).neq("session_id",t).maybeSingle()),o?(console.error("Error checking display name:",o),!1):a!==null}async function Wo({sessionId:e,displayName:t,avatarKey:n=null,avatarColor:a=null}){e=Rt(e);const o=R();let i=e,s=e,{data:l,error:d}=await o.from("nameplates").upsert({user_id:i,display_name:t,avatar_key:n,avatar_color:a,updated_at:new Date().toISOString()},{onConflict:"user_id"}).select().single();if(d&&jo(d,"user_id")&&(console.warn("[DB] nameplates.user_id missing, falling back to session_id for upsert."),s=Rt(s),console.log("[DBG] nameplates fallback session_id =",s),{data:l,error:d}=await o.from("nameplates").upsert({session_id:s,display_name:t,avatar_key:n,avatar_color:a,updated_at:new Date().toISOString()},{onConflict:"session_id"}).select().single()),d)throw console.error("[DB] Error upserting nameplate:",{message:d?.message,details:d?.details,hint:d?.hint,code:d?.code,raw:d}),d;return l}async function _d(){const e=R(),{data:t,error:n}=await e.from("room_settings").select("*"),a=new Map;return n?(console.error("Error fetching room settings:",n),a):(t&&t.forEach(o=>{a.set(o.room_key,{zoomUrl:o.zoom_url||null,isEnabled:o.is_enabled!==!1})}),a)}async function Dd(e){e=Rt(e);const t=R();let{data:n,error:a}=await t.from("nameplates").select("*").eq("user_id",e).maybeSingle();return a&&jo(a,"user_id")&&(console.warn("[DB] nameplates.user_id missing, falling back to session_id for lookup."),e=Rt(e),console.log("[DBG] nameplates fallback session_id =",e),{data:n,error:a}=await t.from("nameplates").select("*").eq("session_id",e).maybeSingle()),a?(console.error("Error fetching nameplate by session:",a),null):n}let Ae=null,zn=[],Ji=[],_t=null;const Pe={onPresenceChange:null,onEvent:null,onChat:null};function xd({supabase:e,me:t,onPresenceChange:n,onEvent:a,onChat:o}){Pe.onPresenceChange=n,Pe.onEvent=a,Pe.onChat=o}async function Bd({presenceChannelKey:e,initialState:t}){const n=R();return _t={...t||{}},Ae=n.channel(e,{config:{presence:{key:t.actorId}}}),Ae.on("presence",{event:"sync"},()=>{const a=Ae.presenceState();Pe.onPresenceChange&&Pe.onPresenceChange(a)}).on("presence",{event:"join"},({key:a,newPresences:o})=>{console.log("Presence join:",a,o)}).on("presence",{event:"leave"},({key:a,leftPresences:o})=>{console.log("Presence leave:",a,o)}).subscribe(async a=>{a==="SUBSCRIBED"&&await Ae.track(_t||{})}),Ae}async function ht(e){Ae&&(!e||typeof e!="object"||(_t={..._t||{},...e},await Ae.track(_t)))}async function Td(){Ae&&(await Ae.untrack(),await Ae.unsubscribe(),Ae=null,_t=null)}function Nd({myActorId:e}){const t=R(),n=t.channel(`evt:to:${e}`);n.on("broadcast",{event:"evt"},o=>{const i=o?.payload;if(!(!Pe.onEvent||!i))try{Pe.onEvent(i)}catch(s){console.error("[realtime] onEvent callback failed (direct)",s,i)}}).subscribe(),zn.push(n);const a=t.channel("evt:all");a.on("broadcast",{event:"evt"},o=>{const i=o?.payload;if(!(!Pe.onEvent||!i))try{Pe.onEvent(i)}catch(s){console.error("[realtime] onEvent callback failed (all)",s,i)}}).subscribe(),zn.push(a)}async function Xe(e,{type:t,payload:n}){const o=R().channel(`evt:to:${e}`);await o.subscribe(),await o.send({type:"broadcast",event:"evt",payload:{type:t,...n}}),setTimeout(()=>o.unsubscribe(),1e3)}async function Od(){await Td();for(const e of zn)await e.unsubscribe();zn=[];for(const e of Ji)await e.unsubscribe();Ji=[]}let ea="none",ln=null;function Rd(e){ln=e,document.querySelectorAll("#menubar .nav-btn[data-drawer]").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.drawer;$d(a)})})}function $d(e){ea===e?rn():Bn(e)}function Bn(e){ea=e,el(),ln&&ln(e)}function rn(){ea="none",el(),ln&&ln("none")}function el(){document.querySelectorAll("#menubar .nav-btn[data-drawer]").forEach(t=>{const n=t.dataset.drawer===ea;t.classList.toggle("active",n)})}function Un(e){const t=document.getElementById("my-display-name");t&&(t.textContent=e)}function qi(e){const t=document.getElementById("my-status-dot");t&&(t.className="status-dot",e!=="online"&&t.classList.add(e))}function Pd({hasUnread:e=!1,count:t=0}={}){const n=document.getElementById("chat-unread-dot"),a=Math.max(0,Number(t)||0);n&&n.classList.toggle("visible",!!e||a>0)}const Hd=4e3;function O(e,t="info"){const n=document.getElementById("toast-container");if(!n)return;const a=document.createElement("div");a.className="toast";const o={info:"üí¨",success:"‚úÖ",warning:"‚ö†Ô∏è",error:"‚ùå",poke:"üëÜ"};a.innerHTML=`
    <span class="toast-icon">${o[t]||o.info}</span>
    <span class="toast-message">${jd(e)}</span>
    <button class="toast-close">√ó</button>
  `,a.querySelector(".toast-close").addEventListener("click",()=>Yi(a)),n.appendChild(a),setTimeout(()=>Yi(a),Hd)}function Yi(e){e.parentElement&&(e.classList.add("leaving"),setTimeout(()=>{e.parentElement&&e.parentElement.removeChild(e)},300))}function jd(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Wd(e){O(`${e} „ÅåËÇ©„Éù„É≥„Åó„Åæ„Åó„Åü`,"poke")}function tl(e){return(e instanceof Date?e:new Date(e)).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"})}function Fd(e,t){if(!e||!t)return null;const n=[String(e),String(t)].sort();return`${n[0]}:${n[1]}`}async function zd({threadKey:e,senderId:t,recipientId:n,body:a}){const o=R();if(!o)throw new Error("Supabase client is not initialized");const i={thread_key:e,sender_id:t,recipient_id:n,body:String(a||"").slice(0,500)},{data:s,error:l}=await o.from("dm_messages").insert(i).select("*").single();if(l)throw l;return s}async function Ud(e,t=200){const n=R();if(!n)throw new Error("Supabase client is not initialized");if(!e)return[];const{data:a,error:o}=await n.from("dm_messages").select("*").eq("thread_key",e).order("created_at",{ascending:!0}).limit(Math.max(1,Math.min(500,Number(t)||200)));if(o)throw o;return a||[]}async function Gd(e,t=300){const n=R();if(!n)throw new Error("Supabase client is not initialized");if(!e)return[];const{data:a,error:o}=await n.from("dm_messages").select("thread_key,sender_id,recipient_id,body,created_at").or(`sender_id.eq.${e},recipient_id.eq.${e}`).order("created_at",{ascending:!1}).limit(Math.max(1,Math.min(1e3,Number(t)||300)));if(o)throw o;return a||[]}function Jd({threadKey:e,onInsert:t,onError:n}){const a=R();if(!a||!e)return async()=>{};const o=a.channel(`dm:thread:${e}`);return o.on("postgres_changes",{event:"INSERT",schema:"public",table:"dm_messages",filter:`thread_key=eq.${e}`},i=>{try{t?.(i?.new||null)}catch(s){n?.(s)}}),o.subscribe(i=>{i==="CHANNEL_ERROR"&&n?.(new Error("dm realtime channel error"))}),async()=>{try{await a.removeChannel(o)}catch(i){n?.(i)}}}function qd({actorId:e,onInsert:t,onError:n}){const a=R();if(!a||!e)return async()=>{};const o=a.channel(`dm:inbox:${e}`);return o.on("postgres_changes",{event:"INSERT",schema:"public",table:"dm_messages"},i=>{try{const s=i?.new||null;if(!s||s.sender_id!==e&&s.recipient_id!==e)return;t?.(s)}catch(s){n?.(s)}}),o.subscribe(i=>{i==="CHANNEL_ERROR"&&n?.(new Error("dm inbox realtime channel error"))}),async()=>{try{await a.removeChannel(o)}catch(i){n?.(i)}}}async function Yd(e){const t=R();if(!t)throw new Error("Supabase client is not initialized");const n=Math.max(1,Number(e)||30),{data:a,error:o}=await t.rpc("admin_purge_dm_before",{p_days:n});if(o)throw o;return Number(a)||0}async function Kd(){const e=R();if(!e)throw new Error("Supabase client is not initialized");const{data:t,error:n}=await e.rpc("admin_purge_dm_all");if(n)throw n;return Number(t)||0}const ut="room:default";async function Vd({roomId:e=ut,message:t,senderActorId:n,senderDisplayName:a,clientMsgId:o=null}){const i=R();if(!i)throw new Error("Supabase client is not initialized");const s={room_id:e||ut,sender_actor_id:n,sender_display_name:String(a).slice(0,80),message:String(t||"").slice(0,500),client_msg_id:o||null},{data:l,error:d}=await i.from("global_messages").insert(s).select("*").single();if(d)throw d;return l}async function Zd({roomId:e=ut,limit:t=200,before:n=null}={}){const a=R();if(!a)throw new Error("Supabase client is not initialized");let o=a.from("global_messages").select("*").eq("room_id",e||ut).eq("deleted",!1).order("created_at",{ascending:!0}).limit(Math.max(1,Math.min(500,Number(t)||200)));n&&(o=o.lt("created_at",n));const{data:i,error:s}=await o;if(s)throw s;return i||[]}function Xd({roomId:e=ut,onInsert:t,onDeleteOrUpdate:n,onError:a}={}){const o=R();if(!o)return async()=>{};const i=e||ut,s=o.channel(`global:messages:${i}`);return s.on("postgres_changes",{event:"INSERT",schema:"public",table:"global_messages",filter:`room_id=eq.${i}`},l=>{try{t?.(l?.new||null)}catch(d){a?.(d)}}),s.on("postgres_changes",{event:"UPDATE",schema:"public",table:"global_messages",filter:`room_id=eq.${i}`},l=>{try{n?.(l?.new||null,l?.old||null)}catch(d){a?.(d)}}),s.on("postgres_changes",{event:"DELETE",schema:"public",table:"global_messages",filter:`room_id=eq.${i}`},l=>{try{n?.(null,l?.old||null)}catch(d){a?.(d)}}),s.subscribe(l=>{l==="CHANNEL_ERROR"&&a?.(new Error("global_messages realtime channel error"))}),async()=>{try{await o.removeChannel(s)}catch(l){a?.(l)}}}async function Qd({roomId:e=null,limit:t=200}={}){const n=R();if(!n)throw new Error("Supabase client is not initialized");let a=n.from("global_messages").select("id,created_at,room_id,sender_actor_id,sender_display_name,message,deleted").order("created_at",{ascending:!1}).limit(Math.max(1,Math.min(1e3,Number(t)||200)));e&&(a=a.eq("room_id",e));const{data:o,error:i}=await a;if(i)throw i;return o||[]}async function eu(e){const t=R();if(!t)throw new Error("Supabase client is not initialized");if(!e)return 0;const{data:n,error:a}=await t.rpc("admin_delete_global_message",{p_id:e});if(a)throw a;return Number(n)||0}async function tu(e,t=null){const n=R();if(!n)throw new Error("Supabase client is not initialized");const a=Math.max(1,Number(e)||30),{data:o,error:i}=await n.rpc("admin_purge_global_before",{p_days:a,p_room_id:t||null});if(i)throw i;return Number(o)||0}async function nu(e=null){const t=R();if(!t)throw new Error("Supabase client is not initialized");const{data:n,error:a}=await t.rpc("admin_purge_global_all",{p_room_id:e||null});if(a)throw a;return Number(n)||0}const nl="vo:lastReadDmTsByThread",au="vo.dm.lastReadAt.v1",al="vo:lastReadGlobalTs",Fo=ut;let Se=[],Dt=new Set,ta=0,cn=new Map,no=new Map,Qe=new Map,et=[],ao=wu(),Zt=hu(),be="all",$t=null,ke=null,Ki=null,Tn=null,Vi=null,ol=null,il=null,sl=null,ll=null,j=null,pe=null,Ge=null,Wt=!1;function ou({getMyName:e,getMyActorId:t,getPersonName:n,getPeople:a}){ol=e,il=t,sl=n,ll=a,document.querySelectorAll(".chat-tab").forEach(i=>{i.dataset.chatTab==="room"&&(i.disabled=!0,i.classList.add("disabled"),i.setAttribute("aria-disabled","true"),i.title="Ê∫ñÂÇô‰∏≠"),i.addEventListener("click",()=>{i.disabled||rl(i.dataset.chatTab||"all")})}),j=document.getElementById("chat-messages"),pe=document.getElementById("chat-input"),Ge=document.getElementById("chat-send"),Ge?.addEventListener("click",()=>{Zi()}),pe?.addEventListener("keydown",i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),Zi())}),du(),Uo(),Go(),dn(),je(),pl()}function iu(e){if(Wt=e,e){be==="all"&&Uo(),be==="dm"&&zo(),Pt();return}na()}function Gn(e){if(!e?.actorId)return;const t=Te();if(!t){O("DM„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error");return}$t={actorId:e.actorId,displayName:e.displayName||Ht(e.actorId)},ke=Fd(t,e.actorId),rl("dm"),zo()}function rl(e){be=e,document.querySelectorAll(".chat-tab").forEach(t=>{t.classList.toggle("active",t.dataset.chatTab===e)}),pl(),e==="dm"?(Go(),zo()):e==="all"?Uo():na(),Pt()}async function zo(){if(!ke){na(),await Go(),Pt();return}await cu(ke),uu(ke),ml(ke),gl(ke),be==="dm"&&Pt()}async function Zi(){const e=Ir(pe?.value);if(e.valid){if(be==="dm")await su(e.value);else{const t=Te();if(!t){O("„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error");return}try{const n=await Vd({roomId:Fo,message:e.value,senderActorId:t,senderDisplayName:ol?.()||"‰∏çÊòé",clientMsgId:gn()});oo(n)}catch(n){console.error("[chat] ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°Â§±Êïó",n),O("ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}}pe&&(pe.value="")}}async function su(e){const t=Te(),n=$t?.actorId,a=ke;if(!t||!n||!a){O("DM„ÅÆÈÄÅ‰ø°ÂÖà„ÅåÊú™ÈÅ∏Êäû„Åß„Åô","error");return}try{const o=await zd({threadKey:a,senderId:t,recipientId:n,body:e});Jo(o)}catch(o){console.error("[chat] DMÈÄÅ‰ø°Â§±Êïó",o),O("DMÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}}async function Uo(){await lu(),ru(),Wt&&be==="all"&&(cl(),Pt())}async function lu(){try{const t=(await Zd({roomId:Fo,limit:200})).map(ul).filter(n=>!!n);Se=t,Dt=new Set(t.map(n=>String(n.id))),dl(),je()}catch(e){console.error("[chat] ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂèñÂæóÂ§±Êïó",e),O("ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}}function ru(){Ki||(Ki=Xd({roomId:Fo,onInsert:e=>{e&&oo(e)},onDeleteOrUpdate:(e,t)=>{if(e?.deleted){Aa(e.id);return}if(!e&&t?.id){Aa(t.id);return}e&&t?.id&&String(e.id)===String(t.id)&&(Aa(e.id),oo(e))},onError:e=>{console.warn("[chat] global realtime error",e)}}))}function oo(e){const t=ul(e);if(!t)return;const n=String(t.id);if(Dt.has(n))return;if(Dt.add(n),Se.push(t),Se.length>300){const o=Se.length-300;Se.splice(0,o).forEach(s=>Dt.delete(String(s.id)))}if(Wt&&be==="all"){cl(),j&&(j.appendChild(aa(t)),j.scrollTop=j.scrollHeight);return}!(t.senderActorId&&t.senderActorId===Te())&&Ft(t.ts)>Zt&&(ta+=1,je())}function Aa(e){if(!e)return;const t=String(e);Dt.has(t)&&(Dt.delete(t),Se=Se.filter(n=>String(n.id)!==t),dl(),je(),Wt&&be==="all"&&Pt())}function cl(){const e=Se.reduce((t,n)=>Math.max(t,Ft(n.ts)),0);Zt=Math.max(Zt,e),vu(Zt),ta=0,je()}function dl(){const e=Te();ta=Se.reduce((t,n)=>!n||e&&n.senderActorId===e?t:Ft(n.ts)>Zt?t+1:t,0)}async function cu(e){try{const n=(await Ud(e,200)).map(fl).filter(a=>!!a);cn.set(e,n),no.set(e,new Set(n.map(a=>String(a.id))))}catch(t){console.error("[chat] DMÂ±•Ê≠¥ÂèñÂæóÂ§±Êïó",t,e),O("DMÂ±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}}async function Go(){const e=Te();if(!e){et=[],Qe=new Map,dn(),je();return}try{const t=await Gd(e,300),n=new Map,a=new Map;for(const o of t){const i=o?.thread_key;if(!i)continue;const s=o?.sender_id||null,l=o?.recipient_id||null,d=s===e?l:s;if(!d)continue;n.has(i)||n.set(i,{threadKey:i,peerActorId:d,peerName:Ht(d),lastMessage:o?.body||"",ts:o?.created_at||Date.now()});const I=Number(ao[i]||0),p=Ft(o?.created_at);s!==e&&p>I&&a.set(i,(a.get(i)||0)+1)}et=Array.from(n.values()),Qe=a,dn(),je()}catch(t){console.warn("[chat] DM„Çπ„É¨„ÉÉ„Éâ‰∏ÄË¶ßÂèñÂæóÂ§±Êïó",t)}}function du(){if(Vi)return;const e=Te();e&&(Vi=qd({actorId:e,onInsert:t=>{t&&Jo(t)},onError:t=>{console.warn("[chat] DM inbox realtime error",t)}}))}function uu(e){na(),Tn=Jd({threadKey:e,onInsert:t=>{t&&Jo(t)},onError:t=>{console.warn("[chat] DM realtime error",t)}})}function na(){if(!Tn)return;const e=Tn;Tn=null,Promise.resolve(e()).catch(t=>{console.warn("[chat] DM subscription cleanup failed",t)})}function Jo(e){const t=fl(e);if(!t)return;const n=t.threadKey;if(!n)return;const a=no.get(n)||new Set,o=String(t.id);if(a.has(o))return;const i=cn.get(n)||[];i.push(t),cn.set(n,i),a.add(o),no.set(n,a),pu(t);const s=Te();!Qi(n)&&t.senderId!==s&&Qe.set(n,(Qe.get(n)||0)+1),Qi(n)&&(ml(n,Ft(t.ts)),gl(n)),dn(),je(),!(!Wt||be!=="dm"||ke!==n||!j)&&(j.appendChild(aa(t)),j.scrollTop=j.scrollHeight)}function Pt(){if(j){if(j.innerHTML="",be==="dm"){fu();return}Se.length===0?j.appendChild(Nn("ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ")):Se.forEach(e=>{j.appendChild(aa(e))}),j.scrollTop=j.scrollHeight}}function fu(){if(!j)return;if(!ke||!$t?.actorId){j.appendChild(Xi("ÊúÄËøë„ÅÆDM")),et.length===0?j.appendChild(Nn("„Åæ„Å†DMÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ")):et.forEach(n=>{j.appendChild(gu(n))}),j.appendChild(Xi("Áõ∏Êâã„ÇíÈÅ∏ÊäûÔºà„Ç™„É≥„É©„Ç§„É≥Ôºâ"));const t=Iu();t.length===0?j.appendChild(Nn("„Ç™„É≥„É©„Ç§„É≥„ÅÆÁõ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ")):t.forEach(n=>{j.appendChild(mu(n))});return}const e=cn.get(ke)||[];if(e.length===0){j.appendChild(Nn(`${$t.displayName||"Áõ∏Êâã"} „Å®„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`));return}e.forEach(t=>{j.appendChild(aa(t))}),j.scrollTop=j.scrollHeight}function Nn(e){const t=document.createElement("div");return t.className="chat-empty",t.textContent=e,t}function Xi(e){const t=document.createElement("div");return t.className="chat-section-title",t.textContent=e,t}function gu(e){const t=document.createElement("button");t.className="chat-thread-item",t.type="button";const n=Qe.get(e.threadKey)||0,a=(e.lastMessage||"").slice(0,40);return t.innerHTML=`
        <div class="chat-thread-header">
            <strong>${Xt(e.peerName||"‰∏çÊòé")}</strong>
            <span class="chat-time">${tl(e.ts)}</span>
        </div>
        <div class="chat-thread-preview">${Xt(a||"„É°„ÉÉ„Çª„Éº„Ç∏„Å™„Åó")}</div>
        ${n>0?`<div class="chat-thread-unread">Êú™Ë™≠ ${n}</div>`:""}
    `,t.addEventListener("click",()=>{Gn({actorId:e.peerActorId,displayName:e.peerName})}),t}function mu(e){const t=document.createElement("button");t.className="chat-thread-item",t.type="button";const n=e.status==="online"?"„Ç™„É≥„É©„Ç§„É≥":e.status==="away"?"Èõ¢Â∏≠":e.status==="focus"?"ÈõÜ‰∏≠":"",a=e.hasHistory?"Â±•Ê≠¥„ÅÇ„Çä":"Êñ∞Ë¶èDM„ÇíÈñãÂßã";return t.innerHTML=`
        <div class="chat-thread-header">
            <strong>${Xt(e.displayName||"‰∏çÊòé")}</strong>
            <span class="chat-time">${Xt(n)}</span>
        </div>
        <div class="chat-thread-preview">${Xt(a)}</div>
    `,t.addEventListener("click",()=>{Gn({actorId:e.actorId,displayName:e.displayName})}),t}function aa(e){const t=document.createElement("div");t.className="chat-message";const n=document.createElement("div");n.className="chat-avatar",n.textContent=yu(e.name);const a=document.createElement("div");a.className="chat-body";const o=document.createElement("span");o.className="chat-name",o.textContent=e.name;const i=document.createElement("span");i.className="chat-time",i.textContent=tl(e.ts);const s=document.createElement("div");return s.className="chat-text",s.textContent=e.text,a.appendChild(o),a.appendChild(i),a.appendChild(s),t.appendChild(n),t.appendChild(a),t}function ul(e){if(!e||typeof e!="object")return null;const t=e.message||e.text||"";return t?{id:e.id||e.message_id||gn(),senderActorId:e.sender_actor_id||e.senderActorId||null,name:e.sender_display_name||e.name||"‰∏çÊòé",text:t,ts:e.created_at||e.ts||Date.now()}:null}function fl(e){if(!e||typeof e!="object")return null;const t=e.thread_key||e.threadKey||null,n=e.sender_id||e.senderId||null,a=e.recipient_id||e.recipientId||null,o=e.body||e.text||"";return!t||!n||!a||!o?null:{id:e.id||e.message_id||gn(),threadKey:t,senderId:n,recipientId:a,name:Ht(n),text:o,ts:e.created_at||e.ts||Date.now()}}function pu(e){const t=Te(),n=e.senderId===t?e.recipientId:e.senderId;if(!n)return;const a={threadKey:e.threadKey,peerActorId:n,peerName:Ht(n),lastMessage:e.text||"",ts:e.ts||Date.now()},o=et.filter(i=>i.threadKey!==e.threadKey);et=[a,...o]}function Ht(e){return e?sl?.(e)||e.slice(0,6):"‰∏çÊòé"}function Iu(){const e=Te(),t=new Map,n=ll?.();if(n&&n instanceof Map)for(const a of n.values())!a?.actorId||a.actorId===e||t.set(a.actorId,{actorId:a.actorId,displayName:a.displayName||Ht(a.actorId),status:a.status||"online",hasHistory:et.some(o=>o.peerActorId===a.actorId)});for(const a of et)if(!(!a?.peerActorId||a.peerActorId===e)){if(t.has(a.peerActorId)){const o=t.get(a.peerActorId);o.hasHistory=!0;continue}t.set(a.peerActorId,{actorId:a.peerActorId,displayName:a.peerName||Ht(a.peerActorId),status:"offline",hasHistory:!0})}return Array.from(t.values()).sort(bu)}function bu(e,t){const n=o=>o==="online"?0:o==="focus"?1:o==="away"?2:3,a=n(e.status)-n(t.status);return a!==0?a:String(e.displayName||"").localeCompare(String(t.displayName||""),"ja")}function je(){const e=Array.from(Qe.values()).reduce((n,a)=>n+(Number(a)||0),0),t=ta+e;Pd({hasUnread:t>0,count:t})}function dn(){const e=document.querySelector('.chat-tab[data-chat-tab="dm"]');if(!e)return;const t=Array.from(Qe.values()).reduce((n,a)=>n+(Number(a)||0),0);e.textContent=t>0?`DM (${t})`:"DM"}function gl(e){e&&(Qe.delete(e),dn(),je())}function ml(e,t=null){if(!e)return;let n=Number(t)||0;n||(n=(cn.get(e)||[]).reduce((o,i)=>Math.max(o,Ft(i.ts)),0)),n||(n=Date.now()),ao[e]=n,Cu(ao)}function pl(){if(!(!pe||!Ge)){if(be==="dm"){$t?.actorId?(pe.placeholder=`${$t.displayName||"Áõ∏Êâã"} „Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...`,pe.disabled=!1,Ge.disabled=!1):(pe.placeholder="DMÁõ∏Êâã„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ",pe.disabled=!0,Ge.disabled=!0),Ge.textContent="ÈÄÅ‰ø°";return}pe.placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...",pe.disabled=!1,Ge.disabled=!1,Ge.textContent="ÈÄÅ‰ø°"}}function Te(){return il?.()||null}function Qi(e){return Wt&&be==="dm"&&ke===e}function yu(e){return e?e.slice(0,2).toUpperCase():"?"}function Xt(e){const t=document.createElement("div");return t.textContent=String(e??""),t.innerHTML}function Ft(e){if(typeof e=="number"&&Number.isFinite(e))return e;const t=Number(e);if(Number.isFinite(t)&&t>0)return t;const a=new Date(e||0).getTime();return Number.isFinite(a)?a:0}function hu(){try{const e=localStorage.getItem(al),t=Number(e||0);return Number.isFinite(t)?t:0}catch{return 0}}function vu(e){try{localStorage.setItem(al,String(Number(e)||0))}catch(t){console.warn("[chat] failed to persist global lastRead",t)}}function wu(){const e=[nl,au];for(const t of e)try{const n=localStorage.getItem(t);if(!n)continue;const a=JSON.parse(n);if(!a||typeof a!="object")continue;return a}catch{}return{}}function Cu(e){try{localStorage.setItem(nl,JSON.stringify(e||{}))}catch(t){console.warn("[chat] failed to persist DM lastRead",t)}}let un=new Map,io=null,so=null,lo=null;function Au({warpCallback:e,pokeCallback:t,dmCallback:n}){io=e,so=t,lo=n}function ku(e){un=new Map,Object.entries(e).forEach(([t,n])=>{if(n&&n.length>0){const a=n[0],o=a.displayName||a.claimedByDisplayName||"‰∏çÊòé";un.set(a.actorId,{actorId:a.actorId,displayName:o,status:a.status||"online",callStatus:a.callStatus||"idle",pos:a.pos||{x:0,y:0},avatarColor:a.avatarColor||null,location:a.location||"",seatedDeskId:a.seatedDeskId||null,seatLockedDeskId:a.seatLockedDeskId||null,areaId:a.areaId||null,claimedByActorId:a.claimedByActorId||a.actorId||null,claimedByDisplayName:a.claimedByDisplayName||o})}}),Su()}function Su(){const e=document.getElementById("people-list");if(!e)return;const t=Array.from(un.values()).sort((n,a)=>n.status==="online"&&a.status!=="online"?-1:n.status!=="online"&&a.status==="online"?1:n.displayName.localeCompare(a.displayName));e.innerHTML=t.map(n=>{const a=n.seatLockedDeskId?`ü™ëüîí „Éá„Çπ„ÇØ ${n.seatLockedDeskId.replace("desk:","")}`:n.seatedDeskId?`ü™ë Á¢∫‰øù‰∏≠ ${n.seatedDeskId.replace("desk:","")}`:n.location||"",o=n.callStatus==="in_call"?"üìû ÈÄöË©±‰∏≠":n.callStatus==="calling"?"üìû Áô∫‰ø°‰∏≠":n.callStatus==="ringing"?"üìû ÁùÄ‰ø°‰∏≠":"";return`
    <div class="person-item" data-actor-id="${n.actorId}">
      <div class="person-avatar" style="background-color: ${n.avatarColor||"var(--color-avatarDefault)"}">
        ${Eu(n.displayName)}
        <div class="person-status ${n.status}"></div>
      </div>
      <div class="person-info">
        <div class="person-name-row">
          <div class="person-name">${ka(n.displayName)}</div>
          ${o?`<div class="person-call-badge">${ka(o)}</div>`:""}
        </div>
        <div class="person-location">${ka(a)}</div>
      </div>
      <div class="person-actions">
        <button class="person-action-btn" data-action="warp" title="Ëøë„Åè„Å´„ÉØ„Éº„Éó">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M12 3v18"/>
          </svg>
        </button>
        <button class="person-action-btn" data-action="poke" title="„Å§„Å§„Åè">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 12c2.5 0 4.5-2 4.5-4.5S14.5 3 12 3 7.5 5 7.5 7.5 9.5 12 12 12zm0 2c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/>
          </svg>
        </button>
        <button class="person-action-btn" data-action="dm" title="„ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </button>
      </div>
    </div>
  `}).join(""),e.querySelectorAll(".person-action-btn").forEach(n=>{n.addEventListener("click",a=>{a.stopPropagation();const i=n.closest(".person-item").dataset.actorId,s=n.dataset.action,l=un.get(i);l&&(s==="warp"&&io?io(l):s==="poke"&&so?so(l):s==="dm"&&lo&&lo(l))})})}function Eu(e){return e?e.slice(0,2).toUpperCase():"?"}function ka(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Le(){return un}let ro=null,Jn=[];function Mu({warpCallback:e}){ro=e;const t=document.getElementById("search-input");t&&t.addEventListener("input",n=>{Il(n.target.value)})}function Il(e){const t=e.toLowerCase().trim(),n=Le();t.length===0?Jn=Array.from(n.values()):Jn=Array.from(n.values()).filter(a=>a.displayName.toLowerCase().includes(t)),Lu()}function Lu(){const e=document.getElementById("search-results");if(e){if(Jn.length===0){e.innerHTML='<div style="text-align: center; padding: 20px; color: var(--color-textMuted);">Ë©≤ÂΩì„Åô„Çã„É°„É≥„Éê„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';return}e.innerHTML=Jn.map(t=>`
    <div class="person-item" data-actor-id="${t.actorId}">
      <div class="person-avatar" style="background-color: ${t.avatarColor||"var(--color-avatarDefault)"}">
        ${_u(t.displayName)}
        <div class="person-status ${t.status}"></div>
      </div>
      <div class="person-info">
        <div class="person-name">${es(t.displayName)}</div>
        <div class="person-location">${es(t.location)}</div>
      </div>
      <button class="btn btn-secondary" data-action="warp">Ëøë„Åè„Å´„ÉØ„Éº„Éó</button>
    </div>
  `).join(""),e.querySelectorAll('[data-action="warp"]').forEach(t=>{t.addEventListener("click",n=>{const o=t.closest(".person-item").dataset.actorId,i=Le().get(o);i&&ro&&ro(i)})})}}function _u(e){return e?e.slice(0,2).toUpperCase():"?"}function es(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Du(){const e=document.getElementById("search-input");e&&Il(e.value)}const co="audio.selectedMicId",uo="audio.selectedSpeakerId";function xu(){return localStorage.getItem(co)||null}function Bu(e){e?localStorage.setItem(co,e):localStorage.removeItem(co)}function Tu(){return localStorage.getItem(uo)||null}function Nu(e){e?localStorage.setItem(uo,e):localStorage.removeItem(uo)}async function Ou(){try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(o=>o.stop()),console.log("[audioDevices] permission unlocked")}catch(a){console.warn("[audioDevices] permission denied or error",a)}const e=await navigator.mediaDevices.enumerateDevices(),t=e.filter(a=>a.kind==="audioinput"),n=e.filter(a=>a.kind==="audiooutput");return console.log("[audioDevices] inputs:",t.length,"outputs:",n.length),{inputs:t,outputs:n}}function Ru(){return typeof document.createElement("audio").setSinkId=="function"}let Sa=null,Ea=null,Ma=null,La=null;function $u({nameChangeCallback:e,statusChangeCallback:t,logoutCallback:n,clearPasswordCallback:a}){Sa=e,Ea=t,Ma=n,La=a;const o=document.querySelectorAll("#theme-options .theme-option");o.forEach(p=>{p.addEventListener("click",()=>{const v=p.dataset.theme;bl(v),o.forEach(g=>g.classList.remove("active")),p.classList.add("active")})});const i=document.querySelectorAll("[data-status]");i.forEach(p=>{p.addEventListener("click",()=>{const v=p.dataset.status;i.forEach(g=>g.classList.remove("active")),p.classList.add("active"),Ea&&Ea(v)})});const s=document.getElementById("settings-name-save"),l=document.getElementById("settings-name");s&&l&&s.addEventListener("click",()=>{const p=l.value.trim();p&&Sa&&Sa(p)});const d=document.getElementById("settings-logout");d&&d.addEventListener("click",()=>{Ma&&Ma()});const I=document.getElementById("settings-clear-pw");I&&I.addEventListener("click",()=>{La&&La()}),Pu()}async function Pu(){const e=document.getElementById("audio-mic"),t=document.getElementById("audio-speaker"),n=document.getElementById("audio-speaker-hint"),a=document.getElementById("audio-refresh");if(!e||!t)return;Ru()||(t.disabled=!0,n&&(n.textContent="„Çπ„Éî„Éº„Ç´„ÉºÂàáÊõø„ÅØÊú™ÂØæÂøú„Åß„ÅôÔºàChromeÊé®Â•®Ôºâ")),e.addEventListener("change",()=>{const i=e.value;Bu(i||null),console.log("[Audio] Mic selected:",i||"default")}),t.addEventListener("change",()=>{const i=t.value;Nu(i||null),console.log("[Audio] Speaker selected:",i||"default")}),a&&a.addEventListener("click",()=>{ts()}),setTimeout(()=>{ts()},100)}async function ts(){const e=document.getElementById("audio-mic"),t=document.getElementById("audio-speaker");if(!(!e||!t))try{const{inputs:n,outputs:a}=await Ou(),o=xu(),i=Tu();e.innerHTML='<option value="">-- „Éá„Éï„Ç©„É´„Éà --</option>',n.forEach((s,l)=>{const d=s.label||`„Éû„Ç§„ÇØ ${l+1}`,I=document.createElement("option");I.value=s.deviceId,I.textContent=d,I.selected=s.deviceId===o,e.appendChild(I)}),t.innerHTML='<option value="">-- „Éá„Éï„Ç©„É´„Éà --</option>',a.forEach((s,l)=>{const d=s.label||`„Çπ„Éî„Éº„Ç´„Éº ${l+1}`,I=document.createElement("option");I.value=s.deviceId,I.textContent=d,I.selected=s.deviceId===i,t.appendChild(I)}),console.log("[Audio] Devices populated:",n.length,"inputs,",a.length,"outputs")}catch(n){console.error("[Audio] Failed to enumerate devices:",n)}}function bl(e){document.body.setAttribute("data-theme",e),xr(e)}function fo(e){const t=document.getElementById("settings-name");t&&(t.value=e)}function Hu(e){document.querySelectorAll("#theme-options .theme-option").forEach(n=>{n.classList.toggle("active",n.dataset.theme===e)})}let _a=null,Da=null;function ju({acceptCallback:e,rejectCallback:t}){_a=e,Da=t;const n=document.getElementById("call-accept"),a=document.getElementById("call-reject");n?.addEventListener("click",()=>{_a&&_a(),go()}),a?.addEventListener("click",()=>{Da&&Da(),go()})}function Wu(e){const t=document.getElementById("modal-overlay"),n=document.getElementById("modal-incoming-call"),a=document.getElementById("modal-password"),o=document.getElementById("modal-nameplate");a?.classList.add("hidden"),o?.classList.add("hidden"),n.classList.remove("hidden"),t.classList.add("visible");const i=document.getElementById("incoming-call-from");i&&(i.textContent=`${e} „Åã„Çâ„ÅÆÁùÄ‰ø°`)}function go(){const e=document.getElementById("modal-overlay");document.getElementById("modal-incoming-call").classList.add("hidden");const n=document.getElementById("modal-password"),a=document.getElementById("modal-nameplate");n?.classList.contains("hidden")&&a?.classList.contains("hidden")&&e.classList.remove("visible")}let mo=new Map,po=null,Io=null,yl=null,hl=null,vl=null,wl=null,qo=null,Yo=null,Cl=null,Al=null,kl=null,Sl=null,El=null,Ml=null;function Fu(e){po=e.openZoom,Io=e.openRoomChat,yl=e.claimDesk,hl=e.seatDesk,vl=e.leaveSeat,wl=e.unclaimDesk,qo=e.poke,Yo=e.dm,Cl=e.call,Al=e.callAccept,kl=e.callReject,Sl=e.callCancel,El=e.callMute,Ml=e.callEnd}async function zu(){mo=await _d()}function Uu(e,t={}){const n=document.getElementById("context-panel"),a=document.getElementById("context-title"),o=document.getElementById("context-actions");if(!n||!e){qn();return}const{kind:i,data:s}=e;if(i==="spot")Gu(s,a,o);else if(i==="desk")Ll(s,a,o,t);else if(i==="user")Ju(s,a,o);else{qn();return}n.classList.add("visible")}function Gu(e,t,n){t.textContent=e.label;let a="";if(e.ui?.showOpenZoom){const l=mo.get(e.roomKey)?.zoomUrl;a+=`
      <button class="btn btn-primary" id="ctx-open-zoom" ${l?"":"disabled"}>
	        ${l?"üìπ Zoom„ÇíÈñã„Åè":"Zoom URLÊú™Ë®≠ÂÆö"}
      </button>
    `}e.ui?.showRoomChat&&(a+='<button class="btn btn-secondary" id="ctx-room-chat">üí¨ „É´„Éº„É†„ÉÅ„É£„ÉÉ„Éà</button>'),n.innerHTML=a;const o=document.getElementById("ctx-open-zoom");o&&!o.disabled&&o.addEventListener("click",()=>{const s=mo.get(e.roomKey);s?.zoomUrl&&po&&po(s.zoomUrl)});const i=document.getElementById("ctx-room-chat");i&&Io&&i.addEventListener("click",()=>Io(e.id))}function Ll(e,t,n,a={}){const o=a.claimed===!0,i=a.seatLocked===!0,s=a.occupant||null,l=a.callState?.peerDisplayName||null,d=a.claimedByDisplayName||s?.claimedByDisplayName||s?.displayName||l||null,I=a.callState||{},p=a.forced===!0,v=I.status||"idle",g=I.peerActorId||null,b=I.peerDisplayName||(g?g.slice(0,6):""),y=I.startedAt?Math.max(0,Math.floor((Date.now()-I.startedAt)/1e3)):0;function h(M){switch(M){case"idle":return"ÈùûÈÄöË©±";case"calling":return"Áô∫‰ø°‰∏≠‚Ä¶";case"ringing":return"ÁùÄ‰ø°‰∏≠";case"in_call":return"ÈÄöË©±‰∏≠";default:return M||"‰∏çÊòé"}}function f(M){const B=String(Math.floor(M/60)).padStart(2,"0"),T=String(M%60).padStart(2,"0");return`${B}:${T}`}function k(){return v==="calling"?'<button class="btn btn-secondary" id="ctx-call-cancel">‚èπ „Ç≠„É£„É≥„Çª„É´</button>':v==="ringing"?`
            <button class="btn btn-primary" id="ctx-call-accept">‚úÖ ÂøúÁ≠î</button>
            <button class="btn btn-secondary" id="ctx-call-reject">‚ùå ÊãíÂê¶</button>
          `:v==="in_call"?`
            <button class="btn btn-secondary" id="ctx-call-mute">${I.muted?"üîà „Éü„É•„Éº„ÉàËß£Èô§":"üîá „Éü„É•„Éº„Éà"}</button>
            <button class="btn btn-secondary" id="ctx-call-end">‚èπ ÈÄöË©±ÁµÇ‰∫Ü</button>
          `:s?'<button class="btn btn-primary" id="ctx-call">üìû Áô∫‰ø°</button>':""}function D(){return i?'<button class="btn btn-secondary" id="ctx-stand">üö∂ Á´ã„Å§</button>':o?`
            <button class="btn btn-primary" id="ctx-seat">ü™ë ÁùÄÂ∏≠</button>
            <button class="btn btn-secondary" id="ctx-unclaim">‚Ü© Á¢∫‰øùËß£Èô§</button>
          `:'<button class="btn btn-primary" id="ctx-claim">ü™ë Â∏≠„ÇíÁ¢∫‰øù</button>'}function $(){return i?`ü™ë ÁùÄÂ∏≠‰∏≠ÔºàÁßªÂãïÂõ∫ÂÆöÔºâ${p?"ÔºàÂº∑Âà∂Ôºâ":""}`:o?"ü™ë Â∏≠„ÇíÁ¢∫‰øù‰∏≠":"ü™ë Êú™Á¢∫‰øù"}t.textContent=`„Éá„Çπ„ÇØ ${e.id.replace("desk:","")}`;let E="";E+=`<div class="context-status">${$()}</div>`,(o||i||s||d)&&(E+=`<div class="context-status">üë§ Á¢∫‰øùËÄÖ: ${Yu(d||"‰∏çÊòé")}</div>`),E+=`<div class="context-status">üìû ${h(v)}${v==="in_call"?`Ôºà${f(y)}Ôºâ`:""}${b?` / ${b}`:""}</div>`,s&&(E+=`
        <button class="btn btn-secondary" id="ctx-dm">üí¨ DM</button>
        <button class="btn btn-secondary" id="ctx-poke">üëÜ „Å§„Å§„Åè</button>
      `),E+=k(),E+=D(),n.innerHTML=E,document.getElementById("ctx-claim")?.addEventListener("click",()=>yl?.(e)),document.getElementById("ctx-seat")?.addEventListener("click",()=>hl?.(e)),document.getElementById("ctx-stand")?.addEventListener("click",()=>vl?.(e)),document.getElementById("ctx-unclaim")?.addEventListener("click",()=>wl?.(e)),document.getElementById("ctx-dm")?.addEventListener("click",()=>Yo?.(s)),document.getElementById("ctx-poke")?.addEventListener("click",()=>qo?.(s)),document.getElementById("ctx-call")?.addEventListener("click",()=>Cl?.(s)),document.getElementById("ctx-call-accept")?.addEventListener("click",()=>Al?.()),document.getElementById("ctx-call-reject")?.addEventListener("click",()=>kl?.()),document.getElementById("ctx-call-cancel")?.addEventListener("click",()=>Sl?.()),document.getElementById("ctx-call-mute")?.addEventListener("click",()=>El?.()),document.getElementById("ctx-call-end")?.addEventListener("click",()=>Ml?.())}function Ju(e,t,n){t.textContent=e.displayName,n.innerHTML=`
    <button class="btn btn-secondary" id="ctx-dm">üí¨ DM</button>
    <button class="btn btn-secondary" id="ctx-poke">üëÜ „Å§„Å§„Åè</button>
    <button class="btn btn-primary" id="ctx-warp">üìç Ëøë„Åè„Å´„ÉØ„Éº„Éó</button>
  `,document.getElementById("ctx-dm")?.addEventListener("click",()=>Yo?.(e)),document.getElementById("ctx-poke")?.addEventListener("click",()=>qo?.(e)),document.getElementById("ctx-warp")?.addEventListener("click",()=>{})}function qn(){const e=document.getElementById("context-panel");e&&e.classList.remove("visible")}function qu(e,t,n,a,o,i=!1,s=null){const l=document.getElementById("context-title"),d=document.getElementById("context-actions");l&&d&&Ll(e,l,d,{claimed:t,seatLocked:n,occupant:a,callState:o,forced:i,claimedByDisplayName:s})}function Yu(e){const t=document.createElement("div");return t.textContent=e??"",t.innerHTML}let _e=null,Je=null,Ko=!1;function Ku(){_e=document.createElement("div"),_e.id="spot-modal-overlay",_e.className="spot-modal-overlay",document.getElementById("app").appendChild(_e),Je=document.createElement("div"),Je.className="spot-modal",Je.id="modal-spot",Je.innerHTML=`
        <div class="modal-header">
            <h2 class="modal-title" id="spot-modal-title">Spot</h2>
            <button class="modal-close-btn" id="spot-modal-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="spot-modal-body"></div>
    `,_e.appendChild(Je),document.getElementById("spot-modal-close").addEventListener("click",e=>{e.stopPropagation(),xt()}),_e.addEventListener("click",e=>{e.target===_e&&xt()}),Je.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Ko&&xt()})}function Vu(e,t){if(!Je)return;document.getElementById("spot-modal-title").textContent=e;const n=document.getElementById("spot-modal-body");n.innerHTML=`
        <div class="spot-links-list">
            ${t.map(a=>`
                <a href="${a.url}" target="_blank" rel="noopener noreferrer" class="spot-link-item">
                    <div class="spot-link-header">
                        <span class="spot-link-label">${a.label}</span>
                        <svg class="spot-link-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                            <polyline points="15 3 21 3 21 9" />
                            <line x1="10" y1="14" x2="21" y2="3" />
                        </svg>
                    </div>
                    ${a.desc?`<div class="spot-link-desc">${a.desc}</div>`:""}
                    ${a.tags&&a.tags.length>0?`
                        <div class="spot-link-tags">
                            ${a.tags.map(o=>`<span class="spot-tag">${o}</span>`).join("")}
                        </div>
                    `:""}
                </a>
            `).join("")}
        </div>
    `,_l()}function Zu(e,t=[]){if(!Je)return;document.getElementById("spot-modal-title").textContent=e;const n=document.getElementById("spot-modal-body");if(!t||t.length===0)n.innerHTML=`
            <div class="bulletin-content">
                <div class="bulletin-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4;">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18" />
                        <path d="M9 21V9" />
                    </svg>
                    <p>„ÅäÁü•„Çâ„Åõ„ÉªÊõ¥Êñ∞ÊÉÖÂ†±„ÅØ„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</p>
                    <span class="bulletin-hint">ÔºàÁèæÂú®Ë®ò‰∫ã„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ</span>
                </div>
            </div>
        `;else{const a=[...t].sort((o,i)=>new Date(i.date)-new Date(o.date));n.innerHTML=`
            <div class="bulletin-list">
                ${a.map(o=>`
                    <div class="bulletin-item" onclick="this.classList.toggle('expanded')">
                        <div class="bulletin-header">
                            <span class="bulletin-title">${o.title}</span>
                            <span class="bulletin-date">${o.date}</span>
                        </div>
                        <div class="bulletin-body">${o.body.replace(/\n/g,"<br>")}</div>
                    </div>
                `).join("")}
            </div>
        `}_l()}function _l(){_e.classList.add("visible"),Ko=!0}function xt(){_e&&(_e.classList.remove("visible"),Ko=!1)}const Xu="8713",Qt="virtualoffice_admin_session",Qu=1440*60*1e3;function zt(){const e=localStorage.getItem(Qt);if(!e)return!1;try{const t=JSON.parse(e);return t.expiresAt&&Date.now()<t.expiresAt?!0:(localStorage.removeItem(Qt),!1)}catch{return localStorage.removeItem(Qt),!1}}function ef(e){if(e!==Xu)return{success:!1,error:"„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô"};const t={loggedInAt:Date.now(),expiresAt:Date.now()+Qu};return localStorage.setItem(Qt,JSON.stringify(t)),console.log("[AdminAuth] Logged in, expires:",new Date(t.expiresAt)),{success:!0}}function tf(){localStorage.removeItem(Qt),console.log("[AdminAuth] Logged out")}const Vo="virtualoffice_gallery_override",Zo="virtualoffice_news_override";let ve=null,we=null;async function nf(){const e=localStorage.getItem(Vo);if(e)try{return ve=JSON.parse(e),console.log("[ContentLoader] Loaded gallery from localStorage override"),ve}catch{console.warn("[ContentLoader] Invalid gallery override, using default")}try{return ve=await(await fetch("./data/gallery.json")).json(),console.log("[ContentLoader] Loaded gallery from file:",ve.items.length,"items"),ve}catch(t){return console.error("[ContentLoader] Failed to load gallery:",t),ve={version:1,items:[]},ve}}async function af(){const e=localStorage.getItem(Zo);if(e)try{return we=JSON.parse(e),console.log("[ContentLoader] Loaded news from localStorage override"),we}catch{console.warn("[ContentLoader] Invalid news override, using default")}try{return we=await(await fetch("./data/news.json")).json(),console.log("[ContentLoader] Loaded news from file:",we.items.length,"items"),we}catch(t){return console.error("[ContentLoader] Failed to load news:",t),we={version:1,items:[]},we}}function oa(){return ve}function ia(){return we}function en(e){localStorage.setItem(Vo,JSON.stringify(e)),ve=e,console.log("[ContentLoader] Saved gallery override:",e.items.length,"items")}function tn(e){localStorage.setItem(Zo,JSON.stringify(e)),we=e,console.log("[ContentLoader] Saved news override:",e.items.length,"items")}function of(){localStorage.removeItem(Vo),localStorage.removeItem(Zo),ve=null,we=null,console.log("[ContentLoader] Cleared overrides")}function sf(){return JSON.stringify({gallery:ve,news:we,exportedAt:new Date().toISOString()},null,2)}function lf(e){try{const t=JSON.parse(e);return t.gallery&&t.gallery.items&&en(t.gallery),t.news&&t.news.items&&tn(t.news),{success:!0}}catch(t){return{success:!1,error:t.message}}}let re=null,Xo=!1,Ke="gallery",Dl=null,xl=null;const Bl="vo:debugHudEnabled";function rf(e={}){Dl=typeof e.onDebugHudToggle=="function"?e.onDebugHudToggle:null,xl=typeof e.getDebugHudEnabled=="function"?e.getDebugHudEnabled:null,re=document.createElement("div"),re.id="admin-modal-overlay",re.className="admin-modal-overlay",re.innerHTML=`
        <div id="admin-modal" class="admin-modal">
            <div id="admin-login-view" class="admin-view">
                <h2>üîê ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥</h2>
                <input type="password" id="admin-password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" maxlength="10">
                <div id="admin-login-error" class="admin-error"></div>
                <div class="admin-buttons">
                    <button id="admin-login-btn" class="admin-btn primary">„É≠„Ç∞„Ç§„É≥</button>
                    <button id="admin-cancel-btn" class="admin-btn">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </div>
            <div id="admin-panel-view" class="admin-view" style="display:none;">
                <div class="admin-header">
                    <h2>‚öôÔ∏è ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´</h2>
                    <button id="admin-logout-btn" class="admin-btn small">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="gallery">„ÇÆ„É£„É©„É™„Éº</button>
                    <button class="admin-tab" data-tab="news">„ÅäÁü•„Çâ„Åõ</button>
                    <button class="admin-tab" data-tab="export">„Ç®„ÇØ„Çπ„Éù„Éº„Éà/„Ç§„É≥„Éù„Éº„Éà</button>
                    <button class="admin-tab" data-tab="dm">DMÁÆ°ÁêÜ</button>
                    <button class="admin-tab" data-tab="global">ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÁÆ°ÁêÜ</button>
                </div>
                <div class="form-group" id="admin-debug-hud-wrap">
                    <label class="form-checkbox" for="admin-debug-hud-toggle">
                        <input type="checkbox" id="admin-debug-hud-toggle">
                        „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫„ÇíÊúâÂäπ„Å´„Åô„Çã
                    </label>
                </div>
                <div id="admin-tab-content" class="admin-tab-content">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="admin-footer">
                    <button id="admin-save-btn" class="admin-btn primary">üíæ ‰øùÂ≠ò</button>
                    <button id="admin-close-btn" class="admin-btn">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    `,document.getElementById("app").appendChild(re),document.getElementById("admin-login-btn").addEventListener("click",ns),document.getElementById("admin-cancel-btn").addEventListener("click",Yt),document.getElementById("admin-logout-btn").addEventListener("click",cf),document.getElementById("admin-save-btn").addEventListener("click",df),document.getElementById("admin-close-btn").addEventListener("click",Yt),document.getElementById("admin-debug-hud-toggle")?.addEventListener("change",uf),document.getElementById("admin-password").addEventListener("keydown",t=>{t.key==="Enter"&&ns()}),re.querySelectorAll(".admin-tab").forEach(t=>{t.addEventListener("click",()=>{Ke=t.dataset.tab,re.querySelectorAll(".admin-tab").forEach(n=>n.classList.remove("active")),t.classList.add("active"),ue()})}),re.addEventListener("click",t=>{t.target===re&&Yt()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&Xo&&Yt()})}function Tl(){re&&(zt()?(document.getElementById("admin-login-view").style.display="none",document.getElementById("admin-panel-view").style.display="block",Nl(),ue()):(document.getElementById("admin-login-view").style.display="block",document.getElementById("admin-panel-view").style.display="none",document.getElementById("admin-password").value="",document.getElementById("admin-login-error").textContent="",fn(!1)),re.classList.add("visible"),Xo=!0,setTimeout(()=>{document.getElementById("admin-password")?.focus()},100))}function Yt(){re&&(re.classList.remove("visible"),Xo=!1)}function ns(){const e=document.getElementById("admin-password").value,t=ef(e);t.success?(document.getElementById("admin-login-view").style.display="none",document.getElementById("admin-panel-view").style.display="block",Nl(),ue()):document.getElementById("admin-login-error").textContent=t.error}function cf(){tf(),bo(!1),fn(!1),Yt()}function df(){Ke==="gallery"?pf():Ke==="news"&&yf()}function ue(){const e=document.getElementById("admin-tab-content"),t=document.getElementById("admin-save-btn");Ke==="gallery"?(gf(e),t&&(t.style.display="")):Ke==="news"?(If(e),t&&(t.style.display="")):Ke==="export"?(hf(e),t&&(t.style.display="none")):Ke==="dm"?(vf(e),t&&(t.style.display="none")):Ke==="global"&&(wf(e),t&&(t.style.display="none"))}function uf(){const e=document.getElementById("admin-debug-hud-toggle");if(!e)return;if(!zt()){e.checked=!1,bo(!1),fn(!1);return}const t=e.checked===!0;bo(t),fn(t)}function Nl(){const e=document.getElementById("admin-debug-hud-toggle");if(!e)return;const t=zt(),n=t&&(xl?.()??ff());e.checked=n,e.disabled=!t,fn(n)}function ff(){try{return localStorage.getItem(Bl)==="1"}catch{return!1}}function bo(e){try{localStorage.setItem(Bl,e?"1":"0")}catch(t){console.warn("[admin] failed to persist debug hud preference",t)}}function fn(e){const t=e===!0&&zt();Dl?.(t)}function gf(e){const n=oa()?.items||[];e.innerHTML=`
        <div class="admin-editor">
            <div class="admin-list" id="gallery-list">
                ${n.map((a,o)=>`
                    <div class="admin-item" data-index="${o}">
                        <div class="item-header">
                            <span class="item-title">${a.title||"(ÁÑ°È°å)"}</span>
                            <div class="item-actions">
                                <button class="item-btn" data-action="up" ${o===0?"disabled":""}>‚Üë</button>
                                <button class="item-btn" data-action="down" ${o===n.length-1?"disabled":""}>‚Üì</button>
                                <button class="item-btn" data-action="edit">‚úèÔ∏è</button>
                                <button class="item-btn danger" data-action="delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="item-meta">${a.url||""}</div>
                    </div>
                `).join("")}
            </div>
            <button id="gallery-add-btn" class="admin-btn">+ „Ç¢„Ç§„ÉÜ„É†ËøΩÂä†</button>
        </div>
    `,e.querySelectorAll(".item-btn").forEach(a=>{a.addEventListener("click",o=>{const i=o.target.closest(".admin-item"),s=parseInt(i.dataset.index);mf(o.target.dataset.action,s)})}),document.getElementById("gallery-add-btn").addEventListener("click",()=>{Ol(-1)})}function mf(e,t){const n=oa(),a=[...n.items];e==="up"&&t>0?([a[t],a[t-1]]=[a[t-1],a[t]],en({...n,items:a}),ue()):e==="down"&&t<a.length-1?([a[t],a[t+1]]=[a[t+1],a[t]],en({...n,items:a}),ue()):e==="delete"?confirm("„Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")&&(a.splice(t,1),en({...n,items:a}),ue()):e==="edit"&&Ol(t)}function Ol(e){const t=oa(),n=e>=0?t.items[e]:{id:`tool-${Date.now()}`,title:"",url:"",desc:"",tags:[]},a=document.getElementById("admin-tab-content");a.innerHTML=`
        <div class="admin-form">
            <h3>${e>=0?"„Ç¢„Ç§„ÉÜ„É†Á∑®ÈõÜ":"Êñ∞Ë¶è„Ç¢„Ç§„ÉÜ„É†"}</h3>
            <label>„Çø„Ç§„Éà„É´</label>
            <input type="text" id="gallery-edit-title" value="${n.title||""}">
            <label>URL</label>
            <input type="url" id="gallery-edit-url" value="${n.url||""}">
            <label>Ë™¨Êòé</label>
            <input type="text" id="gallery-edit-desc" value="${n.desc||""}">
            <label>„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä)</label>
            <input type="text" id="gallery-edit-tags" value="${(n.tags||[]).join(", ")}">
            <div class="admin-buttons">
                <button id="gallery-edit-save" class="admin-btn primary">‰øùÂ≠ò</button>
                <button id="gallery-edit-cancel" class="admin-btn">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    `,document.getElementById("gallery-edit-save").addEventListener("click",()=>{const o={id:n.id,title:document.getElementById("gallery-edit-title").value,url:document.getElementById("gallery-edit-url").value,desc:document.getElementById("gallery-edit-desc").value,tags:document.getElementById("gallery-edit-tags").value.split(",").map(s=>s.trim()).filter(Boolean)},i=[...t.items];e>=0?i[e]=o:i.push(o),en({...t,items:i}),ue()}),document.getElementById("gallery-edit-cancel").addEventListener("click",ue)}function pf(){alert("„ÇÆ„É£„É©„É™„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü")}function If(e){const n=ia()?.items||[];e.innerHTML=`
        <div class="admin-editor">
            <div class="admin-list" id="news-list">
                ${n.map((a,o)=>`
                    <div class="admin-item" data-index="${o}">
                        <div class="item-header">
                            <span class="item-title">${a.title||"(ÁÑ°È°å)"}</span>
                            <span class="item-date">${a.date||""}</span>
                            <div class="item-actions">
                                <button class="item-btn" data-action="up" ${o===0?"disabled":""}>‚Üë</button>
                                <button class="item-btn" data-action="down" ${o===n.length-1?"disabled":""}>‚Üì</button>
                                <button class="item-btn" data-action="edit">‚úèÔ∏è</button>
                                <button class="item-btn danger" data-action="delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="item-meta">${(a.body||"").substring(0,50)}...</div>
                    </div>
                `).join("")}
            </div>
            <button id="news-add-btn" class="admin-btn">+ „Éã„É•„Éº„ÇπËøΩÂä†</button>
        </div>
    `,e.querySelectorAll(".item-btn").forEach(a=>{a.addEventListener("click",o=>{const i=o.target.closest(".admin-item"),s=parseInt(i.dataset.index);bf(o.target.dataset.action,s)})}),document.getElementById("news-add-btn").addEventListener("click",()=>{Rl(-1)})}function bf(e,t){const n=ia(),a=[...n.items];e==="up"&&t>0?([a[t],a[t-1]]=[a[t-1],a[t]],tn({...n,items:a}),ue()):e==="down"&&t<a.length-1?([a[t],a[t+1]]=[a[t+1],a[t]],tn({...n,items:a}),ue()):e==="delete"?confirm("„Åì„ÅÆ„Éã„É•„Éº„Çπ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")&&(a.splice(t,1),tn({...n,items:a}),ue()):e==="edit"&&Rl(t)}function Rl(e){const t=ia(),n=e>=0?t.items[e]:{id:`news-${Date.now()}`,title:"",body:"",date:new Date().toISOString().split("T")[0]},a=document.getElementById("admin-tab-content");a.innerHTML=`
        <div class="admin-form">
            <h3>${e>=0?"„Éã„É•„Éº„ÇπÁ∑®ÈõÜ":"Êñ∞Ë¶è„Éã„É•„Éº„Çπ"}</h3>
            <label>„Çø„Ç§„Éà„É´</label>
            <input type="text" id="news-edit-title" value="${n.title||""}">
            <label>Êó•‰ªò</label>
            <input type="date" id="news-edit-date" value="${n.date||""}">
            <label>Êú¨Êñá</label>
            <textarea id="news-edit-body" rows="5">${n.body||""}</textarea>
            <div class="admin-buttons">
                <button id="news-edit-save" class="admin-btn primary">‰øùÂ≠ò</button>
                <button id="news-edit-cancel" class="admin-btn">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    `,document.getElementById("news-edit-save").addEventListener("click",()=>{const o={id:n.id,title:document.getElementById("news-edit-title").value,date:document.getElementById("news-edit-date").value,body:document.getElementById("news-edit-body").value},i=[...t.items];e>=0?i[e]=o:i.push(o),tn({...t,items:i}),ue()}),document.getElementById("news-edit-cancel").addEventListener("click",ue)}function yf(){alert("„ÅäÁü•„Çâ„Åõ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü")}function hf(e){const t=sf();e.innerHTML=`
        <div class="admin-export">
            <h3>üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</h3>
            <p>ÁèæÂú®„ÅÆ„ÇÆ„É£„É©„É™„Éº/„ÅäÁü•„Çâ„Åõ„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åæ„Åü„ÅØ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô</p>
            <textarea id="export-text" readonly rows="8">${t}</textarea>
            <div class="admin-buttons">
                <button id="export-copy-btn" class="admin-btn">üìã „Ç≥„Éî„Éº</button>
                <button id="export-download-btn" class="admin-btn">üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
            </div>
            
            <h3>üì• „Ç§„É≥„Éù„Éº„Éà</h3>
            <p>JSON„ÇíË≤º„Çä‰ªò„Åë„Å¶„Ç§„É≥„Éù„Éº„Éà</p>
            <textarea id="import-text" rows="5" placeholder='{"gallery": {...}, "news": {...}}'></textarea>
            <div id="import-status" class="admin-status"></div>
            <div class="admin-buttons">
                <button id="import-btn" class="admin-btn primary">„Ç§„É≥„Éù„Éº„Éà</button>
                <button id="clear-overrides-btn" class="admin-btn danger">üóëÔ∏è „Ç™„Éº„Éê„Éº„É©„Ç§„Éâ„Çí„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>
    `,document.getElementById("export-copy-btn").addEventListener("click",()=>{navigator.clipboard.writeText(t),alert("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü")}),document.getElementById("export-download-btn").addEventListener("click",()=>{const n=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`virtualoffice-content-${new Date().toISOString().split("T")[0]}.json`,o.click(),URL.revokeObjectURL(a)}),document.getElementById("import-btn").addEventListener("click",()=>{const n=document.getElementById("import-text").value,a=lf(n),o=document.getElementById("import-status");a.success?(o.textContent="‚úÖ „Ç§„É≥„Éù„Éº„ÉàÊàêÂäü",o.className="admin-status success"):(o.textContent=`‚ùå „Ç®„É©„Éº: ${a.error}`,o.className="admin-status error")}),document.getElementById("clear-overrides-btn").addEventListener("click",()=>{confirm(`localStorage„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ„Çí„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü
„Éá„Éï„Ç©„É´„Éà„ÅÆJSON„Å´Êàª„Çä„Åæ„Åô„ÄÇ`)&&(of(),alert("„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"))})}function vf(e){e.innerHTML=`
        <div class="admin-export">
            <h3>üßπ DM„Éá„Éº„ÇøÂâäÈô§</h3>
            <p>ÁÑ°ÊñôÊû†ÁØÄÁ¥Ñ„ÅÆ„Åü„ÇÅ„ÄÅÂè§„ÅÑDM„ÇÑÂÖ®‰ª∂DM„ÇíÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
                <label class="form-label" for="dm-purge-days">ÂâäÈô§ÂØæË±°ÔºàÊó•Êï∞„Çà„ÇäÂâçÔºâ</label>
                <input type="number" id="dm-purge-days" class="form-input" min="1" step="1" value="30">
            </div>
            <div class="admin-buttons">
                <button id="dm-purge-before-btn" class="admin-btn">30Êó•„Çà„ÇäÂâç„ÇíÂâäÈô§</button>
                <button id="dm-purge-all-btn" class="admin-btn danger">üóëÔ∏è DM„ÇíÂÖ®ÂâäÈô§</button>
            </div>
            <div id="dm-purge-status" class="admin-status"></div>
        </div>
    `;const t=document.getElementById("dm-purge-status"),n=document.getElementById("dm-purge-days"),a=document.getElementById("dm-purge-before-btn"),o=document.getElementById("dm-purge-all-btn");function i(l,d){t&&(t.textContent=l,t.className=d?"admin-status success":"admin-status error")}function s(l){a&&(a.disabled=l),o&&(o.disabled=l)}a?.addEventListener("click",async()=>{const l=Math.max(1,Number(n?.value)||30);if(confirm(`${l}Êó•„Çà„ÇäÂâç„ÅÆDM„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)){s(!0);try{const d=await Yd(l);i(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${d}Ôºâ`,!0)}catch(d){console.error("[admin] DM purge before failed",d),i("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{s(!1)}}}),o?.addEventListener("click",async()=>{if(confirm("DM„ÇíÂÖ®‰ª∂ÂâäÈô§„Åó„Åæ„Åô„ÄÇÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü")){s(!0);try{const l=await Kd();i(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${l}Ôºâ`,!0)}catch(l){console.error("[admin] DM purge all failed",l),i("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{s(!1)}}})}function wf(e){e.innerHTML=`
        <div class="admin-export">
            <h3>üßπ ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂâäÈô§</h3>
            <p>ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí‰∏ÄË¶ßÁ¢∫Ë™ç„Åó„ÄÅ1‰ª∂ÂâäÈô§„Åæ„Åü„ÅØ‰∏ÄÊã¨ÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
                <label class="form-label" for="global-room-id">room_idÔºàÁ©∫Ê¨Ñ„ÅßÂÖ®„É´„Éº„É†Ôºâ</label>
                <input type="text" id="global-room-id" class="form-input" value="room:default" placeholder="room:default">
            </div>
            <div class="form-group">
                <label class="form-label" for="global-purge-days">ÂâäÈô§ÂØæË±°ÔºàÊó•Êï∞„Çà„ÇäÂâçÔºâ</label>
                <input type="number" id="global-purge-days" class="form-input" min="1" step="1" value="30">
            </div>
            <div class="admin-buttons">
                <button id="global-refresh-btn" class="admin-btn">‰∏ÄË¶ß„ÇíÊõ¥Êñ∞</button>
                <button id="global-purge-before-btn" class="admin-btn">30Êó•„Çà„ÇäÂâç„ÇíÂâäÈô§</button>
                <button id="global-purge-all-btn" class="admin-btn danger">üóëÔ∏è ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂÖ®ÂâäÈô§</button>
            </div>
            <div id="global-purge-status" class="admin-status"></div>
            <div class="admin-list" id="global-message-list"></div>
        </div>
    `;const t=document.getElementById("global-purge-status"),n=document.getElementById("global-room-id"),a=document.getElementById("global-purge-days"),o=document.getElementById("global-message-list"),i=document.getElementById("global-refresh-btn"),s=document.getElementById("global-purge-before-btn"),l=document.getElementById("global-purge-all-btn");function d(){return String(n?.value||"").trim()||null}function I(g,b){t&&(t.textContent=g,t.className=b?"admin-status success":"admin-status error")}function p(g){i&&(i.disabled=g),s&&(s.disabled=g),l&&(l.disabled=g),o&&o.querySelectorAll('button[data-action="delete"]').forEach(b=>{b.disabled=g})}async function v(){if(o){o.innerHTML='<div class="chat-empty">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';try{const g=await Qd({roomId:d(),limit:200});if(!g.length){o.innerHTML='<div class="chat-empty">ÂØæË±°„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>';return}o.innerHTML=g.map(b=>{const y=String(b?.message||"").slice(0,120),h=b?.sender_display_name||b?.sender_actor_id||"‰∏çÊòé";return`
                    <div class="admin-item">
                        <div class="item-header">
                            <span class="item-title">${En(h)}</span>
                            <span class="item-date">${En(Cf(b?.created_at))}</span>
                            <div class="item-actions">
                                <button class="item-btn danger" data-action="delete" data-id="${En(b?.id||"")}" title="ÂâäÈô§">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="item-meta">${En(y||"(Á©∫„É°„ÉÉ„Çª„Éº„Ç∏)")}</div>
                    </div>
                `}).join("")}catch(g){console.error("[admin] global list fetch failed",g),o.innerHTML='<div class="chat-empty">‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</div>'}}}i?.addEventListener("click",()=>{v()}),s?.addEventListener("click",async()=>{const g=Math.max(1,Number(a?.value)||30);if(confirm(`${g}Êó•„Çà„ÇäÂâç„ÅÆÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)){p(!0);try{const b=await tu(g,d());I(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${b}Ôºâ`,!0),await v()}catch(b){console.error("[admin] global purge before failed",b),I("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{p(!1)}}}),l?.addEventListener("click",async()=>{if(confirm("ÂÖ®‰Ωì„ÉÅ„É£„ÉÉ„Éà„ÇíÂÖ®‰ª∂ÂâäÈô§„Åó„Åæ„Åô„ÄÇÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü")){p(!0);try{const g=await nu(d());I(`ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: ${g}Ôºâ`,!0),await v()}catch(g){console.error("[admin] global purge all failed",g),I("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{p(!1)}}}),o?.addEventListener("click",async g=>{const b=g.target.closest?.('button[data-action="delete"]');if(!b)return;const y=b.dataset.id;if(y&&confirm("„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")){p(!0);try{await eu(y)>0?I("ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàÂâäÈô§‰ª∂Êï∞: 1Ôºâ",!0):I("ÂØæË±°„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü",!1),await v()}catch(h){console.error("[admin] global delete failed",h),I("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",!1)}finally{p(!1)}}}),v()}function Cf(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?String(e):t.toLocaleString("ja-JP",{hour12:!1})}function En(e){const t=document.createElement("div");return t.textContent=String(e??""),t.innerHTML}let q=null,yo=!1,Bt=null,Yn="area:core";const $l="bgm:volume",Pl="area:garden",Be={playingId:null,playingTitle:null,isPlaying:!1};function Hl(e){return Math.max(0,Math.min(1,Number(e)))}function Af(e){if(!e)return"";if(e.src)return String(e.src);if(e.url)return String(e.url);if(!e.file)return"";const t="/virtualoffice/".replace(/\/+$/,""),n=String(e.file).replace(/^\/+/,"");return`${t}/${n}`.replace(/^\/\//,"/")}function Qo(){if(q)return q;q=new Audio,q.loop=!0,q.preload="auto";const e=Number(localStorage.getItem($l));return q.volume=Number.isFinite(e)?Hl(e):.25,q}function xa(e){Yn=e||"area:core",Yn!==Pl&&Ve()}function Mn(){if(!yo&&(yo=!0,Bt)){const e=Bt;Bt=null,ei(e)}}async function ei(e,{areaId:t}={}){if(!e?.file)return!1;q||Qo();const n=t||Yn;if(n!==Pl)return Ve(),!1;if(Yn=n,!yo)return Bt=e,!1;const a=Af(e);if(!a)return!1;try{return q.pause(),q.src=a,q.load(),q.currentTime=0,await q.play(),Be.playingId=e.id||null,Be.playingTitle=e.title||null,Be.isPlaying=!0,Bt=null,!0}catch(o){return Be.isPlaying=!1,console.warn("[BGM] play failed",o),!1}}function Ve(){if(Be.playingId=null,Be.playingTitle=null,Be.isPlaying=!1,Bt=null,!!q)try{q.pause(),q.currentTime=0,q.src=""}catch(e){console.warn("[BGM] stop failed",e)}}function kf(e){q||Qo();const t=Hl(e);q.volume=t,localStorage.setItem($l,String(t))}function jl(){return{playingId:Be.playingId,playingTitle:Be.playingTitle,isPlaying:Be.isPlaying,volume:q?q.volume:null}}let ye=null,ot=null,ti=!1;const Ba="bgm:garden:selected";function Sf(){ye||(ye=document.createElement("div"),ye.id="bgm-modal-overlay",ye.className="spot-modal-overlay",document.getElementById("app").appendChild(ye),ot=document.createElement("div"),ot.className="spot-modal",ot.id="modal-bgm",ot.innerHTML=`
        <div class="modal-header">
            <h2 class="modal-title" id="bgm-modal-title">„Ç¨„Éº„Éá„É≥BGM</h2>
            <button type="button" class="modal-close-btn" id="bgm-modal-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="bgm-modal-body"></div>
    `,ye.appendChild(ot),document.getElementById("bgm-modal-close").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),On()}),ye.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.target===ye&&On()}),ot.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&ti&&On()}))}function ho({tracks:e=[],selectedId:t=null,title:n="„Ç¨„Éº„Éá„É≥BGM"}={}){if(!ot)return;const a=document.getElementById("bgm-modal-title");a&&(a.textContent=n);const o=document.getElementById("bgm-modal-body"),i=t||localStorage.getItem(Ba)||"none",s=jl?.()||{},l=s.isPlaying?s.playingId:i,d=s.isPlaying?s.playingTitle||"‰∏çÊòé":"ÂÅúÊ≠¢‰∏≠",I=e.map(g=>{const b=g.id===l?'data-active="true"':"";return`
            <button type="button" class="spot-link-item" data-track-id="${g.id}" ${b}>
                <div class="spot-link-header">
                    <span class="spot-link-label">${g.title}</span>
                    ${s.playingId===g.id&&s.isPlaying?'<span class="spot-playing">ÂÜçÁîü‰∏≠</span>':""}
                </div>
            </button>
        `}).join("");o.innerHTML=`
        <div class="spot-link-item bgm-now-playing">
            <span>ÂÜçÁîü‰∏≠</span>
            <strong>${d}</strong>
        </div>
        <div class="spot-links-list bgm-track-list">
            ${I||'<div class="spot-link-item">„Éà„É©„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'}
        </div>
        <div class="spot-links-list" style="margin-top: 12px; gap: 12px;">
            <div class="spot-link-item" style="align-items: center;">
                <label style="flex: 1;">Èü≥Èáè</label>
                <input id="bgm-volume" type="range" min="0" max="1" step="0.01" value="${Mf()}" />
            </div>
            <button type="button" class="spot-link-item" id="bgm-stop-btn">ÂÅúÊ≠¢</button>
        </div>
    `,o.querySelectorAll("[data-track-id]").forEach(g=>{g.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation();const y=g.getAttribute("data-track-id"),h=e.find(f=>f.id===y);h&&ei(h).then(f=>{f&&localStorage.setItem(Ba,h.id),ho({tracks:e,selectedId:h.id,title:n})})})});const p=document.getElementById("bgm-stop-btn");p&&p.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),Ve(),localStorage.setItem(Ba,"none"),ho({tracks:e,selectedId:"none",title:n})});const v=document.getElementById("bgm-volume");v&&v.addEventListener("input",g=>{kf(g.target.value)}),Ef()}function On(){ye&&(ye.classList.remove("visible"),ti=!1)}function Ef(){ye.classList.add("visible"),ti=!0}function Mf(){const e=Number(localStorage.getItem("bgm:volume"));return Number.isFinite(e)?Math.max(0,Math.min(1,e)):.25}const Lf="data:text/plain;base64,44GT44GT44Gr5ZCM5ZCN44GuIG1wMy9vZ2cg44KS572u44GR44Gw5beu44GX5pu/44GI5Y+v6IO9CkdpdEh1YiBQYWdlcyDjgafjga/jg5HjgrnjgYwgL3ZpcnR1YWxvZmZpY2UvYXNzZXRzL2JnbS8uLi4g44Gr44Gq44KLCuaOqOWlqO+8mm1wMyDjgYsgb2dn44CC5a656YeP44Gv6Lu944KB5o6o5aWoCg==",_f="/virtualoffice/assets/akai_ha-B_hf7WkC.mp3",Df="/virtualoffice/assets/fuuga-CWoASvj_.mp3",xf="/virtualoffice/assets/kagaribi_no_yado-Cvb6jlw4.mp3",Bf="/virtualoffice/assets/kouyou_no_kourankei-Ch89g2qC.mp3",Tf="/virtualoffice/assets/noyama-vXIInRqD.mp3",Nf="/virtualoffice/assets/onsengai_no_yube-Bv9QH5JC.mp3",Of="/virtualoffice/assets/ryugujo-CAxxej4u.mp3",Rf="/virtualoffice/assets/ryuuou_no_houkou-H2UHkJuG.mp3",$f="/virtualoffice/assets/sato_no_kosakura-CNVGWNb1.mp3",Pf="/virtualoffice/assets/seihitsu_o_yadosu_niwa-vE9nKOl2.mp3",Hf="/virtualoffice/assets/shiro_ni_somatte-DXPyewuz.mp3",jf="/virtualoffice/assets/suzukaze_ni_chiru-CBTXpfSH.mp3",Wf="/virtualoffice/assets/yozakura_wa_maichiru-Bvlet8ek.mp3",vo="kagaribi_no_yado",Ta=[{id:"kagaribi_no_yado",title:"ÁØùÁÅ´„ÅÆ„ÅäÂÆø",file:"kagaribi_no_yado.mp3"},{id:"noyama",title:"ÈáéÂ±±",file:"noyama.mp3"},{id:"onsengai_no_yube",title:"Ê∏©Ê≥âË°ó„ÅÆÂ§ï„Åπ",file:"onsengai_no_yube.mp3"},{id:"ryugujo",title:"Á´úÂÆÆÂüé",file:"ryugujo.mp3"},{id:"sato_no_kosakura",title:"Èáå„ÅÆÂè§Ê°ú",file:"sato_no_kosakura.mp3"},{id:"shiro_ni_somatte",title:"ÁôΩ„Å´Êüì„Åæ„Å£„Å¶",file:"shiro_ni_somatte.mp3"},{id:"yozakura_wa_maichiru",title:"Â§úÊ°ú„ÅØËàû„ÅÑÊï£„Çã",file:"yozakura_wa_maichiru.mp3"},{id:"suzukaze_ni_chiru",title:"Ê∂ºÈ¢®„Å´Êï£„Çã",file:"suzukaze_ni_chiru.mp3"},{id:"akai_ha",title:"Ëµ§„ÅÑËëâ",file:"akai_ha.mp3"},{id:"fuuga",title:"È¢®ÈõÖ",file:"fuuga.mp3"},{id:"ryuuou_no_houkou",title:"ÈæçÁéã„ÅÆÂíÜÂìÆ",file:"ryuuou_no_houkou.mp3"},{id:"seihitsu_o_yadosu_niwa",title:"ÈùôË¨ê„ÇíÂÆø„ÅôÂ∫≠",file:"seihitsu_o_yadosu_niwa.mp3"},{id:"kouyou_no_kourankei",title:"Á¥ÖËëâ„ÅÆÈ¶ôÂµêÊ∏ì",file:"kouyou_no_kourankei.mp3"}];function as(e){const t=String(e||"").replace(/^\/+/,"");return new URL(Object.assign({"../../assets/bgm/README.txt":Lf,"../../assets/bgm/akai_ha.mp3":_f,"../../assets/bgm/fuuga.mp3":Df,"../../assets/bgm/kagaribi_no_yado.mp3":xf,"../../assets/bgm/kouyou_no_kourankei.mp3":Bf,"../../assets/bgm/noyama.mp3":Tf,"../../assets/bgm/onsengai_no_yube.mp3":Nf,"../../assets/bgm/ryugujo.mp3":Of,"../../assets/bgm/ryuuou_no_houkou.mp3":Rf,"../../assets/bgm/sato_no_kosakura.mp3":$f,"../../assets/bgm/seihitsu_o_yadosu_niwa.mp3":Pf,"../../assets/bgm/shiro_ni_somatte.mp3":Hf,"../../assets/bgm/suzukaze_ni_chiru.mp3":jf,"../../assets/bgm/yozakura_wa_maichiru.mp3":Wf})[`../../assets/bgm/${t}`],import.meta.url).href}let he=null,it=null,ni=!1;const os="ambientPreset:garden";function Ff(){he||(he=document.createElement("div"),he.id="ambient-modal-overlay",he.className="spot-modal-overlay",document.getElementById("app").appendChild(he),it=document.createElement("div"),it.className="spot-modal",it.id="modal-ambient",it.innerHTML=`
        <div class="modal-header">
            <h2 class="modal-title" id="ambient-modal-title">Ambient Particles</h2>
            <button type="button" class="modal-close-btn" id="ambient-modal-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="ambient-modal-body"></div>
    `,he.appendChild(it),document.getElementById("ambient-modal-close").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Rn()}),he.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.target===he&&Rn()}),it.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&ni&&Rn()}))}function Wl(){if(!it)return;const e=Bc()||localStorage.getItem(os)||"firefly",t=Object.values(Pn),n=document.getElementById("ambient-modal-body");n.innerHTML=`
        <div class="spot-links-list ambient-list">
            ${t.map(a=>{const o=a.id===e?'data-active="true"':"";return`
                    <button type="button" class="spot-link-item" data-ambient-id="${a.id}" ${o}>
                        <div class="spot-link-header">
                            <span class="spot-link-label">${a.label}</span>
                            ${a.id===e?'<span class="spot-playing">Selected</span>':""}
                        </div>
                    </button>
                `}).join("")}
        </div>
    `,n.querySelectorAll("[data-ambient-id]").forEach(a=>{a.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const i=a.getAttribute("data-ambient-id");if(i)try{Us(i),localStorage.setItem(os,i),O(`Ambient: ${Pn[i]?.label||i}`,"success"),Wl()}catch(s){console.warn("[Ambient] preset failed",s),O("Ambient„ÅÆÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}})}),zf()}function Rn(){he&&(he.classList.remove("visible"),ni=!1)}function zf(){he.classList.add("visible"),ni=!0}let me=null,vt=null,wo=null,Tt=null,ai=!1;function Fl(){me||(me=document.createElement("div"),me.id="library-modal-overlay",me.className="spot-modal-overlay",document.getElementById("app").appendChild(me),vt=document.createElement("div"),vt.id="library-modal",vt.className="spot-modal",vt.innerHTML=`
        <div class="modal-header">
            <h2 class="modal-title" id="library-modal-title"></h2>
            <button type="button" class="modal-close-btn" id="library-modal-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="library-modal-body"></div>
    `,me.appendChild(vt),document.getElementById("library-modal-close").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),$n()}),me.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.target===me&&$n()}),vt.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&ai&&$n()}),wo=document.getElementById("library-modal-title"),Tt=document.getElementById("library-modal-body"))}function sa({title:e,contentEl:t}){me||Fl(),wo&&(wo.textContent=e||""),Tt&&(Tt.innerHTML="",t&&Tt.appendChild(t)),me.classList.add("visible"),ai=!0}function $n(){me&&(me.classList.remove("visible"),ai=!1,Tt&&(Tt.innerHTML=""))}async function oi(){const e=R();if(!e)return console.error("[ProfileStore] Supabase not initialized"),[];const{data:t,error:n}=await e.from("profiles").select("*").order("updated_at",{ascending:!1});if(n)throw console.error("[ProfileStore] listProfiles error:",n),n;return t||[]}async function jt(e){if(!e)return null;const t=R();if(!t)return null;const{data:n,error:a}=await t.from("profiles").select("*").eq("id",e).maybeSingle();if(a)throw console.error("[ProfileStore] getProfileById error:",a),a;return n}async function Uf(e,t){const n=R();if(!n)throw new Error("Supabase not initialized");const{data:{user:a}}=await n.auth.getUser(),o=a?.id||null;if(e.id){const l=await jt(e.id);if(l){const{error:d}=await n.from("profile_revisions").insert({profile_id:l.id,editor_id:o,editor_label:t,snapshot:l});d&&console.error("[ProfileStore] revision save error:",d)}}const i={display_name:e.display_name||e.name||"Unnamed",role:e.role||null,team:e.team||null,bio:e.bio||null,tags:e.tags||[],avatar_color:e.avatar_color||e.avatarColor||null,updated_by:o,updated_by_label:t};e.handle&&(i.handle=e.handle);let s;if(e.id){const{data:l,error:d}=await n.from("profiles").update(i).eq("id",e.id).select().single();if(d)throw console.error("[ProfileStore] update error:",d),d;s=l}else{const{data:l,error:d}=await n.from("profiles").insert(i).select().single();if(d)throw console.error("[ProfileStore] insert error:",d),d;s=l}return s}async function Gf(e){if(!e)return;const t=R();if(!t)throw new Error("Supabase not initialized");const{error:n}=await t.from("profiles").delete().eq("id",e);if(n)throw console.error("[ProfileStore] delete error:",n),n}async function Jf(e){const t=await oi(),n=String(e||"").trim().toLowerCase();return n?t.filter(a=>[a.display_name,a.role,a.team,a.bio,...Array.isArray(a.tags)?a.tags:[]].filter(Boolean).join(" ").toLowerCase().includes(n)):t}async function qf(e=20){const t=R();if(!t)return[];const{data:n,error:a}=await t.from("profiles").select("*").order("updated_at",{ascending:!1}).limit(e);if(a)throw console.error("[ProfileStore] getRecentProfiles error:",a),a;return n||[]}async function Yf(e){if(!e)return[];const t=R();if(!t)return[];const{data:n,error:a}=await t.from("profile_notes").select("*").eq("profile_id",e).order("created_at",{ascending:!1});if(a)throw console.error("[ProfileStore] listNotes error:",a),a;return n||[]}async function Kf(e,t,n){if(!e||!t?.content)throw new Error("profileId and content are required");const a=R();if(!a)throw new Error("Supabase not initialized");const{data:{user:o}}=await a.auth.getUser(),{data:i,error:s}=await a.from("profile_notes").insert({profile_id:e,kind:t.kind||"note",content:t.content,author_id:o?.id||null,author_label:n}).select().single();if(s)throw console.error("[ProfileStore] addNote error:",s),s;return i}async function Vf(e,t=20){if(!e)return[];const n=R();if(!n)return[];const{data:a,error:o}=await n.from("profile_revisions").select("*").eq("profile_id",e).order("created_at",{ascending:!1}).limit(t);if(o)throw console.error("[ProfileStore] listRevisions error:",o),o;return a||[]}async function Zf(e,t,n){const a=R();if(!a)throw new Error("Supabase not initialized");const{data:o,error:i}=await a.from("profile_revisions").select("*").eq("id",t).single();if(i||!o)throw new Error("Revision not found");const s=await jt(e);if(s){const{data:{user:v}}=await a.auth.getUser();await a.from("profile_revisions").insert({profile_id:e,editor_id:v?.id||null,editor_label:`${n} (revert)`,snapshot:s})}const l=o.snapshot,{data:{user:d}}=await a.auth.getUser(),{data:I,error:p}=await a.from("profiles").update({display_name:l.display_name,role:l.role,team:l.team,bio:l.bio,tags:l.tags,avatar_color:l.avatar_color,updated_by:d?.id||null,updated_by_label:`${n} (revert)`}).eq("id",e).select().single();if(p)throw console.error("[ProfileStore] revert error:",p),p;return I}function Xf(e){if(!e)return"‰∏çÊòé„Å™„Ç®„É©„Éº";const t=e.message||String(e);return t.includes("JWT")||t.includes("token")||t.includes("auth")?"„É≠„Ç∞„Ç§„É≥„ÅåÂàá„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂÜç„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ":t.includes("network")||t.includes("fetch")?"„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ":t.includes("duplicate")||t.includes("unique")?"„Åô„Åß„Å´Âêå„Åò„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Åæ„Åô„ÄÇ":`„Ç®„É©„Éº: ${t}`}const zl="vo.editorLabel.v1";function Ul(){try{return localStorage.getItem(zl)||null}catch{return null}}function Qf(e){try{localStorage.setItem(zl,e)}catch(t){console.warn("[EditorLabel] save failed",t)}}function eg(){const e=Ul();return e!==null&&e.trim()!==""}function Co(){return new Promise(e=>{if(eg()){e(Ul());return}const t=document.createElement("div");t.className="editor-label-modal-overlay",t.innerHTML=`
            <div class="editor-label-modal">
                <div class="editor-label-modal-header">
                    <h3>„ÅÇ„Å™„Åü„ÅÆË°®Á§∫Âêç</h3>
                </div>
                <div class="editor-label-modal-body">
                    <p class="editor-label-hint">
                        Á∑®ÈõÜÂ±•Ê≠¥„Å´Ë®òÈå≤„Åï„Çå„ÇãË°®Á§∫Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </p>
                    <input type="text" 
                           class="form-input" 
                           id="editor-label-input" 
                           placeholder="‰æã: Â±±Áî∞Â§™ÈÉé" 
                           maxlength="50" />
                    <div class="editor-label-error" id="editor-label-error"></div>
                </div>
                <div class="editor-label-modal-footer">
                    <button type="button" class="btn btn-secondary" id="editor-label-cancel">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" id="editor-label-save">‰øùÂ≠ò</button>
                </div>
            </div>
        `,document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("visible")});const n=t.querySelector("#editor-label-input"),a=t.querySelector("#editor-label-error"),o=t.querySelector("#editor-label-save"),i=t.querySelector("#editor-label-cancel");function s(d){t.classList.remove("visible"),setTimeout(()=>{t.remove()},200),e(d)}function l(){const d=n.value.trim();if(!d){a.textContent="Ë°®Á§∫Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",n.focus();return}Qf(d),s(d)}n.addEventListener("keydown",d=>{d.key==="Enter"?(d.preventDefault(),l()):d.key==="Escape"&&s(null)}),o.addEventListener("click",d=>{d.preventDefault(),l()}),i.addEventListener("click",d=>{d.preventDefault(),s(null)}),t.addEventListener("click",d=>{d.target===t&&s(null)}),setTimeout(()=>n.focus(),100)})}function ne(e,t,n){const a=document.createElement(e);return t&&(a.className=t),n!=null&&(a.textContent=n),a}function Nt(e){if(!e)return"";const t=e instanceof Date?e:new Date(e),n=Date.now()-t.getTime(),a=Math.round(n/6e4);if(a<1)return"just now";if(a<60)return`${a}m ago`;const o=Math.round(a/60);return o<24?`${o}h ago`:`${Math.round(o/24)}d ago`}function tg(e){return e?e.split(",").map(t=>t.trim()).filter(Boolean).slice(0,5):[]}function xe(e,t){const n=e.querySelector(".library-error");n&&n.remove();const a=ne("div","library-error",Xf(t));e.insertBefore(a,e.firstChild)}function Ie(e,t=!0){const n=e.querySelector(".library-loading");if(n&&n.remove(),t){const a=ne("div","library-loading","Loading...");e.appendChild(a)}}function ii(e,t,n,a=null){if(e.innerHTML="",!t.length){e.appendChild(ne("div","library-empty","No profiles"));return}t.forEach(o=>{const i=ne("button","library-list-item");i.type="button",i.dataset.profileId=o.id;const s=o.display_name||o.name||"Unnamed";i.innerHTML=`
            <div class="library-list-title">${s}</div>
            <div class="library-list-meta">${o.role||""} ${o.team||""}</div>
        `,o.id===a&&i.classList.add("active"),i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),n(o.id)}),e.appendChild(i)})}async function ng(){const e=ne("div","library-modal-content");e.innerHTML=`
        <div id="profile-editor-error"></div>
        <div class="library-grid">
            <div class="library-pane">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="profile-name" />
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <input type="text" class="form-input" id="profile-role" />
                </div>
                <div class="form-group">
                    <label class="form-label">Team</label>
                    <input type="text" class="form-input" id="profile-team" />
                </div>
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-input" id="profile-bio" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (comma)</label>
                    <input type="text" class="form-input" id="profile-tags" />
                </div>
                <div class="form-group">
                    <label class="form-label">Avatar Color</label>
                    <input type="color" id="profile-color" value="#5b7cff" />
                </div>
                <div class="library-actions">
                    <button class="btn btn-primary" id="profile-save" type="button">Save</button>
                    <button class="btn btn-secondary" id="profile-new" type="button">New</button>
                    <button class="btn btn-secondary" id="profile-history" type="button">History</button>
                    <button class="btn btn-secondary" id="profile-delete" type="button">Delete</button>
                </div>
                <div id="profile-editor-info"></div>
            </div>
            <div class="library-pane">
                <div class="library-section-title">Profiles</div>
                <div id="profile-list" class="library-list"></div>
            </div>
        </div>
        <div id="profile-revisions-panel" style="display:none;">
            <div class="library-section-title" style="margin-top:16px;">Á∑®ÈõÜÂ±•Ê≠¥</div>
            <div id="profile-revisions-list" class="library-revisions-list"></div>
        </div>
    `;const t=e.querySelector("#profile-list"),n=e.querySelector("#profile-editor-error"),a=e.querySelector("#profile-editor-info"),o=e.querySelector("#profile-revisions-panel"),i=e.querySelector("#profile-revisions-list");let s=null,l=!1;function d(g){e.querySelector("#profile-name").value=g?.display_name||g?.name||"",e.querySelector("#profile-role").value=g?.role||"",e.querySelector("#profile-team").value=g?.team||"",e.querySelector("#profile-bio").value=g?.bio||"",e.querySelector("#profile-tags").value=(g?.tags||[]).join(", "),e.querySelector("#profile-color").value=g?.avatar_color||g?.avatarColor||"#5b7cff",g?.updated_by_label?a.innerHTML=`
                <div class="library-editor-info">
                    ÊúÄÁµÇÁ∑®ÈõÜ: <span class="library-editor-label">${g.updated_by_label}</span>
                    ¬∑ ${Nt(g.updated_at)}
                </div>
            `:a.innerHTML=""}async function I(){if(!l){l=!0,Ie(t,!0);try{const g=await oi();Ie(t,!1),ii(t,g,async b=>{s=b;const y=await jt(b);d(y),I(),o.style.display="none"},s)}catch(g){Ie(t,!1),xe(n,g)}finally{l=!1}}}async function p(){if(!s){O("Select a profile first","info");return}try{const g=await Vf(s);if(o.style.display="block",i.innerHTML="",!g.length){i.appendChild(ne("div","library-empty","No revision history"));return}g.forEach(b=>{const y=ne("div","library-revision-item");y.innerHTML=`
                    <div class="library-revision-info">
                        <div class="library-revision-editor">${b.editor_label||"Unknown"}</div>
                        <div class="library-revision-date">${Nt(b.created_at)}</div>
                    </div>
                    <button type="button" class="library-revert-btn">„Åì„ÅÆÁâà„Å´Êàª„Åô</button>
                `,y.querySelector(".library-revert-btn").addEventListener("click",async h=>{h.preventDefault(),h.stopPropagation(),await v(b.id)}),i.appendChild(y)})}catch(g){xe(n,g)}}async function v(g){const b=await Co();if(!b){O("Ë°®Á§∫Âêç„ÅåÂøÖË¶Å„Åß„Åô","error");return}try{await Zf(s,g,b),O("Reverted successfully","success");const y=await jt(s);d(y),await p()}catch(y){xe(n,y)}}e.querySelector("#profile-save").addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation();const b=e.querySelector("#profile-name").value.trim();if(!b){O("Name is required","error");return}const y=await Co();if(!y){O("Ë°®Á§∫Âêç„ÅåÂøÖË¶Å„Åß„Åô","error");return}const h={id:s||void 0,display_name:b,role:e.querySelector("#profile-role").value.trim(),team:e.querySelector("#profile-team").value.trim(),bio:e.querySelector("#profile-bio").value.trim(),tags:tg(e.querySelector("#profile-tags").value),avatar_color:e.querySelector("#profile-color").value};try{const f=await Uf(h,y);s=f.id,d(f),await I(),O("Profile saved","success"),o.style.display="none"}catch(f){xe(n,f)}}),e.querySelector("#profile-new").addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),s=null,d(null),I(),o.style.display="none"}),e.querySelector("#profile-history").addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),p()}),e.querySelector("#profile-delete").addEventListener("click",async g=>{if(g.preventDefault(),g.stopPropagation(),!!s&&confirm("Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü"))try{await Gf(s),s=null,d(null),await I(),O("Profile deleted","info"),o.style.display="none"}catch(b){xe(n,b)}}),await I(),d(null),sa({title:"„Éó„É≠„Éï„Ç£„Éº„É´ÁôªÈå≤„ÉªÁ∑®ÈõÜ",contentEl:e})}async function ag(){const e=ne("div","library-modal-content");e.innerHTML=`
        <div id="directory-error"></div>
        <div class="form-group">
            <label class="form-label">Search</label>
            <input type="text" class="form-input" id="directory-search" placeholder="name, team, tag..." />
        </div>
        <div class="library-list" id="directory-results"></div>
    `;const t=e.querySelector("#directory-search"),n=e.querySelector("#directory-results"),a=e.querySelector("#directory-error");async function o(s){Ie(n,!0);try{const l=await Jf(s);Ie(n,!1),ii(n,l,d=>{si(d)})}catch(l){Ie(n,!1),xe(a,l)}}let i=null;t.addEventListener("input",()=>{clearTimeout(i),i=setTimeout(()=>{o(t.value)},300)}),await o(""),sa({title:"ÁõÆÈå≤Ê§úÁ¥¢",contentEl:e})}async function og(){const e=ne("div","library-modal-content"),t=ne("div");e.appendChild(t);const n=ne("div","library-list");e.appendChild(n),Ie(n,!0);try{const a=await qf(20);Ie(n,!1),a.length?a.forEach(o=>{const i=ne("button","library-list-item");i.type="button";const s=o.display_name||o.name||"Unnamed";i.innerHTML=`
                    <div class="library-list-title">${s}</div>
                    <div class="library-list-meta">${Nt(o.updated_at)} ¬∑ ${o.role||""} ${o.team||""}</div>
                `,i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),si(o.id)}),n.appendChild(i)}):n.appendChild(ne("div","library-empty","No recent updates"))}catch(a){Ie(n,!1),xe(t,a)}sa({title:"ÊúÄËøë„ÅÆÊõ¥Êñ∞",contentEl:e})}async function si(e=null){const t=ne("div","library-modal-content");t.innerHTML=`
        <div id="viewer-error"></div>
        <div class="library-grid">
            <div class="library-pane">
                <div class="library-section-title">Profiles</div>
                <div id="viewer-list" class="library-list"></div>
            </div>
            <div class="library-pane">
                <div id="viewer-detail" class="library-detail"></div>
                <div id="viewer-notes" class="library-notes-section" style="display:none;">
                    <div class="library-notes-title">„Åø„Çì„Å™„ÅÆ„É°„É¢</div>
                    <div id="notes-list" class="library-notes-list"></div>
                    <div class="library-note-form">
                        <div class="library-note-form-row">
                            <select id="note-kind" class="form-input">
                                <option value="note">„É°„É¢</option>
                                <option value="kudos">Kudos</option>
                                <option value="info">Info</option>
                                <option value="skill">Skill</option>
                            </select>
                            <button type="button" class="btn btn-primary" id="note-submit">ÊäïÁ®ø</button>
                        </div>
                        <textarea id="note-content" class="form-input" placeholder="Ê∞ó„Å•„Åç„ÇÑ„É°„É¢„ÇíÊÆã„Åô..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    `;const n=t.querySelector("#viewer-list"),a=t.querySelector("#viewer-detail"),o=t.querySelector("#viewer-notes"),i=t.querySelector("#notes-list"),s=t.querySelector("#viewer-error");let l=e,d=[];async function I(b){if(!b){a.innerHTML='<div class="library-empty">Select a profile</div>',o.style.display="none";return}const y=b.display_name||b.name||"Unnamed";a.innerHTML=`
            <div class="library-detail-name">${y}</div>
            <div class="library-detail-meta">${b.role||""} ${b.team||""}</div>
            <div class="library-detail-bio">${b.bio||""}</div>
            <div class="library-detail-tags">${(b.tags||[]).map(h=>`<span class="library-tag">${h}</span>`).join("")}</div>
            ${b.updated_by_label?`
                <div class="library-editor-info">
                    ÊúÄÁµÇÁ∑®ÈõÜ: <span class="library-editor-label">${b.updated_by_label}</span>
                    ¬∑ ${Nt(b.updated_at)}
                </div>
            `:`<div class="library-detail-updated">Updated: ${Nt(b.updated_at)}</div>`}
        `,o.style.display="block",await p(b.id)}async function p(b){i.innerHTML="";try{const y=await Yf(b);y.length?y.forEach(h=>{const f=ne("div","library-note-item");f.innerHTML=`
                        <div class="library-note-header">
                            <span class="library-note-kind ${h.kind}">${h.kind}</span>
                            <span class="library-note-author">${h.author_label||"Unknown"} ¬∑ ${Nt(h.created_at)}</span>
                        </div>
                        <div class="library-note-content">${h.content}</div>
                    `,i.appendChild(f)}):i.appendChild(ne("div","library-empty","„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"))}catch(y){xe(s,y)}}async function v(b){l=b;const y=await jt(b);await I(y),g()}function g(){ii(n,d,v,l)}t.querySelector("#note-submit").addEventListener("click",async b=>{if(b.preventDefault(),b.stopPropagation(),!l){O("Select a profile first","info");return}const y=t.querySelector("#note-content").value.trim();if(!y){O("„É°„É¢ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ","error");return}const h=await Co();if(!h){O("Ë°®Á§∫Âêç„ÅåÂøÖË¶Å„Åß„Åô","error");return}const f=t.querySelector("#note-kind").value;try{await Kf(l,{kind:f,content:y},h),t.querySelector("#note-content").value="",await p(l),O("„É°„É¢„ÇíÊäïÁ®ø„Åó„Åæ„Åó„Åü","success")}catch(k){xe(s,k)}}),Ie(n,!0);try{if(d=await oi(),Ie(n,!1),g(),l){const b=await jt(l);await I(b)}else await I(null)}catch(b){Ie(n,!1),xe(s,b)}sa({title:"„Éó„É≠„Éï„Ç£„Éº„É´Èñ≤Ë¶ß",contentEl:t})}let oe={state:"idle",peerActorId:null,callId:null,lastError:null},Ao=null;function ig(e){Ao=e}function tt(){return{...oe}}function pn(e,t={}){const n=oe.state;oe={state:e,peerActorId:t.peerActorId||null,callId:t.callId||null,lastError:t.error||null},console.log(`Call state: ${n} -> ${e}`,oe),Ao&&Ao(oe,n)}function sg(e,t){return oe.state!=="idle"?(console.warn("Cannot request call, not in idle state"),!1):(pn("requesting",{peerActorId:e,callId:t}),!0)}function lg(e,t){return oe.state!=="idle"?(console.warn("Cannot receive call, not in idle state"),!1):(pn("incoming",{peerActorId:e,callId:t}),!0)}function rg(){return oe.state!=="incoming"?(console.warn("Cannot accept call, not in incoming state"),!1):(pn("connecting",{peerActorId:oe.peerActorId,callId:oe.callId}),!0)}function li(){return oe.state!=="connecting"&&oe.state!=="requesting"?(console.warn("Cannot connect call, not in connecting/requesting state"),!1):(pn("in_call",{peerActorId:oe.peerActorId,callId:oe.callId}),!0)}function cg(){return pn("idle"),!0}let G=null,He=null,ko=null,Gl=null,So=null,Eo=null;function dg(e){Gl=e?.onIceCandidate||null,So=e?.onTrack||null,Eo=e?.onConnectionStateChange||null}async function Jl(){const t=Vn()?.webrtc?.iceServers||[{urls:["stun:stun.cloudflare.com:3478"]}];return G=new RTCPeerConnection({iceServers:t}),G.onicecandidate=n=>{try{const a=n?.candidate;if(!a)return;console.log("[ICE] local candidate",a);const o=Gl?.({candidate:a});o&&typeof o.catch=="function"&&o.catch(i=>{console.warn("[webrtc] onIceCandidate callback failed",i)})}catch(a){console.warn("[webrtc] onicecandidate handler failed",a)}},G.ontrack=n=>{ko=n.streams[0],So&&So(ko)},G.onconnectionstatechange=()=>{Eo&&Eo(G.connectionState)},G}async function ql(){try{return He=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),He}catch(e){throw console.error("Failed to get user media:",e),e}}async function Yl(){!G||!He||He.getTracks().forEach(e=>{G.addTrack(e,He)})}async function ug(){if(!G)return null;const e=await G.createOffer();return await G.setLocalDescription(e),e}async function fg(){if(!G)return null;const e=await G.createAnswer();return await G.setLocalDescription(e),e}async function Kl(e){G&&await G.setRemoteDescription(new RTCSessionDescription(e))}async function Vl(e){if(!G)return;const t=e?.candidate;if(!t)return;console.log("[ICE] remote candidate received",t);const n=typeof t=="string"?{candidate:t}:t;try{const a=t instanceof RTCIceCandidate?t:new RTCIceCandidate(n);await G.addIceCandidate(a)}catch(a){console.warn("[webrtc] addIceCandidate failed",a,n)}}function gg(){He&&(He.getTracks().forEach(e=>e.stop()),He=null),G&&(G.close(),G=null),ko=null}function In(){return G}function mg(){return He}let de=null;const pg=3e3,Ig=2e4,is=new Map,P={callId:null,deskId:null,role:null,peerActorId:null,status:"idle",pendingOffer:null,pendingCandidates:[],timers:{noAnswerTimeout:null}};function ft(e,t,n){const a=Date.now(),o=is.get(e)||0;a-o<pg||(is.set(e,a),console.warn(t,n))}function bg(e){if(typeof e!="string")return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch{return null}}function yg(e){return e?typeof e=="string"?bg(e):typeof e!="object"?null:e:null}function Kt(e,t,n,a=0){if(a>2)return;const o=yg(e);o&&(n.has(o)||(n.add(o),t.push(o),Kt(o.payload,t,n,a+1),Kt(o.data,t,n,a+1),Kt(o.new,t,n,a+1),Kt(o.message,t,n,a+1)))}function hg(e){if(!e)return null;const t=[];Kt(e,t,new Set);let n=null;for(const a of t){const o=typeof a.type=="string"?a.type:"";if(o.startsWith("call_"))return a;!n&&(o||a.callId||a.offer||a.answer||a.candidate)&&(n=a)}return n}function bn(){P.timers.noAnswerTimeout&&(clearTimeout(P.timers.noAnswerTimeout),P.timers.noAnswerTimeout=null)}function gt(e={}){Object.assign(P,e)}function vg(e){const t=tt();P.status==="idle"&&t.state==="idle"||ie(e)}async function Zl(){if(!In()?.remoteDescription||P.pendingCandidates.length===0)return;const t=[...P.pendingCandidates];P.pendingCandidates=[];for(const n of t)try{await Vl({candidate:n})}catch(a){console.warn("[call] failed to flush ICE candidate",a,n)}}function wg(){bn(),P.timers.noAnswerTimeout=setTimeout(()=>{if(P.status==="idle")return;const e=P.callId,t=P.peerActorId;console.log("[call] hangup",{callId:e,reason:"no_answer_timeout"}),e&&t&&Xe(t,{type:"call_hangup",payload:{callId:e,from:de,to:t,deskId:null,fromActorId:de,toActorId:t,reason:"no_answer_timeout",data:{reason:"no_answer_timeout"}}}).catch(n=>{console.warn("[call] failed to send timeout hangup",n)}),ie("no_answer_timeout")},Ig)}function ie(e){console.warn("[call] reset",e),bn(),P.pendingCandidates=[],P.pendingOffer=null;const t=In();if(t)try{t.onicecandidate=null,t.ontrack=null,t.onconnectionstatechange=null}catch(n){console.warn("[call] reset handler cleanup failed",n)}try{gg()}catch(n){console.warn("[call] reset closePeerConnection failed",n)}gt({callId:null,deskId:null,role:null,peerActorId:null,status:"idle",pendingOffer:null,pendingCandidates:[]}),tt().state!=="idle"&&cg()}function Cg({actorId:e}){de=e}async function Ag(e){if(!e)return!1;(P.status!=="idle"||tt().state!=="idle")&&ie("start_call_while_busy");const t=kr();if(!sg(e,t))return ie("start_call_request_failed"),!1;gt({callId:t,deskId:null,role:"caller",peerActorId:e,status:"calling",pendingOffer:null,pendingCandidates:[]}),wg(),console.log("[call] start",{callId:t,deskId:null,to:e});try{await Jl(),await ql(),await Yl();const n=await ug();return await Xe(e,{type:"call_request",payload:{callId:t,from:de,to:e,deskId:null,fromActorId:de,toActorId:e,data:{offer:n},offer:n}}),!0}catch(n){return console.error("[call] start failed",n),ie("start_call_failed"),!1}}function kg(e){const t=typeof e?.callId=="string"?e.callId:null,n=e?.from||e?.fromActorId||null,a=e?.data?.offer||e?.offer||null;if(!t||!n||!a)return ft("call_request_invalid","[call] dropped event (missing callId/type)",e),!1;if(P.callId===t&&P.status==="ringing")return!0;if(P.status!=="idle"||tt().state!=="idle"){const o=In();if(!!o&&o.connectionState!=="closed")return Xe(n,{type:"call_busy",payload:{callId:t,from:de,to:n,deskId:null,fromActorId:de,toActorId:n,data:{reason:"busy"},reason:"busy"}}).catch(s=>{console.warn("[call] failed to send busy signal",s)}),!1;vg("incoming_offer_when_busy")}return lg(n,t)?(gt({callId:t,deskId:null,role:"callee",peerActorId:n,status:"ringing",pendingOffer:a,pendingCandidates:[]}),console.log("[call] incoming",{callId:t,deskId:null,from:n}),!0):(Xe(n,{type:"call_busy",payload:{callId:t,from:de,to:n,deskId:null,fromActorId:de,toActorId:n,data:{reason:"busy"},reason:"busy"}}).catch(o=>{console.warn("[call] failed to send busy signal",o)}),!1)}async function ss(){const e=tt(),t=P.pendingOffer,n=P.callId||e.callId,a=P.peerActorId||e.peerActorId;if(!t||!n||!a||e.state!=="incoming")return ie("accept_invalid_state"),!1;if(!rg())return ie("accept_state_transition_failed"),!1;gt({status:"connecting"}),console.log("[call] accept",{callId:n});try{await Jl(),await ql(),await Yl(),await Kl(t),await Zl();const o=await fg();return await Xe(a,{type:"call_answer",payload:{callId:n,from:de,to:a,deskId:null,fromActorId:de,toActorId:a,data:{answer:o},answer:o}}),console.log("[call] send_answer",{callId:n}),li(),bn(),gt({status:"connected",pendingOffer:null}),!0}catch(o){return console.error("[call] accept failed",o),ie("accept_failed"),!1}}async function Sg(e){const t=typeof e?.callId=="string"?e.callId:null,n=e?.data?.answer||e?.answer||null;if(!t||!n)return ft("call_answer_invalid","[call] dropped event (missing callId/type)",e),!1;const a=tt();if(a.callId&&a.callId!==t||P.callId&&P.callId!==t)return!1;console.log("[call] recv_answer",{callId:t});try{return In()?(await Kl(n),await Zl(),li(),bn(),gt({status:"connected",pendingOffer:null}),!0):(ie("answer_without_peer_connection"),!1)}catch(o){return console.error("[call] failed to handle answer",o),ie("handle_answer_failed"),!1}}async function Eg(e){const t=typeof e?.callId=="string"?e.callId:null,n=e?.data?.candidate||e?.candidate||null;if(!t||!n)return ft("call_ice_invalid","[call] dropped event (missing callId/type)",e),!1;const a=tt();if(a?.callId&&a.callId!==t||P.callId&&P.callId!==t)return!1;const o=In();if(!o||!o.remoteDescription)return P.pendingCandidates.push(n),!0;try{return await Vl({candidate:n}),!0}catch(i){return console.warn("[signaling] handleIceCandidate failed",i,n),!1}}async function Ln(e="hangup"){const t=tt(),n=P.peerActorId||t.peerActorId,a=P.callId||t.callId;return console.log("[call] hangup",{callId:a,reason:e}),n&&a&&await Xe(n,{type:"call_hangup",payload:{callId:a,from:de,to:n,deskId:null,fromActorId:de,toActorId:n,reason:e,data:{reason:e}}}).catch(o=>{console.warn("[call] failed to send hangup",o)}),ie(e),!0}function Mg(e){const t=typeof e?.callId=="string"?e.callId:null;if(!t)return ft("call_hangup_invalid","[call] dropped event (missing callId/type)",e),!1;if(P.callId&&P.callId!==t)return!1;const n=e?.reason||e?.data?.reason||"remote_hangup";return console.log("[call] hangup",{callId:t,reason:n}),ie(n),!0}function Lg(e){const t=typeof e?.callId=="string"?e.callId:null;return t?P.callId&&P.callId!==t?!1:(ie("busy"),!0):(ft("call_busy_invalid","[call] dropped event (missing callId/type)",e),!1)}function _g(e){if(e){if(e==="connected"){bn(),P.status!=="connected"&&(gt({status:"connected"}),li());return}(e==="failed"||e==="disconnected"||e==="closed")&&ie(`connection_${e}`)}}function Dg(e){try{const t=hg(e);if(!t)return ft("invalid_msg","[call] dropped event (invalid msg)",e),!1;const n=typeof t.type=="string"?t.type:null,a=typeof t.callId=="string"?t.callId:null;if(!n||!a)return ft("missing_type_or_callid","[call] dropped event (missing callId/type)",t),!1;switch(n){case"call_request":return kg(t);case"call_answer":return Sg(t).catch(o=>(console.warn("[signaling] handleCallAnswer failed",o),!1));case"call_ice_candidate":return Eg(t).catch(o=>(console.warn("[signaling] handleIceCandidate failed",o),!1));case"call_hangup":return Mg(t);case"call_busy":return Lg(t);default:return console.warn("[call] unknown event type",n,t),!1}}catch(t){return console.error("[call] handleCallEvent failed",t,e),!1}}const u={ui:{drawer:"none",chatTab:"all",selected:null,modal:"none",themeId:"theme:day",timeMode:"day",toastQueue:[]},world:{areaId:"area:core",pos:{x:260,y:260},facing:"down",seatedDeskId:null,seatLockedDeskId:null,insideSpotId:null,forcedSeated:!1},me:{actorId:null,displayName:"",status:"online",avatar:{key:null,color:null}},queuedAction:null,rt:{people:new Map},call:{status:"idle",peerActorId:null,peerDisplayName:null,deskId:null,callId:null,muted:!1,startedAt:null},debug:{showSpots:!1,canMoveTo:null,lastPathResult:null}};let ls=0,_n=Date.now(),Na=null,Dn=!1;const xg={canMoveTo:null},Bg=1500;let Oa=null,Ra=0,wt=null,Ct=null,rs=0;const Tg="vo:debugHudEnabled";function xn(e){const t=Y();t&&(t.isMapLoading=e,t.isReady=!e)}function Xl(){const e=mn?.()||u.world.areaId||"area:core",t=Ng();try{return(Ta||[]).map(a=>({...a,url:as(a.file),src:as(a.file)}))}catch(n){return console.warn("[BGM] resolveGardenTracks failed; continue without BGM",{activeArea:e,base:t,trackCount:Array.isArray(Ta)?Ta.length:0,err:n}),[]}}function Ng(){try{const e="/virtualoffice/";if(typeof e=="string"&&e.length)return e}catch{}return"/"}function $a(){(mn?.()||u.world.areaId||"area:core")!=="area:garden"&&Ve()}function Ql(){return(typeof u.me.displayName=="string"?u.me.displayName.trim():"")||"anonymous"}function st(e={}){if(!u.me.actorId)return null;const t={actorId:u.me.actorId,displayName:Ql(),status:u.me.status,callStatus:u.call.status,pos:dt(),facing:Fn(),avatarColor:u.me.avatar.color||null,areaId:u.world.areaId||null,seatedDeskId:u.world.seatedDeskId||null,seatLockedDeskId:u.world.seatLockedDeskId||null,location:Ui(u.world.insideSpotId,u.world.seatedDeskId,u.world.areaId,u.world.seatLockedDeskId),...e};return t.displayName=(typeof t.displayName=="string"?t.displayName.trim():"")||"anonymous",t.areaId=t.areaId||null,t.seatedDeskId=t.seatedDeskId||null,t.seatLockedDeskId=t.seatLockedDeskId||null,t.claimedByActorId=t.seatedDeskId?u.me.actorId:null,t.claimedByDisplayName=t.seatedDeskId?t.displayName:null,t.location||(t.location=Ui(u.world.insideSpotId,t.seatedDeskId,t.areaId,t.seatLockedDeskId)),t}function Og(){try{return localStorage.getItem(Tg)==="1"}catch{return!1}}function Rg(){const e=zt()&&Og();return document.body.classList.toggle("debug-hud-on",e),e}async function $g(e,t){Na=e,window.DEBUG_COLLISION===void 0&&(window.DEBUG_COLLISION=!1);let n=ps(Er());_o(n),u.me.actorId=n,ur(n);const a=Dr();a&&(u.ui.themeId=a,bl(a),Hu(a)),u.ui.timeMode=Br(),console.log("[TimeMode] restored from storage",{timeMode:u.ui.timeMode});const o=r=>{window.bootLog?window.bootLog(r):console.log("[BOOT-Main]",r)};o("app: init start");const i=setTimeout(()=>{window.showFatal&&window.showFatal(`Ëµ∑Âãï„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„ÅüÔºà10ÁßíÔºâ„ÄÇ
JSONË™≠Ëæº/JS‰æãÂ§ñ/„Éë„Çπ‰∏çÊï¥Âêà„ÅÆÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ„Åß„Åô„ÄÇ`)},1e4);try{o("app: calling loadMaps"),await ki("core"),o("app: loadMaps done"),clearTimeout(i)}catch(r){throw clearTimeout(i),r}await zu();const s=document.getElementById("map-canvas");await od(s),console.log("[Map] current meta.id",Y()?.meta?.id),Ed(),Rg();const l=Ei("lobby");u.world.pos={...l},xn(!0),hd(l,(r,w,C)=>{if(u.world.pos=r,u.world.facing=w,u.me.actorId){const N=st({pos:r,facing:w});N&&ht(N)}const S=Xs(r.x,r.y);S?.id!==u.world.insideSpotId&&(u.world.insideSpotId=S?.id||null)}),xn(!1),Rd(r=>{u.ui.drawer=r,Pg()}),ou({getMyName:()=>u.me.displayName||"‰∏çÊòé",getMyActorId:()=>u.me.actorId,getPersonName:r=>Le().get(r)?.displayName||r?.slice?.(0,6)||"‰∏çÊòé",getPeople:()=>Le()}),Au({warpCallback:r=>{Gi(r.pos),rn(),O(`${r.displayName} „ÅÆËøë„Åè„Å´„ÉØ„Éº„Éó„Åó„Åæ„Åó„Åü`)},pokeCallback:r=>{ds(r.actorId),O(`${r.displayName} „Çí„Å§„Å§„Åç„Åæ„Åó„Åü`)},dmCallback:r=>{Bn("chat"),Gn(r)}}),Mu({warpCallback:r=>{Gi(r.pos),rn(),O(`${r.displayName} „ÅÆËøë„Åè„Å´„ÉØ„Éº„Éó„Åó„Åæ„Åó„Åü`)}}),$u({nameChangeCallback:async r=>{try{if(await Qs(r,u.me.actorId)){O("„Åì„ÅÆÂêçÂâç„ÅØÊó¢„Å´‰Ωø„Çè„Çå„Å¶„ÅÑ„Åæ„Åô","error");return}await Wo({sessionId:u.me.actorId,displayName:r}),u.me.displayName=r,Is(r),Un(r),O("ÂêçÂâç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü","success")}catch{O("Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}},statusChangeCallback:r=>{u.me.status=r,qi(r);const w=st({status:r});w&&ht(w)},logoutCallback:async()=>{await Od(),await R().auth.signOut(),bi(),window.location.reload()},clearPasswordCallback:()=>{bi(),O("‰øùÂ≠ò„Åï„Çå„Åü„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü","success")}});try{bc()}catch(r){console.error("[MAIN] companion init failed (non-fatal):",r),window.__COMPANION_DISABLED__=!0}const d=document.getElementById("map-menu"),I=document.getElementById("map-menu-btn");document.getElementById("map-menu-label");const p=document.getElementById("map-dropdown"),v={"area:core":"„Ç™„Éï„Ç£„Çπ","area:garden":"„Ç¨„Éº„Éá„É≥","area:library":"„É©„Ç§„Éñ„É©„É™"};function g(r){p?.querySelectorAll(".nav-dropdown-item")?.forEach(C=>{C.classList.toggle("active",C.dataset.area===r)})}function b(){d?.classList.remove("open")}I&&I.addEventListener("click",r=>{r.stopPropagation(),d?.classList.toggle("open")}),p&&p.querySelectorAll(".nav-dropdown-item").forEach(r=>{r.addEventListener("click",w=>{w.stopPropagation();const C=r.dataset.area;if(!C||C===u.world.areaId){b();return}g(C),b(),hn(C)})}),document.addEventListener("click",()=>{b()}),g(u.world.areaId);function y(){const r=mg();r&&(r.getAudioTracks().forEach(w=>{w.enabled=!w.enabled}),u.call.muted=!u.call.muted,T())}function h(){const r=st();r&&ht(r)}function f(r){if(!r?.id)return;const w=u.world.seatLockedDeskId;w&&w!==r.id&&D(Mi(w)),u.world.seatedDeskId&&u.world.seatedDeskId!==r.id&&(u.world.seatLockedDeskId=null,u.world.forcedSeated=!1,yt(!1),Ye()),u.world.seatedDeskId=r.id,h(),T()}function k(r){if(!r?.id)return;u.world.seatedDeskId=r.id,u.world.seatLockedDeskId=r.id,u.world.forcedSeated=!1,Ye(),yt(!0);const w=r.posAbs||r.pos||null;w&&At(w.x,w.y),h(),T()}function D(r){const w=u.world.seatLockedDeskId;if(!w)return;const C=r||Mi(w);Ye(),yt(!1),u.world.seatLockedDeskId=null,u.world.forcedSeated=!1;const S=C?.standPointAbs||C?.standPoint||C?.posAbs||C?.pos||null;S&&At(S.x,S.y),h(),T()}function $(r){const w=r?.id||u.world.seatedDeskId;!w||u.world.seatedDeskId!==w||(u.world.seatLockedDeskId===w&&D(r),u.world.seatedDeskId=null,h(),T())}Fu({openZoom:r=>{window.open(r,"_blank")},openRoomChat:r=>{Bn("chat")},claimDesk:r=>{f(r)},seatDesk:r=>{k(r)},leaveSeat:r=>{D(r)},unclaimDesk:r=>{$(r)},poke:r=>{ds(r.actorId),O(`${r.displayName} „Çí„Å§„Å§„Åç„Åæ„Åó„Åü`)},dm:r=>{Bn("chat"),Gn(r)},call:async r=>{r?.actorId&&(Mn(),await Ag(r.actorId),T())},callAccept:async()=>{Mn(),await ss(),T()},callReject:async()=>{await Ln("declined"),T()},callCancel:async()=>{await Ln("cancelled"),T()},callMute:()=>{y(),T()},callEnd:async()=>{await Ln("hangup"),T()}});function E(r){if(!r)return null;const w=Le();for(const[C,S]of w)if((S.seatLockedDeskId||S.seatedDeskId)===r&&C!==u.me.actorId)return S;return null}function M(r,w=null){if(!r)return null;if(u.world.seatedDeskId===r)return Ql();const C=w||E(r);return C&&(C.claimedByDisplayName||C.displayName)||null}function B(r){if(r?.kind!=="desk")return{};const w=u.world.seatedDeskId===r.data.id,C=u.world.seatLockedDeskId===r.data.id,S=w?null:E(r.data.id),N=M(r.data.id,S);return{claimed:w,seatLocked:C,occupant:S,claimedByDisplayName:N,callState:u.call,forced:u.world.forcedSeated===!0&&C}}function T(){const r=u.ui.selected;if(r?.kind!=="desk")return;const w=u.world.seatedDeskId===r.data.id,C=u.world.seatLockedDeskId===r.data.id,S=w?null:E(r.data.id),N=M(r.data.id,S);qu(r.data,w,C,S,u.call,u.world.forcedSeated===!0&&C,N)}ju({acceptCallback:async()=>{Mn(),await ss()},rejectCallback:async()=>{await Ln("declined")}}),Ku(),Qo(),xa(u.world.areaId),Sf(),di(u.world.areaId),Ff(),Fl(),rf({onDebugHudToggle:r=>{const w=r===!0&&zt();document.body.classList.toggle("debug-hud-on",w)},getDebugHudEnabled:()=>document.body.classList.contains("debug-hud-on")}),nf(),af();try{const w=localStorage.getItem("ambientPreset:garden")||Po;Us(w)}catch(r){console.warn("[Ambient] preset init failed",r)}function L(r){switch(r){case"requesting":case"connecting":return"calling";case"incoming":return"ringing";case"in_call":return"in_call";default:return"idle"}}ig((r,w)=>{const C=u.call.status,S=L(r?.state),N=S==="in_call",Q=C==="in_call",F=r?.peerActorId||null,ee=F?Le().get(F):null;if(u.call={status:S,peerActorId:F,peerDisplayName:ee?.displayName||null,deskId:null,callId:r?.callId||null,muted:N?u.call.muted:!1,startedAt:N?Q?u.call.startedAt:Date.now():null},S==="ringing"){const mt=F?Le().get(F):null;Wu(mt?.displayName||"‰∏çÊòé„Å™Áõ∏Êâã")}else C==="ringing"&&S!=="ringing"&&go();r?.state==="error"&&O(r?.lastError||"ÈÄöË©±„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error");const Ne=st({callStatus:u.call.status});Ne&&ht(Ne),T()}),dg({onIceCandidate:r=>{const w=r?.candidate;w&&u.call.peerActorId&&u.call.callId&&Xe(u.call.peerActorId,{type:"call_ice_candidate",payload:{callId:u.call.callId,from:u.me.actorId,to:u.call.peerActorId,deskId:null,fromActorId:u.me.actorId,toActorId:u.call.peerActorId,data:{candidate:w},candidate:w}}).catch(C=>{console.warn("[main] failed to send ICE candidate",C)})},onTrack:r=>{const w=new Audio;w.srcObject=r,w.play()},onConnectionStateChange:r=>{_g(r),console.log("WebRTC connection state:",r)}}),Cg({actorId:u.me.actorId}),xd({supabase:R(),me:u.me,onPresenceChange:r=>{if(u.rt.people=new Map,Object.entries(r).forEach(([w,C])=>{if(C&&C.length>0){const S=C[0];S.actorId!==u.me.actorId&&u.rt.people.set(S.actorId,S)}}),ku(r),u.call.peerActorId){const w=Le().get(u.call.peerActorId);u.call.peerDisplayName=w?.displayName||u.call.peerDisplayName}T(),Du()},onEvent:r=>{try{Hg(r)}catch(w){console.error("[realtime] event handler failed",w,r)}}}),window.addEventListener("keydown",r=>{if(r.code==="Enter"&&(document.activeElement===document.getElementById("chat-input")||document.getElementById("chat-input")?.focus()),r.code==="F3"&&(r.preventDefault(),u.debug.showSpots=!u.debug.showSpots,Id(u.debug.showSpots),console.log("[Debug] Spots overlay:",u.debug.showSpots?"ON":"OFF")),r.key.toLowerCase()==="e"&&wt){const w=Date.now();if(wt===Oa&&w-Ra<Bg)return;const C=Za(wt);C?.action&&(r.preventDefault(),Oa=wt,Ra=w,cs(C.action,C))}}),Nd({myActorId:u.me.actorId});function W(r){return r.closest("#menubar, #drawer, #modal-overlay, #context-panel, button, input, textarea, a, .toast, .spot-modal-overlay")}function J(){return Ct||(Ct=document.createElement("div"),Ct.id="interact-hint",document.getElementById("app").appendChild(Ct),Ct)}function nt(r){const w=J();if(!r){w.classList.remove("visible"),w.textContent="";return}const C=window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;w.textContent=C?"Tap: Open":"E: Open",w.classList.add("visible")}function la(r){return r?.interactPoint?r.interactPoint:r?.bounds?{x:r.bounds.x+r.bounds.w/2,y:r.bounds.y+r.bounds.h/2}:r?.x!==void 0&&r?.y!==void 0?{x:r.x,y:r.y}:null}function se(r){const w=Xn();let C=null,S=1/0;return w.forEach(N=>{if(!N?.action)return;const Q=la(N);if(!Q)return;const F=r.x-Q.x,ee=r.y-Q.y,Ne=Math.sqrt(F*F+ee*ee),mt=N.proximity||90;Ne<=mt&&Ne<S&&(C=N,S=Ne)}),C}const at=document.getElementById("canvas-container");s.style.touchAction="none",at.style.touchAction="none",at.addEventListener("pointerdown",r=>{if(r.button!==0||W(r.target))return;Mn(),r.preventDefault(),_n=Date.now();const w=s.getBoundingClientRect(),C=r.clientX-w.left,S=r.clientY-w.top,N=to(C,S);r.shiftKey&&console.log("[COORD]",{x:Math.round(N.x),y:Math.round(N.y)}),console.log("[MOVE] click received",{claimedDeskId:u.world.seatedDeskId,seatLockedDeskId:u.world.seatLockedDeskId,forcedSeated:u.world.forcedSeated===!0,inputTarget:Ca(),isMoving:Sn()});const Q=Zs(N.x,N.y);console.log("[Click]",{screenX:C,screenY:S,worldX:Math.round(N.x),worldY:Math.round(N.y),hits:Q.map(ee=>`${ee.id}(P:${ee.priority||0})`)});const F=kd(N.x,N.y);F.kind==="spot"&&F.data?.action?cs(F.data.action,F.data):F.kind?(u.ui.selected=F,Uu(F,B(F)),xt()):(u.ui.selected=null,qn(),xt(),Vs(N.x,N.y),ir(N.x,N.y))}),at.addEventListener("wheel",r=>{if(r.preventDefault(),W(r.target))return;_n=Date.now();const w=s.getBoundingClientRect(),C=r.clientX-w.left,S=r.clientY-w.top;ld(r.deltaY,C,S)},{passive:!1});function yn(r){return r==="area:garden"?"./assets/maps/garden_day.png":r==="area:library"?"./assets/maps/library.png":"./assets/maps/map.png"}function V(r){return r==="area:garden"?"garden":"lobby"}function We(r){return r==="area:garden"?"garden":r==="area:library"?"library":"core"}function ci(r){return Xl().find(w=>w.id===r)||null}function di(r){if(xa(r),r==="area:garden"){const w=localStorage.getItem("bgm:garden:selected"),C=w&&w.length?w:vo;if(C==="none"){Ve();return}const S=ci(C)||ci(vo);S&&ei(S,{areaId:r})}else Ve();$a()}async function hn(r){try{r!=="area:garden"&&(xa(r),Ve()),Dn=!0,xn(!0),u.ui.selected=null,u.queuedAction=null,u.world.insideSpotId=null,qn(),xt(),On(),Rn(),$n(),wt=null,Oa=null,Ra=0,nt(null),Ye(),u.world.seatedDeskId=null,u.world.seatLockedDeskId=null,u.world.forcedSeated=!1,yt(!1);const w=We(r);await ki(w),kc(r),u.world.areaId=r,$a();const C=V(r),S=Ei(C);At(S.x,S.y),ji(S.x,S.y,16.67);const N=yn(r);await Js(N),di(r),g(r),O(`„Ç®„É™„Ç¢„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åó„Åü: ${v[r]||r}`,"success"),console.log("[Area] switched",{areaId:r,spawnName:C,sp:S,bg:N})}catch(w){console.error("[Area] switch failed",w),O("„Ç®„É™„Ç¢Âàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","error")}finally{xn(!1),Dn=!1}}document.addEventListener("keydown",r=>{_n=Date.now();const w=(document.activeElement?.tagName||"").toLowerCase();if(!(w==="input"||w==="textarea"||w==="select"||document.activeElement?.isContentEditable)){if(r.key,r.key,r.key,r.key,r.key.toLowerCase(),r.key.toLowerCase(),r.key.toLowerCase(),r.key.toLowerCase(),r.key==="F9"&&(window.DEBUG_COLLISION=!window.DEBUG_COLLISION,console.log("[DEBUG] Collision Debug",window.DEBUG_COLLISION?"ON":"OFF")),r.key==="F6"){if(u.world.forcedSeated)u.world.seatedDeskId=null,u.world.seatLockedDeskId=null,u.world.forcedSeated=!1,yt(!1),O("Âº∑Âà∂Â∫ßÂ∏≠Âõ∫ÂÆö„ÇíËß£Èô§„Åó„Åæ„Åó„Åü","info");else{const N=dt(),Q=Ad(N.x,N.y);if(Q){u.world.seatedDeskId=Q.id,u.world.seatLockedDeskId=Q.id,u.world.forcedSeated=!0,Ye(),yt(!0);const F=Q.posAbs||Q.pos;F&&At(F.x,F.y),O(`Â∫ßÂ∏≠Âõ∫ÂÆö: ${Q.id}ÔºàÂº∑Âà∂Ôºâ`,"info")}else O("Ëøë„Åè„Å´„Éá„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì","error")}T()}if(r.key.toLowerCase()==="g"&&hn("area:garden"),r.key.toLowerCase()==="o"&&hn("area:core"),r.key.toLowerCase()==="l"){if(r.repeat)return;const S=u.world.areaId==="area:library"?"area:core":"area:library";if(!Y(S)){console.warn("[Area] missing id:",S);return}hn(S)}}}),document.addEventListener("keyup",r=>{r.key,r.key,r.key,r.key,r.key.toLowerCase(),r.key.toLowerCase(),r.key.toLowerCase(),r.key.toLowerCase()});let ui=0,ra={x:0,y:0};const nr=200,ar=6;let Ut=null,ca=0;const or=500;function ir(r,w){Ut={x:r,y:w},ca=Date.now()}function da(r){const w=r-ls;if(ls=r,Dn||Y()?.isMapLoading||!Y()?.isReady){nt(null),requestAnimationFrame(da);return}vd(w);const C=dt(),S=Ca(),N=Sn(),Q=S?S.x-C.x:0,F=S?S.y-C.y:0;Kc(u.me.actorId||"me",N,Q,F,w),ji(C.x,C.y,w);const ee=Date.now();u.call.status==="in_call"&&u.ui.selected?.kind==="desk"&&ee-rs>=1e3&&(T(),rs=ee);const Ne=Math.sqrt(Math.pow(C.x-ra.x,2)+Math.pow(C.y-ra.y,2));if((Ne>ar||ee-ui>nr)&&Ne>.1){const U=st({pos:C,facing:Fn()});U&&ht(U),ra={...C},ui=ee}if(Na.presence?.awayAfterMs&&ee-_n>Na.presence.awayAfterMs&&u.me.status==="online"){u.me.status="away",qi("away");const Gt=st({status:"away"});Gt&&ht(Gt)}Ut&&ee-ca>or&&(Ut=null);const mt=se(C);wt=mt?.id||null,nt(mt),$a(),u.world.areaId!=="area:garden"&&jl().isPlaying&&Ve();const sr=Array.from(u.rt.people.values()).map(U=>({pos:U.pos||{x:0,y:0},displayName:U.displayName||"‰∏çÊòé",status:U.status||"online",callStatus:U.callStatus||"idle",avatarColor:U.avatarColor,actorId:U.actorId}));if(Dn||cd(C,Fn(),sr,{...u.me,callStatus:u.call.status},Ut,ca,w,u.world.areaId,u.ui.timeMode,Le()),u.queuedAction){const U=Za(u.queuedAction.spotId);if(U){const Gt=U.interactPoint||{x:U.bounds?U.bounds.x+U.bounds.w/2:U.x||0,y:U.bounds?U.bounds.y+U.bounds.h/2:U.y||0},fi=dt(),gi=fi.x-Gt.x,mi=fi.y-Gt.y,rr=Math.sqrt(gi*gi+mi*mi),cr=U.proximity||90;rr<=cr?(u.queuedAction.actionType==="openAdmin"&&Tl(),u.queuedAction=null):Sn()||(u.queuedAction=null)}else u.queuedAction=null}const lr=pd();u.debug.lastPathResult=Ks??null,Md({pos:C,target:Ca(),camera:lr,dt:w,isMoving:Sn(),lastTickMoveAt:ee,lastRenderAt:ee,lastClickWorld:Ut,canMoveTo:xg.canMoveTo,pathReason:u.debug.lastPathResult?.reason}),requestAnimationFrame(da)}requestAnimationFrame(da)}function Pg(){const e=document.getElementById("drawer-overlay"),t=document.getElementById("drawer"),n=document.getElementById("drawer-title"),a=u.ui.drawer!=="none",o=u.ui.drawer==="chat";if(document.body.classList.toggle("chat-open",o),e.classList.toggle("visible",a),t.classList.toggle("open",a),document.querySelectorAll('[id^="drawer-"]').forEach(i=>{i.id!=="drawer-overlay"&&i.id!=="drawer"&&i.id!=="drawer-title"&&i.id!=="drawer-close"&&i.classList.add("hidden")}),u.ui.drawer!=="none"){const i=document.getElementById(`drawer-${u.ui.drawer}`);i&&i.classList.remove("hidden");const s={chat:"„ÉÅ„É£„ÉÉ„Éà",people:"„É°„É≥„Éê„Éº",search:"Ê§úÁ¥¢",settings:"Ë®≠ÂÆö"};n.textContent=s[u.ui.drawer]||"„Éâ„É≠„ÉØ„Éº"}iu(o),document.getElementById("drawer-close")?.addEventListener("click",()=>{rn()}),e.addEventListener("click",()=>{rn()})}function Hg(e){const t=typeof e?.type=="string"?e.type:null;if(!t){console.warn("[event] dropped invalid event",e);return}e?.payload;const n=e?.fromActorId,a=e?.fromDisplayName;if(t.startsWith("call_")){try{const o=Dg(e);o&&typeof o.catch=="function"&&o.catch(i=>{console.error("[call] handleCallEvent promise rejected",i,e)})}catch(o){console.error("[call] handleCallEvent failed",o,e)}return}if(t==="poke"){const o=Le().get(n);Wd(o?.displayName||a||"Someone")}}function cs(e,t){if(!(!e||!e.type))switch(e.type){case"openToolLinks":const a=oa()?.items?.map(g=>({label:g.title,url:g.url,desc:g.desc}))||e.links||[];Vu(e.title||"Tools",a);break;case"openBulletin":const o=ia();Zu(e.title||"Bulletin",o?.items||[]);break;case"openBgmSelector":{if(u.world.areaId!=="area:garden"){console.log("[BGM] ignored openBgmSelector outside garden",{areaId:u.world.areaId});return}const g=localStorage.getItem("bgm:garden:selected"),b=g&&g.length?g:vo;ho({tracks:Xl(),selectedId:b,title:"„Ç¨„Éº„Éá„É≥BGM"});break}case"openAmbientParticles":Wl();break;case"openProfileEditor":ng();break;case"openDirectorySearch":ag();break;case"openRecentUpdates":og();break;case"openProfileViewer":si();break;case"openAdmin":const i=t?.proximity||90,s=dt();let l,d;t.interactPoint?(l=t.interactPoint.x,d=t.interactPoint.y):t.bounds?(l=t.bounds.x+t.bounds.w/2,d=t.bounds.y+t.bounds.h/2):(l=t.x||320,d=t.y||85);const I=s.x-l,p=s.y-d,v=Math.sqrt(I*I+p*p);v<=i?Tl():(console.log("[Main] Admin spot far, auto-approaching...",v),Vs(l,d),u.queuedAction={spotId:t.id,actionType:e.type});break;case"cycleTimeMode":if(u.world.areaId!=="area:garden"){console.log("[Temizu] ignored cycleTimeMode outside garden",{areaId:u.world.areaId});return}{const g=u.world.areaId,b=u.ui.timeMode||"day",y=Oc(b);u.ui.timeMode=y,Tr(y),console.log("[Temizu] cycleTimeMode",{areaId:g,prev:b,next:y}),O(`ÊôÇÈñì: ${Gs(y).label.toLowerCase()}`,"success")}break;default:console.log("[Main] Unknown spot action type:",e.type)}}async function ds(e){await Xe(e,{type:"poke",payload:{}})}async function jg(){const e=await Dd(u.me.actorId),t=_r();return e?(u.me.displayName=e.display_name,Un(e.display_name),fo(e.display_name),!0):t&&!await Qs(t,u.me.actorId)?(await Wo({sessionId:u.me.actorId,displayName:t}),u.me.displayName=t,Un(t),fo(t),!0):!1}async function Wg(e){let t=!1;try{await Wo({sessionId:u.me.actorId,displayName:e})}catch(n){const a=typeof n?.message=="string"?n.message:"";if(n?.code==="23505"||a.includes("duplicate")||a.includes("unique"))t=!0,console.warn("[Nameplate] Duplicate detected; continuing without blocking boot.",n);else throw n}u.me.displayName=e,Is(e),Un(e),fo(e),t&&console.warn("[Nameplate] Duplicate prevented remote save; local name retained.")}async function Fg(){const e=dt(),t=st({pos:e,facing:Fn(),avatarColor:u.me.avatar.color||null});t&&await Bd({presenceChannelKey:"presence:office",initialState:t})}window.bootLog=function(e){console.log("[BOOT]",e);const t=document.getElementById("bootLog");t&&(t.textContent+=`${e}
`)};window.showFatal=function(e){console.error("[FATAL]",e);try{Va()}catch{}const t=document.getElementById("fatalError");t?(t.style.display="block",t.textContent=`Ëµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:
${e}

DevTools Console„ÇÇÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`):alert(e);const n=document.getElementById("loading-screen");if(n){n.classList.remove("hidden");const a=n.querySelector(".loading-spinner");a&&(a.style.display="none");const o=n.querySelector(".loading-text");o&&(o.style.display="none")}};function Kn(e){const t=String(e||"").toLowerCase();return t?t.includes("/companion/")||t.includes("companion/voicechat")||t.includes("dialogue.js")||t.includes("tts.js"):!1}window.addEventListener("error",e=>{if(Kn(e?.message)||Kn(e?.filename)){console.error("[BOOT] companion runtime error (non-fatal):",{message:e?.message,filename:e?.filename,lineno:e?.lineno,colno:e?.colno});return}window.showFatal(`JS Error: ${e.message}
${e.filename}:${e.lineno}:${e.colno}`)});window.addEventListener("unhandledrejection",e=>{if(Kn(e?.reason?.message)||Kn(e?.reason)){console.error("[BOOT] companion promise rejection (non-fatal):",e?.reason);return}const t=e.reason?.message||String(e.reason);window.showFatal(`Unhandled Promise Rejection: ${t}`)});async function us(){window.bootLog("Virtual Office - Booting...");try{window.bootLog("Loading config...");const e=await fs();window.bootLog("Initializing Supabase..."),await dr(),window.bootLog("Checking session...");const t=await fr();t?(window.bootLog("Session found, proceeding..."),await er(e,t)):(window.bootLog("No session, showing login..."),zg(e))}catch(e){console.error("Boot failed:",e),window.showFatal(`Ëµ∑Âãï„Ç®„É©„Éº:
${e.message||e}`)}}function zg(e){br(async(n,a)=>{try{const{session:o}=await gr(n);a&&Lr(n),hr(),await er(e,o)}catch(o){console.error("Login flow failed:",o),showError(`„É≠„Ç∞„Ç§„É≥Âæå„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:
${o.message||o}`)}});const t=Mr();if(t){if(!e){window.showFatal("Config not loaded");return}vr(t)}ri(),yr()}async function er(e,t){try{window.bootLog("Login successful"),Mo("„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„Åø‰∏≠..."),window.bootLog("Initializing app logic..."),await $g(e,t),window.bootLog("Checking nameplate..."),Mo("ÂêçÊú≠„ÇíÁ¢∫Ë™ç‰∏≠..."),await jg()?await tr():(ri(),Ug())}catch(n){console.error("Proceed failed:",n),window.showFatal(`ÂàùÊúüÂåñ„Ç®„É©„Éº:
${n.message||n}`)}}function Ug(){wr(async e=>{try{await Wg(e),Ar(),await tr()}catch(t){console.error("Nameplate flow failed:",t),window.showFatal(`ÂêçÊú≠Ë®≠ÂÆö„Ç®„É©„Éº:
${t.message||t}`)}}),Cr()}async function tr(){Mo("Êé•Á∂ö‰∏≠...");try{window.bootLog("Starting presence..."),await Fg(),ri(),Gg(),window.bootLog("Virtual Office - Ready!"),console.log("Virtual Office - Ready!")}catch(e){console.error("Finish boot failed:",e),window.showFatal(`Êé•Á∂ö„Ç®„É©„Éº:
${e.message||e}`)}}function Mo(e="Loading..."){const t=document.getElementById("loading-screen"),n=t?.querySelector(".loading-text");t&&t.classList.remove("hidden"),n&&(n.textContent=e)}function ri(){const e=document.getElementById("loading-screen");e&&e.classList.add("hidden")}function Gg(){document.getElementById("menubar")?.classList.remove("hidden"),document.getElementById("main")?.classList.remove("hidden")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",us):us();
